<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Master - è·ç¼ºä¸»æª”ç®¡ç†ç³»çµ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: 'Inter', 'Noto Sans TC', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="root"></div>

    <script
      type="text/babel"
      data-presets="env,react"
      data-plugins="proposal-class-properties,proposal-object-rest-spread,proposal-optional-chaining,proposal-nullish-coalescing-operator"
    >
      const { useState, useEffect, useMemo } = React;

      if (!window.storage) {
        window.storage = {
          async get(key) {
            const value = localStorage.getItem(key);
            return value ? { value } : null;
          },
          async set(key, value) {
            localStorage.setItem(key, value);
            return true;
          }
        };
      }

      const storage = window.storage;

      const normalizeKey = (key = '') => key.toString().replace(/\s+/g, '').toLowerCase();

      const normalizeRow = (row = {}) =>
        Object.entries(row).reduce((acc, [key, value]) => {
          acc[normalizeKey(key)] = value;
          return acc;
        }, {});

      const locationOptions = ['å…¨éƒ¨å» å€', 'BMC+BML', 'BMC', 'BML', 'BMY', 'å…¶ä»–'];
      const jobFamilyFilters = ['å…¨éƒ¨è·ç³»', 'IDL', 'IDL-å°ˆæ¥­è·', 'IDL-ç®¡ç†è·', 'DL'];
      const recruiterOptions = ['Minnie Hsu', 'Mark Yang', 'Jake Chee', 'Cathy Huang', 'Kim Kao'];

      const getCellValue = (normalizedRow, aliases, fallback = '') => {
        for (const alias of aliases) {
          const value = normalizedRow[normalizeKey(alias)];
          if (value !== undefined && value !== null && value !== '') {
            return typeof value === 'string' ? value.trim() : value;
          }
        }
        return fallback;
      };

      const normalizeStringValue = (value) =>
        value && value.toString ? value.toString().trim().toUpperCase() : '';

      const formatYearMonth = (inputDate) => {
        const date =
          inputDate instanceof Date && !Number.isNaN(inputDate?.getTime()) ? inputDate : new Date();
        const yearPart = String(date.getFullYear()).slice(-2);
        const monthPart = String(date.getMonth() + 1).padStart(2, '0');
        return `${yearPart}${monthPart}`;
      };

      const parseYearFromValue = (value) => {
        if (!value) return null;
        const date = new Date(value);
        if (!Number.isNaN(date.getTime())) {
          return String(date.getFullYear());
        }
        return null;
      };

      const normalizeJobStatus = (status) => {
        if (!status) return 'æ‹›å‹Ÿç¢ºèª';
        if (status === 'æ‹›å‹Ÿä¸­') return 'é–‹å•Ÿä¸­';
        if (status === 'é—œé–‰') return 'å·²é—œé–‰';
        if (status === 'å¾…ç¢ºèª') return 'æ‹›å‹Ÿç¢ºèª';
        return status;
      };

      // æ ¹æ“šäººåŠ›å–®è¡¨å–®ç‹€æ…‹å’Œå ±åˆ°äººæ•¸è‡ªå‹•åˆ¤æ–·è·ç¼ºç‹€æ…‹
      const determineJobStatus = (formStatus, onboardCount, headcount) => {
        const normalizedFormStatus = String(formStatus || '').trim();
        
        // 1. äººåŠ›å–®è¡¨å–®ç‹€æ…‹ç‚º"å¦æ±º" â†’ å·²é—œé–‰ (äººåŠ›ç”³è«‹æœªé)
        if (normalizedFormStatus === 'å¦æ±º') {
          return {
            status: 'å·²é—œé–‰',
            closingReason: 'äººåŠ›ç”³è«‹æœªé',
            autoSet: true
          };
        }
        
        // 2. æ‹›å‹Ÿäººæ•¸ = å ±åˆ°äººæ•¸ â†’ å·²é—œé–‰ (æ‹›å‹Ÿå®Œæˆ)
        if (onboardCount > 0 && onboardCount >= headcount) {
          return {
            status: 'å·²é—œé–‰',
            closingReason: 'æ‹›å‹Ÿå®Œæˆ',
            autoSet: true
          };
        }
        
        // 3. äººåŠ›å–®è¡¨å–®ç‹€æ…‹ç‚º"ç”³è«‹ä¸­"æˆ–"å¾…ç°½æ ¸" â†’ ç”³è«‹ä¸­
        if (normalizedFormStatus === 'ç”³è«‹ä¸­' || normalizedFormStatus === 'å¾…ç°½æ ¸') {
          return {
            status: 'ç”³è«‹ä¸­',
            closingReason: '',
            autoSet: true
          };
        }
        
        // 4. äººåŠ›å–®è¡¨å–®ç‹€æ…‹ç‚º"å·²è™•ç†" â†’ æ‹›å‹Ÿç¢ºèª
        if (normalizedFormStatus === 'å·²è™•ç†') {
          return {
            status: 'æ‹›å‹Ÿç¢ºèª',
            closingReason: '',
            autoSet: true
          };
        }
        
        // é è¨­ç‹€æ…‹
        return {
          status: 'æ‹›å‹Ÿç¢ºèª',
          closingReason: '',
          autoSet: false
        };
      };

      const createInternalId = () => {
        if (window.crypto?.randomUUID) {
          return window.crypto.randomUUID();
        }
        return `job-${Date.now()}-${Math.random().toString(16).slice(2)}`;
      };

      const headerKeywords = [
        'HCæ‰€å±¬éƒ¨é–€',
        'éƒ¨é–€',
        'è·å‹™åç¨±',
        'è·ç¼ºåç¨±',
        'å·¥ä½œåœ°é»',
        'è·ç³»',
        'éœ€æ±‚äººæ•¸',
        'äººåŠ›å–®è¡¨å–®è™Ÿ',
        'è¡¨å–®è™Ÿ',
        'è¡¨å–®ç·¨è™Ÿ'
      ].map(normalizeKey);

      const getJobYear = (job) => {
        const fromForm = parseYearFromValue(job?.formEffectiveDate);
        if (fromForm) return fromForm;
        const fromCreated = parseYearFromValue(job?.createdAt);
        if (fromCreated) return fromCreated;
        const code = job?.jobId?.split?.('-')?.[1];
        if (code && code.length >= 2) {
          const yy = Number(code.slice(0, 2));
          if (Number.isFinite(yy)) {
            const fullYear = yy >= 70 ? 1900 + yy : 2000 + yy;
            return String(fullYear);
          }
        }
        return null;
      };

      const getLocationBucket = (location = '') => {
        const text = location.toUpperCase();
        if (text.includes('BMC')) return 'BMC';
        if (text.includes('BML')) return 'BML';
        if (text.includes('BMY')) return 'BMY';
        return 'å…¶ä»–';
      };

      // æå–å» å€å‰ä¸‰ç¢¼
      const getLocationShortCode = (location = '') => {
        if (!location) return '-';
        const text = location.trim().toUpperCase();
        // æª¢æŸ¥æ˜¯å¦åŒ…å« BMC, BML, BMY
        if (text.includes('BMC')) return 'BMC';
        if (text.includes('BML')) return 'BML';
        if (text.includes('BMY')) return 'BMY';
        // å¦‚æœéƒ½ä¸åŒ…å«,è¿”å›å‰ä¸‰å€‹å­—å…ƒ
        return text.substring(0, 3) || text;
      };

      const getJobFamilyBucket = (family = '') => {
        const text = family.toUpperCase();
        if (text.includes('ç®¡ç†')) return 'IDL-ç®¡ç†è·';
        if (text.includes('å°ˆæ¥­')) return 'IDL-å°ˆæ¥­è·';
        if (text.includes('DL') || text.includes('æŠ€è¡“')) return 'DL';
        return 'å…¶ä»–';
      };

      // è¨ˆç®—å ±åˆ°äººæ•¸ï¼šåŒä¸€å€‹äººåŠ›å–®è¡¨å–®è™Ÿä¸­ï¼Œæ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ç‚º"å·²è™•ç†"çš„ç­†æ•¸
      const calculateOnboardCount = (formNumber, allJobs) => {
        if (!formNumber) return 0;
        
        // æ­£è¦åŒ–è¡¨å–®è™Ÿé€²è¡Œæ¯”å°
        const normalizedFormNumber = String(formNumber).trim();
        
        const matchingJobs = allJobs.filter(job => {
          const jobFormNumber = String(job.formNumber || '').trim();
          const jobOfferStatus = String(job.offerFormStatus || '').trim();
          
          // é™¤éŒ¯ï¼šè¨˜éŒ„åŒ¹é…éç¨‹
          if (jobFormNumber === normalizedFormNumber) {
            console.log(`è¡¨å–®è™Ÿ ${normalizedFormNumber} åŒ¹é…:`, {
              è·ç¼ºä»£ç¢¼: job.jobId,
              è·å‹™: job.position,
              æ ¸è–ªå–®è¡¨å–®è™Ÿ: job.offerFormNumber,
              æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹: jobOfferStatus,
              æ˜¯å¦å·²è™•ç†: jobOfferStatus === 'å·²è™•ç†'
            });
          }
          
          return jobFormNumber === normalizedFormNumber && jobOfferStatus === 'å·²è™•ç†';
        });
        
        return matchingJobs.length;
      };

      const getJobKey = (job) => {
        const formKey = normalizeStringValue(job?.formNumber);
        if (formKey) return `FORM-${formKey}`;
        const jobIdKey = normalizeStringValue(job?.jobId);
        if (jobIdKey) return `JOB-${jobIdKey}`;
        return `ID-${job?.internalId || job?.id || createInternalId()}`;
      };

      const mergeJobRecords = (existing, incoming) => {
        const map = new Map();
        existing.forEach((job) => {
          map.set(getJobKey(job), {
            ...job,
            id: job.id || job.internalId || createInternalId(),
            internalId: job.internalId || job.id || createInternalId(),
            job104Title: job.job104Title || job.position || ''
          });
        });

        incoming.forEach((job) => {
          const key = getJobKey(job);
          if (map.has(key)) {
            const current = map.get(key);
            const merged = {
              ...current,
              ...job,
              id: current.id || job.id || createInternalId(),
              internalId: current.internalId || job.internalId || createInternalId(),
              createdAt: current.createdAt || job.createdAt
            };
            // ä¿è­·ç¶²é ä¸Šå·²å¡«å¯«çš„æ‹›å‹Ÿç¢ºèªè³‡æ–™,ä¸è¢«åŒ¯å…¥è¦†è“‹
            [
              'status',
              'confirmedRequirement',
              'confirmed104',
              'closingDate',
              'closingReason',
              'job104Title',
              'recruitmentOwner'
            ].forEach(
              (field) => {
                if (
                  current[field] !== undefined &&
                  current[field] !== null &&
                  current[field] !== ''
                ) {
                  merged[field] = current[field];
                }
              }
            );
            // ç‰¹åˆ¥è™•ç†å¸ƒæ—å€¼æ¬„ä½
            if (current.confirmedRequirement === true) {
              merged.confirmedRequirement = true;
            }
            if (current.confirmed104 === true) {
              merged.confirmed104 = true;
            }
            merged.status = normalizeJobStatus(merged.status);
            map.set(key, merged);
          } else {
            map.set(key, {
              ...job,
              id: job.id || job.internalId || createInternalId(),
              internalId: job.internalId || job.id || createInternalId(),
              status: normalizeJobStatus(job.status)
            });
          }
        });

        return Array.from(map.values());
      };

      const sheetToObjects = (sheet) => {
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        if (!rows.length) return [];

        let headerRowIndex = rows.findIndex((row) =>
          row.some((cell) => headerKeywords.includes(normalizeKey(cell || '')))
        );

        if (headerRowIndex === -1) {
          // è‹¥æ‰¾ä¸åˆ°æ˜ç¢ºæ¨™é¡Œï¼Œå°±é è¨­ä½¿ç”¨ç¬¬2åˆ— (A2)ï¼Œå¦å‰‡é€€å›ç¬¬1åˆ—
          headerRowIndex = rows.length > 1 ? 1 : 0;
        }

        const headerRow = rows[headerRowIndex].map((cell, idx) => cell || `æ¬„ä½${idx + 1}`);
        const dataRows = rows
          .slice(headerRowIndex + 1)
          .filter((row) => row.some((cell) => cell !== '' && cell !== null && cell !== undefined));

        return dataRows.map((row) =>
          row.reduce((acc, cell, idx) => {
            acc[headerRow[idx] || `æ¬„ä½${idx + 1}`] = cell;
            return acc;
          }, {})
        );
      };

      const BaseIcon = ({ size = 20, strokeWidth = 2, children, className = '', ...props }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth={strokeWidth}
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
          {...props}
        >
          {children}
        </svg>
      );

      const UploadIcon = (props) => (
        <BaseIcon {...props}>
          <path d="M4 18v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" />
          <polyline points="8 12 12 8 16 12" />
          <line x1="12" y1="8" x2="12" y2="2" />
        </BaseIcon>
      );

      const SearchIcon = (props) => (
        <BaseIcon {...props}>
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </BaseIcon>
      );

      const PlusIcon = (props) => (
        <BaseIcon {...props}>
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </BaseIcon>
      );

      const DownloadIcon = (props) => (
        <BaseIcon {...props}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="7 10 12 15 17 10" />
          <line x1="12" y1="15" x2="12" y2="3" />
        </BaseIcon>
      );

      const RefreshIcon = (props) => (
        <BaseIcon {...props}>
          <polyline points="23 4 23 10 17 10" />
          <polyline points="1 20 1 14 7 14" />
          <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10" />
          <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14" />
        </BaseIcon>
      );

      const EditIcon = (props) => (
        <BaseIcon {...props}>
          <path d="m3 17 2 4 4-2 9.5-9.5a2.5 2.5 0 0 0-3.54-3.54Z" />
          <path d="m14 4 6 6" />
        </BaseIcon>
      );

      const TrashIcon = (props) => (
        <BaseIcon {...props}>
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
          <path d="M10 11v6" />
          <path d="M14 11v6" />
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
        </BaseIcon>
      );

      const BriefcaseIcon = (props) => (
        <BaseIcon {...props}>
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
        </BaseIcon>
      );

      const UsersIcon = (props) => (
        <BaseIcon {...props}>
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </BaseIcon>
      );

      const BarChartIcon = (props) => (
        <BaseIcon {...props}>
          <line x1="12" y1="20" x2="12" y2="10" />
          <line x1="18" y1="20" x2="18" y2="4" />
          <line x1="6" y1="20" x2="6" y2="16" />
        </BaseIcon>
      );

      const SettingsIcon = (props) => (
        <BaseIcon {...props}>
          <circle cx="12" cy="12" r="3" />
          <path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.2 4.2l4.2 4.2M1 12h6m6 0h6m-16.4.6l4.2-4.2m4.2-4.2l4.2-4.2" />
        </BaseIcon>
      );

      const FileTextIcon = (props) => (
        <BaseIcon {...props}>
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
          <polyline points="10 9 9 9 8 9" />
        </BaseIcon>
      );

      const ClipboardListIcon = (props) => (
        <BaseIcon {...props}>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
          <line x1="9" y1="12" x2="15" y2="12" />
          <line x1="9" y1="16" x2="15" y2="16" />
          <line x1="9" y1="20" x2="15" y2="20" />
        </BaseIcon>
      );

      const CalendarCheckIcon = (props) => (
        <BaseIcon {...props}>
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
          <polyline points="9 16 11 18 15 14" />
        </BaseIcon>
      );

      const ChevronLeftIcon = (props) => (
        <BaseIcon {...props}>
          <polyline points="15 18 9 12 15 6" />
        </BaseIcon>
      );

      const ChevronRightIcon = (props) => (
        <BaseIcon {...props}>
          <polyline points="9 18 15 12 9 6" />
        </BaseIcon>
      );

      function JobMasterTracker() {
        const [currentPage, setCurrentPage] = useState('job-master');
        const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
        const [jobs, setJobs] = useState([]);
        const [applications, setApplications] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const currentYear = String(new Date().getFullYear());
        const [filterYear, setFilterYear] = useState(currentYear);
        const [filterLocation, setFilterLocation] = useState('å…¨éƒ¨å» å€');
        const [filterJobFamily, setFilterJobFamily] = useState('IDL');
        const [filterRecruiter, setFilterRecruiter] = useState('å…¨éƒ¨');
        const [statusCardFilter, setStatusCardFilter] = useState('å…¨éƒ¨');
        const [activeStatCard, setActiveStatCard] = useState('total');
        const [showAddModal, setShowAddModal] = useState(false);
        const [editingJob, setEditingJob] = useState(null);
        const [jobToDelete, setJobToDelete] = useState(null);
        const [detailJob, setDetailJob] = useState(null);
        
        // Application Master ç¯©é¸ç‹€æ…‹
        const [appSearchTerm, setAppSearchTerm] = useState('');
        const [appFilterYear, setAppFilterYear] = useState(currentYear);
        const [appFilterLocation, setAppFilterLocation] = useState('å…¨éƒ¨å» å€');
        const [appFilterJobFamily, setAppFilterJobFamily] = useState('IDL');
        const [appFilterRecruiter, setAppFilterRecruiter] = useState('å…¨éƒ¨');
        const [appActiveStatCard, setAppActiveStatCard] = useState('é–‹å•Ÿä¸­');
        const [appSortField, setAppSortField] = useState('avgApplications');
        const [appSortDirection, setAppSortDirection] = useState('asc');

        useEffect(() => {
          loadData();
          
          // æä¾›å…¨åŸŸé™¤éŒ¯å‡½æ•¸
          window.checkOnboardCount = (formNumber) => {
            const formNum = String(formNumber).trim();
            console.log(`\nğŸ” æª¢æŸ¥è¡¨å–®è™Ÿ ${formNum} çš„å ±åˆ°äººæ•¸`);
            console.log('='.repeat(50));
            
            const sameFormJobs = jobs.filter(j => String(j.formNumber || '').trim() === formNum);
            
            if (sameFormJobs.length === 0) {
              console.warn(`âŒ æ‰¾ä¸åˆ°è¡¨å–®è™Ÿç‚º ${formNum} çš„è·ç¼º`);
              console.log('\nğŸ’¡ æç¤º: è«‹ç¢ºèªè¡¨å–®è™Ÿæ˜¯å¦æ­£ç¢º');
              return;
            }
            
            console.log(`\nâœ… æ‰¾åˆ° ${sameFormJobs.length} ç­†ç›¸åŒè¡¨å–®è™Ÿçš„è·ç¼º:\n`);
            
            sameFormJobs.forEach((j, index) => {
              const offerStatus = String(j.offerFormStatus || '').trim();
              console.log(`${index + 1}. è·ç¼ºä»£ç¢¼: ${j.jobId}`);
              console.log(`   éƒ¨é–€: ${j.department}`);
              console.log(`   è·å‹™: ${j.position}`);
              console.log(`   æ ¸è–ªå–®è¡¨å–®è™Ÿ: "${j.offerFormNumber || '(ç©ºç™½)'}"`);
              console.log(`   æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹: "${offerStatus || '(ç©ºç™½)'}"`);
              console.log(`   æ˜¯å¦ç‚º"å·²è™•ç†": ${offerStatus === 'å·²è™•ç†' ? 'âœ… æ˜¯' : 'âŒ å¦'}`);
              
              if (offerStatus && offerStatus !== 'å·²è™•ç†') {
                console.log(`   âš ï¸ ç‹€æ…‹ä¸ç¬¦: éœ€è¦"å·²è™•ç†"ï¼Œå¯¦éš›ç‚º"${offerStatus}"`);
              }
              if (!offerStatus) {
                console.log(`   âš ï¸ æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ç‚ºç©ºç™½`);
              }
              console.log('');
            });
            
            const count = sameFormJobs.filter(j => String(j.offerFormStatus || '').trim() === 'å·²è™•ç†').length;
            console.log('='.repeat(50));
            console.log(`ğŸ“Š å ±åˆ°äººæ•¸: ${count} / ${sameFormJobs.length}`);
            console.log('='.repeat(50));
            
            if (count === 0 && sameFormJobs.length > 0) {
              console.warn('\nâŒ å ±åˆ°äººæ•¸ç‚º 0 çš„å¯èƒ½åŸå› :');
              console.warn('1. æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ä¸æ˜¯"å·²è™•ç†"');
              console.warn('2. æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹æ¬„ä½ç‚ºç©ºç™½');
              console.warn('3. ç‹€æ…‹æ–‡å­—æœ‰å¤šé¤˜ç©ºæ ¼æˆ–ä¸åŒå­—å…ƒ');
              console.warn('\nğŸ’¡ è§£æ±ºæ–¹æ³•:');
              console.warn('   åœ¨ Excel ä¸­å°‡ã€Œæ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ã€æ¬„ä½æ”¹ç‚º"å·²è™•ç†"');
              console.warn('   ç„¶å¾Œé‡æ–°ä¸Šå‚³ Excel æª”æ¡ˆ');
            }
          };
          
          // æä¾›ç‹€æ…‹æª¢æŸ¥å‡½æ•¸
          window.checkJobStatus = (formNumber) => {
            const formNum = String(formNumber).trim();
            console.log(`\nğŸ” æª¢æŸ¥è¡¨å–®è™Ÿ ${formNum} çš„è·ç¼ºç‹€æ…‹`);
            console.log('='.repeat(50));
            
            const sameFormJobs = jobs.filter(j => String(j.formNumber || '').trim() === formNum);
            
            if (sameFormJobs.length === 0) {
              console.warn(`âŒ æ‰¾ä¸åˆ°è¡¨å–®è™Ÿç‚º ${formNum} çš„è·ç¼º`);
              return;
            }
            
            console.log(`\nâœ… æ‰¾åˆ° ${sameFormJobs.length} ç­†ç›¸åŒè¡¨å–®è™Ÿçš„è·ç¼º:\n`);
            
            sameFormJobs.forEach((j, index) => {
              const onboardCount = calculateOnboardCount(j.formNumber, jobs);
              const autoStatus = determineJobStatus(j.formStatus, onboardCount, j.originalHeadcount || j.headcount);
              
              console.log(`${index + 1}. è·ç¼ºä»£ç¢¼: ${j.jobId}`);
              console.log(`   è·å‹™: ${j.position}`);
              console.log(`   äººåŠ›å–®è¡¨å–®ç‹€æ…‹: "${j.formStatus || '(ç©ºç™½)'}"`);
              console.log(`   ç•¶å‰è·ç¼ºç‹€æ…‹: "${j.status}"`);
              console.log(`   ç³»çµ±åˆ¤æ–·æ‡‰ç‚º: "${autoStatus.status}"`);
              console.log(`   éœ€æ±‚äººæ•¸: ${j.originalHeadcount || j.headcount}`);
              console.log(`   å ±åˆ°äººæ•¸: ${onboardCount}`);
              
              if (j.status !== autoStatus.status && autoStatus.autoSet) {
                console.warn(`   âš ï¸ ç‹€æ…‹ä¸ä¸€è‡´! æ‡‰è©²æ˜¯"${autoStatus.status}"ä½†é¡¯ç¤ºç‚º"${j.status}"`);
              } else {
                console.log(`   âœ… ç‹€æ…‹æ­£ç¢º`);
              }
              console.log('');
            });
          };
          
          console.log('ğŸ’¡ æç¤º: å¯ä»¥åœ¨ Console ä¸­è¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤ä¾†æª¢æŸ¥:');
          console.log('   checkOnboardCount("è¡¨å–®è™Ÿ") - æª¢æŸ¥å ±åˆ°äººæ•¸');
          console.log('   checkJobStatus("è¡¨å–®è™Ÿ") - æª¢æŸ¥è·ç¼ºç‹€æ…‹');
        }, []);

        const loadData = async () => {
          try {
            const result = await storage.get('job-master-data');
            if (result && result.value) {
              const data = JSON.parse(result.value);
              let needsUpdate = false;
              const normalizedData = data.map((job, index) => {
                const headcount = Math.max(1, Number(job.headcount) || 1);
                const formNumber =
                  (job.formNumber && job.formNumber.toString().trim()) || `FORM${index + 1}`;
                const createdAt = job.createdAt || new Date().toISOString();
                const department = job.department || '';
                const sequenceNumber = job.sequenceNumber || headcount;
                const jobId = generateJobId(department, formNumber, sequenceNumber, new Date(createdAt));
                const normalizedId = job.id ?? job.internalId ?? createInternalId();
                const formStatus = job.formStatus || job.formStatusText || job.jobFormStatus;
                const job104Title = job.job104Title || job.position || '';
                const formEffectiveDate = job.formEffectiveDate || job.approvalDate || job.createdAt || '';
                const recruitmentOwner = job.recruitmentOwner || job.approver || '';
                const confirmedRequirement = Boolean(job.confirmedRequirement);
                const confirmed104 = Boolean(job.confirmed104);
                
                // è¨ˆç®—å ±åˆ°äººæ•¸
                const onboardCount = calculateOnboardCount(formNumber, data);
                const originalHeadcount = job.originalHeadcount || headcount;
                
                // è‡ªå‹•åˆ¤æ–·ç‹€æ…‹
                const autoStatus = determineJobStatus(formStatus, onboardCount, originalHeadcount);
                
                let finalStatus = job.status || autoStatus.status;
                let finalClosingReason = job.closingReason || '';
                
                // å¼·åˆ¶å¥—ç”¨è‡ªå‹•ç‹€æ…‹çš„æƒ…æ³:
                // 1. å·²é—œé–‰ (æ‹›å‹Ÿå®Œæˆæˆ–äººåŠ›ç”³è«‹æœªé)
                // 2. ç”³è«‹ä¸­ (äººåŠ›å–®è¡¨å–®ç‹€æ…‹ç‚º"ç”³è«‹ä¸­"æˆ–"å¾…ç°½æ ¸")
                // 3. æ‹›å‹Ÿç¢ºèª (äººåŠ›å–®è¡¨å–®ç‹€æ…‹ç‚º"å·²è™•ç†")
                if (autoStatus.autoSet) {
                  // å¦‚æœæ˜¯è‡ªå‹•é—œé–‰,å¼·åˆ¶å¥—ç”¨
                  if (autoStatus.status === 'å·²é—œé–‰') {
                    finalStatus = autoStatus.status;
                    if (!finalClosingReason) {
                      finalClosingReason = autoStatus.closingReason;
                    }
                  }
                  // å¦‚æœæ˜¯ç”³è«‹ä¸­æˆ–æ‹›å‹Ÿç¢ºèª,ä¸”ç•¶å‰ç‹€æ…‹ä¸æ˜¯æ‰‹å‹•è¨­å®šçš„"é–‹å•Ÿä¸­",å‰‡å¥—ç”¨
                  else if ((autoStatus.status === 'ç”³è«‹ä¸­' || autoStatus.status === 'æ‹›å‹Ÿç¢ºèª') && 
                           job.status !== 'é–‹å•Ÿä¸­') {
                    finalStatus = autoStatus.status;
                    finalClosingReason = '';
                  }
                }
                
                const normalizedStatus = normalizeJobStatus(finalStatus);
                const closingDate = job.closingDate || '';
                
                if (
                  headcount !== job.headcount ||
                  formNumber !== job.formNumber ||
                  !job.createdAt ||
                  job.jobId !== jobId ||
                  normalizedId !== job.id ||
                  !job.internalId ||
                  job.status !== normalizedStatus ||
                  job.formStatus !== (formStatus || job.formStatus) ||
                  job.formEffectiveDate !== formEffectiveDate ||
                  job.recruitmentOwner !== recruitmentOwner ||
                  (job.job104Title || '') !== job104Title ||
                  job.closingReason !== finalClosingReason
                ) {
                  needsUpdate = true;
                }
                return {
                  ...job,
                  headcount,
                  formNumber,
                  createdAt,
                  jobId,
                  id: normalizedId,
                  internalId: normalizedId,
                  formStatus: formStatus || job.formStatus || 'å¾…ç¢ºèª',
                  formEffectiveDate,
                  recruitmentOwner,
                  job104Title,
                  confirmedRequirement,
                  confirmed104,
                  closingDate,
                  closingReason: finalClosingReason,
                  status: normalizedStatus
                };
              });

              setJobs(normalizedData);

              if (needsUpdate) {
                await saveData(normalizedData);
              }
            }
          } catch (error) {
            console.warn('é¦–æ¬¡ä½¿ç”¨ï¼Œå°šç„¡è³‡æ–™');
          }
        };

        const saveData = async (data) => {
          try {
            await storage.set('job-master-data', JSON.stringify(data));
          } catch (error) {
            console.error('å„²å­˜å¤±æ•—:', error);
            alert('è³‡æ–™å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        };

        const years = useMemo(() => {
          const set = new Set();
          jobs.forEach((job) => {
            const year = getJobYear(job);
            if (year) set.add(year);
          });
          set.add(currentYear);
          if (filterYear !== 'å…¨éƒ¨') {
            set.add(filterYear);
          }
          const ordered = Array.from(set).sort((a, b) => Number(b) - Number(a));
          return ['å…¨éƒ¨', ...ordered];
        }, [jobs, currentYear, filterYear]);

        const jobFamilyOptions = jobFamilyFilters;

        const baseFilteredJobs = useMemo(() => {
          let filtered = jobs;

          if (searchTerm) {
            const keyword = searchTerm.toLowerCase();
            filtered = filtered.filter((job) =>
              job.jobId?.toLowerCase().includes(keyword) ||
              job.department?.toLowerCase().includes(keyword) ||
              job.position?.toLowerCase().includes(keyword) ||
              job.jobFamily?.toLowerCase().includes(keyword) ||
              job.formNumber?.toLowerCase().includes(keyword)
            );
          }

          if (filterYear !== 'å…¨éƒ¨') {
            filtered = filtered.filter((job) => getJobYear(job) === filterYear);
          }

          if (filterLocation !== 'å…¨éƒ¨å» å€') {
            filtered = filtered.filter((job) => {
              const bucket = getLocationBucket(job.location || '');
              if (filterLocation === 'BMC+BML') {
                return bucket === 'BMC' || bucket === 'BML';
              }
              return bucket === filterLocation;
            });
          }

          if (filterJobFamily !== 'å…¨éƒ¨è·ç³»') {
            filtered = filtered.filter((job) => {
              const bucket = getJobFamilyBucket(job.jobFamily || '');
              if (filterJobFamily === 'IDL') {
                return bucket === 'IDL-å°ˆæ¥­è·' || bucket === 'IDL-ç®¡ç†è·';
              }
              return bucket === filterJobFamily;
            });
          }

          if (filterRecruiter !== 'å…¨éƒ¨') {
            const recruiterKey = normalizeStringValue(filterRecruiter);
            filtered = filtered.filter(
              (job) => normalizeStringValue(job.recruitmentOwner) === recruiterKey
            );
          }

          return filtered;
        }, [searchTerm, filterYear, filterLocation, filterJobFamily, filterRecruiter, jobs]);

        const filteredJobs = useMemo(() => {
          if (statusCardFilter === 'å…¨éƒ¨') return baseFilteredJobs;
          return baseFilteredJobs.filter((job) => {
            const status = normalizeJobStatus(job.status);
            return status === statusCardFilter;
          });
        }, [baseFilteredJobs, statusCardFilter]);

        const handleStatCardClick = (type) => {
          if (type === 'total' || type === 'headcount') {
            setStatusCardFilter('å…¨éƒ¨');
            setActiveStatCard(type);
            return;
          }
          setStatusCardFilter((prev) => {
            const next = prev === type ? 'å…¨éƒ¨' : type;
            setActiveStatCard(next === 'å…¨éƒ¨' ? 'total' : type);
            return next;
          });
        };

        const handleFileUpload = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const data = new Uint8Array(event.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const sheetName = workbook.SheetNames[0];
              const sheet = workbook.Sheets[sheetName];
              const jsonData = sheetToObjects(sheet);

              if (!jsonData.length) {
                alert('æœªæ‰¾åˆ°å¯åŒ¯å…¥çš„è³‡æ–™åˆ—ï¼Œè«‹ç¢ºèª Excel å…§å®¹å¾ A2 é–‹å§‹æœ‰è³‡æ–™ã€‚');
                return;
              }

              const newJobs = [];
              jsonData.forEach((row, index) => {
                const normalizedRow = normalizeRow(row);
                const dept = getCellValue(normalizedRow, ['HCæ‰€å±¬éƒ¨é–€', 'éƒ¨é–€', 'ç”¨äººå–®ä½', 'department']);
                const position = getCellValue(normalizedRow, ['è·å‹™åç¨±', 'è·ä½åç¨±', 'è·ç¼ºåç¨±', 'position']);
                const location = getCellValue(normalizedRow, ['å·¥ä½œåœ°é»', 'åœ°é»', 'location']);
                const jobFamily = getCellValue(normalizedRow, ['è·ç³»', 'è·æ—', 'jobfamily']);
                const formNumberRaw = getCellValue(
                  normalizedRow,
                  ['äººåŠ›å–®è¡¨å–®è™Ÿ', 'è¡¨å–®è™Ÿ', 'è¡¨å–®ç·¨è™Ÿ', 'formno', 'formnumber'],
                  `FORM${jobs.length + index + 1}`
                );
                const formNumberClean = formNumberRaw ? formNumberRaw.toString().trim() : '';
                const formNumber = formNumberClean || `FORM${jobs.length + index + 1}`;
                const formStatus = getCellValue(
                  normalizedRow,
                  ['äººåŠ›å–®è¡¨å–®ç‹€æ…‹', 'è¡¨å–®ç‹€æ…‹', 'ç‹€æ…‹'],
                  'å¾…ç¢ºèª'
                );
                const formEffectiveDate = getCellValue(
                  normalizedRow,
                  ['äººåŠ›å–®ç°½æ ¸ç”Ÿæ•ˆæ™‚é–“', 'ç°½æ ¸ç”Ÿæ•ˆæ™‚é–“', 'æ ¸è–ªå–®ç°½æ ¸ç”Ÿæ•ˆæ™‚é–“']
                );
                const recruitmentOwner = getCellValue(
                  normalizedRow,
                  ['æ‹›å‹Ÿå°ˆå®¶', 'è² è²¬æ‹›å‹Ÿ', 'æ ¸å‡†äºº', 'æ ¸å‡†ä¸»ç®¡', 'approver']
                );
                const approvalDate = getCellValue(normalizedRow, ['æ ¸å‡†æ—¥æœŸ', 'approvaldate']);
                const salaryRange = getCellValue(normalizedRow, ['è–ªè³‡ç¯„åœ', 'é ç®—è·ç­‰', 'è–ªè³‡', 'salary']);
                const reason = getCellValue(normalizedRow, ['éœ€æ±‚åŸå› ', 'å‚™è¨»', 'åŸå› ', 'note', 'reason']);
                const job104Title = getCellValue(
                  normalizedRow,
                  ['104è·ç¨±', '104è·å‹™', '104title'],
                  position
                );
                const status = getCellValue(normalizedRow, ['è·ç¼ºç‹€æ…‹', 'ç‹€æ…‹', 'status'], 'é–‹å•Ÿä¸­') || 'é–‹å•Ÿä¸­';
                const headcountValue = Number(
                  getCellValue(normalizedRow, ['éœ€æ±‚äººæ•¸', 'headcount', 'äººæ•¸'], 1)
                );
                const headcount = Number.isFinite(headcountValue) && headcountValue > 0 ? headcountValue : 1;
                const offerFormNumber = getCellValue(
                  normalizedRow,
                  ['æ ¸è–ªå–®è¡¨å–®è™Ÿ', 'æ ¸è–ªè¡¨å–®è™Ÿ', 'offernumber']
                );
                const offerFormStatus = getCellValue(
                  normalizedRow,
                  ['æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹', 'æ ¸è–ªç‹€æ…‹', 'offerstatus']
                );
                const createdAt = new Date().toISOString();

                // æ ¹æ“šéœ€æ±‚äººæ•¸æ‹†åˆ†æˆå¤šç­†ç´€éŒ„
                for (let i = 1; i <= headcount; i++) {
                  const internalId = createInternalId();
                  
                  // è¨ˆç®—å ±åˆ°äººæ•¸ (éœ€è¦å…ˆæœ‰æ‰€æœ‰è³‡æ–™æ‰èƒ½è¨ˆç®—,é€™è£¡å…ˆè¨­ç‚º0)
                  const onboardCount = 0; // æœƒåœ¨ loadData æ™‚é‡æ–°è¨ˆç®—
                  
                  // è‡ªå‹•åˆ¤æ–·åˆå§‹ç‹€æ…‹
                  const autoStatus = determineJobStatus(formStatus, onboardCount, headcount);
                  
                  newJobs.push({
                    id: internalId,
                    internalId,
                    jobId: generateJobId(dept, formNumber, i, new Date(createdAt)),
                    department: dept,
                    position,
                    location,
                    jobFamily,
                    headcount: 1,
                    originalHeadcount: headcount,
                    sequenceNumber: i,
                    formNumber,
                    formStatus,
                    formEffectiveDate,
                    recruitmentOwner,
                    approvalDate,
                    salaryRange,
                    reason,
                    job104Title: job104Title || position,
                    status: autoStatus.status,
                    confirmedRequirement: false,
                    confirmed104: false,
                    closingDate: autoStatus.status === 'å·²é—œé–‰' ? new Date().toISOString().split('T')[0] : '',
                    closingReason: autoStatus.closingReason,
                    closingReasonNote: '',
                    offerFormNumber: offerFormNumber || '',
                    offerFormStatus: offerFormStatus || '',
                    uploadDate: new Date().toLocaleDateString('zh-TW'),
                    createdAt
                  });
                }
              });

              const updatedJobs = mergeJobRecords(jobs, newJobs);
              setJobs(updatedJobs);
              await saveData(updatedJobs);
              
              // é™¤éŒ¯ï¼šé¡¯ç¤ºæ ¸è–ªå–®è³‡æ–™
              console.log('=== Job Master åŒ¯å…¥è³‡æ–™ (æ ¸è–ªå–®è³‡è¨Š) ===');
              const jobsWithOffer = newJobs.filter(j => j.offerFormNumber || j.offerFormStatus);
              if (jobsWithOffer.length > 0) {
                console.log(`æ‰¾åˆ° ${jobsWithOffer.length} ç­†æœ‰æ ¸è–ªå–®è³‡æ–™çš„è·ç¼º:`);
                jobsWithOffer.forEach(job => {
                  console.log(`è¡¨å–®è™Ÿ: ${job.formNumber}, è·å‹™: ${job.position}, æ ¸è–ªå–®è™Ÿ: ${job.offerFormNumber}, æ ¸è–ªç‹€æ…‹: ${job.offerFormStatus}`);
                });
              } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•æ ¸è–ªå–®è³‡æ–™ï¼Œè«‹ç¢ºèª Excel åŒ…å«ã€Œæ ¸è–ªå–®è¡¨å–®è™Ÿã€å’Œã€Œæ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ã€æ¬„ä½');
              }
              
              alert(`æˆåŠŸåŒ¯å…¥ ${newJobs.length} ç­†è·ç¼ºè³‡æ–™\n\nâœ“ å·²ä¿è­·åŸæœ‰çš„æ‹›å‹Ÿç¢ºèªè³‡æ–™ä¸è¢«è¦†è“‹\n  (è·ç¼ºç‹€æ…‹ã€ç¢ºèªä¸»ç®¡éœ€æ±‚ã€ç¢ºèª104è·ç¼ºã€104è·ç¨±ã€æ‹›å‹Ÿå°ˆå®¶ã€é—œé–‰è³‡è¨Š)\n\nğŸ’¡ è«‹é–‹å•Ÿ Console (F12) æŸ¥çœ‹æ ¸è–ªå–®è³‡æ–™åŒ¯å…¥ç‹€æ³`);
            } catch (error) {
              console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
              alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªExcelæ ¼å¼æ­£ç¢º');
            }
          };
          reader.readAsArrayBuffer(file);
          e.target.value = '';
        };

        const generateJobId = (dept, formNumber, sequenceNumber, createdAt = new Date()) => {
          const deptCode = (dept || 'JOB').replace(/\s+/g, '').substring(0, 4).toUpperCase() || 'JOB';
          const yearMonth = formatYearMonth(createdAt);
          const formCode =
            (formNumber || 'FORM')
              .toString()
              .replace(/\s+/g, '')
              .toUpperCase() || 'FORM';
          const num = String(sequenceNumber).padStart(2, '0');
          return `${deptCode}-${yearMonth}-${formCode}-${num}`;
        };

        const handleAddJob = async (jobData) => {
          const headcount = Math.max(1, Number(jobData.headcount) || 1);
          const formNumber =
            (jobData.formNumber && jobData.formNumber.toString().trim()) || `FORM${jobs.length + 1}`;
          const createdAt = new Date().toISOString();
          
          // æ ¹æ“šéœ€æ±‚äººæ•¸æ‹†åˆ†æˆå¤šç­†ç´€éŒ„
          const newJobs = [];
          for (let i = 1; i <= headcount; i++) {
            const internalId = createInternalId();
            newJobs.push({
              ...jobData,
              id: internalId,
              internalId,
              headcount: 1,
              originalHeadcount: headcount,
              sequenceNumber: i,
              formNumber,
              formStatus: jobData.formStatus || 'å¾…ç¢ºèª',
              formEffectiveDate: jobData.formEffectiveDate || '',
              recruitmentOwner: jobData.recruitmentOwner || '',
              job104Title: jobData.job104Title || jobData.position || '',
              confirmedRequirement: Boolean(jobData.confirmedRequirement),
              confirmed104: Boolean(jobData.confirmed104),
              closingDate: jobData.closingDate || '',
              closingReason: jobData.closingReason || '',
              status: jobData.status || 'å¾…ç¢ºèª',
              jobId: generateJobId(jobData.department, formNumber, i, new Date(createdAt)),
              uploadDate: new Date().toLocaleDateString('zh-TW'),
              createdAt
            });
          }
          
          const updatedJobs = mergeJobRecords(jobs, newJobs);
          setJobs(updatedJobs);
          await saveData(updatedJobs);
          setShowAddModal(false);
        };

        const handleEditJob = async (jobData) => {
          const updatedJobs = jobs.map((job) => {
            if (job.id !== editingJob.id) return job;
            const department = jobData.department || job.department;
            const formNumber =
              (jobData.formNumber && jobData.formNumber.toString().trim()) ||
              job.formNumber ||
              `FORM${job.id}`;
            const createdAtDate = job.createdAt ? new Date(job.createdAt) : new Date();
            const stableId = job.id || job.internalId || createInternalId();
            const sequenceNumber = job.sequenceNumber || 1;
            return {
              ...job,
              ...jobData,
              headcount: 1,
              formNumber,
              id: stableId,
              internalId: stableId,
              sequenceNumber,
              jobId: generateJobId(department, formNumber, sequenceNumber, createdAtDate)
            };
          });
          setJobs(updatedJobs);
          await saveData(updatedJobs);
          setEditingJob(null);
        };

        const deleteJob = async (jobRef) => {
          if (!jobRef) return;
          const targetId = jobRef.id || jobRef.internalId;
          const targetJobId = jobRef.jobId;
          const before = jobs.length;
          const updatedJobs = jobs.filter((job) => {
            if (targetId && (job.id === targetId || job.internalId === targetId)) {
              return false;
            }
            if (!targetId && targetJobId && job.jobId === targetJobId) {
              return false;
            }
            return true;
          });
          if (updatedJobs.length === before) {
            alert('æ‰¾ä¸åˆ°å°æ‡‰çš„è·ç¼ºè³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†å¾Œå†è©¦ä¸€æ¬¡');
            return;
          }
          setJobs(updatedJobs);
          await saveData(updatedJobs);
          if (
            detailJob &&
            (detailJob.id === jobRef.id ||
              detailJob.internalId === jobRef.internalId ||
              detailJob.jobId === jobRef.jobId)
          ) {
            setDetailJob(null);
          }
        };

        const confirmDeleteJob = async () => {
          if (!jobToDelete) return;
          await deleteJob(jobToDelete);
          setJobToDelete(null);
        };

        const handleClearData = async () => {
          if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è·ç¼ºè³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
            await saveData([]);
            setJobs([]);
            setJobToDelete(null);
            setDetailJob(null);
            setStatusCardFilter('å…¨éƒ¨');
            setActiveStatCard('total');
            setFilterYear(currentYear);
            setFilterLocation('å…¨éƒ¨å» å€');
            setFilterJobFamily('IDL-å°ˆæ¥­è·');
            setFilterRecruiter('å…¨éƒ¨');
            setSearchTerm('');
          }
        };

        const handleExport = () => {
          if (!filteredJobs.length) return;

          const exportData = filteredJobs.map((job) => ({
            'è·ç¼ºä»£ç¢¼': job.jobId,
            'äººåŠ›å–®è¡¨å–®è™Ÿ': job.formNumber,
            'äººåŠ›å–®è¡¨å–®ç‹€æ…‹': job.formStatus,
            'äººåŠ›å–®ç°½æ ¸ç”Ÿæ•ˆæ™‚é–“': job.formEffectiveDate,
            'HCæ‰€å±¬éƒ¨é–€': job.department,
            'è·å‹™åç¨±': job.position,
            '104è·ç¨±': job.job104Title || job.position,
            'å·¥ä½œåœ°é»': job.location,
            'è·ç³»': job.jobFamily,
            'éœ€æ±‚äººæ•¸': job.originalHeadcount || job.headcount,
            'å ±åˆ°äººæ•¸': calculateOnboardCount(job.formNumber, jobs),
            'æ‹›å‹Ÿå°ˆå®¶': job.recruitmentOwner,
            'ç¢ºèªä¸»ç®¡éœ€æ±‚': job.confirmedRequirement ? 'æ˜¯' : 'å¦',
            'ç¢ºèª104è·ç¼º': job.confirmed104 ? 'æ˜¯' : 'å¦',
            'è·ç¼ºç‹€æ…‹': normalizeJobStatus(job.status),
            'é—œé–‰æ—¥æœŸ': job.closingDate,
            'é—œé–‰åŸå› ': job.closingReason,
            'éœ€æ±‚åŸå›  / å‚™è¨»': job.reason,
            'å»ºæª”æ—¥æœŸ': job.uploadDate
          }));

          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Job Master');
          XLSX.writeFile(wb, `Job_Master_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        const handleExportAllData = () => {
          if (!jobs.length) {
            alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
            return;
          }

          const exportData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            totalJobs: jobs.length,
            data: jobs
          };

          const dataStr = JSON.stringify(exportData, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `BMC_ATS_Backup_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          alert(`æˆåŠŸåŒ¯å‡º ${jobs.length} ç­†è·ç¼ºè³‡æ–™`);
        };

        const handleImportAllData = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          if (!confirm('åŒ¯å…¥è³‡æ–™å°‡æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è·ç¼ºè³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
            e.target.value = '';
            return;
          }

          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const jsonData = JSON.parse(event.target.result);
              
              // é©—è­‰è³‡æ–™æ ¼å¼
              if (!jsonData.data || !Array.isArray(jsonData.data)) {
                throw new Error('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
              }

              const importedJobs = jsonData.data;
              
              // é©—è­‰å¿…è¦æ¬„ä½
              const validJobs = importedJobs.filter(job => 
                job.id && job.jobId && job.department && job.position
              );

              if (validJobs.length === 0) {
                throw new Error('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„è·ç¼ºè³‡æ–™');
              }

              // åŒ¯å…¥è³‡æ–™
              setJobs(validJobs);
              await saveData(validJobs);
              
              alert(`æˆåŠŸåŒ¯å…¥ ${validJobs.length} ç­†è·ç¼ºè³‡æ–™\nåŒ¯å‡ºæ—¥æœŸ: ${jsonData.exportDate ? new Date(jsonData.exportDate).toLocaleString('zh-TW') : 'æœªçŸ¥'}`);
              
              // é‡æ–°è¼‰å…¥é é¢æ•¸æ“š
              await loadData();
            } catch (error) {
              console.error('åŒ¯å…¥å¤±æ•—:', error);
              alert(`åŒ¯å…¥å¤±æ•—: ${error.message}\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º`);
            }
          };
          reader.readAsText(file);
          e.target.value = '';
        };

        // Application Master ç›¸é—œåŠŸèƒ½
        const handleApplicationUpload = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = new Uint8Array(event.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              
              // å¾ç¬¬3è¡Œé–‹å§‹è®€å– (A1, A2 å¿½ç•¥ä¸çœ‹)
              // ç¬¬3è¡Œæ˜¯æ¨™é¡Œè¡Œï¼Œç¬¬4è¡Œé–‹å§‹æ˜¯è³‡æ–™
              const jsonData = XLSX.utils.sheet_to_json(sheet, { 
                range: 2  // å¾ç¬¬3è¡Œé–‹å§‹ (0-based index)
              });

              if (jsonData.length === 0) {
                alert('æª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™');
                return;
              }

              // è™•ç†æ‡‰å¾µè³‡æ–™
              const processedApplications = jsonData.map(row => {
                const normalizedRow = Object.keys(row).reduce((acc, key) => {
                  acc[normalizeKey(key)] = row[key];
                  return acc;
                }, {});

                // æ ¹æ“šè²¼åœ–çš„æ¬„ä½åç¨±é€²è¡ŒåŒ¹é…
                const result = {
                  id: createInternalId(),
                  department: getCellValue(normalizedRow, ['éƒ¨é–€åç¨±', 'éƒ¨é–€', 'department'], ''),
                  jobTitle: getCellValue(normalizedRow, ['è·å‹™åç¨±', 'è·ç¨±', 'jobtitle', 'job_title'], ''),
                  lastOpenDate: getCellValue(normalizedRow, ['æœ€è¿‘é–‹å•Ÿæ—¥', 'é–‹å•Ÿæ—¥æœŸ', 'lastopendate'], ''),
                  status: getCellValue(normalizedRow, ['è·å‹™ç‹€æ…‹', 'è·ç¼ºç‹€æ…‹', 'status'], ''),
                  totalApplications: Number(getCellValue(normalizedRow, ['ç´¯è¨ˆæ‡‰å¾µæ•¸', 'æ‡‰å¾µç¸½æ•¸', 'ç¸½æ‡‰å¾µæ•¸'], 0)),
                  totalViews: Number(getCellValue(normalizedRow, ['ç´¯è¨ˆç€è¦½æ•¸', 'ç€è¦½ç¸½æ•¸', 'ç¸½ç€è¦½æ•¸'], 0)),
                  totalDays: Number(getCellValue(normalizedRow, ['ç´¯è¨ˆåˆŠç™»å¤©æ•¸', 'åˆŠç™»å¤©æ•¸', 'å¤©æ•¸', 'ç´¯è¨ˆå¤©æ•¸'], 0)),
                  uploadDate: new Date().toISOString().split('T')[0]
                };
                
                // Debug: è¨˜éŒ„ç¬¬ä¸€ç­†è³‡æ–™ä»¥ä¾¿æª¢æŸ¥
                if (jsonData.indexOf(row) === 0) {
                  console.log('Excel æ¬„ä½åç¨±:', Object.keys(row));
                  console.log('è§£æçµæœ:', result);
                }
                
                return result;
              });

              setApplications(processedApplications);
              localStorage.setItem('jobApplications', JSON.stringify(processedApplications));
              
              // é™¤éŒ¯è³‡è¨Šï¼šé¡¯ç¤ºæ‰€æœ‰åŒ¯å…¥çš„è·å‹™åç¨±
              console.log('=== Application Master åŒ¯å…¥è³‡æ–™ ===');
              console.log('åŒ¯å…¥çš„è·å‹™åç¨±åˆ—è¡¨:');
              processedApplications.forEach((app, index) => {
                console.log(`${index + 1}. éƒ¨é–€: ${app.department}, è·å‹™: ${app.jobTitle}, æ‡‰å¾µæ•¸: ${app.totalApplications}, ç€è¦½æ•¸: ${app.totalViews}, å¤©æ•¸: ${app.totalDays}`);
              });
              
              // æª¢æŸ¥æ˜¯å¦æœ‰ç´¯è¨ˆåˆŠç™»å¤©æ•¸
              const hasValidDays = processedApplications.some(app => app.totalDays > 0);
              let alertMsg = `æˆåŠŸåŒ¯å…¥ ${processedApplications.length} ç­†æ‡‰å¾µæ•¸æ“š`;
              if (!hasValidDays) {
                alertMsg += '\n\nâš ï¸ è­¦å‘Š: æœªåµæ¸¬åˆ°ã€Œç´¯è¨ˆåˆŠç™»å¤©æ•¸ã€æ¬„ä½ï¼Œå¹³å‡æ‡‰å¾µæ•¸å°‡é¡¯ç¤ºç‚º 0.0\nè«‹ç¢ºèª Excel åŒ…å«æ­¤æ¬„ä½';
              }
              alertMsg += '\n\nğŸ’¡ æç¤º: è«‹é–‹å•Ÿç€è¦½å™¨ Console (F12) æŸ¥çœ‹è©³ç´°åŒ¹é…è³‡è¨Š';
              alert(alertMsg);
            } catch (error) {
              console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
              alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªExcelæ ¼å¼æ­£ç¢º');
            }
          };
          reader.readAsArrayBuffer(file);
          e.target.value = '';
        };

        // è¼‰å…¥æ‡‰å¾µè³‡æ–™
        useEffect(() => {
          const savedApplications = localStorage.getItem('jobApplications');
          if (savedApplications) {
            try {
              setApplications(JSON.parse(savedApplications));
            } catch (error) {
              console.error('è¼‰å…¥æ‡‰å¾µè³‡æ–™å¤±æ•—:', error);
            }
          }
        }, []);

        // è¨ˆç®—æ¯å€‹è·ç¼ºçš„çµ±è¨ˆæ•¸æ“š
        const jobStats = useMemo(() => {
          const statsMap = new Map();
          
          jobs.forEach(job => {
            const key = job.jobId;
            if (!statsMap.has(key)) {
              statsMap.set(key, {
                jobId: job.jobId,
                department: job.department,
                position: job.position,
                job104Title: job.job104Title || job.position,  // 104è·ç¨±
                location: job.location,
                status: job.status,
                jobFamily: job.jobFamily,
                recruitmentOwner: job.recruitmentOwner || '',
                year: getJobYear(job),
                totalApplications: 0,
                totalViews: 0,
                totalDays: 0,
                lastOpenDate: ''
              });
            }
          });

          // é™¤éŒ¯ï¼šé¡¯ç¤ºæ‰€æœ‰è·ç¼ºçš„ 104è·ç¨±
          console.log('=== Job Master è·ç¼ºåˆ—è¡¨ (ç”¨æ–¼åŒ¹é…) ===');
          statsMap.forEach((stat, key) => {
            console.log(`è·ç¼ºä»£ç¢¼: ${stat.jobId}, éƒ¨é–€: ${stat.department}, 104è·ç¨±: ${stat.job104Title}, åŸè·å‹™: ${stat.position}`);
          });

          // åŒ¹é…æ‡‰å¾µæ•¸æ“šåˆ°è·ç¼º
          const unmatchedApps = [];
          applications.forEach(app => {
            // åªç”¨ 104è·ç¨± åŒ¹é…ï¼Œä¸æ¯”å°éƒ¨é–€
            let matchCount = 0;
            
            for (const [key, stat] of statsMap) {
              const job104Title = stat.job104Title || stat.position;  // å–å¾—104è·ç¨±ï¼Œè‹¥ç„¡å‰‡ç”¨è·å‹™åç¨±
              const appJobTitle = app.jobTitle || '';
              
              // åªä½¿ç”¨ 104è·ç¨± é€²è¡Œç²¾ç¢ºåŒ¹é… (å®Œå…¨ç›¸åŒ)
              const titleMatch = job104Title && appJobTitle && 
                (job104Title === appJobTitle);
              
              if (titleMatch) {
                stat.totalApplications += app.totalApplications || 0;
                stat.totalViews += app.totalViews || 0;
                stat.totalDays += app.totalDays || 0;
                if (app.lastOpenDate && (!stat.lastOpenDate || app.lastOpenDate > stat.lastOpenDate)) {
                  stat.lastOpenDate = app.lastOpenDate;
                }
                matchCount++;
                console.log(`âœ… åŒ¹é…æˆåŠŸ: Excelã€Œ${app.jobTitle}ã€â†’ Job Masterã€Œ${stat.job104Title}ã€(${stat.jobId})`);
                // ä¸ä½¿ç”¨ breakï¼Œè®“ä¸€ç­† Excel è³‡æ–™å¯ä»¥åŒ¹é…åˆ°å¤šå€‹è·ç¼º
              }
            }
            
            if (matchCount === 0) {
              unmatchedApps.push(app);
            } else if (matchCount > 1) {
              console.log(`â„¹ï¸ Excelã€Œ${app.jobTitle}ã€åŒ¹é…åˆ° ${matchCount} å€‹è·ç¼º`);
            }
          });

          // é¡¯ç¤ºæœªåŒ¹é…çš„æ‡‰å¾µè³‡æ–™
          if (unmatchedApps.length > 0) {
            console.warn('=== âš ï¸ æœªåŒ¹é…åˆ°çš„æ‡‰å¾µè³‡æ–™ ===');
            unmatchedApps.forEach(app => {
              console.warn(`âŒ éƒ¨é–€: ${app.department}, è·å‹™: ${app.jobTitle}, æ‡‰å¾µæ•¸: ${app.totalApplications}`);
              console.warn(`   â†’ å¯èƒ½åŸå› : Job Master ä¸­æ²’æœ‰å°æ‡‰çš„ã€Œ104è·ç¨±ã€`);
              console.warn(`   â†’ è§£æ±ºæ–¹æ³•: è«‹åœ¨ Job Master çš„ã€Œæ‹›å‹Ÿç¢ºèªã€ä¸­å¡«å¯«ã€Œ104è·ç¨±ã€ç‚ºã€Œ${app.jobTitle}ã€`);
            });
          }

          // è¨ˆç®—è¡ç”Ÿæ¬„ä½
          return Array.from(statsMap.values()).map(stat => {
            const avgApplications = stat.totalDays > 0 
              ? (stat.totalApplications / stat.totalDays).toFixed(1)
              : '0.0';
            const applicationRate = stat.totalViews > 0 
              ? ((stat.totalApplications / stat.totalViews) * 100).toFixed(1)
              : '0.0';
            
            return {
              ...stat,
              avgApplications: parseFloat(avgApplications),
              applicationRate: parseFloat(applicationRate)
            };
          });
        }, [jobs, applications]);

        // Application Master ç¯©é¸é‚è¼¯
        const filteredJobStats = useMemo(() => {
          let filtered = jobStats;

          // å¹´ä»½ç¯©é¸
          if (appFilterYear !== 'å…¨éƒ¨') {
            filtered = filtered.filter(stat => stat.year === appFilterYear);
          }

          // å» å€ç¯©é¸
          if (appFilterLocation !== 'å…¨éƒ¨å» å€') {
            filtered = filtered.filter(stat => {
              const location = stat.location || '';
              if (appFilterLocation === 'BMC+BML') {
                return location.includes('BMC') || location.includes('BML');
              }
              return location.includes(appFilterLocation);
            });
          }

          // è·ç³»ç¯©é¸
          if (appFilterJobFamily !== 'å…¨éƒ¨è·ç³»') {
            filtered = filtered.filter(stat => {
              const bucket = getJobFamilyBucket(stat.jobFamily || '');
              if (appFilterJobFamily === 'IDL') {
                return bucket === 'IDL-å°ˆæ¥­è·' || bucket === 'IDL-ç®¡ç†è·';
              }
              return bucket === appFilterJobFamily;
            });
          }

          // æ‹›å‹Ÿå°ˆå®¶ç¯©é¸
          if (appFilterRecruiter !== 'å…¨éƒ¨') {
            const recruiterKey = normalizeStringValue(appFilterRecruiter);
            filtered = filtered.filter(stat => {
              const statRecruiter = normalizeStringValue(stat.recruitmentOwner || '');
              return statRecruiter === recruiterKey;
            });
          }

          // æœå°‹ç¯©é¸
          if (appSearchTerm) {
            const searchLower = appSearchTerm.toLowerCase();
            filtered = filtered.filter(stat =>
              (stat.jobId || '').toLowerCase().includes(searchLower) ||
              (stat.department || '').toLowerCase().includes(searchLower) ||
              (stat.position || '').toLowerCase().includes(searchLower)
            );
          }

          // çµ±è¨ˆå¡ç‰‡ç¯©é¸
          if (appActiveStatCard === 'å¾…ç¢ºèª') {
            filtered = filtered.filter(stat => normalizeJobStatus(stat.status) === 'å¾…ç¢ºèª');
          } else if (appActiveStatCard === 'é–‹å•Ÿä¸­') {
            filtered = filtered.filter(stat => normalizeJobStatus(stat.status) === 'é–‹å•Ÿä¸­');
          } else if (appActiveStatCard === 'å·²é—œé–‰') {
            filtered = filtered.filter(stat => normalizeJobStatus(stat.status) === 'å·²é—œé–‰');
          }

          return filtered;
        }, [jobStats, appSearchTerm, appFilterYear, appFilterLocation, appFilterJobFamily, appFilterRecruiter, appActiveStatCard]);

        // Application Master çµ±è¨ˆæ•¸æ“š
        const appStats = useMemo(() => {
          // å¡ç‰‡æ•¸å­—åŸºæ–¼ä¸Šæ–¹ç¯©é¸(ä½†ä¸å«ç‹€æ…‹ç¯©é¸)çš„æ•¸æ“š
          const baseStats = jobStats.filter(stat => {
            let filtered = [stat];
            
            // å¹´ä»½ç¯©é¸
            if (appFilterYear !== 'å…¨éƒ¨') {
              filtered = filtered.filter(s => s.year === appFilterYear);
            }
            
            // å» å€ç¯©é¸
            if (appFilterLocation !== 'å…¨éƒ¨å» å€') {
              filtered = filtered.filter(s => {
                const location = s.location || '';
                if (appFilterLocation === 'BMC+BML') {
                  return location.includes('BMC') || location.includes('BML');
                }
                return location.includes(appFilterLocation);
              });
            }
            
            // è·ç³»ç¯©é¸
            if (appFilterJobFamily !== 'å…¨éƒ¨è·ç³»') {
              filtered = filtered.filter(s => {
                const bucket = getJobFamilyBucket(s.jobFamily || '');
                if (appFilterJobFamily === 'IDL') {
                  return bucket === 'IDL-å°ˆæ¥­è·' || bucket === 'IDL-ç®¡ç†è·';
                }
                return bucket === appFilterJobFamily;
              });
            }
            
            // æ‹›å‹Ÿå°ˆå®¶ç¯©é¸
            if (appFilterRecruiter !== 'å…¨éƒ¨') {
              const recruiterKey = normalizeStringValue(appFilterRecruiter);
              filtered = filtered.filter(s => {
                const statRecruiter = normalizeStringValue(s.recruitmentOwner || '');
                return statRecruiter === recruiterKey;
              });
            }
            
            // æœå°‹ç¯©é¸
            if (appSearchTerm) {
              const searchLower = appSearchTerm.toLowerCase();
              filtered = filtered.filter(s =>
                (s.jobId || '').toLowerCase().includes(searchLower) ||
                (s.department || '').toLowerCase().includes(searchLower) ||
                (s.position || '').toLowerCase().includes(searchLower)
              );
            }
            
            return filtered.length > 0;
          });
          
          // è¨ˆç®—å„ç‹€æ…‹çš„è·ç¼ºæ•¸(åŸºæ–¼ä¸Šæ–¹ç¯©é¸,ä¸å«ç‹€æ…‹ç¯©é¸)
          const pendingCount = baseStats.filter(stat => normalizeJobStatus(stat.status) === 'å¾…ç¢ºèª').length;
          const openCount = baseStats.filter(stat => normalizeJobStatus(stat.status) === 'é–‹å•Ÿä¸­').length;
          const closedCount = baseStats.filter(stat => normalizeJobStatus(stat.status) === 'å·²é—œé–‰').length;
          
          // å¹³å‡æ‡‰å¾µæ•¸å’Œç€è¦½æ‡‰å¾µç‡åŸºæ–¼æœ€çµ‚ç¯©é¸çµæœ(å«ç‹€æ…‹ç¯©é¸)
          const totalApplications = filteredJobStats.reduce((sum, stat) => sum + (stat.totalApplications || 0), 0);
          const totalViews = filteredJobStats.reduce((sum, stat) => sum + (stat.totalViews || 0), 0);
          const totalDays = filteredJobStats.reduce((sum, stat) => sum + (stat.totalDays || 0), 0);
          
          const avgApplications = totalDays > 0 
            ? (totalApplications / totalDays).toFixed(1)
            : '0.0';
          
          const applicationRate = totalViews > 0 
            ? ((totalApplications / totalViews) * 100).toFixed(1)
            : '0.0';
          
          return {
            pending: pendingCount,
            open: openCount,
            closed: closedCount,
            avgApplications: parseFloat(avgApplications),
            applicationRate: parseFloat(applicationRate)
          };
        }, [jobStats, filteredJobStats, appFilterYear, appFilterLocation, appFilterJobFamily, appFilterRecruiter, appSearchTerm]);

        const handleAppStatCardClick = (cardType) => {
          setAppActiveStatCard(cardType);
        };

        const handleAppSort = (field) => {
          if (appSortField === field) {
            // åŒä¸€æ¬„ä½,åˆ‡æ›æ’åºæ–¹å‘
            setAppSortDirection(appSortDirection === 'asc' ? 'desc' : 'asc');
          } else {
            // æ–°æ¬„ä½,é è¨­å¾å°åˆ°å¤§
            setAppSortField(field);
            setAppSortDirection('asc');
          }
        };

        // æ’åºå¾Œçš„è³‡æ–™
        const sortedJobStats = useMemo(() => {
          if (!appSortField) return filteredJobStats;

          return [...filteredJobStats].sort((a, b) => {
            let aValue = 0;
            let bValue = 0;

            switch (appSortField) {
              case 'totalApplications':
                aValue = a.totalApplications || 0;
                bValue = b.totalApplications || 0;
                break;
              case 'totalViews':
                aValue = a.totalViews || 0;
                bValue = b.totalViews || 0;
                break;
              case 'avgApplications':
                aValue = a.avgApplications || 0;
                bValue = b.avgApplications || 0;
                break;
              case 'applicationRate':
                aValue = a.applicationRate || 0;
                bValue = b.applicationRate || 0;
                break;
              default:
                return 0;
            }

            if (appSortDirection === 'asc') {
              return aValue - bValue;
            } else {
              return bValue - aValue;
            }
          });
        }, [filteredJobStats, appSortField, appSortDirection]);

        const filteredHeadcount = baseFilteredJobs.reduce(
          (sum, job) => sum + (Number(job.headcount) || 0),
          0
        );
        const statusStats = useMemo(() => {
          return baseFilteredJobs.reduce(
            (acc, job) => {
              const status = normalizeJobStatus(job.status);
              if (status === 'ç”³è«‹ä¸­') acc.applying += 1;
              else if (status === 'æ‹›å‹Ÿç¢ºèª') acc.confirming += 1;
              else if (status === 'é–‹å•Ÿä¸­') acc.open += 1;
              else if (status === 'å·²é—œé–‰') acc.closed += 1;
              else acc.confirming += 1; // é è¨­æ­¸é¡åˆ°æ‹›å‹Ÿç¢ºèª
              return acc;
            },
            { applying: 0, confirming: 0, open: 0, closed: 0 }
          );
        }, [baseFilteredJobs]);

        const menuItems = [
          { id: 'job-master', name: 'Job Master', icon: BriefcaseIcon, description: 'è·ç¼ºç®¡ç†' },
          { id: 'application-master', name: 'Application Master', icon: FileTextIcon, description: 'æ‡‰å¾µæ•¸æ“šç®¡ç†' },
          { id: 'recruitment-master', name: 'Recruitment Master', icon: ClipboardListIcon, description: 'æ‹›å‹Ÿæµç¨‹ç®¡ç†' },
          { id: 'interview-master', name: 'Interview Master', icon: CalendarCheckIcon, description: 'é¢è©¦ç®¡ç†' },
          { id: 'candidates', name: 'Candidates', icon: UsersIcon, description: 'å€™é¸äººç®¡ç†' },
          { id: 'reports', name: 'Reports', icon: BarChartIcon, description: 'å ±è¡¨åˆ†æ' },
          { id: 'settings', name: 'Settings', icon: SettingsIcon, description: 'ç³»çµ±è¨­å®š' }
        ];

        return (
          <>
            <div className="flex min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
              {/* å´æ¬„ */}
              <aside className={`${sidebarCollapsed ? 'w-20' : 'w-64'} bg-white shadow-xl flex-shrink-0 flex flex-col transition-all duration-300`}>
                <div className={`${sidebarCollapsed ? 'p-4' : 'p-6'} border-b border-gray-200 flex items-center justify-between`}>
                  {!sidebarCollapsed && (
                    <div>
                      <h1 className="text-2xl font-bold text-indigo-900">BMC ATS</h1>
                      <p className="text-xs text-gray-500 mt-1">æ‹›å‹Ÿç®¡ç†ç³»çµ±</p>
                    </div>
                  )}
                  <button
                    onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                    className="p-2 rounded-lg hover:bg-indigo-50 text-gray-600 hover:text-indigo-600 transition-colors"
                    title={sidebarCollapsed ? 'å±•é–‹å´æ¬„' : 'æŠ˜ç–Šå´æ¬„'}
                  >
                    {sidebarCollapsed ? <ChevronRightIcon size={20} /> : <ChevronLeftIcon size={20} />}
                  </button>
                </div>
                <nav className="p-4 flex-1">
                  {menuItems.map((item) => {
                    const Icon = item.icon;
                    const isActive = currentPage === item.id;
                    return (
                      <button
                        key={item.id}
                        onClick={() => setCurrentPage(item.id)}
                        className={`w-full flex items-center ${sidebarCollapsed ? 'justify-center' : 'gap-3'} px-4 py-3 rounded-lg mb-2 transition-all ${
                          isActive
                            ? 'bg-indigo-600 text-white shadow-md'
                            : 'text-gray-700 hover:bg-indigo-50 hover:text-indigo-600'
                        }`}
                        title={sidebarCollapsed ? item.name : ''}
                      >
                        <Icon size={20} />
                        {!sidebarCollapsed && (
                          <div className="text-left flex-1">
                            <p className="font-semibold text-sm">{item.name}</p>
                            <p className={`text-xs ${isActive ? 'text-indigo-100' : 'text-gray-500'}`}>
                              {item.description}
                            </p>
                          </div>
                        )}
                      </button>
                    );
                  })}
                </nav>
                {!sidebarCollapsed && (
                  <div className="p-4 border-t border-gray-200 bg-gray-50">
                    <p className="text-xs text-gray-500">æœ€å¾Œæ›´æ–°</p>
                    <p className="text-sm font-semibold text-gray-700">{new Date().toLocaleString('zh-TW')}</p>
                  </div>
                )}
              </aside>

              {/* ä¸»è¦å…§å®¹å€ */}
              <div className="flex-1 flex flex-col min-h-screen">
                {/* Job Master é é¢å…§å®¹ */}
                {currentPage === 'job-master' && (
            <div className="flex-1 px-6 py-8">
              <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                <div className="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-sm text-blue-800">
                    ğŸ’¡ <strong>æ™ºæ…§åŒ¯å…¥:</strong> ä¸Šå‚³ Excel æ™‚,ç³»çµ±æœƒè‡ªå‹•ä¿è­·å·²å¡«å¯«çš„æ‹›å‹Ÿç¢ºèªè³‡æ–™(è·ç¼ºç‹€æ…‹ã€ç¢ºèªé …ç›®ã€104è·ç¨±ã€æ‹›å‹Ÿå°ˆå®¶ç­‰),ä¸æœƒè¢«è¦†è“‹
                  </p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                  <label className="flex items-center justify-center gap-2 px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 cursor-pointer transition-colors">
                    <UploadIcon size={20} />
                    <span className="font-medium">ä¸Šå‚³ Excel</span>
                    <input type="file" accept=".xlsx,.xls" onChange={handleFileUpload} className="hidden" />
                  </label>

                  <button
                    onClick={() => setShowAddModal(true)}
                    className="flex items-center justify-center gap-2 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <PlusIcon size={20} />
                    <span className="font-medium">æ–°å¢è·ç¼º</span>
                  </button>

                  <button
                    onClick={handleExport}
                    className="flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                    disabled={filteredJobs.length === 0}
                  >
                    <DownloadIcon size={20} />
                    <span className="font-medium">åŒ¯å‡º Excel</span>
                  </button>

                  <button
                    onClick={loadData}
                    className="flex items-center justify-center gap-2 px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                  >
                    <RefreshIcon size={20} />
                    <span className="font-medium">é‡æ–°è¼‰å…¥</span>
                  </button>

                  <button
                    onClick={handleClearData}
                    className="flex items-center justify-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                  >
                    <TrashIcon size={20} />
                    <span className="font-medium">æ¸…ç©ºè³‡æ–™</span>
                  </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mt-4">
                  <div className="relative">
                    <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                    <input
                      type="text"
                      placeholder="æœå°‹è·ç¼ºä»£ç¢¼ã€éƒ¨é–€ã€è·ä½ã€è·ç³»..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>

                  <select
                    value={filterYear}
                    onChange={(e) => setFilterYear(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                    {years.map((year) => (
                      <option key={year} value={year}>
                        {year === 'å…¨éƒ¨' ? 'å…¨éƒ¨å¹´ä»½' : year}
                      </option>
                    ))}
                  </select>

                  <select
                    value={filterLocation}
                    onChange={(e) => setFilterLocation(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                    {locationOptions.map((location) => (
                      <option key={location} value={location}>
                        {location}
                      </option>
                    ))}
                  </select>

                  <select
                    value={filterJobFamily}
                    onChange={(e) => setFilterJobFamily(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                    {jobFamilyOptions.map((family) => (
                      <option key={family} value={family}>
                        {family}
                      </option>
                    ))}
                  </select>

                  <select
                    value={filterRecruiter}
                    onChange={(e) => setFilterRecruiter(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                    {['å…¨éƒ¨', ...recruiterOptions].map((recruiter) => (
                      <option key={recruiter} value={recruiter}>
                        {recruiter === 'å…¨éƒ¨' ? 'å…¨éƒ¨æ‹›å‹Ÿå°ˆå®¶' : recruiter}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                <StatCard
                  title="ç¸½è·ç¼ºæ•¸"
                  value={baseFilteredJobs.length}
                  color="bg-blue-500"
                  active={activeStatCard === 'total'}
                  onClick={() => handleStatCardClick('total')}
                />
                <StatCard
                  title="éœ€æ±‚äººæ•¸"
                  value={filteredHeadcount}
                  color="bg-purple-500"
                  active={activeStatCard === 'headcount'}
                  onClick={() => handleStatCardClick('headcount')}
                />
                <StatCard
                  title="ç”³è«‹ä¸­"
                  value={statusStats.applying}
                  color="bg-orange-500"
                  active={activeStatCard === 'ç”³è«‹ä¸­'}
                  onClick={() => handleStatCardClick('ç”³è«‹ä¸­')}
                />
                <StatCard
                  title="æ‹›å‹Ÿç¢ºèª"
                  value={statusStats.confirming}
                  color="bg-yellow-500"
                  active={activeStatCard === 'æ‹›å‹Ÿç¢ºèª'}
                  onClick={() => handleStatCardClick('æ‹›å‹Ÿç¢ºèª')}
                />
                <StatCard
                  title="é–‹å•Ÿä¸­"
                  value={statusStats.open}
                  color="bg-green-500"
                  active={activeStatCard === 'é–‹å•Ÿä¸­'}
                  onClick={() => handleStatCardClick('é–‹å•Ÿä¸­')}
                />
                <StatCard
                  title="å·²é—œé–‰"
                  value={statusStats.closed}
                  color="bg-gray-500"
                  active={activeStatCard === 'å·²é—œé–‰'}
                  onClick={() => handleStatCardClick('å·²é—œé–‰')}
                />
              </div>

              <div className="bg-white rounded-lg shadow-md overflow-hidden">
                <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-indigo-600 text-white">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-semibold">è·ç¼ºä»£ç¢¼</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">éƒ¨é–€</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">è·å‹™åç¨±</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">å» å€</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">è·ç³»</th>
                  <th className="px-4 py-3 text-center text-sm font-semibold">éœ€æ±‚äººæ•¸</th>
                  <th className="px-4 py-3 text-center text-sm font-semibold bg-green-700">å ±åˆ°äººæ•¸</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">æ‹›å‹Ÿå°ˆå®¶</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold">ç‹€æ…‹</th>
                  <th className="px-4 py-3 text-center text-sm font-semibold">æ“ä½œ</th>
                </tr>
              </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredJobs.length === 0 ? (
                        <tr>
                          <td colSpan="9" className="px-6 py-12 text-center text-gray-500">
                            <div className="flex flex-col items-center gap-3">
                              <UploadIcon size={48} className="text-gray-300" />
                              <p className="text-lg font-medium">å°šç„¡è·ç¼ºè³‡æ–™</p>
                              <p className="text-sm">è«‹ä¸Šå‚³ Excel æª”æ¡ˆæˆ–æ–°å¢è·ç¼º</p>
                            </div>
                          </td>
                        </tr>
                      ) : (
                        filteredJobs.map((job, idx) => (
                          <tr
                            key={job.id ?? job.jobId ?? `${job.formNumber || 'job'}-${idx}`}
                            className="hover:bg-gray-50 transition-colors"
                          >
                            <td className="px-4 py-4 text-sm font-medium text-indigo-600">
                              <button
                                onClick={() => setDetailJob(job)}
                                className="hover:underline text-left"
                                title="æª¢è¦–è·ç¼ºè©³æƒ…"
                              >
                                {job.jobId}
                              </button>
                            </td>
                            <td className="px-4 py-4 text-sm text-gray-700">{job.department}</td>
                            <td className="px-4 py-4 text-sm text-gray-700 font-medium">{job.position}</td>
                            <td className="px-4 py-4 text-sm text-gray-600">{getLocationShortCode(job.location)}</td>
                            <td className="px-4 py-4 text-sm text-gray-600">
                              {job.jobFamily ? (
                                <span className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-medium">{job.jobFamily}</span>
                              ) : (
                                '-'
                              )}
                            </td>
                            <td className="px-4 py-4 text-center">
                              <span className="inline-flex items-center justify-center w-8 h-8 bg-indigo-100 text-indigo-700 rounded-full font-semibold text-sm">
                                {job.originalHeadcount || job.headcount}
                              </span>
                            </td>
                            <td className="px-4 py-4 text-center">
                              <span 
                                className="inline-flex items-center justify-center w-8 h-8 bg-green-100 text-green-700 rounded-full font-semibold text-sm cursor-pointer hover:bg-green-200 transition-colors"
                                title="é»æ“ŠæŸ¥çœ‹å ±åˆ°è©³æƒ…"
                                onClick={() => {
                                  const formNumber = String(job.formNumber || '').trim();
                                  console.log(`\n=== è¡¨å–®è™Ÿ ${formNumber} å ±åˆ°äººæ•¸è©³æƒ… ===`);
                                  console.log(`è·å‹™: ${job.position}`);
                                  console.log(`éƒ¨é–€: ${job.department}`);
                                  
                                  // æ‰¾å‡ºæ‰€æœ‰ç›¸åŒè¡¨å–®è™Ÿçš„è·ç¼º
                                  const sameFormJobs = jobs.filter(j => String(j.formNumber || '').trim() === formNumber);
                                  console.log(`\næ‰¾åˆ° ${sameFormJobs.length} ç­†ç›¸åŒè¡¨å–®è™Ÿçš„è·ç¼º:`);
                                  
                                  sameFormJobs.forEach((j, index) => {
                                    const offerStatus = String(j.offerFormStatus || '').trim();
                                    console.log(`\n${index + 1}. è·ç¼ºä»£ç¢¼: ${j.jobId}`);
                                    console.log(`   è·å‹™: ${j.position}`);
                                    console.log(`   æ ¸è–ªå–®è¡¨å–®è™Ÿ: "${j.offerFormNumber || '(ç©ºç™½)'}"`);
                                    console.log(`   æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹: "${offerStatus || '(ç©ºç™½)'}"`);
                                    console.log(`   æ˜¯å¦ç‚º"å·²è™•ç†": ${offerStatus === 'å·²è™•ç†' ? 'âœ… æ˜¯' : 'âŒ å¦'}`);
                                    
                                    if (offerStatus && offerStatus !== 'å·²è™•ç†') {
                                      console.log(`   âš ï¸ ç‹€æ…‹ä¸ç¬¦: éœ€è¦"å·²è™•ç†"ï¼Œå¯¦éš›ç‚º"${offerStatus}"`);
                                    }
                                    if (!offerStatus) {
                                      console.log(`   âš ï¸ æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ç‚ºç©ºç™½`);
                                    }
                                  });
                                  
                                  const count = sameFormJobs.filter(j => String(j.offerFormStatus || '').trim() === 'å·²è™•ç†').length;
                                  console.log(`\nğŸ“Š å ±åˆ°äººæ•¸: ${count} (ç‹€æ…‹ç‚º"å·²è™•ç†"çš„ç­†æ•¸)`);
                                  
                                  if (count === 0 && sameFormJobs.length > 0) {
                                    console.warn('\nâŒ å ±åˆ°äººæ•¸ç‚º 0 çš„å¯èƒ½åŸå› :');
                                    console.warn('1. æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ä¸æ˜¯"å·²è™•ç†"');
                                    console.warn('2. æ ¸è–ªå–®è¡¨å–®ç‹€æ…‹æ¬„ä½ç‚ºç©ºç™½');
                                    console.warn('3. ç‹€æ…‹æ–‡å­—æœ‰å¤šé¤˜ç©ºæ ¼æˆ–ä¸åŒå­—å…ƒ');
                                    console.warn('\nğŸ’¡ è§£æ±ºæ–¹æ³•: è«‹åœ¨ Excel ä¸­å°‡ã€Œæ ¸è–ªå–®è¡¨å–®ç‹€æ…‹ã€æ¬„ä½æ”¹ç‚º"å·²è™•ç†"');
                                  }
                                }}
                              >
                                {calculateOnboardCount(job.formNumber, jobs)}
                              </span>
                            </td>
                            <td className="px-4 py-4 text-sm text-gray-700">{job.recruitmentOwner || '-'}</td>
                            <td className="px-4 py-4">
                              {(() => {
                                const status = normalizeJobStatus(job.status);
                                const statusClass =
                                  status === 'é–‹å•Ÿä¸­'
                                    ? 'bg-green-100 text-green-800'
                                    : status === 'å·²é—œé–‰'
                                    ? 'bg-gray-200 text-gray-800'
                                    : 'bg-yellow-100 text-yellow-800';
                                return (
                                  <span className={`px-3 py-1 rounded-full text-xs font-semibold ${statusClass}`}>
                                    {status}
                                  </span>
                                );
                              })()}

                            </td>
                            <td className="px-4 py-4">
                              <div className="flex items-center justify-center gap-2">
                          <button
                            onClick={() => setEditingJob(job)}
                            className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="ç·¨è¼¯"
                          >
                            <EditIcon size={16} />
                          </button>
                          <button
                            onClick={() => setJobToDelete(job)}
                            className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="åˆªé™¤"
                          >
                            <TrashIcon size={16} />
                          </button>
                              </div>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {filteredJobs.length > 0 && (
                <div className="mt-4 text-sm text-gray-600 text-center">
                  é¡¯ç¤º {filteredJobs.length} ç­†è·ç¼ºï¼Œå…±éœ€{' '}
                  {filteredJobs.reduce((sum, job) => sum + (Number(job.headcount) || 0), 0)} äºº
                </div>
              )}
            </div>
                )}

                {/* Application Master é é¢ */}
                {currentPage === 'application-master' && (
                  <div className="flex-1 px-6 py-8">
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                      <h2 className="text-2xl font-bold text-gray-800 mb-4">æ‡‰å¾µæ•¸æ“šç®¡ç†</h2>
                      
                      {/* ä¸Šå‚³æŒ‰éˆ• */}
                      <div className="mb-6">
                        <label className="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 cursor-pointer transition-colors">
                          <UploadIcon size={20} />
                          <span className="font-medium">ä¸Šå‚³ 104 æ‡‰å¾µæ•¸æ“š</span>
                          <input type="file" accept=".xlsx,.xls" onChange={handleApplicationUpload} className="hidden" />
                        </label>
                      </div>

                      {/* æœå°‹èˆ‡ç¯©é¸ */}
                      <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div className="relative">
                          <SearchIcon size={20} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                          <input
                            type="text"
                            placeholder="æœå°‹è·ç¼ºä»£ç¢¼ã€éƒ¨é–€ã€è·å‹™..."
                            value={appSearchTerm}
                            onChange={(e) => setAppSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                          />
                        </div>

                        <select
                          value={appFilterYear}
                          onChange={(e) => setAppFilterYear(e.target.value)}
                          className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        >
                          <option value="å…¨éƒ¨">å…¨éƒ¨å¹´ä»½</option>
                          {Array.from(new Set(jobs.map(j => getJobYear(j)).filter(Boolean)))
                            .sort((a, b) => b.localeCompare(a))
                            .map(year => (
                              <option key={year} value={year}>{year}</option>
                            ))}
                        </select>

                        <select
                          value={appFilterLocation}
                          onChange={(e) => setAppFilterLocation(e.target.value)}
                          className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        >
                          {locationOptions.map(option => (
                            <option key={option} value={option}>{option}</option>
                          ))}
                        </select>

                        <select
                          value={appFilterJobFamily}
                          onChange={(e) => setAppFilterJobFamily(e.target.value)}
                          className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        >
                          {jobFamilyFilters.map(option => (
                            <option key={option} value={option}>{option}</option>
                          ))}
                        </select>

                        <select
                          value={appFilterRecruiter}
                          onChange={(e) => setAppFilterRecruiter(e.target.value)}
                          className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        >
                          <option value="å…¨éƒ¨">å…¨éƒ¨æ‹›å‹Ÿå°ˆå®¶</option>
                          {recruiterOptions.map(option => (
                            <option key={option} value={option}>{option}</option>
                          ))}
                        </select>
                      </div>
                    </div>

                    {/* çµ±è¨ˆå¡ç‰‡ */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                      <StatCard
                        title="å¾…ç¢ºèª"
                        value={appStats.pending}
                        color="bg-yellow-500"
                        active={appActiveStatCard === 'å¾…ç¢ºèª'}
                        onClick={() => handleAppStatCardClick('å¾…ç¢ºèª')}
                      />
                      <StatCard
                        title="é–‹å•Ÿä¸­"
                        value={appStats.open}
                        color="bg-green-500"
                        active={appActiveStatCard === 'é–‹å•Ÿä¸­'}
                        onClick={() => handleAppStatCardClick('é–‹å•Ÿä¸­')}
                      />
                      <StatCard
                        title="å·²é—œé–‰"
                        value={appStats.closed}
                        color="bg-gray-500"
                        active={appActiveStatCard === 'å·²é—œé–‰'}
                        onClick={() => handleAppStatCardClick('å·²é—œé–‰')}
                      />
                      <StatCard
                        title="å¹³å‡æ‡‰å¾µæ•¸"
                        value={appStats.avgApplications}
                        color="bg-orange-500"
                        active={false}
                      />
                      <StatCard
                        title="ç€è¦½æ‡‰å¾µç‡"
                        value={`${appStats.applicationRate}%`}
                        color="bg-purple-500"
                        active={false}
                      />
                    </div>

                    <div className="bg-white rounded-lg shadow-md overflow-hidden">
                      <div className="overflow-x-auto">
                        <table className="w-full">
                          <thead className="bg-indigo-600 text-white">
                            <tr>
                              <th className="px-4 py-3 text-left text-sm font-semibold">è·ç¼ºä»£ç¢¼</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">éƒ¨é–€</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold bg-indigo-700">104è·ç¨±</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">æœ€è¿‘é–‹å•Ÿæ—¥</th>
                              <th className="px-4 py-3 text-center text-sm font-semibold">è·å‹™ç‹€æ…‹</th>
                              <th 
                                className="px-4 py-3 text-center text-sm font-semibold bg-blue-700 cursor-pointer hover:bg-blue-800 transition-colors"
                                onClick={() => handleAppSort('totalApplications')}
                              >
                                ç´¯è¨ˆæ‡‰å¾µæ•¸
                              </th>
                              <th 
                                className="px-4 py-3 text-center text-sm font-semibold bg-green-700 cursor-pointer hover:bg-green-800 transition-colors"
                                onClick={() => handleAppSort('totalViews')}
                              >
                                ç´¯è¨ˆç€è¦½æ•¸
                              </th>
                              <th 
                                className="px-4 py-3 text-center text-sm font-semibold bg-orange-700 cursor-pointer hover:bg-orange-800 transition-colors"
                                onClick={() => handleAppSort('avgApplications')}
                              >
                                å¹³å‡æ‡‰å¾µæ•¸
                              </th>
                              <th 
                                className="px-4 py-3 text-center text-sm font-semibold bg-purple-700 cursor-pointer hover:bg-purple-800 transition-colors"
                                onClick={() => handleAppSort('applicationRate')}
                              >
                                ç€è¦½æ‡‰å¾µç‡
                              </th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {sortedJobStats.length === 0 ? (
                              <tr>
                                <td colSpan="9" className="px-6 py-12 text-center text-gray-500">
                                  <div className="flex flex-col items-center gap-3">
                                    <FileTextIcon size={48} className="text-gray-300" />
                                    <p className="text-lg font-medium">
                                      {jobStats.length === 0 ? 'å°šç„¡æ‡‰å¾µæ•¸æ“š' : 'ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™'}
                                    </p>
                                    <p className="text-sm">
                                      {jobStats.length === 0 ? 'è«‹å…ˆä¸Šå‚³ 104 æ‡‰å¾µæ•¸æ“š Excel æª”æ¡ˆ' : 'è«‹èª¿æ•´ç¯©é¸æ¢ä»¶'}
                                    </p>
                                  </div>
                                </td>
                              </tr>
                            ) : (
                              sortedJobStats.map((stat, idx) => (
                                <tr key={idx} className="hover:bg-gray-50 transition-colors">
                                  <td className="px-4 py-3">
                                    <span className="font-mono text-sm font-medium text-indigo-600">{stat.jobId}</span>
                                  </td>
                                  <td className="px-4 py-3">
                                    <span className="text-sm text-gray-700">{stat.department}</span>
                                  </td>
                                  <td className="px-4 py-3">
                                    <span className="text-sm text-indigo-700 font-medium">{stat.job104Title || '-'}</span>
                                  </td>
                                  <td className="px-4 py-3">
                                    <span className="text-sm text-gray-600">{stat.lastOpenDate || '-'}</span>
                                  </td>
                                  <td className="px-4 py-3 text-center">
                                    <span className={`inline-block px-3 py-1 rounded-full text-xs font-medium ${
                                      normalizeJobStatus(stat.status) === 'é–‹å•Ÿä¸­' ? 'bg-green-100 text-green-800' :
                                      normalizeJobStatus(stat.status) === 'å·²é—œé–‰' ? 'bg-gray-100 text-gray-800' :
                                      'bg-yellow-100 text-yellow-800'
                                    }`}>
                                      {normalizeJobStatus(stat.status)}
                                    </span>
                                  </td>
                                  <td className="px-4 py-3 text-center">
                                    <span className="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-bold">
                                      {stat.totalApplications || 0}
                                    </span>
                                  </td>
                                  <td className="px-4 py-3 text-center">
                                    <span className="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-bold">
                                      {stat.totalViews || 0}
                                    </span>
                                  </td>
                                  <td className="px-4 py-3 text-center">
                                    <span className="inline-block px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-bold">
                                      {stat.avgApplications || '0.0'}
                                    </span>
                                  </td>
                                  <td className="px-4 py-3 text-center">
                                    <span className="inline-block px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-bold">
                                      {stat.applicationRate || '0.0'}%
                                    </span>
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* çµ±è¨ˆæ‘˜è¦ */}
                    {filteredJobStats.length > 0 && (
                      <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                          <p className="text-sm text-gray-600 mb-1">ç¸½æ‡‰å¾µæ•¸</p>
                          <p className="text-3xl font-bold text-blue-600">
                            {filteredJobStats.reduce((sum, stat) => sum + (stat.totalApplications || 0), 0)}
                          </p>
                        </div>
                        <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                          <p className="text-sm text-gray-600 mb-1">ç¸½ç€è¦½æ•¸</p>
                          <p className="text-3xl font-bold text-green-600">
                            {filteredJobStats.reduce((sum, stat) => sum + (stat.totalViews || 0), 0)}
                          </p>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Recruitment Master é é¢ */}
                {currentPage === 'recruitment-master' && (
                  <div className="flex-1 flex items-center justify-center p-8">
                    <div className="text-center">
                      <ClipboardListIcon size={64} className="mx-auto text-gray-300 mb-4" />
                      <h2 className="text-2xl font-bold text-gray-700 mb-2">æ‹›å‹Ÿæµç¨‹ç®¡ç†</h2>
                      <p className="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                    </div>
                  </div>
                )}

                {/* Interview Master é é¢ */}
                {currentPage === 'interview-master' && (
                  <div className="flex-1 flex items-center justify-center p-8">
                    <div className="text-center">
                      <CalendarCheckIcon size={64} className="mx-auto text-gray-300 mb-4" />
                      <h2 className="text-2xl font-bold text-gray-700 mb-2">é¢è©¦ç®¡ç†</h2>
                      <p className="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                    </div>
                  </div>
                )}

                {/* Candidates é é¢ */}
                {currentPage === 'candidates' && (
                  <div className="flex-1 flex items-center justify-center p-8">
                    <div className="text-center">
                      <UsersIcon size={64} className="mx-auto text-gray-300 mb-4" />
                      <h2 className="text-2xl font-bold text-gray-700 mb-2">å€™é¸äººç®¡ç†</h2>
                      <p className="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                    </div>
                  </div>
                )}

                {/* Reports é é¢ */}
                {currentPage === 'reports' && (
                  <div className="flex-1 flex items-center justify-center p-8">
                    <div className="text-center">
                      <BarChartIcon size={64} className="mx-auto text-gray-300 mb-4" />
                      <h2 className="text-2xl font-bold text-gray-700 mb-2">å ±è¡¨åˆ†æ</h2>
                      <p className="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                    </div>
                  </div>
                )}

                {/* Settings é é¢ */}
                {currentPage === 'settings' && (
                  <div className="flex-1 p-8">
                    <div className="max-w-4xl mx-auto">
                      <h2 className="text-3xl font-bold text-gray-800 mb-6">ç³»çµ±è¨­å®š</h2>
                      
                      {/* è³‡æ–™ç®¡ç†å€å¡Š */}
                      <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 className="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                          <DownloadIcon size={24} className="text-indigo-600" />
                          è³‡æ–™åŒ¯å‡º/åŒ¯å…¥
                        </h3>
                        <p className="text-sm text-gray-600 mb-6">
                          åŒ¯å‡ºæ‰€æœ‰è·ç¼ºè³‡æ–™åŠæ‹›å‹Ÿç¢ºèªè³‡è¨Šï¼Œæˆ–åŒ¯å…¥å…ˆå‰å‚™ä»½çš„è³‡æ–™
                        </p>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {/* åŒ¯å‡ºå®Œæ•´è³‡æ–™ */}
                          <button
                            onClick={handleExportAllData}
                            className="flex items-center justify-center gap-3 px-6 py-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm"
                          >
                            <DownloadIcon size={20} />
                            <div className="text-left">
                              <p className="font-semibold">åŒ¯å‡ºå®Œæ•´è³‡æ–™</p>
                              <p className="text-xs text-indigo-100">åŒ…å«æ‰€æœ‰è·ç¼ºåŠæ‹›å‹Ÿç¢ºèªè³‡è¨Š</p>
                            </div>
                          </button>

                          {/* åŒ¯å…¥å®Œæ•´è³‡æ–™ */}
                          <label className="flex items-center justify-center gap-3 px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-sm cursor-pointer">
                            <UploadIcon size={20} />
                            <div className="text-left">
                              <p className="font-semibold">åŒ¯å…¥å®Œæ•´è³‡æ–™</p>
                              <p className="text-xs text-green-100">å¾å‚™ä»½æª”æ¡ˆé‚„åŸè³‡æ–™</p>
                            </div>
                            <input
                              type="file"
                              accept=".json"
                              onChange={handleImportAllData}
                              className="hidden"
                            />
                          </label>
                        </div>

                        <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                          <p className="text-sm text-yellow-800 flex items-start gap-2">
                            <span className="font-semibold">âš ï¸ æ³¨æ„:</span>
                            <span>åŒ¯å…¥è³‡æ–™å°‡æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è·ç¼ºè³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œå†åŸ·è¡Œã€‚å»ºè­°å…ˆåŒ¯å‡ºç•¶å‰è³‡æ–™ä½œç‚ºå‚™ä»½ã€‚</span>
                          </p>
                        </div>
                      </div>

                      {/* è³‡æ–™çµ±è¨ˆ */}
                      <div className="bg-white rounded-lg shadow-md p-6">
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">è³‡æ–™çµ±è¨ˆ</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="p-4 bg-blue-50 rounded-lg">
                            <p className="text-sm text-gray-600">ç¸½è·ç¼ºæ•¸</p>
                            <p className="text-2xl font-bold text-blue-600">{jobs.length}</p>
                          </div>
                          <div className="p-4 bg-green-50 rounded-lg">
                            <p className="text-sm text-gray-600">å·²ç¢ºèªéœ€æ±‚</p>
                            <p className="text-2xl font-bold text-green-600">
                              {jobs.filter(j => j.confirmedRequirement).length}
                            </p>
                          </div>
                          <div className="p-4 bg-purple-50 rounded-lg">
                            <p className="text-sm text-gray-600">å·²ç¢ºèª104</p>
                            <p className="text-2xl font-bold text-purple-600">
                              {jobs.filter(j => j.confirmed104).length}
                            </p>
                          </div>
                          <div className="p-4 bg-orange-50 rounded-lg">
                            <p className="text-sm text-gray-600">è³‡æ–™å¤§å°</p>
                            <p className="text-2xl font-bold text-orange-600">
                              {(JSON.stringify(jobs).length / 1024).toFixed(1)} KB
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

      {(showAddModal || editingJob) && (
        <JobModal
          job={editingJob}
          onSave={editingJob ? handleEditJob : handleAddJob}
          onClose={() => {
            setShowAddModal(false);
            setEditingJob(null);
          }}
        />
      )}

      {jobToDelete && (
        <DeleteConfirmModal
          job={jobToDelete}
          onConfirm={confirmDeleteJob}
          onClose={() => setJobToDelete(null)}
        />
      )}
      {detailJob && <JobDetailModal job={detailJob} onClose={() => setDetailJob(null)} allJobs={jobs} calculateOnboardCount={calculateOnboardCount} />}
        </>
      );
    }

function StatCard({ title, value, color, active, onClick }) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={`w-full text-left bg-white rounded-lg shadow-md p-6 transition ring-2 ${
        active ? 'ring-indigo-400' : 'ring-transparent hover:ring-indigo-200'
      }`}
    >
      <div className="flex items-center justify-between">
        <div>
          <p className="text-sm text-gray-600 mb-1">{title}</p>
          <p className="text-3xl font-bold text-gray-800">{value}</p>
        </div>
        <div className={`min-w-[60px] h-10 ${color} rounded-lg flex items-center justify-center text-white text-lg font-bold px-3`}>
          {value}
        </div>
      </div>
    </button>
  );
}


function JobModal({ job, onSave, onClose }) {
  const [formData, setFormData] = useState({
    department: job?.department || '',
    formNumber: job?.formNumber || '',
    formStatus: job?.formStatus || 'å¾…ç¢ºèª',
    position: job?.position || '',
    location: job?.location || '',
    jobFamily: job?.jobFamily || 'IDL',
    headcount: job?.headcount || 1,
    recruitmentOwner: job?.recruitmentOwner || job?.approver || '',
    confirmedRequirement: Boolean(job?.confirmedRequirement),
    confirmed104: Boolean(job?.confirmed104),
    job104Title: job?.job104Title || job?.position || '',
    status: normalizeJobStatus(job?.status) || 'æ‹›å‹Ÿç¢ºèª',
    closingDate: job?.closingDate || '',
    closingReason: job?.closingReason || '',
    closingReasonNote: job?.closingReasonNote || '',
    reason: job?.reason || ''
  });

  const handleSubmit = () => {
    if (!formData.department || !formData.position || !formData.formNumber) {
      alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šHCæ‰€å±¬éƒ¨é–€ã€è·å‹™åç¨±èˆ‡äººåŠ›å–®è¡¨å–®è™Ÿ');
      return;
    }
    if (formData.status === 'é–‹å•Ÿä¸­' && (!formData.confirmedRequirement || !formData.confirmed104)) {
      alert('è«‹å…ˆå®Œæˆå…©é …æ‹›å‹Ÿç¢ºèªå†å°‡è·ç¼ºç‹€æ…‹è¨­ç‚ºé–‹å•Ÿä¸­');
      return;
    }
    if (formData.status === 'å·²é—œé–‰') {
      if (!formData.closingDate) {
        alert('è«‹å¡«å¯«é—œé–‰æ—¥æœŸ');
        return;
      }
      if (!formData.closingReason || !formData.closingReason.trim()) {
        alert('è«‹é¸æ“‡é—œé–‰åŸå› ');
        return;
      }
    }
    onSave({
      ...formData,
      confirmedRequirement: Boolean(formData.confirmedRequirement),
      confirmed104: Boolean(formData.confirmed104)
    });
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div className="p-6 space-y-4">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-2xl font-bold text-gray-800">{job ? 'ç·¨è¼¯è·ç¼º' : 'æ–°å¢è·ç¼º'}</h2>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">
              Ã—
            </button>
          </div>

          <div className="border-b pb-4">
            <h3 className="text-lg font-semibold text-gray-700 mb-3">åŸºæœ¬è³‡è¨Š</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  HCæ‰€å±¬éƒ¨é–€ <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={formData.department}
                  onChange={(e) => setFormData({ ...formData, department: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ä¾‹: è³‡è¨Šéƒ¨"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  è·å‹™åç¨± <span className="text-red-500">*</span>
                </label>
                      <input
                        type="text"
                        value={formData.position}
                        onChange={(e) =>
                          setFormData((prev) => {
                            const newPosition = e.target.value;
                            const shouldSync =
                              !prev.job104Title || prev.job104Title === prev.position;
                            return {
                              ...prev,
                              position: newPosition,
                              job104Title: shouldSync ? newPosition : prev.job104Title
                            };
                          })
                        }
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="ä¾‹: è»Ÿé«”å·¥ç¨‹å¸«"
                        required
                      />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œåœ°é»</label>
                <input
                  type="text"
                  value={formData.location}
                  onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ä¾‹: å°åŒ—ã€æ–°ç«¹"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">è·ç³»</label>
                <input
                  type="text"
                  value={formData.jobFamily}
                  onChange={(e) => setFormData({ ...formData, jobFamily: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ä¾‹: æŠ€è¡“ã€æ¥­å‹™ã€ç®¡ç†"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  äººåŠ›å–®è¡¨å–®è™Ÿ <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={formData.formNumber || ''}
                  onChange={(e) => setFormData({ ...formData, formNumber: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ä¾‹: HR24001"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">éœ€æ±‚äººæ•¸</label>
                <input
                  type="number"
                  min="1"
                  value={formData.headcount}
                  onChange={(e) =>
                    setFormData({ ...formData, headcount: parseInt(e.target.value, 10) || 1 })
                  }
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
              </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">è¡¨å–®ç‹€æ…‹</label>
                      <input
                        type="text"
                        value={formData.formStatus || 'å¾…ç¢ºèª'}
                        readOnly
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                        placeholder="ä¾‹: ç°½æ ¸ä¸­"
                      />
                    </div>
            </div>
          </div>

                <div className="border-b pb-4 space-y-4 bg-indigo-50 rounded-lg p-4">
                  <h3 className="text-lg font-semibold text-gray-700 mb-1">æ‹›å‹Ÿç¢ºèª</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">æ‹›å‹Ÿå°ˆå®¶</label>
                      <input
                        type="text"
                        list="recruiter-options"
                        value={formData.recruitmentOwner || ''}
                        onChange={(e) => setFormData({ ...formData, recruitmentOwner: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="é¸æ“‡æˆ–è¼¸å…¥æ‹›å‹Ÿå°ˆå®¶"
                      />
                    </div>
              <div className="flex flex-col gap-2">
                <label className="text-sm font-medium text-gray-700">æ‹›å‹Ÿç¢ºèª</label>
                <label className="inline-flex items-center gap-2 text-sm text-gray-700">
                  <input
                    type="checkbox"
                    className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                    checked={formData.confirmedRequirement}
                    onChange={(e) =>
                      setFormData({ ...formData, confirmedRequirement: e.target.checked })
                    }
                  />
                  å·²èˆ‡ä¸»ç®¡ç¢ºèªè·ç¼ºéœ€æ±‚
                </label>
                <label className="inline-flex items-center gap-2 text-sm text-gray-700">
                  <input
                    type="checkbox"
                    className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                          checked={formData.confirmed104}
                          onChange={(e) => setFormData({ ...formData, confirmed104: e.target.checked })}
                        />
                        å·²é–‹å•Ÿ104è·ç¼º
                      </label>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">104è·ç¨±</label>
                        <input
                          type="text"
                          value={formData.job104Title || ''}
                          onChange={(e) => setFormData({ ...formData, job104Title: e.target.value })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                          placeholder="é è¨­ç‚ºè·å‹™åç¨±"
                        />
                      </div>
                    </div>
                  </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">è·ç¼ºç‹€æ…‹</label>
                <select
                  value={formData.status}
                  onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                  {['ç”³è«‹ä¸­', 'æ‹›å‹Ÿç¢ºèª', 'é–‹å•Ÿä¸­', 'å·²é—œé–‰'].map((status) => (
                    <option key={status} value={status}>
                      {status}
                    </option>
                  ))}
                </select>
                <p className="text-xs text-gray-500 mt-1">
                  â€» ç”³è«‹ä¸­ã€æ‹›å‹Ÿç¢ºèªç‹€æ…‹ç”±ç³»çµ±æ ¹æ“šäººåŠ›å–®è¡¨å–®ç‹€æ…‹è‡ªå‹•è¨­å®š
                </p>
              </div>
              {formData.status === 'å·²é—œé–‰' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">é—œé–‰æ—¥æœŸ</label>
                  <input
                    type="date"
                    value={formData.closingDate || ''}
                    onChange={(e) => setFormData({ ...formData, closingDate: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  />
                </div>
              )}
            </div>
            {formData.status === 'å·²é—œé–‰' && (
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    é—œé–‰åŸå›  <span className="text-red-500">*</span>
                  </label>
                  <select
                    value={formData.closingReason || ''}
                    onChange={(e) => setFormData({ ...formData, closingReason: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  >
                    <option value="">è«‹é¸æ“‡é—œé–‰åŸå› </option>
                    <option value="æ‹›å‹Ÿå®Œæˆ">æ‹›å‹Ÿå®Œæˆ</option>
                    <option value="äººåŠ›ç”³è«‹æœªé">äººåŠ›ç”³è«‹æœªé</option>
                    <option value="éƒ¨é–€åœæ­¢æ‹›å‹Ÿ">éƒ¨é–€åœæ­¢æ‹›å‹Ÿ</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                  <textarea
                    value={formData.closingReasonNote || ''}
                    onChange={(e) => setFormData({ ...formData, closingReasonNote: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    rows="2"
                    placeholder="å¯è‡ªç”±å¡«å¯«è£œå……èªªæ˜"
                  />
                </div>
              </div>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">éœ€æ±‚åŸå›  / å‚™è¨»</label>
            <textarea
              value={formData.reason}
              onChange={(e) => setFormData({ ...formData, reason: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
              rows="3"
              placeholder="è«‹èªªæ˜äººåŠ›éœ€æ±‚åŸå› ..."
            />
          </div>

                <div className="flex gap-4 pt-4">
                  <button
                    onClick={handleSubmit}
                    className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-colors"
                  >
                    {job ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢è·ç¼º'}
                  </button>
                  <button
                    onClick={onClose}
                    className="flex-1 px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium transition-colors"
                  >
                    å–æ¶ˆ
                  </button>
                </div>

                <datalist id="recruiter-options">
                  {recruiterOptions.map((name) => (
                    <option key={name} value={name} />
                  ))}
                </datalist>
              </div>
            </div>
    </div>
  );
}
function DeleteConfirmModal({ job, onConfirm, onClose }) {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div className="p-6 space-y-4">
          <h2 className="text-xl font-bold text-gray-800">ç¢ºèªåˆªé™¤è·ç¼º</h2>
          <p className="text-sm text-gray-600">
            ç¢ºå®šè¦åˆªé™¤ <span className="font-semibold text-indigo-600">{job.jobId}</span>ï¼ˆ
            {job.position || 'æœªå‘½åè·ç¼º'}ï¼‰å—ï¼Ÿæ­¤å‹•ä½œå°‡ç„¡æ³•å¾©åŸã€‚
          </p>
          <div className="bg-gray-50 rounded-md p-4 text-sm text-gray-700 space-y-1">
            <p>äººåŠ›å–®è¡¨å–®è™Ÿï¼š{job.formNumber || '-'}</p>
            <p>HCæ‰€å±¬éƒ¨é–€ï¼š{job.department || '-'}</p>
            <p>éœ€æ±‚äººæ•¸ï¼š{job.headcount || '-'}</p>
          </div>
          <div className="flex gap-3 pt-4">
            <button
              onClick={onConfirm}
              className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
            >
              ç¢ºèªåˆªé™¤
            </button>
            <button
              onClick={onClose}
              className="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function JobDetailModal({ job, onClose, allJobs, calculateOnboardCount }) {
  const detailFields = [
    { label: 'è·ç¼ºä»£ç¢¼', value: job.jobId },
    { label: 'äººåŠ›å–®è¡¨å–®è™Ÿ', value: job.formNumber },
    { label: 'äººåŠ›å–®è¡¨å–®ç‹€æ…‹', value: job.formStatus },
    { label: 'äººåŠ›å–®ç°½æ ¸ç”Ÿæ•ˆæ™‚é–“', value: job.formEffectiveDate },
    { label: 'HCæ‰€å±¬éƒ¨é–€', value: job.department },
    { label: 'è·å‹™åç¨±', value: job.position },
    { label: '104è·ç¨±', value: job.job104Title || job.position },
    { label: 'å·¥ä½œåœ°é»', value: job.location },
    { label: 'è·ç³»', value: job.jobFamily },
    { label: 'éœ€æ±‚äººæ•¸', value: job.originalHeadcount || job.headcount },
    { label: 'å ±åˆ°äººæ•¸', value: calculateOnboardCount(job.formNumber, allJobs) },
    { label: 'æ‹›å‹Ÿå°ˆå®¶', value: job.recruitmentOwner },
    { label: 'ç¢ºèªä¸»ç®¡éœ€æ±‚', value: job.confirmedRequirement ? 'æ˜¯' : 'å¦' },
    { label: 'ç¢ºèª104è·ç¼º', value: job.confirmed104 ? 'æ˜¯' : 'å¦' },
    { label: 'è·ç¼ºç‹€æ…‹', value: normalizeJobStatus(job.status) },
    { label: 'é—œé–‰æ—¥æœŸ', value: job.closingDate },
    { label: 'é—œé–‰åŸå› ', value: job.closingReason },
    { label: 'éœ€æ±‚åŸå›  / å‚™è¨»', value: job.reason },
    { label: 'å»ºæª”æ—¥æœŸ', value: job.uploadDate },
    { label: 'å»ºç«‹æ™‚é–“', value: job.createdAt }
  ].filter((item) => item.value !== undefined && item.value !== null && item.value !== '');

  const extraEntries = Object.entries(job)
    .filter(
      ([key]) =>
        ![
          'jobId',
          'formNumber',
          'department',
          'position',
          'location',
          'jobFamily',
          'headcount',
          'status',
          'formStatus',
          'formEffectiveDate',
          'recruitmentOwner',
          'job104Title',
          'confirmedRequirement',
          'confirmed104',
          'closingDate',
          'closingReason',
          'reason',
          'uploadDate',
          'createdAt',
          'id',
          'internalId'
        ].includes(key)
    )
    .map(([key, value]) => ({
      label: key,
      value
    }))
    .filter((item) => item.value !== undefined && item.value !== null && item.value !== '');

  const rows = [...detailFields, ...extraEntries];

  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="p-6 space-y-4">
          <div className="flex items-start justify-between">
            <div>
              <p className="text-sm text-gray-500">è·ç¼ºè©³æƒ…</p>
              <h2 className="text-2xl font-bold text-gray-900">{job.position || job.jobId}</h2>
            </div>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">
              Ã—
            </button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {rows.map(({ label, value }) => (
              <div key={`${label}-${value}`} className="border rounded-lg p-3 bg-gray-50">
                <p className="text-xs text-gray-500">{label}</p>
                <p className="mt-1 text-sm text-gray-800 break-words">{value || '-'}</p>
              </div>
            ))}
          </div>
          <div className="flex justify-end">
            <button
              onClick={onClose}
              className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
            >
              é—œé–‰
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

      ReactDOM.createRoot(document.getElementById('root')).render(<JobMasterTracker />);
    </script>
  </body>
</html>
