<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å€‹äººæŠ•è³‡ç´€éŒ„ï½œPortfolio Tracker (Flat Enterprise UI)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --ink: #1f2937;
      --sub: #6b7280;
      --muted: #e5e7eb;
      --line: #e6e9ef;
      --brand: #2563eb;    /* è— */
      --accent: #0ea5e9;   /* é’ */
      --ok: #10b981;       /* ç¶  */
      --warn: #f59e0b;     /* é»ƒ */
      --danger: #ef4444;   /* ç´… */
      --shadow: 0 6px 18px rgba(17,24,39,0.06);
      --radius: 14px;
      --font: 'Inter', ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Hiragino Sans", "Heiti TC", "Microsoft JhengHei", Arial, sans-serif;
      --fs: 14px;          /* å…¨ç«™å°å­—é«” */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink); font: 400 var(--fs)/1.5 var(--font);
      display:flex; flex-direction:column; min-height:100vh;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    header{
      position:sticky; top:0; z-index:20; backdrop-filter:saturate(1.2) blur(6px);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75));
      border-bottom:1px solid var(--line);
    }
    .wrap{width:100%; max-width:min(1440px, calc(100% - 40px)); margin:0 auto; padding:16px 20px}
    .titlebar{display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    .brand{font-weight:700; letter-spacing:.3px; font-size:20px;}

    /* ===== Buttons / Toolbar ===== */
    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .search{display:flex; align-items:center; gap:8px; padding:8px 10px; background:#fff; border:1px solid var(--line); border-radius:10px; box-shadow:var(--shadow)}
    .search input{border:0; outline:0; font:inherit; width:200px}
    .btn{border:1px solid var(--line); background:#fff; color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow)}
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger); color:#fff; border-color:transparent}
    .btn.ok{background:var(--ok); color:#fff; border-color:transparent}

    main{
      width:100%; max-width:min(1440px, calc(100% - 40px)); margin:18px auto; padding:0 20px;
      flex:1; display:flex; flex-direction:column; overflow:hidden;
    }

    .tabs{display:flex; gap:6px; border-bottom:1px solid var(--line)}
    .tab{appearance:none; background:transparent; border:0; padding:10px 12px; cursor:pointer; color:var(--sub); position:relative; font-weight:600}
    .tab[aria-selected="true"]{color:var(--brand)}
    .tab[aria-selected="true"]::after{content:""; position:absolute; left:10px; right:10px; bottom:-1px; height:3px; background:var(--brand); border-radius:3px 3px 0 0}

    .tab-views{flex:1; overflow:auto; padding:16px 0}

    section.view{display:none; padding:0}
    section.view.active{display:block}

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .card + .card{margin-top:14px}

    table{width:100%; border-collapse:collapse}
    thead th{font-size:12px; color:var(--sub); font-weight:600; text-align:center; padding:10px 8px; border-bottom:1px solid var(--line)}
    th.sortable{cursor:pointer; user-select:none}
    th.sortable::after{content:''; display:inline-block; margin-left:4px; font-size:10px; color:var(--brand)}
    th.sortable.sort-asc::after{content:'â–²'}
    th.sortable.sort-desc::after{content:'â–¼'}
    tbody td{padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:middle; text-align:center}
    #tbl-return tbody td, #tbl-holdings tbody td, #tbl-long-term tbody td, #tbl-txns tbody td, #tbl-txn-monthly tbody td, #tbl-snapshots tbody td{padding:6px 8px}
    tbody tr:hover{background:#fafafa}
    tbody tr.dividend-month-active{background:#fee2e2}
    tbody tr.dividend-month-active:hover{background:#fecaca}
    tbody tr.dividend-next-month{background:#dcfce7}
    tbody tr.dividend-next-month:hover{background:#bbf7d0}
    .highlight-max{background:#dcfce7; color:#065f46; font-weight:600; border-radius:6px; padding:2px 6px; display:inline-block}
    .highlight-min{background:#fee2e2; color:#991b1b; font-weight:600; border-radius:6px; padding:2px 6px; display:inline-block}
    .num{text-align:right; font-variant-numeric: tabular-nums}
    thead th.num{text-align:center}
    tbody td.num{text-align:center}
    .muted{color:var(--sub)}
    .grow{flex:1}

    .inline-input{width:100px; padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
    .select{padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
    .stack{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .right{margin-left:auto}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#fff}
    .badge.green{color:#0f766e; background:#ccfbf1; border-color:#99f6e4}
    .badge.red{color:#b91c1c; background:#fee2e2; border-color:#fecaca}
    .badge.red-light{color:#b91c1c; background:#ffe4e6; border-color:#fecdd3}
    .badge.red-medium{color:#fff; background:#f87171; border-color:#ef4444}
    .badge.red-strong{color:#fff; background:#b91c1c; border-color:#7f1d1d}
    .badge.green-light{color:#15803d; background:#dcfce7; border-color:#bbf7d0}
    .badge.green-medium{color:#fff; background:#4ade80; border-color:#22c55e}
    .badge.green-strong{color:#fff; background:#166534; border-color:#14532d}
    .badge.neutral{color:#4b5563; background:#f3f4f6; border-color:#e5e7eb}
    .badge.blue{color:#1e3a8a; background:#eff6ff; border-color:#bfdbfe}
    .badge.gray{color:#6b7280; background:#f9fafb; border-color:#e5e7eb}
    .account-stat{font-size:12px; color:var(--sub)}
    .account-stat strong{color:var(--ink)}
    tr.dividend-no-holdings{background:#f3f4f6;}
    tr.dividend-no-holdings td{color:#6b7280;}

    dialog{border:0; border-radius:16px; box-shadow:0 24px 64px rgba(2,6,23,.2); width:min(680px, calc(100% - 32px)); padding:0}
    dialog::backdrop{background:rgba(2,6,23,.4)}
    .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); background:#fff; border-radius:16px 16px 0 0}
    .dlg-body{padding:16px}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    .field label{display:block; font-size:12px; color:var(--sub); margin-bottom:6px}
    .field input,.field select,.field textarea{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font:inherit}

    .footer{display:flex; justify-content:flex-end; gap:10px; padding:14px 16px; border-top:1px solid var(--line); background:#fff; border-radius:0 0 16px 16px}

    .donut{width:190px; height:190px; border-radius:50%; background:conic-gradient(#d1d5db 0 100%); position:relative; box-shadow:var(--shadow)}
    .donut::after{content:""; position:absolute; inset:22px; background:#fff; border-radius:50%; border:1px solid var(--line)}
    .donut .center{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; font-weight:700}
    
    .chart-legend{display:flex; align-items:center; gap:8px; margin-bottom:6px}
    .chart-legend .color{width:12px; height:12px; border-radius:50%; border:1px solid var(--line)}
    .chart-legend .label{flex:1; font-size:12px}
    .chart-legend .value{font-size:12px; font-weight:600}

    /* KPI æŒ‡æ¨™åˆ—ï¼šè‡ªé©æ‡‰æ¬„å¯¬ */
    .kpi{
      display:flex;
      flex-wrap:nowrap;
      gap:16px;
      padding:0 8px 4px;
      overflow-x:auto;
      scrollbar-width:thin;
    }
    .kpi .item{
      flex:0 0 160px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      box-shadow:var(--shadow);
      text-align:center;
    }
    .kpi .item.net-gain{
      background:#fee2e2;
      border-color:#fecaca;
      color:#b91c1c;
    }
    .kpi .item.net-gain .label{color:#b91c1c;}
    .kpi .item.net-gain .value{color:#b91c1c;}
    .kpi .item.cash-available{
      background:#e0f2fe;
      border-color:#bae6fd;
      color:#0f172a;
    }
    .kpi .item.cash-available .label{color:#0f172a;}
    .kpi .item.cash-available .value{color:#0f172a;}
    .kpi .label{font-size:12px; color:var(--sub)}
    .kpi .value{font-weight:700; font-size:20px}

    /* ğŸ“Š è³‡ç”¢é…ç½®ä¸‹æ–¹çµ±è¨ˆç”¨çš„è‡ªé©æ‡‰ç¶²æ ¼ï¼ˆèˆ‡ header KPI åˆ†é–‹ï¼‰ */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
      gap:16px;
    }
    .kpi-grid .item{
      text-align:center; padding:12px; background:#fff; border-radius:8px; border:1px solid var(--line)
    }
    .kpi-grid .item .label{font-size:11px; color:var(--sub); margin-bottom:4px}
    .kpi-grid .item .value{font-size:16px; font-weight:700; color:var(--text)}

    .note{font-size:12px; color:var(--sub)}
    .hr{height:1px; background:var(--line); margin:12px 0}

    .mini{font-size:12px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff}

    .empty{padding:18px; color:var(--sub); text-align:center}

    /* åœ–è¡¨ç¯„åœé¸æ“‡å™¨æ¨£å¼ */
    .chart-range-selector{display:flex; gap:4px; background:#f1f5f9; padding:4px; border-radius:8px}
    .range-btn{appearance:none; border:0; background:transparent; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:500; color:var(--sub); transition:all 0.2s}
    .range-btn:hover{background:#e2e8f0; color:var(--ink)}
    .range-btn.active{background:var(--brand); color:#fff; box-shadow:0 2px 4px rgba(37,99,235,0.2)}

    /* åœ–ä¾‹æ¨£å¼ */
    .chart-legend-container{display:flex; gap:20px; align-items:center}
    .chart-legend-item{display:flex; align-items:center; gap:8px}
    .legend-line{display:inline-block}
    .legend-label{font-size:12px; color:var(--sub); font-weight:500}

    /* è³‡ç”¢æ‘˜è¦æ¨£å¼ */
    .asset-summary{text-align:left}
    .summary-text{font-size:14px; font-weight:600; color:var(--ink)}
    .summary-text span{color:var(--brand)}
  </style>
  <script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="stack" style="margin-top:10px">
        <!-- âœ… é€™è£¡çš„ .kpi æœƒå›ºå®šæ°´å¹³æ’ -->
        <div class="kpi">
          <div class="item"><div class="label">ç¸½è³‡ç”¢</div><div class="value" id="kpi-total">â€”</div></div>
          <div class="item net-gain"><div class="label">é ä¼°ç¸½æç›Š</div><div class="value" id="kpi-net-gain">â€”</div></div>
          <div class="item"><div class="label">é ä¼°å ±é…¬ç‡</div><div class="value" id="kpi-return">â€”</div></div>
          <div class="item cash-available"><div class="label">å¯ä½¿ç”¨è³‡é‡‘</div><div class="value" id="kpi-cash">â€”</div></div>
        </div>

        <div class="toolbar">
          <button class="btn" id="btn-start-proxy">ğŸš€ å•Ÿå‹•ä»£ç†ä¼ºæœå™¨</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="tabs" role="tablist" aria-label="ä¸»å°è¦½">
      <button class="tab" role="tab" aria-selected="true" data-target="#view-snapshots">è³‡ç”¢è®ŠåŒ–</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-accounts">å¸³æˆ¶è³‡è¨Š</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-allocation">è³‡ç”¢é…ç½®</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-holdings">æŒæœ‰æ¨™çš„</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-txns">ç•°å‹•ç´€éŒ„</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-dividend">è‚¡æ¯è¦åŠƒ</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-return">å ±é…¬æª¢è¦–</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-settings">è¨­å®š / èªªæ˜</button>
  </div>

  <div class="tab-views">

  <!-- æŒæœ‰æ¨™çš„ -->
    <section id="view-holdings" class="view" role="tabpanel">
      <div class="card">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <button class="btn primary" id="btn-add-stock">ï¼‹ æ–°å¢æ¨™çš„</button>
            <button class="btn" id="btn-add-txn">ï¼‹ æ–°å¢ç•°å‹•</button>
          </div>
          <div class="stack">
            <div class="search">
              ğŸ” <select id="q" class="select">
                <option value="">å…¨éƒ¨æ¨™çš„</option>
              </select>
            </div>
          <button class="btn danger" id="btn-refresh-all" data-action="refresh-all">å³æ™‚æ›´æ–°å…¨éƒ¨</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="table-wrap">
          <table id="tbl-holdings">
            <thead>
              <tr>
                <th class="sortable" data-sort="category">åˆ†é¡</th>
                <th class="sortable" data-sort="symbol">ä»£è™Ÿ</th>
                <th class="sortable" data-sort="name">åç¨±</th>
                <th class="num sortable" data-sort="qty">æŒæœ‰è‚¡æ•¸</th>
                <th class="num sortable" data-sort="avgCost">æˆäº¤åƒ¹æ ¼</th>
                <th class="num sortable" data-sort="price">å¸‚å ´å¯¦åƒ¹</th>
                <th class="num sortable" data-sort="marketValue">å¸‚å€¼</th>
                <th class="num sortable" data-sort="stockPnl">è‚¡ç¥¨æç›Š</th>
                <th class="num sortable" data-sort="stockReturnPct">è‚¡ç¥¨å ±é…¬%</th>
                <th class="num sortable" data-sort="dividends">å¯¦é ˜è‚¡æ¯</th>
                <th class="num sortable" data-sort="totalPnl">å«è‚¡æ¯æç›Š</th>
                <th class="num sortable" data-sort="totalReturnPct">ç¸½å ±é…¬%</th>
                <th class="num">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <!-- é•·æœŸæŒ‡æ¨™ -->
      <div class="card" style="margin-top:16px;">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <h3 style="margin:0; font-size:18px; font-weight:600">é•·æœŸæŒ‡æ¨™</h3>
          <div class="note">è§€å¯Ÿå„æ¨™çš„é…ç½®ã€å«æ¯å ±é…¬ç‡èˆ‡å°ç¸½æç›Šçš„è²¢ç»åº¦ã€‚</div>
        </div>
        <div class="hr"></div>
        <div class="table-wrap">
          <table id="tbl-long-term">
            <thead>
              <tr>
                <th class="sortable" data-sort="symbol">ä»£è™Ÿ</th>
                <th class="sortable" data-sort="name">åç¨±</th>
                <th class="num sortable" data-sort="allocation">é…ç½®æ¯”ä¾‹</th>
                <th class="num sortable" data-sort="totalReturn">å«æ¯å ±é…¬ç‡</th>
                <th class="num sortable" data-sort="contribution">å ±é…¬è²¢ç»</th>
                <th class="num sortable" data-sort="yield">å¹´æ®–åˆ©ç‡</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ç•°å‹•ç´€éŒ„ -->
    <section id="view-txns" class="view" role="tabpanel">
      <div class="card">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <button class="btn primary" id="btn-add-txn-2">ï¼‹ æ–°å¢ç•°å‹•</button>
          </div>
          <div class="stack">
            <div class="search">
              ğŸ” <select id="q-txn" class="select">
                <option value="">å…¨éƒ¨æ¨™çš„</option>
              </select>
            </div>
            <div class="search">
              ğŸ” <select id="type-filter" class="select">
                <option value="">å…¨éƒ¨é¡å‹</option>
                <option value="buy">è²·å…¥</option>
                <option value="sell">è³£å‡º</option>
                <option value="dividend">è‚¡æ¯</option>
              </select>
            </div>
            <label class="btn" for="import-csv">åŒ¯å…¥åƒ¹æ ¼ (CSV)</label>
            <input id="import-csv" type="file" accept=".csv" hidden />
          </div>
        </div>
        <div class="hr"></div>
        <div class="card" style="background:#f8fafc; margin-bottom:16px">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
            <h3 style="margin:0; font-size:18px; font-weight:600">æœˆåº¦è²·è³£çµ±è¨ˆ</h3>
          </div>
          <table id="tbl-txn-monthly">
            <thead>
              <tr>
                <th>æœˆä»½</th>
                <th>æ¨™çš„</th>
                <th class="num">è²·å…¥ç¸½é¡</th>
                <th class="num">è³£å‡ºç¸½é¡</th>
                <th class="num">æœˆä»½ç¸½è²·å…¥</th>
                <th class="num">æœˆä»½ç¸½è³£å‡º</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <table id="tbl-txns">
          <thead>
            <tr>
              <th>æ™‚é–“</th>
              <th>æ¨™çš„</th>
              <th>å¸³æˆ¶</th>
              <th>é¡å‹</th>
              <th class="num">æˆäº¤åƒ¹æ ¼</th>
              <th class="num">è‚¡æ•¸</th>
              <th class="num">è‚¡ç¥¨æˆæœ¬</th>
              <th class="num">æŒæœ‰æˆæœ¬</th>
              <th class="num">è©¦ç®—æç›Š</th>
              <th class="num">è©¦ç®—å ±é…¬ç‡</th>
              <th class="num">å¯¦éš›æç›Š</th>
              <th class="num">å¯¦éš›å ±é…¬ç‡</th>
              <th>å‚™è¨»</th>
              <th class="num">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- å¸³æˆ¶ç¾é‡‘ -->
    <section id="view-accounts" class="view" role="tabpanel">
      <div class="card">
        <div id="accounts-list" style="display:flex; flex-wrap:wrap; gap:16px;"></div>
        <div class="hr"></div>
        <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:8px; flex-wrap:wrap; gap:12px">
          <h3 style="margin:0; font-size:18px; font-weight:600">æŠ•è³‡ç¾é‡‘ç´€éŒ„</h3>
          <div class="stack" style="gap:8px; align-items:center">
            <select id="invest-log-account" class="select"></select>
            <button class="btn mini" id="btn-add-invest-log">ï¼‹ æ–°å¢ç´€éŒ„</button>
          </div>
        </div>
        <div id="invest-cash-log" class="table-wrap"></div>
      </div>
    </section>

    <!-- è³‡ç”¢æˆæœ -->
    <section id="view-snapshots" class="view active" role="tabpanel">
      <div class="card">
        <!-- ç´¯è¨ˆè³‡ç”¢å¢æ¸›è¶¨å‹¢åœ– -->
        <div class="card" style="background:#f8fafc; margin-bottom:16px">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px">
            <div class="stack" style="gap:12px; flex-wrap:wrap; align-items:center">
              <h3 style="margin:0; font-size:18px; font-weight:600">ç´¯è¨ˆè³‡ç”¢å¢æ¸›</h3>
              <div class="stack" style="gap:8px; flex-wrap:wrap;">
                <button class="btn ok" id="btn-add-snapshot">ï¼‹ è¨˜éŒ„ä»Šå¤©</button>
                <button class="btn danger" id="btn-refresh-all-snapshots" data-action="refresh-all">å³æ™‚æ›´æ–°å…¨éƒ¨</button>
              </div>
            </div>
            <div class="chart-range-selector">
              <button class="range-btn" data-range="7">7å¤©</button>
              <button class="range-btn active" data-range="14">14å¤©</button>
              <button class="range-btn" data-range="30">30å¤©</button>
              <button class="range-btn" data-range="60">60å¤©</button>
              <button class="range-btn" data-range="90">90å¤©</button>
              <button class="range-btn" data-range="120">120å¤©</button>
            </div>
          </div>
          <div id="asset-summary" class="asset-summary" style="display:none;"></div>
          <div id="snapshot-change-chart" style="height:360px; position:relative; background:#fff; border-radius:8px; border:1px solid var(--line); padding:20px;">
            <div id="change-chart-svg-container" style="width:100%; height:100%;"></div>
          </div>
        </div>
        <!-- ç¸½è³‡ç”¢å¢æ¸›è¶¨å‹¢åœ– -->
        <div class="card" style="background:#f8fafc; margin-bottom:16px">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
            <h3 style="margin:0; font-size:18px; font-weight:600">ç¸½è³‡ç”¢è®ŠåŒ–</h3>
            <div class="chart-range-selector">
              <button class="range-btn" data-range="7">7å¤©</button>
              <button class="range-btn active" data-range="14">14å¤©</button>
              <button class="range-btn" data-range="30">30å¤©</button>
              <button class="range-btn" data-range="60">60å¤©</button>
              <button class="range-btn" data-range="90">90å¤©</button>
              <button class="range-btn" data-range="120">120å¤©</button>
            </div>
          </div>
          
          <!-- åœ–è¡¨å®¹å™¨ -->
          <div id="snapshot-chart" style="height:360px; position:relative; background:#fff; border-radius:8px; border:1px solid var(--line); padding:20px;">
            <div id="chart-svg-container" style="width:100%; height:100%;"></div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="note">å…§å®¹åŒ…å«ï¼šæŒæœ‰æ¨™çš„å¸‚å€¼ + æ‰€æœ‰å¸³æˆ¶çš„å¯ç”¨é¤˜é¡ï¼›ä¸¦èˆ‡å‰ä¸€ç­†æ¯”è¼ƒç¸½è³‡ç”¢å¢æ¸›é‡‘é¡èˆ‡æ¯”ä¾‹ã€‚</div>
        <div class="hr"></div>
        <table id="tbl-snapshots">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th class="num">æŒæœ‰å¸‚å€¼</th>
              <th class="num">å¯ç”¨ç¾é‡‘</th>
              <th class="num">ç¸½è³‡ç”¢</th>
              <th class="num">ç¸½è³‡ç”¢å¢æ¸›</th>
              <th class="num">å¢æ¸›æ¯”ä¾‹</th>
              <th class="num">ç´¯è¨ˆè³‡ç”¢å¢æ¸›</th>
              <th class="num">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        
      </div>
    </section>

    <!-- è³‡ç”¢é…ç½® -->
    <section id="view-allocation" class="view" role="tabpanel">
      <div class="card">
        <h3 style="margin:0 0 16px">è³‡ç”¢é…ç½®åˆ†æ</h3>
        
        <!-- ç¬¬ä¸€è¡Œï¼šä¸‰å€‹ä¸»è¦åœ–è¡¨ -->
        <div class="stack" style="gap:20px; align-items:flex-start; flex-wrap:wrap; margin-bottom:20px">
          <!-- å€‹è‚¡æŠ•è³‡å æ¯” -->
          <div class="card" style="flex:1; min-width:300px">
            <div class="mini muted" style="margin-bottom:12px">å€‹è‚¡æŠ•è³‡å æ¯”</div>
            <div class="donut" id="donut-stocks" style="width:200px; height:200px; margin:0 auto">
              <div class="center">
                <div>
                  <div class="mini muted">å€‹è‚¡åˆ†å¸ƒ</div>
                  <div id="label-stocks" style="font-size:16px">â€”</div>
                </div>
              </div>
            </div>
            <div id="stocks-list" class="mini" style="margin-top:12px"></div>
          </div>
          
          <!-- å°ç£ vs å…¨çƒ -->
          <div class="card" style="flex:1; min-width:250px">
          <div class="mini muted" style="margin-bottom:12px">å°ç£ vs å…¨çƒ</div>
          <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:12px">
            <div class="badge" id="region-target-label">ç›®æ¨™ï¼šâ€” / â€”</div>
            <button class="btn mini" id="btn-edit-region-target">âš™ï¸ è¨­å®šç›®æ¨™</button>
          </div>
          <div class="donut" id="donut-region" style="width:180px; height:180px; margin:0 auto">
            <div class="center">
              <div>
                <div class="mini muted">åœ°å€åˆ†å¸ƒ</div>
                <div id="label-region" style="font-size:18px">â€”</div>
              </div>
            </div>
          </div>
          <div id="region-list" class="mini" style="margin-top:12px"></div>
          <div id="region-rebalance-note" class="note" style="margin-top:12px"></div>
        </div>
          
          <!-- è‚¡ç¥¨ vs å‚µåˆ¸ -->
          <div class="card" style="flex:1; min-width:250px">
            <div class="mini muted" style="margin-bottom:12px">è‚¡ç¥¨ vs å‚µåˆ¸</div>
            <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:12px">
              <div class="badge" id="allocation-target-label">ç›®æ¨™ï¼šâ€” / â€”</div>
              <button class="btn mini" id="btn-edit-allocation-target">âš™ï¸ è¨­å®šç›®æ¨™</button>
            </div>
            <div class="donut" id="donut-class" style="width:180px; height:180px; margin:0 auto">
              <div class="center">
                <div>
                  <div class="mini muted">è³‡ç”¢é¡åˆ¥</div>
                  <div id="label-class" style="font-size:18px">â€”</div>
                </div>
              </div>
            </div>
            <div id="class-list" class="mini" style="margin-top:12px"></div>
            <div id="allocation-rebalance-note" class="note" style="margin-top:12px"></div>
          </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œï¼šè©³ç´°çµ±è¨ˆ -->
        <div class="card" style="background:#f8fafc">
          <div class="mini muted" style="margin-bottom:8px">æŠ•è³‡çµ„åˆçµ±è¨ˆ</div>
          <!-- âœ… é€™è£¡æ”¹ç”¨ kpi-gridï¼ˆä¸æ˜¯ header ç”¨çš„ kpiï¼‰ -->
          <div id="portfolio-stats" class="kpi-grid" style="gap:16px;"></div>
        </div>
        <div class="card" style="background:#ffffff">
          <div class="mini muted" style="margin-bottom:12px">æ•´é«”é…ç½®å°ç…§</div>
          <div id="allocation-overview-chart" style="height:320px"></div>
        </div>
        <div class="card" style="background:#ffffff">
          <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:12px">
            <div>
              <div class="mini muted">æŠ•è³‡è¦åŠƒ</div>
              <h3 style="margin:4px 0 0; font-size:18px; font-weight:600">æŠ•è³‡è¦åŠƒæ¨¡æ“¬</h3>
            </div>
            <button class="btn mini" id="btn-reset-planner">é‡è¨­</button>
          </div>
          <div class="mini muted" style="margin-bottom:12px">è¼¸å…¥åŠ ç¢¼ï¼ˆæ­£æ•¸ï¼‰æˆ–æ¸›ç¢¼ï¼ˆè² æ•¸ï¼‰å¼µæ•¸ä»¥æ¨¡æ“¬é‡æ–°é…ç½®å¾Œçš„æ¯”ä¾‹ã€‚</div>
          <div class="table-wrap">
            <table id="tbl-allocation-planner">
              <thead>
                <tr>
                  <th>æ¨™çš„</th>
                  <th>åç¨±</th>
                <th class="num">ç¾æœ‰è‚¡æ•¸</th>
                <th class="num">èª¿æ•´è‚¡æ•¸</th>
                <th class="num">æ¨¡æ“¬å¾Œè‚¡æ•¸</th>
                  <th class="num">é è¨ˆäº¤æ˜“é‡‘é¡</th>
                  <th class="num">æ¨¡æ“¬å¾Œå¸‚å€¼</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hr"></div>
          <div class="mini" id="planner-summary-region">æ¨¡æ“¬å¾Œ å°ç£ / å…¨çƒï¼šâ€”</div>
          <div class="mini" id="planner-summary-class">æ¨¡æ“¬å¾Œ è‚¡ç¥¨ / å‚µåˆ¸ï¼šâ€”</div>
          <div class="mini" id="planner-summary-trading">é ä¼°ç¸½äº¤æ˜“é‡‘é¡ï¼šâ€”</div>
        </div>
      </div>
    </section>

    <!-- è‚¡æ¯è¦åŠƒ -->
    <section id="view-dividend" class="view" role="tabpanel">
      <div class="card">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <h3 style="margin:0 0 16px">è‚¡æ¯è¦åŠƒ</h3>
          </div>
        </div>
        <div class="card" style="background:#f8fafc; margin-bottom:16px">
          <h3 style="margin:0 0 12px; font-size:18px; font-weight:600">æœˆåº¦è‚¡æ¯åŠ ç¸½</h3>
          <div id="dividend-monthly-chart" style="height:320px"></div>
        </div>
        <div class="hr"></div>
        <div class="table-wrap">
          <table id="tbl-dividend">
            <thead>
              <tr>
                <th>ä»£è™Ÿ</th>
                <th>åç¨±</th>
                <th>æŒæœ‰è‚¡æ•¸</th>
                <th>å‹æ…‹</th>
                <th>ç™¼æ”¾æ™‚é–“</th>
                <th class="num">ä»Šå¹´è‚¡æ¯æ”¶å…¥</th>
                <th class="num">ä¸‹æ¬¡è‚¡æ¯é‡‘é¡</th>
                <th class="num">ä¸‹æ¬¡è‚¡æ¯</th>
                <th>é™¤æ¯æ—¥</th>
                <th>é è¨ˆç™¼æ”¾æ—¥</th>
                <th class="num">å¹´æ®–åˆ©ç‡</th>
                <th>è³‡æ–™ä¾†æº / é€£çµ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- å ±é…¬æª¢è¦– -->
    <section id="view-return" class="view" role="tabpanel">
      <div class="card">
        <div class="table-wrap">
          <table id="tbl-return">
            <thead>
              <tr>
                <th class="sortable" data-sort="category">åˆ†é¡</th>
                <th class="sortable" data-sort="symbol">ä»£è™Ÿ</th>
                <th class="sortable" data-sort="name">åç¨±</th>
                <th class="num sortable" data-sort="allocation">æŠ•è³‡å æ¯”</th>
                <th class="num sortable" data-sort="receivedDividend">å·²é ˜è‚¡æ¯</th>
                <th class="num sortable" data-sort="unrealizedPnl">æœªå¯¦ç¾æç›Š(ä¸å«æ¯)</th>
                <th class="num sortable" data-sort="realizedPnl">å·²å¯¦ç¾æç›Š(å«æ¯)</th>
                <th class="num sortable" data-sort="totalPnl">ç¸½æç›Š</th>
                <th class="num sortable" data-sort="totalReturnPct">å«æ¯å ±é…¬ç‡</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- æ‰‹å‹•ç·¨è¼¯è‚¡æ¯è³‡è¨Šçš„å°è©±æ¡† -->
    <dialog id="dlg-dividend-edit">
      <form method="dialog">
        <div class="dlg-head">
          <div>ç·¨è¼¯è‚¡æ¯è³‡è¨Š</div>
          <button class="btn ghost" value="cancel">âœ•</button>
        </div>
        <div class="dlg-body">
          <div class="grid">
            <div class="field col-6">
              <label>è‚¡ç¥¨ä»£è™Ÿ</label>
              <input id="dividend-symbol" readonly />
            </div>
            <div class="field col-6">
              <label>è‚¡ç¥¨åç¨±</label>
              <input id="dividend-name" readonly />
            </div>
            <div class="field col-6">
              <label>ç™¼æ”¾å‹æ…‹</label>
              <select id="dividend-frequency">
                <option value="none">ä¸ç™¼æ”¾</option>
                <option value="annual">å¹´é…</option>
                <option value="semiannual">åŠå¹´é…</option>
                <option value="quarterly">å­£é…</option>
                <option value="bimonthly">é›™æœˆé…</option>
                <option value="monthly">æœˆé…</option>
              </select>
            </div>
            <div class="field col-12">
              <label>ç™¼æ”¾æœˆä»½ï¼ˆå¯è¤‡é¸ï¼‰</label>
              <div id="dividend-months" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
            </div>
            <div class="field col-6">
              <label>ç™¼æ”¾æ™‚é–“</label>
              <input id="dividend-payout-time" placeholder="ä¾‹å¦‚ï¼šæ¯æœˆ15æ—¥ã€æ¯å­£æœ€å¾Œä¸€å€‹äº¤æ˜“æ—¥" />
            </div>
            <div class="field col-6">
              <label>ä¸‹æ¬¡è‚¡æ¯ï¼ˆæ¯è‚¡ï¼‰</label>
              <input id="dividend-per-share" type="number" step="0.001" min="0" />
            </div>
            <div class="field col-6">
              <label>è‚¡æ¯é‡‘é¡</label>
              <input id="dividend-total-amount" type="number" step="1" min="0" />
            </div>
            <div class="field col-6">
              <label>é™¤æ¯æ—¥</label>
              <input id="dividend-ex-date" type="date" />
            </div>
            <div class="field col-6">
              <label>é è¨ˆç™¼æ”¾æ—¥</label>
              <input id="dividend-pay-date" type="date" />
            </div>
            <div class="field col-6">
              <label>å¹´æ®–åˆ©ç‡ (%)</label>
              <input id="dividend-yield" type="number" step="0.01" min="0" max="100" />
            </div>

          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
          <button class="btn primary" value="ok">å„²å­˜</button>
        </div>
      </form>
    </dialog>

    <!-- è‚¡ç¥¨ vs å‚µåˆ¸ç›®æ¨™è¨­å®š -->
    <dialog id="dlg-allocation-target">
      <form method="dialog">
        <div class="dlg-head">
          <div>è¨­å®šè‚¡ç¥¨ / å‚µåˆ¸ç›®æ¨™æ¯”ä¾‹</div>
          <button class="btn ghost" value="cancel">âœ•</button>
        </div>
        <div class="dlg-body">
          <div class="mini muted" style="margin-bottom:12px">è«‹è¼¸å…¥ç™¾åˆ†æ¯”æ•¸å€¼ï¼Œç¸½å’Œéœ€ç‚º 100ã€‚</div>
          <div class="grid">
            <div class="field col-6">
              <label>è‚¡ç¥¨ (%)</label>
              <input id="target-equity" type="number" min="0" max="100" step="1" required />
            </div>
            <div class="field col-6">
              <label>å‚µåˆ¸ (%)</label>
              <input id="target-bond" type="number" min="0" max="100" step="1" required />
            </div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
          <button class="btn primary" value="ok">å„²å­˜</button>
        </div>
      </form>
    </dialog>

    <!-- å°ç£ vs å…¨çƒç›®æ¨™è¨­å®š -->
    <dialog id="dlg-region-target">
      <form method="dialog">
        <div class="dlg-head">
          <div>è¨­å®šå°ç£ / å…¨çƒç›®æ¨™æ¯”ä¾‹</div>
          <button class="btn ghost" value="cancel">âœ•</button>
        </div>
        <div class="dlg-body">
          <div class="mini muted" style="margin-bottom:12px">è«‹è¼¸å…¥ç™¾åˆ†æ¯”æ•¸å€¼ï¼Œç¸½å’Œéœ€ç‚º 100ã€‚</div>
          <div class="grid">
            <div class="field col-6">
              <label>å°ç£ (%)</label>
              <input id="target-tw" type="number" min="0" max="100" step="1" required />
            </div>
            <div class="field col-6">
              <label>å…¨çƒ (%)</label>
              <input id="target-global" type="number" min="0" max="100" step="1" required />
            </div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
          <button class="btn primary" value="ok">å„²å­˜</button>
        </div>
      </form>
    </dialog>

  <!-- è¨­å®š / èªªæ˜ -->
  <section id="view-settings" class="view" role="tabpanel">
    <div class="card">
      <h3 style="margin:0 0 8px">èªªæ˜</h3>
      <ul class="mini" style="margin-top:0; color:var(--sub)">
          <li>ç³»çµ±ä»¥ <strong>åŠ æ¬Šå¹³å‡æˆæœ¬æ³•</strong> è¨ˆç®—æŒæœ‰æˆæœ¬ï¼›è³£å‡ºæ™‚å³æ™‚è¨ˆå…¥å¯¦ç¾æç›Šï¼ˆSell äº¤æ˜“ï¼‰ã€‚</li>
          <li>ã€Œå«è‚¡æ¯ç¸½æç›Šã€= æœªå¯¦ç¾æç›Šï¼ˆä»¥ç¾åƒ¹ï¼‰ + è©²æ¨™çš„è‡³ä»Šçš„è‚¡æ¯æ”¶å…¥ï¼ˆDividend äº¤æ˜“é‡‘é¡ï¼‰ã€‚</li>
          <li>ã€Œå¸³æˆ¶å¯ç”¨é¤˜é¡ã€= å¯¦éš›å¸³æˆ¶é‡‘é¡ + é è¨ˆäº¤å‰²é‡‘é¡ï¼ˆå¯ç‚ºæ­£/è² ï¼‰ã€‚</li>
          <li>åƒ¹æ ¼é è¨­ <strong>æ‰‹å‹•æ›´æ–°</strong>ï¼›ä½ ä¹Ÿå¯ä»¥åœ¨ <code>priceProvider.fetch(symbol)</code> æ”¹æˆä½ çš„è¡Œæƒ… APIï¼Œä¸¦ç”¨ã€Œå³æ™‚æ›´æ–°å…¨éƒ¨ã€æŒ‰éˆ•æ‰¹æ¬¡æŠ“åƒ¹ã€‚</li>
        </ul>
        <div class="hr"></div>
        <div class="mini muted">é–‹ç™¼èªªæ˜ï¼šç´”åŸç”Ÿ HTML/CSS/JSï¼Œå–®æª”å³å¯é›¢ç·šä½¿ç”¨ï¼›è³‡æ–™å­˜æ–¼ localStorageï¼Œæä¾›åŒ¯å‡º/åŒ¯å…¥ JSONã€‚</div>
      </div>
    </section>
  </div>
</main>

  <!-- Dialog: Stock -->
  <dialog id="dlg-stock">
    <form method="dialog">
      <div class="dlg-head"><div>æ¨™çš„è³‡æ–™</div><button class="btn ghost" value="cancel">âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6"><label>ä»£è™Ÿ (Symbol)</label><input id="stock-symbol" required /></div>
          <div class="field col-6"><label>åç¨±</label><input id="stock-name" required /></div>
          <div class="field col-6"><label>å¸‚å ´</label>
            <select id="stock-market" class="select">
              <option value="TW">å°ç£</option>
              <option value="Global">å…¨çƒ</option>
            </select>
          </div>
          <div class="field col-6"><label>è³‡ç”¢é¡åˆ¥</label>
            <select id="stock-class" class="select">
              <option value="Equity">è‚¡ç¥¨</option>
              <option value="Bond">å‚µåˆ¸</option>
            </select>
          </div>
          <div class="field col-6"><label>ç¾åƒ¹ (å¯ç•™ç©º)</label><input id="stock-price" type="number" step="0.01" /></div>
          <div class="field col-6"><label>å¹£åˆ¥ (è¨»è¨˜)</label><input id="stock-currency" placeholder="TWD / USD â€¦" /></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Transaction -->
  <dialog id="dlg-txn">
    <form method="dialog">
      <div class="dlg-head"><div>æ–°å¢/ç·¨è¼¯ ç•°å‹•ç´€éŒ„</div><button class="btn ghost" value="cancel">âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6">
            <label>æ¨™çš„</label>
            <select id="txn-stock" class="select"></select>
          </div>
          <div class="field col-6">
            <label>è‚¡ç¥¨å¸³æˆ¶</label>
            <select id="txn-account" class="select">
              <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
              <option value="sinopac">æ°¸è±éŠ€è¡Œ</option>
            </select>
          </div>
          <div class="field col-6">
            <label>é¡å‹</label>
            <select id="txn-type" class="select">
              <option value="buy">è²·å…¥ (Buy)</option>
              <option value="sell">è³£å‡º (Sell)</option>
              <option value="dividend">è‚¡æ¯ (Dividend)</option>
              <option value="fee">æ‰‹çºŒ/è²»ç”¨ (Fee)</option>
            </select>
          </div>
          <div class="field col-6"><label>åƒ¹æ ¼ (Dividend å¯ç•™ç©º)</label><input id="txn-price" type="number" step="0.01" /></div>
          <div class="field col-6"><label>æ•¸é‡ (Dividend å¯ç•™ç©ºæˆ– 0)</label><input id="txn-qty" type="number" step="0.01" /></div>
          <div class="field col-6"><label>é‡‘é¡ (è‡ªå‹•=åƒ¹æ ¼Ã—æ•¸é‡ï¼›Dividend éœ€å¡«å…¥å…¥å¸³é‡‘é¡)</label><input id="txn-amount" type="number" step="1" /></div>
          <div class="field col-6"><label>æ™‚é–“</label><input id="txn-time" type="datetime-local" /></div>
          <div class="field col-12"><label>å‚™è¨»</label><input id="txn-note" /></div>
        </div>
        <div class="mini note" style="margin-top:8px">è³£å‡º(Sell) æœƒä¾åŠ æ¬Šå¹³å‡æˆæœ¬æ³•è¨ˆç®— <strong>æœ¬æ¬¡å¯¦ç¾æç›Š</strong>ï¼›è‚¡æ¯(Dividend) é‡‘é¡æœƒè¨ˆå…¥ã€Œå«è‚¡æ¯ç¸½æç›Šã€ã€‚è²»ç”¨(Fee) æœƒå¢åŠ æŒæœ‰æˆæœ¬ã€‚</div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Snapshot -->
  <dialog id="dlg-snapshot">
    <form method="dialog">
      <div class="dlg-head"><div>è³‡ç”¢æˆæœè¨˜éŒ„</div><button class="btn ghost" value="cancel">âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6"><label>æ—¥æœŸ</label><input id="snapshot-date" type="date" required /></div>
          <div class="field col-6"><label>æŒæœ‰å¸‚å€¼</label><input id="snapshot-holdings" type="number" step="1" /></div>
          <div class="field col-6"><label>å¯ç”¨ç¾é‡‘</label><input id="snapshot-cash" type="number" step="1" /></div>
          <div class="field col-6"><label>ç¸½è³‡ç”¢</label><input id="snapshot-total" type="number" step="1" readonly /></div>
          <div class="field col-12"><label>å‚™è¨»</label><input id="snapshot-note" /></div>
        </div>
        <div class="mini note" style="margin-top:8px">ç¸½è³‡ç”¢æœƒè‡ªå‹•è¨ˆç®—ç‚ºæŒæœ‰å¸‚å€¼ + å¯ç”¨ç¾é‡‘ã€‚èˆ‡å‰æ—¥å·®é¡å’Œæ¯”ä¾‹æœƒè‡ªå‹•è¨ˆç®—ã€‚</div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Account -->
  <dialog id="dlg-account">
    <form method="dialog">
      <div class="dlg-head"><div>å¸³æˆ¶è¨­å®š / ç•°å‹•</div><button class="btn ghost" value="cancel">âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6"><label>å¸³æˆ¶åç¨±</label><input id="acct-name" required /></div>
          <div class="field col-6"><label>å¯¦éš›å¸³æˆ¶é‡‘é¡</label><input id="acct-actual" type="number" step="1" /></div>
          <div class="field col-6"><label>é è¨ˆäº¤å‰²é‡‘é¡ (å¯æ­£/è² )</label><input id="acct-settle" type="number" step="1" /></div>
          <div class="field col-6"><label>å‚™è¨»</label><input id="acct-note" /></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">è¿”å›</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Capital Change -->
  <dialog id="dlg-capital">
    <form method="dialog">
      <div class="dlg-head"><div>å¢æ¸›è³‡ç´€éŒ„</div><button class="btn ghost" value="cancel" formnovalidate>âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6">
            <label>é¡å‹</label>
            <select id="cap-type">
              <option value="deposit">å¢è³‡</option>
              <option value="withdraw">æ¸›è³‡</option>
            </select>
          </div>
          <div class="field col-6">
            <label>é‡‘é¡</label>
            <input id="cap-amount" type="number" step="1" min="1" required />
          </div>
          <div class="field col-6">
            <label>æ—¥æœŸ</label>
            <input id="cap-date" type="datetime-local" required />
          </div>
          <div class="field col-6">
            <label>å‚™è¨»</label>
            <input id="cap-note" />
          </div>
        </div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel" formnovalidate>å–æ¶ˆ</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <script>
  // ========= åŸºç¤å·¥å…· =========
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmtInt = new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 });
const fmt2 = new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const pct = (n) => (isFinite(n)? (n*100).toFixed(2)+'%':'â€”');
const uid = () => Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4);
const todayStr = () => new Date().toISOString().slice(0,10);
const nowISO = () => new Date().toISOString();
const parseN = (v) => isNaN(parseFloat(v))? 0 : parseFloat(v);
let dividendMonthlyChart = null;
const allocationTargetDefaults = { equity: 60, bond: 40 };
const allocationTargetStorageKey = 'allocation_target_ratio';
const regionTargetDefaults = { tw: 50, global: 50 };
const regionTargetStorageKey = 'region_target_ratio';
let allocationPlannerBase = [];
let allocationPlannerAdjustments = {};
let allocationPlannerContext = null;
  const formatIntensityBadge = (value, percent, formatter='amount') => {
    if(!Number.isFinite(value)){
      return '<span class="badge neutral">â€”</span>';
    }
    if(Math.abs(value) < 1e-9){
      return `<span class="badge neutral">${formatter==='percent' ? '0.0%' : '0'}</span>`;
    }
    const toneClass = value > 0 ? 'badge red-light' : value < 0 ? 'badge green-light' : 'badge neutral';
    const arrow = value >= 0 ? 'â–² ' : 'â–¼ ';
    if(formatter === 'percent'){
      return `<span class="${toneClass}">${arrow}${Math.abs(value).toFixed(1)}%</span>`;
    }
    return `<span class="${toneClass}">${arrow}${fmtInt.format(Math.round(Math.abs(value)))}</span>`;
  };

  // é ä¼°æ‰‹çºŒè²»
  const estimateFee = (amount) => {
    const rate = Number(window.FEE_RATE ?? 0.001425);
    return Math.round((Math.abs(Number(amount) || 0) * rate) * 100) / 100;
  };

  const storeKey = 'pfv1';
  const DEFAULT_INITIAL_CAPITAL = 2626550;
  const DEFAULT_INITIAL_DATE = () => new Date(Date.UTC(2024, 7, 1, 0, 0, 0)).toISOString(); // 2024-08-01
  const loadDB = () => {
    const fallback = {stocks:[], txns:[], accounts:[], snapshots:[], meta:{}};
    try{
      const parsed = JSON.parse(localStorage.getItem(storeKey) || 'null');
      if(!parsed || typeof parsed !== 'object') return fallback;
      return {
        stocks: parsed.stocks || [],
        txns: parsed.txns || [],
        accounts: parsed.accounts || [],
        snapshots: parsed.snapshots || [],
        meta: parsed.meta || {}
      };
    }catch{
      return fallback;
    }
  };
  const saveDB = () => { try { localStorage.setItem(storeKey, JSON.stringify(DB)); } catch(e){ alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š'); } };
  let DB = loadDB();
  const ensureInitialCapitalEntry = () => {
    if(!DB.meta) DB.meta = {};
    if(!DB.meta.initialCapital){
      DB.meta.initialCapital = {
        amount: DEFAULT_INITIAL_CAPITAL,
        time: DEFAULT_INITIAL_DATE(),
        note: 'èµ·å§‹æŠ•å…¥'
      };
      saveDB();
    }
    return DB.meta.initialCapital;
  };
  const getInitialCapitalAmount = () => {
    const entry = ensureInitialCapitalEntry();
    return entry ? parseN(entry.amount) : 0;
  };
  const sumCapitalAdjustments = (upTo) => {
    let cutoffTime = null;
    if(upTo){
      const cutoff = new Date(upTo);
      if(!isNaN(cutoff.valueOf())){
        cutoffTime = cutoff.getTime();
        if(typeof upTo === 'string' && !upTo.includes('T')){
          cutoffTime += 86400000 - 1; // include entire day when only date is provided
        }
      }
    }
    return DB.accounts.reduce((total, acct)=>{
      return total + (acct.history||[]).reduce((acc, entry)=>{
        if(entry && (entry.type==='deposit' || entry.type==='withdraw')){
          if(cutoffTime !== null){
            const entryTime = entry.time ? new Date(entry.time).getTime() : null;
            if(entryTime !== null && entryTime > cutoffTime){
              return acc;
            }
          }
          return acc + parseN(entry.amount);
        }
        return acc;
      }, 0);
    }, 0);
  };

  // ========= åƒ¹æ ¼ä¾›æ‡‰å™¨ =========
  const priceProvider = {
    async fetch(symbol){
      if(!symbol) return null;
      const origSym = String(symbol).toUpperCase();
      
      // å‚µåˆ¸ä»£ç¢¼è™•ç†ï¼šå˜—è©¦å¤šç¨®æ ¼å¼
      const symbolsToTry = [];
      
      // å¦‚æœæ˜¯å‚µåˆ¸ä»£ç¢¼ï¼ˆä»¥Bçµå°¾ï¼‰ï¼Œå˜—è©¦ä¸åŒæ ¼å¼
      if(origSym.endsWith('B')) {
        symbolsToTry.push(origSym); // åŸå§‹æ ¼å¼ï¼š00687B
        symbolsToTry.push(`${origSym}.TW`); // åŠ ä¸Š.TWï¼š00687B.TW
        symbolsToTry.push(`${origSym}.TWO`); // åŠ ä¸Š.TWOï¼š00687B.TWO
      } else {
        // è‚¡ç¥¨ä»£ç¢¼è™•ç†
        if(origSym.endsWith('.TW') || origSym.endsWith('.TWO')) {
          symbolsToTry.push(origSym);
        } else {
          symbolsToTry.push(`${origSym}.TW`);
        }
      }
      
      const LOCAL = (window.API_BASE || 'http://localhost:3000').replace(/\/$/,'');
      const parseV8 = (j)=>{ try{ const m=j?.chart?.result?.[0]?.meta; return (m?.regularMarketPrice ?? m?.previousClose ?? null);}catch(e){return null;} };
      const parseV7 = (j)=>{ try{ const r=j?.quoteResponse?.result?.[0]; return (r?.regularMarketPrice ?? r?.regularMarketPreviousClose ?? null);}catch(e){return null;} };

      // å˜—è©¦æ¯å€‹å¯èƒ½çš„ç¬¦è™Ÿæ ¼å¼
      for(const sym of symbolsToTry) {
        // å„ªå…ˆå˜—è©¦æœ¬åœ°ä»£ç†ä¼ºæœå™¨
        try{ 
          const res=await fetch(`${LOCAL}/quote2?symbol=${encodeURIComponent(sym)}`,{cache:'no-store'});
          if(res.ok){ 
            const j=await res.json(); 
            const p=parseV8(j)??parseV7(j); 
            if(p!=null&&!isNaN(p)) return {price:Number(p), via:'local-quote2'}; 
          } 
        }catch(err){
          console.log(`æœ¬åœ°ä»£ç† quote2 å¤±æ•—: ${err.message}`);
        }
        
        try{ 
          const res=await fetch(`${LOCAL}/quote?symbol=${encodeURIComponent(sym)}`,{cache:'no-store'});
          if(res.ok){ 
            const j=await res.json(); 
            const p=parseV7(j)??parseV8(j); 
            if(p!=null&&!isNaN(p)) return {price:Number(p), via:'local-quote'}; 
          } 
        }catch(err){
          console.log(`æœ¬åœ°ä»£ç† quote å¤±æ•—: ${err.message}`);
        }

        // å¦‚æœæœ¬åœ°ä»£ç†å¤±æ•—ï¼Œå˜—è©¦å¤–éƒ¨ä»£ç†æœå‹™
        const v7url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(sym)}`;
        const attempts = [
          { name:'jina', url:`https://r.jina.ai/http://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(sym)}` },
          { name:'allorigins', url:`https://api.allorigins.win/raw?url=${encodeURIComponent(v7url)}` },
        ];
        
        for(const a of attempts){
          try{
            console.log(`å˜—è©¦ ${a.name} å¤–éƒ¨ä»£ç†ç²å– ${sym} çš„è‚¡åƒ¹...`);
            const res = await fetch(a.url, {cache:'no-store'});
            if(!res.ok) {
              console.log(`${a.name} ä»£ç†è¿”å›ç‹€æ…‹: ${res.status}`);
              continue;
            }
            const txt = await res.text();
            let j; try{ j = JSON.parse(txt); }catch(e){ 
              console.log(`${a.name} ä»£ç†è¿”å›çš„å…§å®¹ç„¡æ³•è§£æç‚º JSON`);
              continue; 
            }
            const p = parseV7(j) ?? parseV8(j);
            if(p!=null && !isNaN(p)) {
              console.log(`æˆåŠŸå¾ ${a.name} ç²å– ${sym} çš„è‚¡åƒ¹: ${p}`);
              return {price:Number(p), via:a.name};
            }
          }catch(err){
            console.log(`${a.name} å¤–éƒ¨ä»£ç†è«‹æ±‚å¤±æ•—: ${err.message}`);
          }
        }
      }
      return null;
    }
  };

  // ========= æˆæœ¬/éƒ¨ä½è¨ˆç®—ï¼ˆåŠ æ¬Šå¹³å‡æˆæœ¬æ³•ï¼‰ =========
  function calcPosition(stockId){
    const tx = DB.txns.filter(t=>t.stockId===stockId).sort((a,b)=>new Date(a.time)-new Date(b.time));
    let qty=0, costBasis=0, avgCost=0, dividends=0;
    for(const t of tx){
      if(t.type==='buy'){
        const amount = parseN(t.price)*parseN(t.qty);
        costBasis += amount; qty += parseN(t.qty);
        avgCost = qty? costBasis/qty : 0;
      }else if(t.type==='sell'){
        const sellQty = parseN(t.qty);
        const realized = (parseN(t.price)-avgCost)*sellQty;
        costBasis -= avgCost*sellQty; qty -= sellQty;
        avgCost = qty? costBasis/qty : 0; t._realized = realized;
      }else if(t.type==='fee'){
        costBasis += parseN(t.amount);
        avgCost = qty? costBasis/qty : 0;
      }else if(t.type==='dividend'){
        dividends += parseN(t.amount);
      }
    }
    const stock = DB.stocks.find(s=>s.id===stockId);
    const price = parseN(stock?.price);
    const marketValue = price*qty;
    const unrealized = marketValue - costBasis;
    const totalPnl = unrealized + dividends;
    return {qty, avgCost, costBasis, price, marketValue, unrealized, dividends, totalPnl};
  }

  function computeAllPositions(){
    const map = {};
    for(const s of DB.stocks){ map[s.id] = calcPosition(s.id); }
    return map;
  }

  function computeTxnRealizedList(){
    const tx = DB.txns.slice().sort((a,b)=>new Date(a.time)-new Date(b.time));
    const state = new Map(); // stockId -> {qty, avgCost}
    return tx.map(t=>{
      const st = state.get(t.stockId) || {qty:0, avgCost:0};
      let realized = 0;
      if(t.type==='buy'){
        const amount = parseN(t.price)*parseN(t.qty);
        const newQty = st.qty + parseN(t.qty);
        const newCost = st.avgCost*st.qty + amount;
        st.qty = newQty; st.avgCost = newQty? newCost/newQty : 0;
      }else if(t.type==='sell'){
        realized = (parseN(t.price)-st.avgCost) * parseN(t.qty);
        st.qty -= parseN(t.qty);
      }else if(t.type==='fee'){
        const newCostBasis = st.avgCost*st.qty + parseN(t.amount);
        st.avgCost = st.qty? newCostBasis/st.qty : 0;
      }else if(t.type==='dividend'){
        realized = parseN(t.amount);
      }
      state.set(t.stockId, st);
      return {...t, realized};
    }).sort((a,b)=>new Date(b.time)-new Date(a.time));
  }

  // ========= Header KPI =========
  function refreshKPI(){
    const pos = computeAllPositions();
    const holdings = Object.values(pos).reduce((a,b)=>a + b.marketValue, 0);
    const cash = DB.accounts.reduce((a,acc)=> a + (parseN(acc.actual) + parseN(acc.settlement)), 0);
    const capitalAdjustments = sumCapitalAdjustments();
    const initialCapital = getInitialCapitalAmount();
    const totalAssets = holdings + cash;
    $('#kpi-total').textContent = fmtInt.format(Math.round(totalAssets));
    $('#kpi-cash').textContent = fmtInt.format(Math.round(cash));
    const netGain = totalAssets - initialCapital - capitalAdjustments;
    const investedCapital = initialCapital + capitalAdjustments;
    $('#kpi-net-gain').textContent = (netGain>=0? 'â–² ':'â–¼ ') + fmtInt.format(Math.round(Math.abs(netGain)));
    $('#kpi-net-gain').parentElement.querySelector('.label').style.color = netGain>=0? '#065f46' : '#991b1b';
    const returnRate = investedCapital !== 0 ? netGain / investedCapital : 0;
    $('#kpi-return').textContent = (returnRate>=0? 'â–² ':'â–¼ ') + Math.abs(returnRate*100).toFixed(2) + '%';
    $('#kpi-return').parentElement.querySelector('.label').style.color = returnRate>=0? '#065f46' : '#991b1b';
  }

  // ========= æ›´æ–°æœå°‹ä¸‹æ‹‰é¸å–® =========
  function updateSearchDropdown(){
    // æ›´æ–°æŒæœ‰æ¨™çš„é é¢çš„ç¯©é¸å™¨
    const select = $('#q');
    const currentValue = select.value;
    
    // ä¿ç•™ã€Œå…¨éƒ¨æ¨™çš„ã€é¸é …
    select.innerHTML = '<option value="">å…¨éƒ¨æ¨™çš„</option>';
    
    // è‡ªå®šç¾©æ’åºé †åº
    const customOrder = ['0050', '00878', '00923', '8215', '00646', '00687B', '00719B', '00772B'];
    const getSortIndex = (symbol) => {
      const index = customOrder.indexOf(symbol);
      return index >= 0 ? index : 999; // ä¸åœ¨åˆ—è¡¨ä¸­çš„è‚¡ç¥¨æ’åœ¨æœ€å¾Œ
    };
    
    // æ·»åŠ æ‰€æœ‰è‚¡ç¥¨ä»£ç¢¼é¸é …
    DB.stocks
      .sort((a,b)=> getSortIndex(a.symbol) - getSortIndex(b.symbol))
      .forEach(stock => {
        const option = document.createElement('option');
        option.value = stock.symbol;
        option.textContent = `${stock.symbol} Â· ${stock.name}`;
        select.appendChild(option);
      });
    
    // æ¢å¾©ä¹‹å‰é¸ä¸­çš„å€¼
    if(currentValue) {
      select.value = currentValue;
    }
    
    // æ›´æ–°ç•°å‹•ç´€éŒ„é é¢çš„æ¨™çš„ç¯©é¸å™¨
    const selectTxn = $('#q-txn');
    const currentValueTxn = selectTxn.value;
    
    // ä¿ç•™ã€Œå…¨éƒ¨æ¨™çš„ã€é¸é …
    selectTxn.innerHTML = '<option value="">å…¨éƒ¨æ¨™çš„</option>';
    
    // æ·»åŠ æ‰€æœ‰è‚¡ç¥¨ä»£ç¢¼é¸é …
    DB.stocks
      .sort((a,b)=> getSortIndex(a.symbol) - getSortIndex(b.symbol))
      .forEach(stock => {
        const option = document.createElement('option');
        option.value = stock.symbol;
        option.textContent = `${stock.symbol} Â· ${stock.name}`;
        selectTxn.appendChild(option);
      });
    
    // æ¢å¾©ä¹‹å‰é¸ä¸­çš„å€¼
    if(currentValueTxn) {
      selectTxn.value = currentValueTxn;
    }
  }

  // ========= Holdings è¡¨æ ¼ =========
  const holdingsSortDefaults = {
    category: 'asc',
    symbol: 'asc',
    name: 'asc',
    qty: 'desc',
    avgCost: 'desc',
    price: 'desc',
    marketValue: 'desc',
    stockPnl: 'desc',
    stockReturnPct: 'desc',
    dividends: 'desc',
    totalPnl: 'desc',
    totalReturnPct: 'desc'
  };
  let holdingsSort = { key: 'category', dir: 'asc' };
  
  // åˆ†é¡æ’åºé †åºï¼ˆèˆ‡å ±é…¬æª¢è¦–ä¸€è‡´ï¼‰
  const holdingsCategoryOrder = { 'å°ç£è‚¡ç¥¨': 1, 'ç¾åœ‹è‚¡ç¥¨': 2, 'ç¾åœ‹å‚µåˆ¸': 3, 'å°ç£å‚µåˆ¸': 4, 'å…¶ä»–': 5 };

  function getHoldingsSortValue(row, key){
    switch(key){
      case 'category': return holdingsCategoryOrder[row.category] || 999;
      case 'symbol': return (row.stock.symbol || '').toString();
      case 'name': return (row.stock.name || '').toString();
      case 'qty': return row.qty;
      case 'avgCost': return row.avgCost;
      case 'price': return row.currentPrice;
      case 'marketValue': return row.marketValue;
      case 'stockPnl': return row.stockPnlWithFees;
      case 'stockReturnPct': return row.stockReturnPct;
      case 'dividends': return row.dividends;
      case 'totalPnl': return row.totalPnlWithFees;
      case 'totalReturnPct': return row.totalReturnPct;
      default: return 0;
    }
  }

  function compareHoldingsRows(a,b){
    const {key, dir} = holdingsSort;
    const dirFactor = dir === 'asc' ? 1 : -1;
    
    // å…ˆæŒ‰åˆ†é¡æ’åºï¼ˆå°ç£è‚¡ç¥¨ â†’ ç¾åœ‹è‚¡ç¥¨ â†’ ç¾åœ‹å‚µåˆ¸ï¼‰
    const catA = holdingsCategoryOrder[a.category] || 999;
    const catB = holdingsCategoryOrder[b.category] || 999;
    if(catA !== catB) return catA - catB;
    
    // å†æŒ‰å¸‚å€¼é™åº
    const mvA = a.marketValue || 0;
    const mvB = b.marketValue || 0;
    if(mvA !== mvB) return mvB - mvA;
    
    // å¦‚æœä½¿ç”¨è€…é»æ“Šå…¶ä»–æ¬„ä½æ’åºï¼Œå‰‡æŒ‰è©²æ¬„ä½æ’åº
    if(key !== 'category'){
      const va = getHoldingsSortValue(a, key);
      const vb = getHoldingsSortValue(b, key);
      
      if(typeof va === 'string' || typeof vb === 'string'){
        const sa = (va ?? '').toString();
        const sb = (vb ?? '').toString();
        const cmp = sa.localeCompare(sb, 'zh-Hant', {numeric:true, sensitivity:'base'});
        if(cmp !== 0) return cmp * dirFactor;
      } else {
        const aNum = Number(va);
        const bNum = Number(vb);
        const safeA = Number.isFinite(aNum) ? aNum : (dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY);
        const safeB = Number.isFinite(bNum) ? bNum : (dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY);
        if(safeA !== safeB) return safeA > safeB ? dirFactor : -dirFactor;
      }
    }
    
    // æœ€å¾ŒæŒ‰è‚¡ç¥¨ä»£è™Ÿæ’åº
    return (a.stock.symbol || '').localeCompare(b.stock.symbol || '', 'zh-Hant', {numeric:true, sensitivity:'base'});
  }

  function updateHoldingsSortIndicators(){
    $$('#tbl-holdings thead th.sortable').forEach(th=>{
      th.classList.remove('sort-asc','sort-desc');
      th.removeAttribute('aria-sort');
      if(th.dataset.sort === holdingsSort.key){
        th.classList.add(holdingsSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.setAttribute('aria-sort', holdingsSort.dir === 'asc' ? 'ascending' : 'descending');
      }
    });
  }

  function computeStockMetrics(){
    const pos = computeAllPositions();
    return DB.stocks.map(s => {
      const p = pos[s.id] || { qty:0, avgCost:0, costBasis:0, marketValue:0, dividends:0 };
      const currentPrice = parseN(s.price);
      const currentValue = currentPrice * p.qty;
      const marketValue = Number.isFinite(p.marketValue) ? p.marketValue : currentValue;
      const buyFee = estimateFee(p.costBasis);
      const sellFee = estimateFee(currentValue);
      const totalFees = buyFee + sellFee;
      const stockPnlWithFees = currentValue - p.costBasis - totalFees;
      const totalPnlWithFees = stockPnlWithFees + p.dividends;
      const costBasisWithBuyFee = p.costBasis + buyFee;
      const stockReturnPct = costBasisWithBuyFee > 0 ? (stockPnlWithFees / costBasisWithBuyFee * 100) : 0;
      const totalReturnPct = costBasisWithBuyFee > 0 ? (totalPnlWithFees / costBasisWithBuyFee * 100) : 0;
      return {
        stock: s,
        pos: p,
        currentPrice,
        marketValue,
        stockPnlWithFees,
        stockReturnPct,
        totalPnlWithFees,
        totalReturnPct,
        dividends: p.dividends,
        avgCost: p.avgCost,
        qty: p.qty
      };
    });
  }

  const longTermSortDefaults = {
    symbol: 'asc',
    name: 'asc',
    allocation: 'desc',
    totalReturn: 'desc',
    contribution: 'desc',
    yield: 'desc'
  };
  let longTermSort = { key: 'allocation', dir: 'desc' };

  function getLongTermSortValue(row, key){
    switch(key){
      case 'symbol': return (row.stock.symbol || '').toString();
      case 'name': return (row.stock.name || '').toString();
      case 'allocation': return Number.isFinite(row.allocationRatio) ? row.allocationRatio : Number.NEGATIVE_INFINITY;
      case 'totalReturn': return Number.isFinite(row.totalReturnPct) ? row.totalReturnPct : Number.NEGATIVE_INFINITY;
      case 'contribution': return Number.isFinite(row.contributionRatio) ? row.contributionRatio : Number.NEGATIVE_INFINITY;
      case 'yield': return Number.isFinite(row.yieldPct) ? row.yieldPct : Number.NEGATIVE_INFINITY;
      default: return 0;
    }
  }

  function compareLongTermRows(a,b){
    const { key, dir } = longTermSort;
    const dirFactor = dir === 'asc' ? 1 : -1;
    const va = getLongTermSortValue(a, key);
    const vb = getLongTermSortValue(b, key);

    if(typeof va === 'string' || typeof vb === 'string'){
      const sa = (va ?? '').toString();
      const sb = (vb ?? '').toString();
      const cmp = sa.localeCompare(sb, 'zh-Hant', {numeric:true, sensitivity:'base'});
      if(cmp !== 0) return cmp * dirFactor;
      return (a.stock.symbol || '').localeCompare(b.stock.symbol || '', 'zh-Hant', {numeric:true, sensitivity:'base'});
    }

    const aNum = Number(va);
    const bNum = Number(vb);
    const safeA = Number.isFinite(aNum) ? aNum : (dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY);
    const safeB = Number.isFinite(bNum) ? bNum : (dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY);
    if(safeA === safeB){
      return (a.stock.symbol || '').localeCompare(b.stock.symbol || '', 'zh-Hant', {numeric:true, sensitivity:'base'});
    }
    return safeA > safeB ? dirFactor : -dirFactor;
  }

  function updateLongTermSortIndicators(){
    $$('#tbl-long-term thead th.sortable').forEach(th=>{
      th.classList.remove('sort-asc','sort-desc');
      th.removeAttribute('aria-sort');
      if(th.dataset.sort === longTermSort.key){
        th.classList.add(longTermSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.setAttribute('aria-sort', longTermSort.dir === 'asc' ? 'ascending' : 'descending');
      }
    });
  }

  function renderHoldings(){
    const tbody = $('#tbl-holdings tbody');
    tbody.innerHTML = '';
    const q = $('#q').value;
    
    const dataset = computeStockMetrics()
      .filter(row => !q || row.stock.symbol === q)
      .filter(row => row.qty > 0)
      .map(row => ({
        ...row,
        category: getStockCategory(row.stock)
      }));
    
    dataset.sort(compareHoldingsRows);
    
    // æ ¼å¼åŒ–æ•¸å­—ï¼šé»‘å­—æ­£å€¼ï¼Œç´…å­—è² å€¼
    const formatNum = (value, isPercent = false) => {
      if(!Number.isFinite(value)) return 'â€”';
      const color = value < 0 ? '#dc2626' : 'inherit';
      const formatted = isPercent 
        ? `${fmt2.format(value)}%`
        : fmtInt.format(Math.round(value));
      return `<span style="color:${color}">${formatted}</span>`;
    };
    
    for(const row of dataset){
      const s = row.stock;
      const tr = document.createElement('tr');
      tr.style.lineHeight = '1.2';
      
      // è¨­å®šèƒŒæ™¯è‰²ï¼šç¾åœ‹è‚¡ç¥¨æ·¡è—è‰²ï¼Œç¾åœ‹å‚µåˆ¸æ·¡ç´«è‰²
      if(row.category === 'ç¾åœ‹è‚¡ç¥¨'){
        tr.style.background = '#eff6ff';
      } else if(row.category === 'ç¾åœ‹å‚µåˆ¸'){
        tr.style.background = '#f5f3ff';
      }
      
      const qtyDisplay = Number.isFinite(row.qty) ? fmtInt.format(Math.round(row.qty)) : 'â€”';
      const avgCostDisplay = row.avgCost ? fmt2.format(row.avgCost) : 'â€”';
      const priceDisplay = Number.isFinite(row.currentPrice) ? fmt2.format(row.currentPrice) : 'â€”';
      const marketValueDisplay = Number.isFinite(row.marketValue) ? fmtInt.format(Math.round(row.marketValue)) : 'â€”';
      const dividendsDisplay = row.dividends > 0 ? fmtInt.format(Math.round(row.dividends)) : 'â€”';
      
      const stockPnlDisplay = formatNum(row.stockPnlWithFees);
      const stockReturnDisplay = formatNum(row.stockReturnPct, true);
      const totalPnlDisplay = formatNum(row.totalPnlWithFees);
      const totalReturnDisplay = formatNum(row.totalReturnPct, true);
      
      tr.innerHTML = `
        <td>${row.category}</td>
        <td><span class="badge blue">${s.symbol}</span></td>
        <td>${s.name||''}</td>
        <td class="num">${qtyDisplay}</td>
        <td class="num">${avgCostDisplay}</td>
        <td class="num">${priceDisplay}</td>
        <td class="num">${marketValueDisplay}</td>
        <td class="num">${stockPnlDisplay}</td>
        <td class="num">${stockReturnDisplay}</td>
        <td class="num">${dividendsDisplay}</td>
        <td class="num">${totalPnlDisplay}</td>
        <td class="num">${totalReturnDisplay}</td>
        <td class="num">
          <button class="btn mini" data-action="edit-stock" data-id="${s.id}">ç·¨è¼¯</button>
        </td>`;
      tbody.appendChild(tr);
    }
    
    updateHoldingsSortIndicators();
  }

  function renderLongTermMetrics(){
    const tbody = $('#tbl-long-term tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    
  const dataset = computeStockMetrics().filter(row => row.qty > 0);
    if(dataset.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="empty">å°šç„¡æ¨™çš„è³‡æ–™</td>`;
      tbody.appendChild(tr);
      updateLongTermSortIndicators();
      return;
    }

    const totalMarketValue = dataset.reduce((sum, row) => {
      const value = Number.isFinite(row.marketValue) ? row.marketValue : 0;
      return sum + value;
    }, 0);
    const totalPnlWithFees = dataset.reduce((sum, row) => {
      const value = Number.isFinite(row.totalPnlWithFees) ? row.totalPnlWithFees : 0;
      return sum + value;
    }, 0);
    const rows = dataset.map(row => {
      const allocationRatio = totalMarketValue > 0 ? row.marketValue / totalMarketValue : 0;
      const contributionRatio = totalPnlWithFees !== 0 ? (row.totalPnlWithFees / totalPnlWithFees * 100) : null;
      const dividendInfo = getCurrentDividendInfo(row.stock.symbol);
      const yieldValue = parseFloat(dividendInfo?.yield);
      const yieldPct = Number.isFinite(yieldValue) ? yieldValue : null;
      return {
        ...row,
        allocationRatio,
        contributionRatio,
        yieldPct
      };
    });

    const buildHighlightSets = (accessor) => {
      const entries = rows
        .map(r => ({ id: r.stock.id, value: accessor(r) }))
        .filter(entry => Number.isFinite(entry.value));
      if(entries.length === 0){
        return { max: new Set(), min: new Set() };
      }
      entries.sort((a,b)=> b.value - a.value);
      const maxSet = new Set(entries.slice(0, Math.min(3, entries.length)).map(entry => entry.id));
      entries.sort((a,b)=> a.value - b.value);
      const minSet = new Set(entries.slice(0, Math.min(3, entries.length)).map(entry => entry.id));
      return { max: maxSet, min: minSet };
    };

    const highlightMap = {
      allocation: buildHighlightSets(r => r.allocationRatio),
      totalReturn: buildHighlightSets(r => r.totalReturnPct),
      contribution: buildHighlightSets(r => r.contributionRatio),
      yield: buildHighlightSets(r => r.yieldPct)
    };

    const wrapHighlight = (text, metricKey, hasValue, id) => {
      if(!hasValue) return text;
      const entry = highlightMap[metricKey];
      if(!entry) return text;
      if(entry.max.has(id)){
        return `<span class="highlight-max">${text}</span>`;
      }
      if(entry.min.has(id) && !entry.max.has(id)){
        return `<span class="highlight-min">${text}</span>`;
      }
      return text;
    };

    rows.sort(compareLongTermRows);
    
    for(const row of rows){
      const allocationDisplayRaw = Number.isFinite(row.allocationRatio) ? `${fmt2.format(row.allocationRatio * 100)}%` : 'â€”';
      const totalReturnDisplayRaw = Number.isFinite(row.totalReturnPct) ? `${fmt2.format(row.totalReturnPct)}%` : 'â€”';
      const contributionDisplayRaw = Number.isFinite(row.contributionRatio) ? `${fmt2.format(row.contributionRatio)}%` : 'â€”';
      const yieldDisplayRaw = Number.isFinite(row.yieldPct) && row.yieldPct > 0 ? `${fmt2.format(row.yieldPct)}%` : 'â€”';

      const allocationDisplay = Number.isFinite(row.allocationRatio)
        ? wrapHighlight(allocationDisplayRaw, 'allocation', true, row.stock.id)
        : allocationDisplayRaw;
      const totalReturnDisplay = Number.isFinite(row.totalReturnPct)
        ? wrapHighlight(totalReturnDisplayRaw, 'totalReturn', true, row.stock.id)
        : totalReturnDisplayRaw;
      const contributionDisplay = Number.isFinite(row.contributionRatio)
        ? wrapHighlight(contributionDisplayRaw, 'contribution', true, row.stock.id)
        : contributionDisplayRaw;
      const yieldDisplay = Number.isFinite(row.yieldPct) && row.yieldPct > 0
        ? wrapHighlight(yieldDisplayRaw, 'yield', true, row.stock.id)
        : yieldDisplayRaw;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge blue">${row.stock.symbol}</span></td>
        <td>${row.stock.name || ''}</td>
        <td class="num">${allocationDisplay}</td>
        <td class="num">${totalReturnDisplay}</td>
        <td class="num">${contributionDisplay}</td>
        <td class="num">${yieldDisplay}</td>
      `;
      tbody.appendChild(tr);
    }

    updateLongTermSortIndicators();
  }

  // ========= å ±é…¬æª¢è¦– =========
  const returnSortDefaults = {
    category: 'asc',
    symbol: 'asc',
    name: 'asc',
    totalReturnPct: 'desc',
    allocation: 'desc',
    receivedDividend: 'desc',
    unrealizedPnl: 'desc',
    realizedPnl: 'desc',
    totalPnl: 'desc'
  };
  let returnSort = { key: 'category', dir: 'asc' };
  
  // åˆ†é¡æ’åºé †åºï¼šå°ç£è‚¡ç¥¨ â†’ ç¾åœ‹è‚¡ç¥¨ â†’ ç¾åœ‹å‚µåˆ¸
  const categoryOrder = { 'å°ç£è‚¡ç¥¨': 1, 'ç¾åœ‹è‚¡ç¥¨': 2, 'ç¾åœ‹å‚µåˆ¸': 3, 'å°ç£å‚µåˆ¸': 4, 'å…¶ä»–': 5 };

  function getReturnSortValue(row, key){
    switch(key){
      case 'category': return categoryOrder[row.category] || 999;
      case 'symbol': return (row.stock.symbol || '').toString();
      case 'name': return (row.stock.name || '').toString();
      case 'totalReturnPct': return Number.isFinite(row.totalReturnPct) ? row.totalReturnPct : Number.NEGATIVE_INFINITY;
      case 'allocation': return Number.isFinite(row.allocationRatio) ? row.allocationRatio : Number.NEGATIVE_INFINITY;
      case 'receivedDividend': return Number.isFinite(row.receivedDividend) ? row.receivedDividend : Number.NEGATIVE_INFINITY;
      case 'unrealizedPnl': return Number.isFinite(row.unrealizedPnl) ? row.unrealizedPnl : Number.NEGATIVE_INFINITY;
      case 'realizedPnl': return Number.isFinite(row.realizedPnl) ? row.realizedPnl : Number.NEGATIVE_INFINITY;
      case 'totalPnl': return Number.isFinite(row.totalPnl) ? row.totalPnl : Number.NEGATIVE_INFINITY;
      default: return 0;
    }
  }

  function compareReturnRows(a,b){
    const { key, dir } = returnSort;
    const dirFactor = dir === 'asc' ? 1 : -1;
    
    // å…ˆæŒ‰åˆ†é¡æ’åºï¼ˆå°ç£è‚¡ç¥¨ â†’ ç¾åœ‹è‚¡ç¥¨ â†’ ç¾åœ‹å‚µåˆ¸ï¼‰
    const catA = categoryOrder[a.category] || 999;
    const catB = categoryOrder[b.category] || 999;
    if(catA !== catB) return catA - catB;
    
    // å†æŒ‰æŠ•è³‡å æ¯”é™åºï¼ˆç›®å‰æŒæœ‰å„ªå…ˆï¼‰
    const allocA = a.isCurrentlyHeld ? (a.allocationRatio || 0) : -1;
    const allocB = b.isCurrentlyHeld ? (b.allocationRatio || 0) : -1;
    if(allocA !== allocB) return allocB - allocA;
    
    // å¦‚æœä½¿ç”¨è€…é»æ“Šå…¶ä»–æ¬„ä½æ’åºï¼Œå‰‡æŒ‰è©²æ¬„ä½æ’åº
    if(key !== 'category'){
      const va = getReturnSortValue(a, key);
      const vb = getReturnSortValue(b, key);

      if(typeof va === 'string' || typeof vb === 'string'){
        const sa = (va ?? '').toString();
        const sb = (vb ?? '').toString();
        const cmp = sa.localeCompare(sb, 'zh-Hant', {numeric:true, sensitivity:'base'});
        if(cmp !== 0) return cmp * dirFactor;
      } else {
        const aNum = Number(va);
        const bNum = Number(vb);
        const safeA = Number.isFinite(aNum) ? aNum : (dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY);
        const safeB = Number.isFinite(bNum) ? bNum : (dir === 'asc' ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY);
        if(safeA !== safeB) return safeA > safeB ? dirFactor : -dirFactor;
      }
    }
    
    // æœ€å¾ŒæŒ‰è‚¡ç¥¨ä»£è™Ÿæ’åº
    return (a.stock.symbol || '').localeCompare(b.stock.symbol || '', 'zh-Hant', {numeric:true, sensitivity:'base'});
  }

  function updateReturnSortIndicators(){
    $$('#tbl-return thead th.sortable').forEach(th=>{
      th.classList.remove('sort-asc','sort-desc');
      th.removeAttribute('aria-sort');
      if(th.dataset.sort === returnSort.key){
        th.classList.add(returnSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.setAttribute('aria-sort', returnSort.dir === 'asc' ? 'ascending' : 'descending');
      }
    });
  }

  // è¨ˆç®—æ¯æª”è‚¡ç¥¨çš„å·²å¯¦ç¾æç›Šï¼ˆå«æ¯ï¼‰
  function computeRealizedPnlByStock(){
    const realizedMap = {};
    const txList = computeTxnRealizedList();
    for(const t of txList){
      const stockId = t.stockId;
      if(!realizedMap[stockId]){
        realizedMap[stockId] = 0;
      }
      // å·²å¯¦ç¾æç›ŠåŒ…å«ï¼šè³£å‡ºæç›Š + è‚¡æ¯æ”¶å…¥
      if(t.type === 'sell' || t.type === 'dividend'){
        realizedMap[stockId] += Number.isFinite(t.realized) ? t.realized : 0;
      }
    }
    return realizedMap;
  }

  // è¨ˆç®—æ¯æª”è‚¡ç¥¨çš„æ­·å²ç¸½æŠ•å…¥æˆæœ¬ï¼ˆæ‰€æœ‰è²·å…¥é‡‘é¡ + æ‰‹çºŒè²»ï¼‰
  function computeTotalCostByStock(){
    const costMap = {};
    for(const t of DB.txns){
      const stockId = t.stockId;
      if(!costMap[stockId]){
        costMap[stockId] = 0;
      }
      if(t.type === 'buy'){
        const amount = parseN(t.price) * parseN(t.qty);
        costMap[stockId] += amount;
      } else if(t.type === 'fee'){
        costMap[stockId] += parseN(t.amount);
      }
    }
    // åŠ ä¸Šä¼°ç®—æ‰‹çºŒè²»
    for(const stockId in costMap){
      costMap[stockId] += estimateFee(costMap[stockId]);
    }
    return costMap;
  }

  // å–å¾—è‚¡ç¥¨åˆ†é¡åç¨±
  function getStockCategory(stock){
    const market = stock.market || 'TW';
    const assetClass = stock.assetClass || 'Equity';
    if(market === 'TW' && assetClass === 'Equity') return 'å°ç£è‚¡ç¥¨';
    if(market === 'Global' && assetClass === 'Equity') return 'ç¾åœ‹è‚¡ç¥¨';
    if(market === 'Global' && assetClass === 'Bond') return 'ç¾åœ‹å‚µåˆ¸';
    if(market === 'TW' && assetClass === 'Bond') return 'å°ç£å‚µåˆ¸';
    return 'å…¶ä»–';
  }

  // å–å¾—åˆ†é¡å°æ‡‰çš„ badge æ¨£å¼
  function getCategoryBadgeClass(category){
    switch(category){
      case 'å°ç£è‚¡ç¥¨': return 'badge blue';
      case 'ç¾åœ‹è‚¡ç¥¨': return 'badge green';
      case 'ç¾åœ‹å‚µåˆ¸': return 'badge gray';
      case 'å°ç£å‚µåˆ¸': return 'badge neutral';
      default: return 'badge neutral';
    }
  }

  async function renderReturnOverview(){
    const tbody = $('#tbl-return tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    
    // å–å¾—æ‰€æœ‰è‚¡ç¥¨çš„æŒ‡æ¨™ï¼ˆåŒ…å«ç›®å‰æŒæœ‰å’Œæ›¾ç¶“æŒæœ‰ï¼‰
    const allMetrics = computeStockMetrics();
    
    // æ‰¾å‡ºæ›¾ç¶“æœ‰äº¤æ˜“è¨˜éŒ„çš„è‚¡ç¥¨ ID
    const heldStockIds = new Set(DB.txns.map(t => t.stockId));
    
    // ç¯©é¸ï¼šç›®å‰æŒæœ‰ æˆ– æ›¾ç¶“æŒæœ‰éï¼ˆæœ‰äº¤æ˜“è¨˜éŒ„ï¼‰
    const metrics = allMetrics.filter(row => row.qty > 0 || heldStockIds.has(row.stock.id));
    
    if(metrics.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="9" class="empty">å°šç„¡æŒæœ‰æˆ–æ›¾æŒæœ‰æ¨™çš„</td>`;
      tbody.appendChild(tr);
      updateReturnSortIndicators();
      return;
    }

    // è¨ˆç®—ç¸½å¸‚å€¼ç”¨æ–¼æŠ•è³‡å æ¯”ï¼ˆåªè¨ˆç®—ç›®å‰æŒæœ‰çš„ï¼‰
    const totalMarketValue = metrics.reduce((sum, row) => {
      if(row.qty <= 0) return sum;
      const value = Number.isFinite(row.marketValue) ? row.marketValue : 0;
      return sum + value;
    }, 0);

    // å–å¾—å·²å¯¦ç¾æç›Š
    const realizedMap = computeRealizedPnlByStock();
    
    // å–å¾—æ­·å²ç¸½æŠ•å…¥æˆæœ¬
    const totalCostMap = computeTotalCostByStock();

    // å»ºç«‹è¡Œè³‡æ–™
    const rows = [];
    for(const row of metrics){
      const isCurrentlyHeld = row.qty > 0;
      const allocationRatio = (isCurrentlyHeld && totalMarketValue > 0) ? row.marketValue / totalMarketValue : 0;
      
      // åˆ†é¡
      const category = getStockCategory(row.stock);
      
      // å·²é ˜è‚¡æ¯
      const receivedDividend = row.dividends || 0;

      // æœªå¯¦ç¾æç›Šï¼ˆä¸å«æ¯ï¼‰= è‚¡ç¥¨æç›Šï¼ˆæœªæŒæœ‰æ™‚ç‚º 0ï¼‰
      const unrealizedPnl = isCurrentlyHeld ? row.stockPnlWithFees : 0;

      // å·²å¯¦ç¾æç›Šï¼ˆå«æ¯ï¼‰= è³£å‡ºæç›Š + å·²é ˜è‚¡æ¯
      const realizedPnl = realizedMap[row.stock.id] || 0;

      // ç¶œåˆå«æ¯å ±é…¬ç‡ = (æœªå¯¦ç¾æç›Š + å·²å¯¦ç¾æç›Š) Ã· æ­·å²ç¸½æŠ•å…¥æˆæœ¬ Ã— 100%
      const totalCost = totalCostMap[row.stock.id] || 0;
      const combinedPnl = unrealizedPnl + realizedPnl;
      const combinedReturnPct = totalCost > 0 ? (combinedPnl / totalCost * 100) : 0;

      rows.push({
        stock: row.stock,
        category,
        totalReturnPct: combinedReturnPct,
        allocationRatio,
        receivedDividend,
        unrealizedPnl,
        realizedPnl,
        totalPnl: combinedPnl,
        marketValue: row.marketValue,
        qty: row.qty,
        isCurrentlyHeld
      });
    }

    // æ’åº
    rows.sort(compareReturnRows);

    // æ¸²æŸ“è¡¨æ ¼
    for(const row of rows){
      const tr = document.createElement('tr');
      tr.style.lineHeight = '1.2';
      
      // è¨­å®šèƒŒæ™¯è‰²ï¼šç¾åœ‹è‚¡ç¥¨æ·¡è—è‰²ï¼ŒæœªæŒæœ‰æ·¡ç°è‰²
      if(row.category === 'ç¾åœ‹è‚¡ç¥¨'){
        tr.style.background = '#eff6ff';
      } else if(row.category === 'ç¾åœ‹å‚µåˆ¸'){
        tr.style.background = '#f5f3ff';
      }
      
      // æœªæŒæœ‰çš„è‚¡ç¥¨åŠ ä¸Šæ›´æ·¡çš„ç°è‰²å­—é«”
      const textColor = row.isCurrentlyHeld ? 'inherit' : '#9ca3af';
      if(!row.isCurrentlyHeld){
        tr.style.color = '#9ca3af';
        if(row.category !== 'ç¾åœ‹è‚¡ç¥¨' && row.category !== 'ç¾åœ‹å‚µåˆ¸'){
          tr.style.background = '#fafafa';
        }
      }

      // æ ¼å¼åŒ–æ•¸å­—ï¼šæŒæœ‰è‚¡ç¥¨é»‘å­—æ­£å€¼/ç´…å­—è² å€¼ï¼ŒæœªæŒæœ‰è‚¡ç¥¨æ·¡ç°è‰²
      const formatValue = (value, isPercent = false) => {
        if(!Number.isFinite(value)) return 'â€”';
        let color;
        if(!row.isCurrentlyHeld){
          color = '#9ca3af'; // æœªæŒæœ‰è‚¡ç¥¨å…¨éƒ¨æ·¡ç°è‰²
        } else {
          color = value < 0 ? '#dc2626' : 'inherit'; // æŒæœ‰è‚¡ç¥¨ï¼šè² å€¼ç´…è‰²ï¼Œæ­£å€¼é»‘è‰²
        }
        const formatted = isPercent 
          ? `${fmt2.format(value)}%`
          : fmtInt.format(Math.round(value));
        return `<span style="color:${color}">${formatted}</span>`;
      };

      // åˆ†é¡
      const categoryDisplay = row.category;
      
      // å«æ¯å ±é…¬ç‡
      const totalReturnDisplay = Number.isFinite(row.totalReturnPct)
        ? formatValue(row.totalReturnPct, true)
        : 'â€”';

      // æŠ•è³‡å æ¯”
      const allocationDisplay = row.isCurrentlyHeld && Number.isFinite(row.allocationRatio)
        ? `${fmt2.format(row.allocationRatio * 100)}%`
        : 'â€”';

      // å·²é ˜è‚¡æ¯
      const receivedDividendDisplay = row.receivedDividend > 0
        ? formatValue(row.receivedDividend)
        : 'â€”';

      // æœªå¯¦ç¾æç›Šï¼ˆä¸å«æ¯ï¼‰
      const unrealizedPnlDisplay = row.isCurrentlyHeld && Number.isFinite(row.unrealizedPnl)
        ? formatValue(row.unrealizedPnl)
        : 'â€”';

      // å·²å¯¦ç¾æç›Šï¼ˆå«æ¯ï¼‰
      const realizedPnlDisplay = Number.isFinite(row.realizedPnl) && row.realizedPnl !== 0
        ? formatValue(row.realizedPnl)
        : 'â€”';

      // ç¸½æç›Š
      const totalPnlDisplay = Number.isFinite(row.totalPnl) && row.totalPnl !== 0
        ? formatValue(row.totalPnl)
        : 'â€”';

      tr.innerHTML = `
        <td>${categoryDisplay}</td>
        <td><span class="badge blue">${row.stock.symbol}</span></td>
        <td>${row.stock.name || ''}</td>
        <td class="num">${allocationDisplay}</td>
        <td class="num">${receivedDividendDisplay}</td>
        <td class="num">${unrealizedPnlDisplay}</td>
        <td class="num">${realizedPnlDisplay}</td>
        <td class="num">${totalPnlDisplay}</td>
        <td class="num">${totalReturnDisplay}</td>
      `;
      tbody.appendChild(tr);
    }

    updateReturnSortIndicators();
  }

  // å ±é…¬æª¢è¦–è¡¨é ­æ’åºäº‹ä»¶
  const returnHead = $('#tbl-return thead');
  if(returnHead){
    returnHead.addEventListener('click', (event)=>{
      const th = event.target.closest('th.sortable');
      if(!th) return;
      const key = th.dataset.sort;
      if(!key) return;
      if(returnSort.key === key){
        returnSort.dir = returnSort.dir === 'asc' ? 'desc' : 'asc';
      }else{
        returnSort.key = key;
        returnSort.dir = returnSortDefaults[key] || 'desc';
      }
      renderReturnOverview();
    });
  }

  $('#tbl-holdings thead').addEventListener('click', (event)=>{
    const th = event.target.closest('th.sortable');
    if(!th) return;
    const key = th.dataset.sort;
    if(!key) return;
    if(holdingsSort.key === key){
      holdingsSort.dir = holdingsSort.dir === 'asc' ? 'desc' : 'asc';
    }else{
      holdingsSort.key = key;
      holdingsSort.dir = holdingsSortDefaults[key] || 'desc';
    }
    renderHoldings();
  });

  const longTermHead = $('#tbl-long-term thead');
  if(longTermHead){
    longTermHead.addEventListener('click', (event)=>{
      const th = event.target.closest('th.sortable');
      if(!th) return;
      const key = th.dataset.sort;
      if(!key) return;
      if(longTermSort.key === key){
        longTermSort.dir = longTermSort.dir === 'asc' ? 'desc' : 'asc';
      }else{
        longTermSort.key = key;
        longTermSort.dir = longTermSortDefaults[key] || 'desc';
      }
      renderLongTermMetrics();
    });
  }

  function renderTxnMonthlySummary(filteredRows){
    const tbody = $('#tbl-txn-monthly tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    if(!filteredRows || filteredRows.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="empty">å°šç„¡è²·è³£è³‡æ–™</td>`;
      tbody.appendChild(tr);
      return;
    }

    const summaryMap = new Map();

    for(const { txn, stock } of filteredRows){
      if(!txn || (txn.type !== 'buy' && txn.type !== 'sell')) continue;
      const date = new Date(txn.time);
      if(Number.isNaN(date.getTime())) continue;
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const monthId = `${year}-${String(month).padStart(2,'0')}`;
      const key = `${monthId}|${stock?.symbol || 'unknown'}`;
      if(!summaryMap.has(key)){
        summaryMap.set(key, {
          monthId,
          monthLabel: `${year}å¹´${String(month).padStart(2,'0')}æœˆ`,
          symbol: stock?.symbol || 'â€”',
          name: stock?.name || '',
          buyTotal: 0,
          sellTotal: 0
        });
      }
      const entry = summaryMap.get(key);
      const qty = Math.abs(parseN(txn.qty));
      const price = parseN(txn.price);
      const amountByPrice = price > 0 && qty > 0 ? price * qty : 0;
      const amountFallback = Math.abs(parseN(txn.amount));
      const amount = amountByPrice > 0 ? amountByPrice : amountFallback;
      if(txn.type === 'buy'){
        entry.buyTotal += amount;
      }else if(txn.type === 'sell'){
        entry.sellTotal += amount;
      }
    }

    const summaryRows = Array.from(summaryMap.values())
      .filter(entry => entry.buyTotal > 0 || entry.sellTotal > 0)
      .sort((a,b)=> b.monthId.localeCompare(a.monthId) || (a.symbol || '').localeCompare(b.symbol || ''));

    if(summaryRows.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="empty">å°šç„¡è²·è³£è³‡æ–™</td>`;
      tbody.appendChild(tr);
      return;
    }

    const monthGroups = new Map();
    for(const row of summaryRows){
      if(!monthGroups.has(row.monthId)){
        monthGroups.set(row.monthId, {
          monthId: row.monthId,
          monthLabel: row.monthLabel,
          rows: [],
          totalBuy: 0,
          totalSell: 0
        });
      }
      const group = monthGroups.get(row.monthId);
      group.rows.push(row);
      group.totalBuy += row.buyTotal;
      group.totalSell += row.sellTotal;
    }

    const orderedMonths = Array.from(monthGroups.values())
      .sort((a,b)=> b.monthId.localeCompare(a.monthId));

    for(const group of orderedMonths){
      group.rows.sort((a,b)=> (a.symbol || '').localeCompare(b.symbol || '', 'zh-Hant', {numeric:true, sensitivity:'base'}));
      const rowCount = group.rows.length;
      group.rows.forEach((row, idx)=>{
        const symbolLabel = row.symbol && row.symbol !== 'â€”'
          ? `<span class="badge blue">${row.symbol}</span> ${row.name || ''}`
          : (row.name || row.symbol || 'â€”');
        const buyCell = row.buyTotal > 0 ? fmtInt.format(Math.round(row.buyTotal)) : 'â€”';
        const sellCell = row.sellTotal > 0 ? fmtInt.format(Math.round(row.sellTotal)) : 'â€”';
        const cells = [];
        if(idx === 0){
          cells.push(`<td rowspan="${rowCount}">${group.monthLabel}</td>`);
        }
        cells.push(`<td>${symbolLabel}</td>`);
        cells.push(`<td class="num">${buyCell}</td>`);
        cells.push(`<td class="num">${sellCell}</td>`);
        if(idx === 0){
          const totalBuyCell = group.totalBuy > 0 ? fmtInt.format(Math.round(group.totalBuy)) : 'â€”';
          const totalSellCell = group.totalSell > 0 ? fmtInt.format(Math.round(group.totalSell)) : 'â€”';
          cells.push(`<td class="num" rowspan="${rowCount}">${totalBuyCell}</td>`);
          cells.push(`<td class="num" rowspan="${rowCount}">${totalSellCell}</td>`);
        }
        const tr = document.createElement('tr');
        tr.innerHTML = cells.join('');
        tbody.appendChild(tr);
      });
    }
  }

  // ========= äº¤æ˜“è¡¨æ ¼ =========
  function renderTxns(){
    const tbody = $('#tbl-txns tbody');
    tbody.innerHTML = '';
    const typeNames = { buy:'è²·å…¥', sell:'è³£å‡º', dividend:'è‚¡æ¯', fee:'æ‰‹çºŒè²»' };
    const accountNames = { ctbc:'ä¸­åœ‹ä¿¡è¨—', sinopac:'æ°¸è±éŠ€è¡Œ' };

    const rows = computeTxnRealizedList();
    const q = $('#q-txn').value; // å–å¾—ç•°å‹•ç´€éŒ„é é¢çš„è‚¡ç¥¨ç¯©é¸å™¨å€¼
    const globalFilter = $('#q').value; // å–å¾—é ‚éƒ¨æœå°‹ä¸‹æ‹‰çš„ç¯©é¸çµæœ
    const typeFilter = $('#type-filter').value; // å–å¾—é¡å‹ç¯©é¸å™¨å€¼
    const targetSymbol = q || globalFilter;

    const filteredRows = [];
    for(const t of rows){
      const stock = DB.stocks.find(s => s.id === t.stockId);
      if(targetSymbol){
        if(!stock || stock.symbol !== targetSymbol){
          continue;
        }
      }
      if(typeFilter && t.type !== typeFilter) continue;
      filteredRows.push({ txn: t, stock });
    }

    renderTxnMonthlySummary(filteredRows);

    if(filteredRows.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="14" class="empty">å°šç„¡ç•°å‹•ç´€éŒ„</td>`;
      tbody.appendChild(tr);
      return;
    }
    
    for(const { txn: t, stock } of filteredRows){
      const tr = document.createElement('tr');
      const stockCost = t.amount || 0;
      const buyFee = estimateFee(stockCost);
      const holdingCost = stockCost + buyFee;
      const currentPrice = stock ? parseN(stock.price) : 0;
      const currentValue = currentPrice * parseN(t.qty);
      const sellFee = estimateFee(currentValue);
      const estimatedPnl = (t.type === 'buy' || t.type === 'sell') ? (currentValue - holdingCost - sellFee) : 0;
      const estimatedReturn = holdingCost > 0 ? (estimatedPnl / holdingCost * 100) : 0;
      const actualPnl = Number.isFinite(t.realized)? t.realized : 0;
      const actualReturn = holdingCost > 0 ? (actualPnl / holdingCost * 100) : 0;

      tr.innerHTML = `
        <td>${new Date(t.time).toLocaleDateString('zh-TW')}</td>
        <td>${stock ? stock.symbol : 'æœªçŸ¥æ¨™çš„'}</td>
        <td>${accountNames[t.account] || t.account || 'â€”'}</td>
        <td>${typeNames[t.type] || t.type}</td>
        <td class="num">${t.price ? fmt2.format(t.price) : 'â€”'}</td>
        <td class="num">${t.qty ? fmtInt.format(Math.round(t.qty)) : 'â€”'}</td>
        <td class="num">${t.amount ? fmtInt.format(Math.round(t.amount)) : 'â€”'}</td>
        <td class="num">${(t.type==='buy'||t.type==='sell')? fmtInt.format(Math.round(holdingCost)) : 'â€”'}</td>
        <td class="num">${(t.type==='buy'||t.type==='sell')
          ? (estimatedPnl > 0 ? '<span class="badge green">â–² '+fmtInt.format(Math.round(estimatedPnl))+'</span>'
            : estimatedPnl < 0 ? '<span class="badge red">â–¼ '+fmtInt.format(Math.round(Math.abs(estimatedPnl)))+'</span>'
            : '<span class="badge gray">0</span>')
          : 'â€”'}</td>
        <td class="num">${(t.type==='buy'||t.type==='sell')
          ? (estimatedReturn > 0 ? '<span class="badge green">â–² '+estimatedReturn.toFixed(1)+'%</span>'
            : estimatedReturn < 0 ? '<span class="badge red">â–¼ '+Math.abs(estimatedReturn).toFixed(1)+'%</span>'
            : '<span class="badge gray">0.0%</span>')
          : 'â€”'}</td>
        <td class="num">${Number.isFinite(actualPnl)
          ? (actualPnl > 0 ? '<span class="badge green">â–² '+fmtInt.format(Math.round(actualPnl))+'</span>'
            : actualPnl < 0 ? '<span class="badge red">â–¼ '+fmtInt.format(Math.round(Math.abs(actualPnl)))+'</span>'
            : '<span class="badge gray">0</span>')
          : 'â€”'}</td>
        <td class="num">${Number.isFinite(actualReturn)
          ? (actualReturn > 0 ? '<span class="badge green">â–² '+actualReturn.toFixed(1)+'%</span>'
            : actualReturn < 0 ? '<span class="badge red">â–¼ '+Math.abs(actualReturn).toFixed(1)+'%</span>'
            : '<span class="badge gray">0.0%</span>')
          : 'â€”'}</td>
        <td>${t.note || ''}</td>
        <td class="num">
          <button class="btn mini" data-id="${t.id}" data-action="edit-txn">ç·¨è¼¯</button>
          <button class="btn mini danger" data-id="${t.id}" data-action="del-txn">åˆªé™¤</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ========= å¸³æˆ¶ =========
  function renderAccounts(){
    const box = $('#accounts-list');
    const cashBox = $('#invest-cash-log');
    const investSelect = $('#invest-log-account');
    const investBtn = $('#btn-add-invest-log');
    if(box){ box.innerHTML=''; }
    if(cashBox){ cashBox.innerHTML=''; }

    const hasAccounts = DB.accounts.length>0;

    if(investSelect){
      const prev = investSelect.value;
      if(!hasAccounts){
        investSelect.innerHTML = '<option value="">å°šç„¡å¸³æˆ¶</option>';
        investSelect.disabled = true;
      }else{
        investSelect.innerHTML = DB.accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
        investSelect.disabled = false;
        if(prev && DB.accounts.some(a=>a.id===prev)){ investSelect.value = prev; }
        else{ investSelect.value = DB.accounts[0].id; }
      }
    }
    if(investBtn){ investBtn.disabled = !hasAccounts; }

    const depositLogs = [];
    const initialEntry = ensureInitialCapitalEntry();
    if(initialEntry){
      depositLogs.push({
        account: 'èµ·å§‹æŠ•å…¥',
        accountId: null,
        time: initialEntry.time || '',
        note: initialEntry.note || 'èµ·å§‹æŠ•å…¥',
        amount: parseN(initialEntry.amount),
        historyIndex: null,
        source: 'initial'
      });
    }

    // è¨ˆç®—ç¸½æŠ•è³‡ç¾é‡‘
    let totalInvestmentCash = initialEntry ? parseN(initialEntry.amount) : 0;

    for(const a of DB.accounts){
      const available = parseN(a.actual) + parseN(a.settlement);
      const capitalTotal = (a.history||[]).reduce((sum, entry)=>{
        if(entry && (entry.type==='deposit' || entry.type==='withdraw')){
          return sum + parseN(entry.amount);
        }
        return sum;
      }, 0);
      totalInvestmentCash += capitalTotal;
      
      const card = document.createElement('div');
      card.style.cssText = 'flex:1; min-width:200px; padding:16px; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);';
      card.innerHTML = `
        <div style="margin-bottom:12px;">
          <div class="brand" style="font-size:20px; font-weight:700; margin-bottom:8px;">${a.name}</div>
          <div style="font-size:18px; font-weight:600; color:#b91c1c; margin-bottom:10px;">å¯ç”¨é¤˜é¡ï¼š${fmtInt.format(Math.round(available))}</div>
          <div class="account-stat">å¯¦éš›ï¼š<strong>${fmtInt.format(Math.round(parseN(a.actual)))}</strong></div>
          <div class="account-stat">äº¤å‰²ï¼š<strong>${fmtInt.format(Math.round(parseN(a.settlement)))}</strong></div>
          <div class="account-stat">å¢æ¸›è³‡ï¼š<strong>${fmtInt.format(Math.round(capitalTotal))}</strong></div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button class="btn mini" data-action="edit-account" data-id="${a.id}">ç·¨è¼¯</button>
          <button class="btn mini" data-action="capital-change" data-id="${a.id}">å¢æ¸›è³‡</button>
          <button class="btn mini danger" data-action="del-account" data-id="${a.id}">åˆªé™¤</button>
        </div>`;
      box.appendChild(card);
      (a.history||[]).forEach((entry, idx)=>{
        if(entry && entry.type==='deposit'){
          depositLogs.push({
            account: a.name,
            accountId: a.id,
            time: entry.time || '',
            note: entry.note || '',
            amount: parseN(entry.amount),
            historyIndex: idx,
            source: 'history'
          });
        }
      });
    }

    // æ–°å¢ç¸½æŠ•è³‡ç¾é‡‘å¡ç‰‡
    const totalCard = document.createElement('div');
    totalCard.style.cssText = 'flex:1; min-width:200px; padding:16px; background:#e0f2fe; border:1px solid #bae6fd; border-radius:12px; box-shadow:var(--shadow);';
    totalCard.innerHTML = `
      <div style="margin-bottom:12px;">
        <div class="brand" style="font-size:20px; font-weight:700; margin-bottom:8px;">ç¸½æŠ•è³‡ç¾é‡‘</div>
        <div style="font-size:22px; font-weight:700; color:#0369a1; margin-bottom:10px;">${fmtInt.format(Math.round(totalInvestmentCash))}</div>
        <div class="account-stat" style="color:#6b7280;">èµ·å§‹æŠ•å…¥ + å„å¸³æˆ¶å¢æ¸›è³‡ç¸½å’Œ</div>
      </div>`;
    box.appendChild(totalCard);
    if(cashBox){
      if(depositLogs.length===0){
        cashBox.innerHTML = `<div class="empty">å°šç„¡æŠ•è³‡ç¾é‡‘ç´€éŒ„</div>`;
      }else{
        depositLogs.sort((a,b)=> new Date(b.time||0) - new Date(a.time||0));
        const rows = depositLogs.map(log=>{
          const ts = log.time ? new Date(log.time).toLocaleDateString('zh-TW') : 'â€”';
          const amt = fmtInt.format(Math.round(log.amount));
          const note = log.note || '';
          const isInitial = log.source === 'initial';
          return `<tr>
            <td>${ts}</td>
            <td>${log.account}</td>
            <td class="num">${amt}</td>
            <td>${note}</td>
            <td class="num">
              <button class="btn mini" data-action="edit-invest-log" data-source="${log.source||'history'}" ${isInitial ? '' : `data-account-id="${log.accountId}" data-history-index="${log.historyIndex}"`}>ç·¨è¼¯</button>
              ${isInitial ? '' : `<button class="btn mini danger" data-action="del-invest-log" data-source="history" data-account-id="${log.accountId}" data-history-index="${log.historyIndex}">åˆªé™¤</button>`}
            </td>
          </tr>`;
        }).join('');
        cashBox.innerHTML = `
          <table style="width:100%">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>å¸³æˆ¶</th>
                <th class="num">æŠ•å…¥é‡‘é¡</th>
                <th>å‚™è¨»</th>
                <th class="num">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      }
    }
  }

  // ========= è³‡ç”¢æˆæœ =========
  function renderSnapshots(){
    const tbody = $('#tbl-snapshots tbody'); tbody.innerHTML='';
    const list = DB.snapshots.slice().sort((a,b)=> a.date<b.date?1:-1);
    if(list.length===0){ 
      tbody.innerHTML = `<tr><td colspan="8" class="empty">å°šç„¡ç´€éŒ„</td></tr>`; 
      const changeContainer = $('#change-chart-svg-container');
      if(changeContainer){ changeContainer.innerHTML = '<div class="empty">å°šç„¡è³‡æ–™</div>'; }
      const totalContainer = $('#chart-svg-container');
      if(totalContainer){ totalContainer.innerHTML = '<div class="empty">å°šç„¡è³‡æ–™</div>'; }
      const summaryEl = $('#summary-change');
      if(summaryEl){ summaryEl.textContent = 'â€”'; }
      return; 
    }
    
    // æº–å‚™åœ–è¡¨è³‡æ–™
    const chartData = [];
    const initialCapital = getInitialCapitalAmount();
    
    for(let i = 0; i < list.length; i++){
      const s = list[i];
      const currentTotal = parseN(s.total);
      
      // è¨ˆç®—èˆ‡å‰ä¸€ç­†çš„å·®ç•°ï¼ˆæŒ‰æ—¥æœŸæ’åºï¼Œæ‰¾æœ€è¿‘çš„è¼ƒæ—©æ—¥æœŸï¼‰
      let deltaAmt = 0;
      let deltaPct = 0;
      
      if(i < list.length - 1) { // ä¸æ˜¯æœ€å¾Œä¸€ç­†ï¼ˆæœ€æ–°çš„ï¼‰
        const prevSnapshot = list[i + 1]; // å‰ä¸€ç­†è¨˜éŒ„
        const prevTotal = parseN(prevSnapshot.total);
        deltaAmt = currentTotal - prevTotal;
        deltaPct = prevTotal > 0 ? (deltaAmt / prevTotal) : 0;
      }
      
      const capitalAdjustmentsToDate = sumCapitalAdjustments(s.date);
      const investedCapitalToDate = initialCapital + capitalAdjustmentsToDate;
      const cumulativeChange = currentTotal - investedCapitalToDate;
      // æ”¶é›†åœ–è¡¨è³‡æ–™ï¼ˆåè½‰é †åºï¼Œè®“æœ€æ—©çš„æ—¥æœŸåœ¨å·¦é‚Šï¼‰
      chartData.unshift({
        date: s.date,
        deltaAmt: deltaAmt,
        deltaPct: deltaPct,
        totalAsset: currentTotal,
        cumulativeChange,
        investedCapital: investedCapitalToDate
      });
      
      const tr = document.createElement('tr');
      const cumulativeText = cumulativeChange>=0
        ? 'â–² '+fmtInt.format(Math.round(cumulativeChange))
        : 'â–¼ '+fmtInt.format(Math.round(Math.abs(cumulativeChange)));
      tr.innerHTML = `
        <td>${s.date}</td>
        <td class="num">${fmtInt.format(Math.round(parseN(s.holdings)))}</td>
        <td class="num">${fmtInt.format(Math.round(parseN(s.cash)))}</td>
        <td class="num">${fmtInt.format(Math.round(currentTotal))}</td>
        <td class="num">${deltaAmt>=0? 'â–² '+fmtInt.format(Math.round(deltaAmt)): 'â–¼ '+fmtInt.format(Math.round(Math.abs(deltaAmt)))}</td>
        <td class="num">${deltaPct>=0? '+'+ (deltaPct*100).toFixed(2)+'%': (deltaPct*100).toFixed(2)+'%'}</td>
        <td class="num">${cumulativeText}</td>
        <td class="num">
          <button class="btn mini" type="button" data-id="${s.date}" data-action="edit-snapshot" onclick="handleSnapshotAction('edit', '${s.date}')">ç·¨è¼¯</button>
          <button class="btn mini danger" type="button" data-id="${s.date}" data-action="del-snapshot" onclick="handleSnapshotAction('delete', '${s.date}')">åˆªé™¤</button>
        </td>`;
      tbody.appendChild(tr);
    }
    
    // æ¸²æŸ“ Highcharts æŠ˜ç·šåœ–
    renderSnapshotChangeChart(chartData);
    renderSnapshotChart(chartData);
  }

  function handleSnapshotAction(action, date){
    if(!date) return;
    const snapshot = DB.snapshots.find(s=>s.date===date);
    if(action === 'edit'){
      if(snapshot){ openSnapshotDialog(snapshot); }
      return;
    }
    if(action === 'delete'){
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡ç”¢æˆæœè¨˜éŒ„ï¼Ÿ')){
        DB.snapshots = DB.snapshots.filter(s=>s.date!==date);
        saveDB(); fullRender();
      }
    }
  }
  window.handleSnapshotAction = handleSnapshotAction;
  
  // ç•¶å‰é¸ä¸­çš„æ™‚é–“ç¯„åœ
  let currentRange = 14;
  
  // æ¸²æŸ“ç´¯è¨ˆè³‡ç”¢å¢æ¸›åœ–è¡¨ï¼ˆHighcharts æŠ˜ç·šåœ–ï¼‰
  function renderSnapshotChangeChart(data){
    const containerId = 'change-chart-svg-container';
    const containerEl = $('#'+containerId);
    if (!containerEl) return;

    if (data.length === 0) {
      containerEl.innerHTML = '<div class="empty">å°šç„¡è³‡æ–™</div>';
      $('#summary-change').textContent = 'â€”';
      return;
    }

    const filteredData = getFilteredData(data, currentRange);
    if (filteredData.length === 0) {
      containerEl.innerHTML = '<div class="empty">é¸å®šç¯„åœå…§å°šç„¡è³‡æ–™</div>';
      $('#summary-change').textContent = 'â€”';
      return;
    }

    updateAssetSummary(filteredData);

    if (typeof Highcharts === 'undefined') {
      containerEl.innerHTML = '<div class="empty">åœ–è¡¨åº«æœªè¼‰å…¥</div>';
      return;
    }

    containerEl.textContent = '';

    const categories = filteredData.map(item => {
      if(!item.date) return '';
      const raw = item.date.slice(5);
      return raw.replace('-', '/');
    });
    const toWan = (value) => {
      const num = parseN(value);
      return Number.isFinite(num) ? Number((num / 10000).toFixed(2)) : null;
    };
    const changeSeries = filteredData.map(item => toWan(item.cumulativeChange));

    Highcharts.chart(containerId, {
      chart: { type: 'line', height: 340, spacingBottom: 40 },
      title: { text: null },
      subtitle: { text: null },
      credits: { enabled: false },
      xAxis: {
        categories,
        labels: { style: { color: '#6b7280', fontSize: '12px' } }
      },
      yAxis: {
        title: { text: 'ç´¯è¨ˆè³‡ç”¢å¢æ¸› (è¬å…ƒ)' },
        labels: {
          formatter() { return this.value.toFixed(1); },
          style: { color: '#6b7280', fontSize: '12px' }
        },
        plotLines: [{ value: 0, color: '#94a3b8', width: 1, dashStyle: 'Dash' }]
      },
      legend: { enabled: false },
      plotOptions: {
        line: {
          dataLabels: {
            enabled: true,
            formatter() {
              return this.y != null ? this.y.toFixed(1) : '';
            }
          },
          enableMouseTracking: false,
          marker: { symbol: 'circle' }
        },
        series: { animation: false }
      },
      series: [{
        name: 'è³‡ç”¢è®ŠåŒ–é‡‘é¡',
        data: changeSeries,
        color: '#ef4444'
      }]
    });
  }

  // æ¸²æŸ“ç¸½è³‡ç”¢è®ŠåŒ–åœ–è¡¨ï¼ˆHighcharts æŠ˜ç·šåœ–ï¼‰
  function renderSnapshotChart(data) {
    const containerId = 'chart-svg-container';
    const containerEl = $('#'+containerId);
    if (!containerEl) return;
  
    if (data.length === 0) {
      containerEl.innerHTML = '<div class="empty">å°šç„¡è³‡æ–™</div>';
      $('#summary-change').textContent = 'â€”';
      return;
    }
  
    const filteredData = getFilteredData(data, currentRange);
    if (filteredData.length === 0) {
      containerEl.innerHTML = '<div class="empty">é¸å®šç¯„åœå…§å°šç„¡è³‡æ–™</div>';
      $('#summary-change').textContent = 'â€”';
      return;
    }
  
    if (typeof Highcharts === 'undefined') {
      containerEl.innerHTML = '<div class="empty">åœ–è¡¨åº«æœªè¼‰å…¥</div>';
      return;
    }
  
    containerEl.textContent = '';
  
    const categories = filteredData.map(item => {
      if(!item.date) return '';
      const raw = item.date.slice(5); // å–å‡º MM-DD
      return raw.replace('-', '/');
    });
    const toWan = (value) => {
      const num = parseN(value);
      return Number.isFinite(num) ? Number((num / 10000).toFixed(2)) : null;
    };
    const totalSeries = filteredData.map(item => toWan(item.totalAsset));
  
    Highcharts.chart(containerId, {
      chart: { type: 'line', height: 340, spacingBottom: 40 },
      title: { text: null },
      subtitle: { text: null },
      credits: { enabled: false },
      xAxis: {
        categories,
        labels: { style: { color: '#6b7280', fontSize: '12px' } }
      },
      yAxis: {
        title: { text: 'ç¸½è³‡ç”¢ (è¬å…ƒ)' },
        labels: {
          formatter() { return this.value.toFixed(1); },
          style: { color: '#6b7280', fontSize: '12px' }
        }
      },
      legend: { enabled: false },
      plotOptions: {
        line: {
          dataLabels: {
            enabled: true,
            formatter() {
              return this.y != null ? this.y.toFixed(1) : '';
            }
          },
          enableMouseTracking: false,
          marker: { symbol: 'circle' }
        },
        series: { animation: false }
      },
      series: [{
        name: 'ç¸½è³‡ç”¢',
        data: totalSeries,
        color: '#3b82f6'
      }]
    });
  }
  
  // æ ¹æ“šæ™‚é–“ç¯„åœç¯©é¸æ•¸æ“š
  function getFilteredData(data, range) {
    if (range >= data.length) return data;
    return data.slice(-range);
  }
  
  // æ›´æ–°è³‡ç”¢è®ŠåŒ–æ‘˜è¦
  function updateAssetSummary(data) {
    const summary = $('#asset-summary');
    if(summary){ summary.style.display = 'none'; }
  }

  // ========= é…ç½® =========
  function renderAllocation(){
    const pos = computeAllPositions();
    const rows = DB.stocks.map(s=>({s, mval: pos[s.id].marketValue})).filter(r=>r.mval>0);
    const total = rows.reduce((a,b)=>a+b.mval,0) || 1;

    // 1. å€‹è‚¡æŠ•è³‡å æ¯”
    const stockColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'];
    const sortedStocks = rows.sort((a,b)=>b.mval-a.mval);
    let stockGradient = '', currentAngle = 0;
    sortedStocks.forEach((r, i) => {
      const pct = r.mval / total, angle = pct * 360;
      const color = stockColors[i % stockColors.length];
      stockGradient += `${color} ${currentAngle}deg ${currentAngle + angle}deg, `;
      currentAngle += angle;
    });
    stockGradient = stockGradient.slice(0, -2);
    $('#donut-stocks').style.background = `conic-gradient(${stockGradient})`;
    $('#label-stocks').textContent = `${sortedStocks.length} æª”æ¨™çš„`;
    $('#stocks-list').innerHTML = sortedStocks.map((r,i)=>{
      const p = (r.mval/total*100).toFixed(1), color = stockColors[i % stockColors.length];
      return `<div class="chart-legend"><div class="color" style="background:${color}"></div><div class="label">${r.s.symbol} Â· ${r.s.name}</div><div class="value">${p}%</div></div>`;
    }).join('') || '<div class="empty">å°šç„¡éƒ¨ä½</div>';

    // 2. å°ç£ vs å…¨çƒ
    const byRegion = {TW:0, Global:0};
    for(const r of rows){ byRegion[r.s.market||'Global'] += r.mval; }
    const twPct = byRegion.TW/total, glbPct = byRegion.Global/total;
    $('#donut-region').style.background = `conic-gradient(#3b82f6 0 ${twPct*360}deg, #10b981 ${twPct*360}deg 360deg)`;
    $('#label-region').textContent = `${(twPct*100).toFixed(1)}% / ${(glbPct*100).toFixed(1)}%`;
    $('#region-list').innerHTML = `
      <div class="chart-legend"><div class="color" style="background:#3b82f6"></div><div class="label">å°ç£</div><div class="value">${(twPct*100).toFixed(1)}%</div></div>
      <div class="chart-legend"><div class="color" style="background:#10b981"></div><div class="label">å…¨çƒ</div><div class="value">${(glbPct*100).toFixed(1)}%</div></div>`;

    // 3. è‚¡ç¥¨ vs å‚µåˆ¸
    const byClass = {Equity:0, Bond:0};
    for(const r of rows){ byClass[r.s.assetClass||'Equity'] += r.mval; }
    const eqPct = byClass.Equity/total, bdPct = byClass.Bond/total;
    $('#donut-class').style.background = `conic-gradient(#ef4444 0 ${eqPct*360}deg, #8b5cf6 ${eqPct*360}deg 360deg)`;
    $('#label-class').textContent = `${(eqPct*100).toFixed(1)}% / ${(bdPct*100).toFixed(1)}%`;
    $('#class-list').innerHTML = `
      <div class="chart-legend"><div class="color" style="background:#ef4444"></div><div class="label">è‚¡ç¥¨</div><div class="value">${(eqPct*100).toFixed(1)}%</div></div>
      <div class="chart-legend"><div class="color" style="background:#8b5cf6"></div><div class="label">å‚µåˆ¸</div><div class="value">${(bdPct*100).toFixed(1)}%</div></div>`;

    // 4. æŠ•è³‡çµ„åˆçµ±è¨ˆï¼ˆâœ… é€™è£¡ç”¨ kpi-gridï¼‰
    const cash = DB.accounts.reduce((a,acc)=> a + (parseN(acc.actual) + parseN(acc.settlement)), 0);
    const totalAssets = total + cash;
    const cashPct = totalAssets > 0 ? (cash / totalAssets * 100) : 0;
    const stats = `
      <div class="item"><div class="label">ç¸½æŠ•è³‡æ¨™çš„</div><div class="value">${sortedStocks.length} æª”</div></div>
      <div class="item"><div class="label">æŒæœ‰å¸‚å€¼</div><div class="value">${fmtInt.format(Math.round(total))}</div></div>
      <div class="item"><div class="label">å¯ç”¨ç¾é‡‘</div><div class="value">${fmtInt.format(Math.round(cash))}</div></div>
      <div class="item"><div class="label">ç¸½è³‡ç”¢</div><div class="value">${fmtInt.format(Math.round(totalAssets))}</div></div>
      <div class="item"><div class="label">ç¾é‡‘å æ¯”</div><div class="value">${cashPct.toFixed(1)}%</div></div>
    `;
    $('#portfolio-stats').innerHTML = stats;

    const actualAllocation = {
      equity: Number((eqPct * 100).toFixed(2)),
      bond: Number((bdPct * 100).toFixed(2))
    };
    const allocationTarget = getAllocationTarget();
    const allocationNote = $('#allocation-rebalance-note');
    const allocationExceeded = actualAllocation.equity > allocationTarget.equity + 5 || actualAllocation.bond > allocationTarget.bond + 5;
    if(allocationNote){
      if(allocationExceeded){
        allocationNote.textContent = 'âš ï¸ å¯¦éš›ä½”æ¯”å·²è¶…å‡ºè‚¡ç¥¨ / å‚µåˆ¸ç›®æ¨™ 5%ï¼Œå»ºè­°å•Ÿå‹•å†å¹³è¡¡æ©Ÿåˆ¶èª¿æ•´çµæ§‹ã€‚';
        allocationNote.style.color = '#b91c1c';
      }else{
        allocationNote.textContent = 'âœ“ ç›®å‰è‚¡ç¥¨ / å‚µåˆ¸å¯¦éš›ä½”æ¯”ç¶­æŒåœ¨ç›®æ¨™ç¯„åœå…§ã€‚';
        allocationNote.style.color = '#047857';
      }
    }

    const regionActual = {
      tw: Number((twPct * 100).toFixed(2)),
      global: Number((glbPct * 100).toFixed(2))
    };
    const regionTarget = getRegionTarget();
    const regionNote = $('#region-rebalance-note');
    const regionExceeded = regionActual.tw > regionTarget.tw + 5 || regionActual.global > regionTarget.global + 5;
    if(regionNote){
      if(regionExceeded){
        regionNote.textContent = 'âš ï¸ å¯¦éš›ä½”æ¯”å·²è¶…å‡ºå°ç£ / å…¨çƒç›®æ¨™ 5%ï¼Œå»ºè­°å•Ÿå‹•å†å¹³è¡¡æ©Ÿåˆ¶èª¿æ•´çµæ§‹ã€‚';
        regionNote.style.color = '#b91c1c';
      }else{
        regionNote.textContent = 'âœ“ ç›®å‰å°ç£ / å…¨çƒå¯¦éš›ä½”æ¯”ç¶­æŒåœ¨ç›®æ¨™ç¯„åœå…§ã€‚';
        regionNote.style.color = '#047857';
      }
    }

    updateTargetLabels(allocationTarget, regionTarget);

    const plannerSources = DB.stocks.map(stock => ({ stock, position: pos[stock.id] || {} }));
    renderAllocationPlanner(plannerSources, actualAllocation, regionActual, allocationTarget, regionTarget);
    renderAllocationOverviewChart(regionActual, actualAllocation);
  }

  function computeMonthlyDividendTotals(){
    const totals = new Map();
    for(const txn of DB.txns){
      if(!txn || txn.type !== 'dividend') continue;
      const amount = parseN(txn.amount);
      if(!amount) continue;
      const dt = new Date(txn.time || txn.date);
      if(Number.isNaN(dt.getTime())) continue;
      const year = dt.getFullYear();
      const month = dt.getMonth() + 1;
      const monthId = `${year}-${String(month).padStart(2,'0')}`;
      if(!totals.has(monthId)){
        totals.set(monthId, {
          monthId,
          label: `${year}å¹´${String(month).padStart(2,'0')}æœˆ`,
          total: 0
        });
      }
      const entry = totals.get(monthId);
      entry.total += amount;
    }
    return Array.from(totals.values()).sort((a,b)=> a.monthId.localeCompare(b.monthId));
  }

  function renderDividendMonthlyChart(monthlyData){
    const container = document.getElementById('dividend-monthly-chart');
    if(!container) return;

    if(dividendMonthlyChart){
      dividendMonthlyChart.destroy();
      dividendMonthlyChart = null;
    }

    if(!monthlyData || monthlyData.length === 0){
      container.innerHTML = '<div class="empty">å°šç„¡è‚¡æ¯è³‡æ–™</div>';
      return;
  }
  
  container.innerHTML = '';
  const categories = monthlyData.map(item => item.label);
  const data = monthlyData.map(item => Number(parseFloat(item.total.toFixed(2))));

  dividendMonthlyChart = Highcharts.chart('dividend-monthly-chart', {
      chart: { type: 'column' },
      title: { text: '' },
      xAxis: {
        categories,
        crosshair: true,
        accessibility: { description: 'æœˆä»½' }
      },
      yAxis: {
        min: 0,
        title: { text: 'è‚¡æ¯é‡‘é¡ (å…ƒ)' }
      },
      tooltip: {
        valueSuffix: ' å…ƒ'
      },
      credits: { enabled: false },
      legend: { enabled: false },
      plotOptions: {
        column: {
          pointPadding: 0.2,
          borderWidth: 0
        }
      },
      series: [{
        name: 'è‚¡æ¯',
        data
      }]
    });
  }

  function getAllocationTarget(){
    try{
      const saved = JSON.parse(localStorage.getItem(allocationTargetStorageKey));
      if(saved){
        let equity = Number.parseFloat(saved.equity);
        let bond = Number.parseFloat(saved.bond);
        if(!Number.isFinite(equity)) equity = allocationTargetDefaults.equity;
        if(!Number.isFinite(bond)) bond = allocationTargetDefaults.bond;
        const total = equity + bond;
        if(total > 0){
          const normalizedEquity = equity / total * 100;
          const normalizedBond = bond / total * 100;
          return {
            equity: Number(normalizedEquity.toFixed(2)),
            bond: Number(normalizedBond.toFixed(2))
          };
        }
      }
    }catch(err){
      console.warn('è§£æé…ç½®ç›®æ¨™å¤±æ•—ï¼Œæ”¹ç”¨é è¨­å€¼', err);
    }
    return { ...allocationTargetDefaults };
  }

  function saveAllocationTarget(target){
    localStorage.setItem(allocationTargetStorageKey, JSON.stringify(target));
  }

  function getRegionTarget(){
    try{
      const saved = JSON.parse(localStorage.getItem(regionTargetStorageKey));
      if(saved){
        let tw = Number.parseFloat(saved.tw);
        let global = Number.parseFloat(saved.global);
        if(!Number.isFinite(tw)) tw = regionTargetDefaults.tw;
        if(!Number.isFinite(global)) global = regionTargetDefaults.global;
        const total = tw + global;
        if(total > 0){
          const normalizedTw = tw / total * 100;
          const normalizedGlobal = global / total * 100;
          return {
            tw: Number(normalizedTw.toFixed(2)),
            global: Number(normalizedGlobal.toFixed(2))
          };
        }
      }
    }catch(err){
      console.warn('è§£æå°ç£ / å…¨çƒç›®æ¨™å¤±æ•—ï¼Œæ”¹ç”¨é è¨­å€¼', err);
    }
    return { ...regionTargetDefaults };
  }

  function saveRegionTarget(target){
    localStorage.setItem(regionTargetStorageKey, JSON.stringify(target));
  }

  function updateTargetLabels(allocationTarget, regionTarget){
    const allocationLabel = $('#allocation-target-label');
    if(allocationLabel){
      const eqTarget = Number.isFinite(allocationTarget?.equity) ? Math.round(allocationTarget.equity) : allocationTargetDefaults.equity;
      const bondTarget = Number.isFinite(allocationTarget?.bond) ? Math.round(allocationTarget.bond) : allocationTargetDefaults.bond;
      allocationLabel.textContent = `ç›®æ¨™ï¼šè‚¡ç¥¨ ${eqTarget}% / å‚µåˆ¸ ${bondTarget}%`;
    }
    const regionLabel = $('#region-target-label');
  if(regionLabel){
    const twTarget = Number.isFinite(regionTarget?.tw) ? Math.round(regionTarget.tw) : regionTargetDefaults.tw;
    const globalTarget = Number.isFinite(regionTarget?.global) ? Math.round(regionTarget.global) : regionTargetDefaults.global;
    regionLabel.textContent = `ç›®æ¨™ï¼šå°ç£ ${twTarget}% / å…¨çƒ ${globalTarget}%`;
  }
}

function renderAllocationOverviewChart(regionActual, allocationActual){
  const container = document.getElementById('allocation-overview-chart');
  if(!container){ return; }

  if(typeof Highcharts === 'undefined'){
    container.innerHTML = '<div class="empty">Highcharts æœªè¼‰å…¥ï¼Œç„¡æ³•é¡¯ç¤ºæŒ‡æ¨™åœ–ã€‚</div>';
    return;
  }

  const targetRegion = getRegionTarget();
  const targetAllocation = getAllocationTarget();

  const categories = ['å°ç£', 'å…¨çƒ', 'è‚¡ç¥¨', 'å‚µåˆ¸'];
  const actualSeries = [
    Number(regionActual.tw?.toFixed(2)) || 0,
    Number(regionActual.global?.toFixed(2)) || 0,
    Number(allocationActual.equity?.toFixed(2)) || 0,
    Number(allocationActual.bond?.toFixed(2)) || 0
  ];
  const targetSeries = [
    Number(targetRegion.tw?.toFixed(2)) || 0,
    Number(targetRegion.global?.toFixed(2)) || 0,
    Number(targetAllocation.equity?.toFixed(2)) || 0,
    Number(targetAllocation.bond?.toFixed(2)) || 0
  ];

  Highcharts.chart('allocation-overview-chart', {
    chart: { type: 'column' },
    title: { text: 'é…ç½®å¯¦éš› vs ç›®æ¨™' },
    xAxis: { categories },
    yAxis: [{
      min: 20,
      max: 80,
      title: { text: 'å æ¯” (%)' }
    }],
    legend: { shadow: false },
    tooltip: { shared: true, valueSuffix: '%' },
    plotOptions: {
      column: {
        grouping: false,
        shadow: false,
        borderWidth: 0
      }
    },
    series: [{
      name: 'å¯¦éš›å æ¯”',
      color: 'rgba(126,86,134,1)',
      data: actualSeries,
      pointPadding: 0.15,
      pointPlacement: 0,
      pointRange: 0.4,
      borderRadius: 6,
      dataLabels: { enabled: true, format: '{y:.1f}%' }
    }, {
      name: 'ç›®æ¨™å æ¯”',
      color: 'rgba(186,60,61,.5)',
      data: targetSeries,
      pointPadding: 0,
      pointRange: 0.45,
      borderRadius: 14,
      zIndex: -1,
      states: { hover: { enabled: false } },
      enableMouseTracking: false
    }]
  });
}

function renderAllocationPlanner(stockSources, actualAllocation, regionActual, allocationTarget, regionTarget){
  const tbody = $('#tbl-allocation-planner tbody');
  const regionSummary = $('#planner-summary-region');
  const classSummary = $('#planner-summary-class');
  const tradingSummary = $('#planner-summary-trading');
  if(!tbody){ return; }

  allocationPlannerContext = { allocationTarget, regionTarget };
  allocationPlannerBase = stockSources.map(source => {
    const stock = source.stock;
    const position = source.position || {};
    const qty = parseN(position.qty);
    const priceRaw = parseN(stock.price);
    const fallbackValue = parseN(position.marketValue);
    const price = Number.isFinite(priceRaw) && priceRaw > 0
      ? priceRaw
      : (qty > 0 ? fallbackValue / qty : 0);
    return {
      id: stock.id,
      symbol: stock.symbol,
      name: stock.name || '',
      market: (stock.market === 'TW' ? 'TW' : 'Global'),
      assetClass: (stock.assetClass === 'Bond' ? 'Bond' : 'Equity'),
      qty,
      price: Number.isFinite(price) && price > 0 ? price : 0
    };
  }).filter(item => item.price > 0);

  const baseIds = new Set(allocationPlannerBase.map(item => item.id));
  Object.keys(allocationPlannerAdjustments).forEach(id => {
    if(!baseIds.has(id)) delete allocationPlannerAdjustments[id];
  });
  allocationPlannerBase.forEach(item => {
    if(!Number.isFinite(parseN(allocationPlannerAdjustments[item.id]))){
      allocationPlannerAdjustments[item.id] = 0;
    }
  });

  if(allocationPlannerBase.length === 0){
    tbody.innerHTML = '<tr><td colspan="7" class="empty">å°šç„¡æŒæœ‰æ¨™çš„å¯æ¨¡æ“¬</td></tr>';
    if(regionSummary){ regionSummary.textContent = 'æ¨¡æ“¬å¾Œ å°ç£ / å…¨çƒï¼šâ€”'; }
    if(classSummary){ classSummary.textContent = 'æ¨¡æ“¬å¾Œ è‚¡ç¥¨ / å‚µåˆ¸ï¼šâ€”'; }
    if(tradingSummary){ tradingSummary.textContent = 'é ä¼°ç¸½äº¤æ˜“é‡‘é¡ï¼šâ€”'; }
    const allocationNote = $('#allocation-rebalance-note');
    if(allocationNote){ allocationNote.textContent = 'å°šç„¡æŒè‚¡å¯é€²è¡Œæ¨¡æ“¬ã€‚'; allocationNote.style.color = '#6b7280'; }
    const regionNote = $('#region-rebalance-note');
    if(regionNote){ regionNote.textContent = 'å°šç„¡æŒè‚¡å¯é€²è¡Œæ¨¡æ“¬ã€‚'; regionNote.style.color = '#6b7280'; }
    return;
  }

  tbody.innerHTML = allocationPlannerBase.map(item => {
    const delta = parseN(allocationPlannerAdjustments[item.id]) || 0;
    const simulated = Math.max(item.qty + delta, 0);
    const minAdjust = -Math.round(item.qty);
    const tradeValue = delta * item.price;
    const simulatedValue = simulated * item.price;
    return `
      <tr>
        <td><span class="badge blue">${item.symbol}</span></td>
        <td>${item.name}</td>
        <td class="num">${fmtInt.format(Math.round(item.qty))}</td>
        <td class="num"><input type="number" class="planner-input" data-id="${item.id}" value="${delta}" step="1" min="${minAdjust}" /></td>
        <td class="num"><span class="planner-sim" data-id="${item.id}">${fmtInt.format(Math.round(simulated))}</span></td>
        <td class="num"><span class="planner-trade" data-id="${item.id}">${fmtInt.format(Math.round(tradeValue))}</span></td>
        <td class="num"><span class="planner-value" data-id="${item.id}">${fmtInt.format(Math.round(simulatedValue))}</span></td>
      </tr>`;
  }).join('');

  updateAllocationPlannerSummary();
}

function updateAllocationPlannerSummary(){
  const context = allocationPlannerContext;
  const regionSummary = $('#planner-summary-region');
  const classSummary = $('#planner-summary-class');
  const tradingSummary = $('#planner-summary-trading');
  if(!context){
    if(regionSummary) regionSummary.textContent = 'æ¨¡æ“¬å¾Œ å°ç£ / å…¨çƒï¼šâ€”';
    if(classSummary) classSummary.textContent = 'æ¨¡æ“¬å¾Œ è‚¡ç¥¨ / å‚µåˆ¸ï¼šâ€”';
    if(tradingSummary) tradingSummary.textContent = 'é ä¼°ç¸½äº¤æ˜“é‡‘é¡ï¼šâ€”';
    return;
  }

  if(allocationPlannerBase.length === 0){
    if(regionSummary) regionSummary.textContent = 'æ¨¡æ“¬å¾Œ å°ç£ / å…¨çƒï¼šâ€”';
    if(classSummary) classSummary.textContent = 'æ¨¡æ“¬å¾Œ è‚¡ç¥¨ / å‚µåˆ¸ï¼šâ€”';
    if(tradingSummary) tradingSummary.textContent = 'é ä¼°ç¸½äº¤æ˜“é‡‘é¡ï¼šâ€”';
    return;
  }

  let totalValue = 0;
  const byRegion = { TW:0, Global:0 };
  const byClass = { Equity:0, Bond:0 };
  let totalTradeValue = 0;

  allocationPlannerBase.forEach(item => {
    const adj = parseN(allocationPlannerAdjustments[item.id]) || 0;
    const simulatedQty = Math.max(item.qty + adj, 0);
    const value = simulatedQty * item.price;
    const tradeValue = adj * item.price;
    totalValue += value;
    totalTradeValue += tradeValue;
    const regionKey = item.market === 'TW' ? 'TW' : 'Global';
    byRegion[regionKey] += value;
    const classKey = item.assetClass === 'Bond' ? 'Bond' : 'Equity';
    byClass[classKey] += value;
    const simCell = document.querySelector(`.planner-sim[data-id="${item.id}"]`);
    if(simCell){ simCell.textContent = fmtInt.format(Math.round(simulatedQty)); }
    const tradeCell = document.querySelector(`.planner-trade[data-id="${item.id}"]`);
    if(tradeCell){ tradeCell.textContent = fmtInt.format(Math.round(tradeValue)); }
    const valueCell = document.querySelector(`.planner-value[data-id="${item.id}"]`);
    if(valueCell){ valueCell.textContent = fmtInt.format(Math.round(simulatedQty * item.price)); }
  });

  let regionTwPct = 0, regionGlobalPct = 0, equityPct = 0, bondPct = 0;
  if(totalValue > 0){
    regionTwPct = byRegion.TW / totalValue * 100;
    regionGlobalPct = byRegion.Global / totalValue * 100;
    equityPct = byClass.Equity / totalValue * 100;
    bondPct = byClass.Bond / totalValue * 100;
  }

  if(regionSummary){
    regionSummary.textContent = `æ¨¡æ“¬å¾Œ å°ç£ ${regionTwPct.toFixed(1)}% / å…¨çƒ ${regionGlobalPct.toFixed(1)}% ï¼ˆç›®æ¨™ å°ç£ ${Math.round(context.regionTarget.tw)}% / å…¨çƒ ${Math.round(context.regionTarget.global)}%ï¼‰`;
  }
  if(classSummary){
    classSummary.textContent = `æ¨¡æ“¬å¾Œ è‚¡ç¥¨ ${equityPct.toFixed(1)}% / å‚µåˆ¸ ${bondPct.toFixed(1)}% ï¼ˆç›®æ¨™ è‚¡ç¥¨ ${Math.round(context.allocationTarget.equity)}% / å‚µåˆ¸ ${Math.round(context.allocationTarget.bond)}%ï¼‰`;
  }

  if(tradingSummary){
    tradingSummary.textContent = `é ä¼°ç¸½äº¤æ˜“é‡‘é¡ï¼š${fmtInt.format(Math.round(totalTradeValue))} å…ƒ`;
  }

  const regionNote = $('#region-rebalance-note');
  if(regionNote){
    const regionExceeded = regionTwPct > context.regionTarget.tw + 5 || regionGlobalPct > context.regionTarget.global + 5;
    if(regionExceeded){
      regionNote.textContent = 'âš ï¸ æ¨¡æ“¬çµæœå·²è®“å°ç£ / å…¨çƒè¶…å‡ºç›®æ¨™ 5%ï¼Œå»ºè­°å†å¹³è¡¡ã€‚';
      regionNote.style.color = '#b91c1c';
    }else{
      regionNote.textContent = 'âœ“ æ¨¡æ“¬çµæœç¶­æŒå°ç£ / å…¨çƒåœ¨ç›®æ¨™ç¯„åœå…§ã€‚';
      regionNote.style.color = '#047857';
    }
  }

  const allocationNote = $('#allocation-rebalance-note');
  if(allocationNote){
    const allocationExceeded = equityPct > context.allocationTarget.equity + 5 || bondPct > context.allocationTarget.bond + 5;
    if(allocationExceeded){
      allocationNote.textContent = 'âš ï¸ æ¨¡æ“¬çµæœå·²è®“è‚¡ç¥¨ / å‚µåˆ¸è¶…å‡ºç›®æ¨™ 5%ï¼Œå»ºè­°å†å¹³è¡¡ã€‚';
      allocationNote.style.color = '#b91c1c';
    }else{
      allocationNote.textContent = 'âœ“ æ¨¡æ“¬çµæœç¶­æŒè‚¡ç¥¨ / å‚µåˆ¸åœ¨ç›®æ¨™ç¯„åœå…§ã€‚';
      allocationNote.style.color = '#047857';
    }
  }
}

  function openAllocationTargetDialog(){
    const dlg = $('#dlg-allocation-target');
    if(!dlg) return;
    const target = getAllocationTarget();
    $('#target-equity').value = Math.round(target.equity);
    $('#target-bond').value = Math.round(target.bond);
    dlg.returnValue = '';
    dlg.showModal();
  }

  function openRegionTargetDialog(){
    const dlg = $('#dlg-region-target');
    if(!dlg) return;
    const target = getRegionTarget();
    $('#target-tw').value = Math.round(target.tw);
    $('#target-global').value = Math.round(target.global);
    dlg.returnValue = '';
    dlg.showModal();
  }

  // ========= è‚¡æ¯è¦åŠƒ =========
  const dividendFrequencyLabels = {
    none: 'ä¸ç™¼æ”¾',
    annual: 'å¹´é…',
    semiannual: 'åŠå¹´é…',
    quarterly: 'å­£é…',
    bimonthly: 'é›™æœˆé…',
    monthly: 'æœˆé…'
  };

  const defaultDividendFrequencyMap = {
    '0050': 'semiannual',
    '00878': 'quarterly',
    '00923': 'semiannual',
    '8215': 'annual',
    '00646': 'none',
    '00687B': 'quarterly',
    '00719B': 'quarterly',
    '00772B': 'monthly'
  };

  function getDefaultDividendFrequency(symbol){
    return defaultDividendFrequencyMap[symbol] || 'none';
  }

  function getDividendFrequencyLabel(code){
    return dividendFrequencyLabels[code] || code || 'â€”';
  }

  function normalizeFrequencyCode(value){
    if(!value) return null;
    if(dividendFrequencyLabels[value]) return value;
    const legacyMap = {
      'ä¸ç™¼æ”¾': 'none',
      'ä¸é…': 'none',
      'å¹´é…': 'annual',
      'åŠå¹´é…': 'semiannual',
      'å­£é…': 'quarterly',
      'é›™æœˆé…': 'bimonthly',
      'æ¯æœˆé…': 'monthly',
      'æœˆé…': 'monthly'
    };
    return legacyMap[value] || null;
  }

  function normalizeDividendMonths(months){
    if(!Array.isArray(months)) return [];
    return Array.from(new Set(months.map(m => Number(m))))
      .filter(m => Number.isInteger(m) && m >= 1 && m <= 12)
      .sort((a,b)=>a-b);
  }

  async function renderDividend(){
    const tbody = $('#tbl-dividend tbody');
    tbody.innerHTML = '';
    const pos = computeAllPositions();
    
    // è‡ªå®šç¾©æ’åºé †åº
    const customOrder = ['0050', '00878', '00923', '8215', '00646', '00687B', '00719B', '00772B'];
    const getSortIndex = (symbol) => {
      const index = customOrder.indexOf(symbol);
      return index >= 0 ? index : 999;
    };
    
    const heldStockIds = new Set(DB.txns.map(t => t.stockId));
    const rows = DB.stocks
      .map(stock => {
        const position = pos[stock.id] || {qty:0};
        return {stock, position};
      })
      .filter(({stock, position}) => {
        const hasPosition = parseN(position.qty) > 0;
        const hasHistory = heldStockIds.has(stock.id);
        return hasPosition || hasHistory;
      })
      .sort((a,b) => {
        const qtyDiff = parseN(b.position.qty) - parseN(a.position.qty);
        if(qtyDiff !== 0) return qtyDiff;
        return getSortIndex(a.stock.symbol) - getSortIndex(b.stock.symbol);
      });
    
    if(rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="13" class="empty">å°šç„¡æ­·å²æŒè‚¡</td></tr>';
      return;
    }
    
    const currentYear = new Date().getFullYear();
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    
    for(const {stock, position} of rows) {
      const currentQty = parseN(position.qty);
      
      // è¨ˆç®—ä»Šå¹´è‚¡æ¯æ”¶å…¥
      const thisYearDividends = DB.txns
        .filter(t => t.stockId === stock.id && t.type === 'dividend')
        .filter(t => {
          const txDate = new Date(t.time);
          return txDate.getFullYear() === currentYear;
        })
        .reduce((sum, t) => sum + parseN(t.amount), 0);
      

      // é æ¸¬ä¸‹æ¬¡è‚¡æ¯è³‡è¨Š
      const nextDividendInfo = await predictNextDividend(stock.symbol, currentDate);
      const normalizedFrequency = normalizeFrequencyCode(nextDividendInfo.frequency);
      const frequencyCode = normalizedFrequency || getDefaultDividendFrequency(stock.symbol);
      const frequencyLabel = getDividendFrequencyLabel(frequencyCode);
      const payoutMonths = normalizeDividendMonths(nextDividendInfo.payoutMonths);
      const isAllMonths = payoutMonths.length === 12 && payoutMonths.every((month, index) => month === index + 1);
      const monthsText = payoutMonths.length ? (isAllMonths ? 'æ¯æœˆ' : payoutMonths.join('ã€')) : '';
      let payoutScheduleDisplay = 'â€”';
      if(monthsText){
        payoutScheduleDisplay = nextDividendInfo.payoutTime ? `${monthsText}ï½œ${nextDividendInfo.payoutTime}` : monthsText;
      }else if(nextDividendInfo.payoutTime){
        payoutScheduleDisplay = nextDividendInfo.payoutTime;
      }
      
      const computedNextDividend = (nextDividendInfo.perShare || 0) * currentQty;
      const savedTotalAmount = parseN(nextDividendInfo.totalAmount);
      const nextDividendAmount = savedTotalAmount > 0 ? savedTotalAmount : computedNextDividend;
      
      // æ ¼å¼åŒ–æ—¥æœŸç‚º MM/DD æ ¼å¼
      const formatDate = (dateStr) => {
        if (!dateStr) return 'â€”';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return 'â€”';
        return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
      };
      
      const payDateRaw = nextDividendInfo.payDate;
      const formattedPayDate = formatDate(payDateRaw);
      const tr = document.createElement('tr');
      const isMonthly = payoutMonths.length === 12 && payoutMonths.every((month, index) => month === index + 1);
      const nextMonthNumber = currentMonth === 12 ? 1 : currentMonth + 1;
      if(currentQty <= 0){
        tr.classList.add('dividend-no-holdings');
      }else if(payoutMonths.includes(currentMonth)){
        tr.classList.add('dividend-month-active');
      }else if(!isMonthly && payoutMonths.includes(nextMonthNumber)){
        tr.classList.add('dividend-next-month');
      }
      tr.innerHTML = `
        <td><span class="badge blue">${stock.symbol}</span></td>
        <td>${stock.name || ''}</td>
        <td class="num">${fmtInt.format(Math.round(currentQty))}</td>
        <td><span class="badge gray">${frequencyLabel}</span></td>
        <td>${payoutScheduleDisplay}</td>
        <td class="num">${thisYearDividends > 0 ? '<span class="badge blue">' + fmtInt.format(Math.round(thisYearDividends)) + '</span>' : 'â€”'}</td>
        <td class="num">${nextDividendAmount > 0 ? fmtInt.format(Math.round(nextDividendAmount)) : 'â€”'}</td>
        <td class="num">${nextDividendInfo.perShare > 0 ? nextDividendInfo.perShare.toFixed(3) : 'â€”'}</td>
        <td>${formatDate(nextDividendInfo.exDate)}</td>
        <td class="pay-date">${formattedPayDate}</td>
        <td class="num">${nextDividendInfo.yield > 0 ? nextDividendInfo.yield.toFixed(2) + '%' : 'â€”'}</td>
        <td>
          <a href="${getDividendUrl(stock.symbol)}" target="_blank" style="color: #3b82f6; text-decoration: none;">
            <span class="badge blue">WantGoo</span>
          </a>
        </td>
        <td class="num">
          <button class="btn mini" onclick="openDividendEdit('${stock.symbol}')">ç·¨è¼¯</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    const chartSection = $('#dividend-monthly-chart');
    if(chartSection){
      const dividendMonthlyTotals = computeMonthlyDividendTotals();
      renderDividendMonthlyChart(dividendMonthlyTotals);
    }
  }
  
  // å–å¾—è‚¡æ¯ç¶²é é€£çµ
  function getDividendUrl(symbol) {
    return `https://www.wantgoo.com/stock/etf/${symbol}/dividend-policy/ex-dividend`;
  }
  
  // è‚¡æ¯è³‡æ–™æä¾›è€…
  const dividendProvider = {
    // å¾ç¶²è·¯æŠ“å–è‚¡æ¯è³‡è¨Š
    async fetch(symbol) {
      try {
        // é€™è£¡å¯ä»¥æ•´åˆå¤šå€‹è³‡æ–™ä¾†æº
        const data = await this.fetchFromMultipleSources(symbol);
        return data;
      } catch (error) {
        console.warn(`ç„¡æ³•å–å¾— ${symbol} çš„è‚¡æ¯è³‡è¨Š:`, error);
        return this.getFallbackData(symbol);
      }
    },

    // å¾å¤šå€‹ä¾†æºæŠ“å–è³‡æ–™
    async fetchFromMultipleSources(symbol) {
      // 1. å˜—è©¦å¾è‡ªå®šç¾©ç¶²å€æŠ“å–
      try {
        const customData = await this.fetchFromCustomUrl(symbol);
        if (customData) return customData;
      } catch (e) {
        console.log('è‡ªå®šç¾©ç¶²å€æŠ“å–å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–ä¾†æº');
      }

      // 2. å˜—è©¦å¾ WantGoo æŠ“å–ï¼ˆä¸»è¦è³‡æ–™ä¾†æºï¼‰
      try {
        const wantgooData = await this.fetchFromMockAPI(symbol);
        if (wantgooData) return wantgooData;
      } catch (e) {
        console.log('WantGoo æŠ“å–å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–ä¾†æº');
      }

      // 3. å˜—è©¦å¾è­‰äº¤æ‰€ API æŠ“å–
      try {
        const twseData = await this.fetchFromTWSE(symbol);
        if (twseData) return twseData;
      } catch (e) {
        console.log('è­‰äº¤æ‰€ API å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–ä¾†æº');
      }

      // 4. å˜—è©¦å¾ Yahoo Finance æŠ“å–
      try {
        const yahooData = await this.fetchFromYahoo(symbol);
        if (yahooData) return yahooData;
      } catch (e) {
        console.log('Yahoo Finance API å¤±æ•—');
      }

      // 5. å¦‚æœéƒ½å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™
      return this.getFallbackData(symbol);
    },

    // å¾è‡ªå®šç¾©ç¶²å€æŠ“å–è‚¡æ¯è³‡è¨Š
    async fetchFromCustomUrl(symbol) {
      try {
        // æª¢æŸ¥æ˜¯å¦æœ‰è‡ªå®šç¾©ç¶²å€
        if (!window.customDividendUrls) {
          return null;
        }

        const customUrl = window.customDividendUrls[symbol] || window.customDividendUrls['default'];
        if (!customUrl) {
          return null;
        }

        console.log(`æ­£åœ¨å¾è‡ªå®šç¾©ç¶²å€æŠ“å– ${symbol} çš„è‚¡æ¯è³‡è¨Š:`, customUrl);

        const response = await fetch(customUrl, {
          method: 'GET',
          headers: {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept-Language': 'zh-TW,zh;q=0.9,en;q=0.8'
          }
        });

        if (!response.ok) {
          console.warn(`è‡ªå®šç¾©ç¶²å€å›æ‡‰éŒ¯èª¤: ${response.status} ${response.statusText}`);
          return null;
        }

        const html = await response.text();
        console.log(`è‡ªå®šç¾©ç¶²å€å›æ‡‰ HTML é•·åº¦:`, html.length);

        // å˜—è©¦è§£æ HTML ä¸­çš„è‚¡æ¯è³‡è¨Š
        // é€™è£¡éœ€è¦æ ¹æ“šå…·é«”ç¶²é çµæ§‹ä¾†èª¿æ•´
        const dividendInfo = this.parseHtmlForDividend(html, symbol);
        
        if (dividendInfo) {
          return {
            ...dividendInfo,
            source: 'è‡ªå®šç¾©ç¶²å€'
          };
        }

        return null;

      } catch (error) {
        console.error(`å¾è‡ªå®šç¾©ç¶²å€æŠ“å– ${symbol} è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
        return null;
      }
    },

    // è§£æ HTML ä¸­çš„è‚¡æ¯è³‡è¨Š
    parseHtmlForDividend(html, symbol) {
      try {
        // å‰µå»ºä¸€å€‹è‡¨æ™‚çš„ DOM è§£æå™¨
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // å˜—è©¦å¤šç¨®å¸¸è¦‹çš„è‚¡æ¯è³‡è¨Šæ ¼å¼
        const patterns = [
          // è‚¡æ¯é‡‘é¡æ¨¡å¼
          { regex: /(\d+(?:\.\d+)?)\s*å…ƒ?\s*ç¾é‡‘è‚¡åˆ©/g, type: 'amount' },
          { regex: /ç¾é‡‘è‚¡åˆ©\s*(\d+(?:\.\d+)?)/g, type: 'amount' },
          { regex: /è‚¡æ¯\s*(\d+(?:\.\d+)?)/g, type: 'amount' },
          
          // æ—¥æœŸæ¨¡å¼
          { regex: /(\d{4}[-/]\d{1,2}[-/]\d{1,2})/g, type: 'date' },
          { regex: /(\d{1,2}[-/]\d{1,2})/g, type: 'date' }
        ];

        let amount = 0;
        let exDate = null;
        let payDate = null;

        // æœå°‹è‚¡æ¯é‡‘é¡
        for (const pattern of patterns) {
          if (pattern.type === 'amount') {
            const matches = html.match(pattern.regex);
            if (matches && matches.length > 0) {
              const numMatch = matches[0].match(/(\d+(?:\.\d+)?)/);
              if (numMatch) {
                amount = parseFloat(numMatch[1]);
                break;
              }
            }
          }
        }

        // æœå°‹æ—¥æœŸ
        const dateMatches = html.match(/(\d{4}[-/]\d{1,2}[-/]\d{1,2})/g);
        if (dateMatches && dateMatches.length >= 2) {
          exDate = dateMatches[0];
          payDate = dateMatches[1];
        }

        if (amount > 0 || exDate || payDate) {
          console.log(`å¾ HTML è§£æåˆ°è‚¡æ¯è³‡è¨Š:`, { amount, exDate, payDate });
          return { amount, exDate, payDate };
        }

        return null;

      } catch (error) {
        console.error('è§£æ HTML æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        return null;
      }
    },

    // å¾ WantGoo æŠ“å–è‚¡æ¯è³‡è¨Š
    async fetchFromMockAPI(symbol) {
      try {
        console.log(`æ­£åœ¨å¾ WantGoo æŠ“å– ${symbol} çš„è‚¡æ¯è³‡è¨Š...`);
        
        // ä½¿ç”¨ä»£ç†ä¼ºæœå™¨ä¾†é¿å… CORS å•é¡Œ
        const proxyUrl = `http://localhost:3000/api/wantgoo/${symbol}`;
        const originalUrl = `https://www.wantgoo.com/stock/etf/${symbol}/dividend-policy/ex-dividend`;
        
        console.log(`è«‹æ±‚ä»£ç† URL: ${proxyUrl}`);
        console.log(`åŸå§‹ URL: ${originalUrl}`);
        
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
          }
        });
        
        if (!response.ok) {
          console.warn(`WantGoo å›æ‡‰éŒ¯èª¤: ${response.status} ${response.statusText}`);
          return null;
        }
        
        // æª¢æŸ¥ CORS å•é¡Œ
        if (response.status === 0 || response.type === 'opaque') {
          console.warn(`æª¢æ¸¬åˆ° CORS å•é¡Œï¼Œå›æ‡‰ç‹€æ…‹: ${response.status}, å›æ‡‰é¡å‹: ${response.type}`);
          console.warn(`ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•ç›´æ¥å¾ WantGoo æŠ“å–è³‡æ–™`);
          console.warn(`å»ºè­°ï¼šä½¿ç”¨ç€è¦½å™¨æ“´å……åŠŸèƒ½æˆ–å¾Œç«¯ä»£ç†ä¾†è§£æ±º CORS å•é¡Œ`);
          return null;
        }
        
        const html = await response.text();
        console.log(`WantGoo å›æ‡‰ HTML é•·åº¦:`, html.length);
        
        // è§£æ HTML ä¸­çš„è‚¡æ¯è³‡è¨Š
        const dividendInfo = this.parseWantGooHtml(html, symbol);
        
        if (dividendInfo) {
          return {
            ...dividendInfo,
            source: 'WantGoo',
            sourceUrl: originalUrl
          };
        }
        
        console.log(`æœªæ‰¾åˆ° ${symbol} çš„è‚¡æ¯è³‡æ–™ï¼Œä½¿ç”¨é è¨­è³‡æ–™`);
        
        // å¦‚æœæ²’æœ‰æ‰¾åˆ°è³‡æ–™ï¼Œè¿”å›é è¨­è³‡æ–™ï¼ˆä½†åŒ…å« WantGoo é€£çµï¼‰
        // æ³¨æ„ï¼šé€™è£¡çš„é è¨­è³‡æ–™åƒ…ä½œç‚ºæœ€å¾Œçš„å›é€€é¸é …
        const fallbackData = {
          '0050': { amount: 1800, exDate: '2025-09-20', payDate: '2025-10-20', source: 'WantGoo', sourceUrl: originalUrl }, // åŠå¹´é…
          '00878': { amount: 950, exDate: '2025-09-25', payDate: '2025-10-25', source: 'WantGoo', sourceUrl: originalUrl }, // å­£é…
          '00923': { amount: 1400, exDate: '2025-09-30', payDate: '2025-10-30', source: 'WantGoo', sourceUrl: originalUrl }, // åŠå¹´é…
          '8215': { amount: 1200, exDate: '2025-09-15', payDate: '2025-10-15', source: 'WantGoo', sourceUrl: originalUrl }, // å¹´é…
          '00646': { amount: 0, exDate: null, payDate: null, source: 'WantGoo', sourceUrl: originalUrl }, // ä¸é…
          '00687B': { amount: 350, exDate: '2025-09-05', payDate: '2025-09-25', source: 'WantGoo', sourceUrl: originalUrl }, // å­£é…
          '00719B': { amount: 300, exDate: '2025-09-08', payDate: '2025-09-28', source: 'WantGoo', sourceUrl: originalUrl }, // å­£é…
          '00772B': { amount: 320, exDate: '2025-09-12', payDate: '2025-10-02', source: 'WantGoo', sourceUrl: originalUrl } // æ¯æœˆé…
        };
        
        console.log(`ä½¿ç”¨é è¨­è³‡æ–™ä½œç‚ºå›é€€é¸é …:`, fallbackData[symbol]);
        return fallbackData[symbol] || null;
        
      } catch (error) {
        console.error(`å¾ WantGoo æŠ“å– ${symbol} è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
        
        // éŒ¯èª¤æ™‚ä¹Ÿè¿”å›é è¨­è³‡æ–™ï¼ˆä½†åŒ…å« WantGoo é€£çµï¼‰
        const originalUrl = `https://www.wantgoo.com/stock/etf/${symbol}/dividend-policy/ex-dividend`;
        const fallbackData = {
          '0050': { amount: 1800, exDate: '2025-09-20', payDate: '2025-10-20', source: 'WantGoo (å›é€€)', sourceUrl: originalUrl }, // åŠå¹´é…
          '00878': { amount: 950, exDate: '2025-09-25', payDate: '2025-10-25', source: 'WantGoo (å›é€€)', sourceUrl: originalUrl }, // å­£é…
          '00923': { amount: 1400, exDate: '2025-09-30', payDate: '2025-10-30', source: 'WantGoo (å›é€€)', sourceUrl: originalUrl }, // åŠå¹´é…
          '8215': { amount: 1200, exDate: '2025-09-15', payDate: '2025-10-15', source: 'WantGoo (å›é€€)', sourceUrl: originalUrl }, // å¹´é…
          '00646': { amount: 0, exDate: null, payDate: null, source: 'WantGoo (å›é€€)', sourceUrl: originalUrl }, // ä¸é…
          '00687B': { amount: 350, exDate: '2025-09-05', payDate: '2025-09-25', source: 'WantGoo (å›é€€)', sourceUrl: originalUrl }, // å­£é…
          '00719B': { amount: 300, exDate: '2025-09-08', payDate: '2025-09-28', source: 'WantGoo (å›é€€)', sourceUrl: originalUrl }, // å­£é…
          '00772B': { amount: 320, exDate: '2025-09-12', payDate: '2025-10-02', source: 'WantGoo (å›é€€)', sourceUrl: originalUrl } // æ¯æœˆé…
        };
        
        return fallbackData[symbol] || null;
      }
    },

    // è§£æ WantGoo HTML ä¸­çš„è‚¡æ¯è³‡è¨Š
    parseWantGooHtml(html, symbol) {
      try {
        console.log(`æ­£åœ¨è§£æ WantGoo HTML ä¸­çš„è‚¡æ¯è³‡è¨Š...`);
        console.log(`HTML å…§å®¹é è¦½:`, html.substring(0, 500));
        
        // å‰µå»ºä¸€å€‹è‡¨æ™‚çš„ DOM è§£æå™¨
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        let amount = 0;
        let exDate = null;
        let payDate = null;
        
        // æ–¹æ³•1: ç›´æ¥æœå°‹åŒ…å«è‚¡æ¯è³‡è¨Šçš„è¡¨æ ¼è¡Œ
        console.log(`æ–¹æ³•1: æœå°‹åŒ…å«è‚¡æ¯è³‡è¨Šçš„è¡¨æ ¼è¡Œ...`);
        const allRows = doc.querySelectorAll('tr');
        console.log(`æ‰¾åˆ° ${allRows.length} å€‹è¡¨æ ¼è¡Œ`);
        
        // å…ˆæœå°‹åŒ…å« "2025" çš„è¡Œï¼Œé€™é€šå¸¸æ˜¯è‚¡æ¯è³‡æ–™è¡Œ
        for (let i = 0; i < allRows.length; i++) {
          const row = allRows[i];
          const rowText = row.textContent.trim();
          
          // æª¢æŸ¥æ˜¯å¦åŒ…å« 2025 å¹´ä»½
          if (rowText.includes('2025')) {
            console.log(`æ‰¾åˆ°åŒ…å« 2025 çš„è¡Œ ${i}: ${rowText}`);
            
            // æå–æ‰€æœ‰æ•¸å­—ï¼ˆåŒ…æ‹¬å°æ•¸é»ï¼‰
            const numbers = rowText.match(/(\d+(?:\.\d+)?)/g);
            if (numbers && numbers.length > 0) {
              console.log(`è¡Œ ${i} ä¸­çš„æ•¸å­—:`, numbers);
              
              // ç¬¬ä¸€å€‹æ•¸å­—é€šå¸¸æ˜¯è‚¡åˆ©é‡‘é¡
              if (!amount && numbers[0]) {
                amount = parseFloat(numbers[0]);
                console.log(`å¾è¡Œ ${i} æå–åˆ°è‚¡åˆ©é‡‘é¡: ${amount}`);
              }
            }
            
            // æå–æ—¥æœŸï¼ˆæ”¯æ´ 2025/07/17 æ ¼å¼ï¼‰
            const dateMatches = rowText.match(/(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/g);
            if (dateMatches && dateMatches.length >= 2) {
              if (!exDate) {
                exDate = dateMatches[0].replace(/\//g, '-');
                console.log(`å¾è¡Œ ${i} æå–åˆ°é™¤æ¯æ—¥: ${exDate}`);
              }
              if (!payDate) {
                payDate = dateMatches[1].replace(/\//g, '-');
                console.log(`å¾è¡Œ ${i} æå–åˆ°ç™¼æ”¾æ—¥: ${payDate}`);
              }
            }
            
            // å¦‚æœæ‰¾åˆ°è¶³å¤ çš„è³‡è¨Šï¼Œå°±åœæ­¢æœå°‹
            if (amount > 0 && exDate && payDate) {
              console.log(`æ‰¾åˆ°å®Œæ•´çš„è‚¡æ¯è³‡è¨Šï¼Œåœæ­¢æœå°‹`);
              break;
            }
          }
        }
        
        // å¦‚æœæ–¹æ³•1æ²’æœ‰æ‰¾åˆ°å®Œæ•´è³‡è¨Šï¼Œå˜—è©¦æ›´ç²¾ç¢ºçš„æœå°‹
        if (!amount || !exDate || !payDate) {
          console.log(`æ–¹æ³•1æœªæ‰¾åˆ°å®Œæ•´è³‡è¨Šï¼Œå˜—è©¦æ›´ç²¾ç¢ºçš„æœå°‹...`);
          
          // æœå°‹åŒ…å« "è‚¡åˆ©" æˆ– "é…æ¯" çš„è¡Œ
          for (let i = 0; i < allRows.length; i++) {
            const row = allRows[i];
            const rowText = row.textContent.trim();
            
            if (rowText.includes('è‚¡åˆ©') || rowText.includes('é…æ¯')) {
              console.log(`æ‰¾åˆ°åŒ…å«è‚¡æ¯é—œéµå­—çš„è¡Œ ${i}: ${rowText}`);
              
              // æå–æ•¸å­—
              const numbers = rowText.match(/(\d+(?:\.\d+)?)/g);
              if (numbers && numbers.length > 0) {
                console.log(`è‚¡æ¯è¡Œ ${i} ä¸­çš„æ•¸å­—:`, numbers);
                
                // æ‰¾åˆ°ç¬¬ä¸€å€‹å°æ•¸é»æ•¸å­—ï¼ˆé€šå¸¸æ˜¯è‚¡åˆ©é‡‘é¡ï¼‰
                for (const num of numbers) {
                  if (num.includes('.') && !amount) {
                    amount = parseFloat(num);
                    console.log(`å¾è‚¡æ¯è¡Œ ${i} æå–åˆ°è‚¡åˆ©é‡‘é¡: ${amount}`);
                    break;
                  }
                }
              }
              
              // æå–æ—¥æœŸ
              const dates = rowText.match(/(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/g);
              if (dates && dates.length >= 2) {
                if (!exDate) {
                  exDate = dates[0].replace(/\//g, '-');
                  console.log(`å¾è‚¡æ¯è¡Œ ${i} æå–åˆ°é™¤æ¯æ—¥: ${exDate}`);
                }
                if (!payDate) {
                  payDate = dates[1].replace(/\//g, '-');
                  console.log(`å¾è‚¡æ¯è¡Œ ${i} æå–åˆ°ç™¼æ”¾æ—¥: ${payDate}`);
                }
              }
            }
          }
        }
        
        // æ–¹æ³•2: å¦‚æœæ–¹æ³•1å¤±æ•—ï¼Œå˜—è©¦ç”¨æ­£å‰‡è¡¨é”å¼å¾æ•´å€‹ HTML ä¸­æå–
        if (!amount && !exDate && !payDate) {
          console.log(`æ–¹æ³•2: ç”¨æ­£å‰‡è¡¨é”å¼å¾æ•´å€‹ HTML ä¸­æå–...`);
          
          // æœå°‹è‚¡åˆ©é‡‘é¡
          const amountPatterns = [
            /(\d+(?:\.\d+)?)\s*è‚¡åˆ©/g,
            /è‚¡åˆ©[ï¼š:]\s*(\d+(?:\.\d+)?)/g,
            /(\d+(?:\.\d+)?)\s*é…æ¯/g,
            /é…æ¯[ï¼š:]\s*(\d+(?:\.\d+)?)/g
          ];
          
          for (const pattern of amountPatterns) {
            const matches = html.match(pattern);
            if (matches && matches.length > 0) {
              const numMatch = matches[0].match(/(\d+(?:\.\d+)?)/);
              if (numMatch) {
                amount = parseFloat(numMatch[1]);
                console.log(`ç”¨æ­£å‰‡è¡¨é”å¼æ‰¾åˆ°è‚¡åˆ©é‡‘é¡: ${amount}`);
                break;
              }
            }
          }
          
          // æœå°‹æ—¥æœŸ
          const dateMatches = html.match(/(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/g);
          if (dateMatches && dateMatches.length >= 2) {
            exDate = dateMatches[0].replace(/\//g, '-');
            payDate = dateMatches[1].replace(/\//g, '-');
            console.log(`ç”¨æ­£å‰‡è¡¨é”å¼æ‰¾åˆ°æ—¥æœŸ: é™¤æ¯æ—¥=${exDate}, ç™¼æ”¾æ—¥=${payDate}`);
          }
        }
        
        // æ–¹æ³•3: æœå°‹ç‰¹å®šçš„ WantGoo è¡¨æ ¼çµæ§‹
        if (!amount && !exDate && !payDate) {
          console.log(`æ–¹æ³•3: æœå°‹ç‰¹å®šçš„ WantGoo è¡¨æ ¼çµæ§‹...`);
          
          // æœå°‹åŒ…å« "é™¤æ¬Šæ¯å¹´åº¦"ã€"è‚¡åˆ©"ã€"é™¤æ¯æ—¥"ã€"ç™¼æ”¾æ—¥" çš„è¡¨æ ¼
          const tableText = html.toLowerCase();
          if (tableText.includes('é™¤æ¬Šæ¯å¹´åº¦') || tableText.includes('è‚¡åˆ©') || tableText.includes('é™¤æ¯æ—¥') || tableText.includes('ç™¼æ”¾æ—¥')) {
            console.log(`æ‰¾åˆ°åŒ…å«è‚¡æ¯é—œéµå­—çš„è¡¨æ ¼`);
            
            // æå–æ‰€æœ‰æ—¥æœŸ
            const allDates = html.match(/(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/g);
            if (allDates && allDates.length >= 2) {
              exDate = allDates[0].replace(/\//g, '-');
              payDate = allDates[1].replace(/\//g, '-');
              console.log(`å¾è¡¨æ ¼ä¸­æå–åˆ°æ—¥æœŸ: é™¤æ¯æ—¥=${exDate}, ç™¼æ”¾æ—¥=${payDate}`);
            }
            
            // æå–è‚¡åˆ©é‡‘é¡
            const amountMatch = html.match(/(\d+(?:\.\d+)?)/);
            if (amountMatch) {
              amount = parseFloat(amountMatch[1]);
              console.log(`å¾è¡¨æ ¼ä¸­æå–åˆ°è‚¡åˆ©é‡‘é¡: ${amount}`);
            }
          }
        }
        
        // æ–¹æ³•4: æ›´è©³ç´°çš„ HTML åˆ†æ
        if (!amount && !exDate && !payDate) {
          console.log(`æ–¹æ³•4: æ›´è©³ç´°çš„ HTML åˆ†æ...`);
          
          // æœå°‹åŒ…å« 2025 çš„å…§å®¹
          const lines = html.split('\n');
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.includes('2025')) {
              console.log(`æ‰¾åˆ°åŒ…å« 2025 çš„è¡Œ ${i}: ${line.substring(0, 100)}`);
              
              // æå–æ•¸å­—
              const numbers = line.match(/(\d+(?:\.\d+)?)/g);
              if (numbers && numbers.length > 0) {
                console.log(`è¡Œ ${i} ä¸­çš„æ•¸å­—:`, numbers);
                
                // ç¬¬ä¸€å€‹æ•¸å­—å¯èƒ½æ˜¯è‚¡åˆ©
                if (!amount && numbers[0]) {
                  amount = parseFloat(numbers[0]);
                  console.log(`å¾è¡Œ ${i} æå–åˆ°è‚¡åˆ©é‡‘é¡: ${amount}`);
                }
              }
              
              // æå–æ—¥æœŸ
              const dates = line.match(/(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/g);
              if (dates && dates.length >= 2) {
                if (!exDate) {
                  exDate = dates[0].replace(/\//g, '-');
                  console.log(`å¾è¡Œ ${i} æå–åˆ°é™¤æ¯æ—¥: ${exDate}`);
                }
                if (!payDate) {
                  payDate = dates[1].replace(/\//g, '-');
                  console.log(`å¾è¡Œ ${i} æå–åˆ°ç™¼æ”¾æ—¥: ${payDate}`);
                }
              }
            }
          }
        }
        
        // æª¢æŸ¥æ˜¯å¦æ‰¾åˆ°æœ‰æ•ˆçš„è‚¡æ¯è³‡è¨Š
        if (amount > 0 || exDate || payDate) {
          console.log(`âœ… æˆåŠŸè§£æ WantGoo è‚¡æ¯è³‡è¨Š:`, { amount, exDate, payDate });
          
          // å¦‚æœæ²’æœ‰æ‰¾åˆ°è‚¡åˆ©é‡‘é¡ï¼Œä½†æ‰¾åˆ°äº†æ—¥æœŸï¼Œè¡¨ç¤ºå¯èƒ½æ²’æœ‰è‚¡æ¯
          if (amount === 0 && (exDate || payDate)) {
            console.log(`âš ï¸ æ‰¾åˆ°æ—¥æœŸä½†æ²’æœ‰è‚¡åˆ©é‡‘é¡ï¼Œå¯èƒ½è¡¨ç¤ºç„¡è‚¡æ¯`);
          }
          
          return { amount, exDate, payDate };
        }
        
        console.log(`âŒ ç„¡æ³•å¾ WantGoo HTML ä¸­è§£æåˆ°è‚¡æ¯è³‡è¨Š`);
        console.log(`HTML å…§å®¹é è¦½:`, html.substring(0, 2000));
        
        // æœå°‹åŒ…å«é—œéµå­—çš„å…§å®¹
        if (html.includes('2025')) {
          console.log(`âœ… HTML ä¸­åŒ…å« 2025 å¹´ä»½`);
        }
        if (html.includes('è‚¡åˆ©')) {
          console.log(`âœ… HTML ä¸­åŒ…å«ã€Œè‚¡åˆ©ã€é—œéµå­—`);
        }
        if (html.includes('é™¤æ¯')) {
          console.log(`âœ… HTML ä¸­åŒ…å«ã€Œé™¤æ¯ã€é—œéµå­—`);
        }
        if (html.includes('ç™¼æ”¾')) {
          console.log(`âœ… HTML ä¸­åŒ…å«ã€Œç™¼æ”¾ã€é—œéµå­—`);
        }
        
        // æœå°‹åŒ…å« 0.62 çš„å…§å®¹ï¼ˆæ˜åŸºæçš„é æœŸè‚¡åˆ©ï¼‰
        if (html.includes('0.62')) {
          console.log(`âœ… HTML ä¸­åŒ…å« 0.62ï¼ˆæ˜åŸºæé æœŸè‚¡åˆ©ï¼‰`);
        }
        
        // æœå°‹åŒ…å« 2025/07/17 çš„å…§å®¹
        if (html.includes('2025/07/17')) {
          console.log(`âœ… HTML ä¸­åŒ…å« 2025/07/17ï¼ˆæ˜åŸºæé æœŸé™¤æ¯æ—¥ï¼‰`);
        }
        
        // æœå°‹åŒ…å« 2025/08/15 çš„å…§å®¹
        if (html.includes('2025/08/15')) {
          console.log(`âœ… HTML ä¸­åŒ…å« 2025/08/15ï¼ˆæ˜åŸºæé æœŸç™¼æ”¾æ—¥ï¼‰`);
        }
        
        // é¡¯ç¤ºæ‰€æœ‰åŒ…å«æ•¸å­—çš„è¡Œ
        console.log(`ğŸ” æœå°‹åŒ…å«æ•¸å­—çš„è¡Œ...`);
        const lines = html.split('\n');
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          if (line.includes('0.62') || line.includes('2025/07/17') || line.includes('2025/08/15')) {
            console.log(`æ‰¾åˆ°ç›¸é—œè¡Œ ${i}: ${line.substring(0, 200)}`);
          }
        }
        
        return null;
        
      } catch (error) {
        console.error('è§£æ WantGoo HTML æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        return null;
      }
    },

    // å¾è­‰äº¤æ‰€æŠ“å–é™¤æ¬Šé™¤æ¯è³‡è¨Š
    async fetchFromTWSE(symbol) {
      try {
        // ä½¿ç”¨å…¬é–‹è³‡è¨Šè§€æ¸¬ç«™çš„è³‡æ–™
        const url = `https://www.twse.com.tw/rwd/zh/afterTrading/STOCK_DIVIDEND?date=${new Date().toISOString().slice(0, 10).replace(/-/g, '')}&stockNo=${symbol}&response=json`;
        
        console.log(`æ­£åœ¨å¾è­‰äº¤æ‰€æŠ“å– ${symbol} çš„è‚¡æ¯è³‡è¨Š...`);
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          console.warn(`è­‰äº¤æ‰€ API å›æ‡‰éŒ¯èª¤: ${response.status} ${response.statusText}`);
          return null;
        }
        
        const data = await response.json();
        console.log(`è­‰äº¤æ‰€å›æ‡‰è³‡æ–™:`, data);
        
        // è§£æè­‰äº¤æ‰€è³‡æ–™æ ¼å¼
        if (data.data && data.data.length > 0) {
          const dividendData = data.data.find(item => 
            item[0] === symbol && item[1] && item[1].includes('ç¾é‡‘è‚¡åˆ©')
          );
          
          if (dividendData) {
            console.log(`æ‰¾åˆ° ${symbol} çš„è‚¡æ¯è³‡æ–™:`, dividendData);
            return {
              amount: parseFloat(dividendData[2]) || 0,
              exDate: dividendData[3] || null,
              payDate: dividendData[4] || null,
              source: 'TWSE'
            };
          }
        }
        
        console.log(`æœªæ‰¾åˆ° ${symbol} çš„è‚¡æ¯è³‡æ–™`);
        return null;
        
      } catch (error) {
        console.error(`å¾è­‰äº¤æ‰€æŠ“å– ${symbol} è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
        return null;
      }
    },

    // å¾ Yahoo Finance æŠ“å–è‚¡æ¯è³‡è¨Š
    async fetchFromYahoo(symbol) {
      try {
        console.log(`æ­£åœ¨å¾ Yahoo Finance æŠ“å– ${symbol} çš„è‚¡æ¯è³‡è¨Š...`);
        
        // ä½¿ç”¨ Yahoo Finance çš„åŸºæœ¬ APIï¼ˆä¸éœ€è¦ API Keyï¼‰
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.TW?interval=1d&range=1y`;
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          console.warn(`Yahoo Finance API å›æ‡‰éŒ¯èª¤: ${response.status} ${response.statusText}`);
          return null;
        }
        
        const data = await response.json();
        console.log(`Yahoo Finance å›æ‡‰è³‡æ–™:`, data);
        
        // æ³¨æ„ï¼šYahoo Finance çš„åŸºæœ¬ API ä¸åŒ…å«è‚¡æ¯è³‡è¨Š
        // éœ€è¦ä»˜è²» API æˆ–ä½¿ç”¨å…¶ä»–æ–¹æ³•
        console.log(`Yahoo Finance åŸºæœ¬ API ä¸åŒ…å«è‚¡æ¯è³‡è¨Šï¼Œéœ€è¦ä»˜è²» API`);
        return null;
        
      } catch (error) {
        console.error(`å¾ Yahoo Finance æŠ“å– ${symbol} è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
        return null;
      }
    },

    // é è¨­è³‡æ–™ï¼ˆç•¶ç¶²è·¯æŠ“å–å¤±æ•—æ™‚ä½¿ç”¨ï¼‰
    getFallbackData(symbol) {
      const wantgooUrl = `https://www.wantgoo.com/stock/etf/${symbol}/dividend-policy/ex-dividend`;
      const dividendInfo = {
        '0050': { amount: 1500, exDate: '2025-09-15', payDate: '2025-10-15', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'semiannual', payoutMonths: [6, 12] },
        '00878': { amount: 800, exDate: '2025-09-20', payDate: '2025-10-20', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'quarterly', payoutMonths: [3, 6, 9, 12] },
        '00923': { amount: 1200, exDate: '2025-09-25', payDate: '2025-10-25', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'semiannual', payoutMonths: [6, 12] },
        '8215': { amount: 600, exDate: '2025-09-30', payDate: '2025-10-30', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'annual', payoutMonths: [7] },
        '00646': { amount: 900, exDate: '2025-09-10', payDate: '2025-10-10', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'none', payoutMonths: [] },
        '00687B': { amount: 300, exDate: '2025-09-05', payDate: '2025-09-25', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'quarterly', payoutMonths: [3, 6, 9, 12] },
        '00719B': { amount: 250, exDate: '2025-09-08', payDate: '2025-09-28', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'quarterly', payoutMonths: [3, 6, 9, 12] },
        '00772B': { amount: 280, exDate: '2025-09-12', payDate: '2025-10-02', source: 'WantGoo (é è¨­)', sourceUrl: wantgooUrl, frequency: 'monthly', payoutMonths: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12] }
      };
      
      console.log(`ä½¿ç”¨é è¨­è³‡æ–™:`, dividendInfo[symbol]);
      return dividendInfo[symbol] || { amount: 0, exDate: null, payDate: null, source: 'Fallback', frequency: 'none', payoutMonths: [] };
    }
  };

  // é æ¸¬ä¸‹æ¬¡è‚¡æ¯è³‡è¨Šï¼ˆæ”¹ç‚ºéåŒæ­¥ï¼‰
  async function predictNextDividend(symbol, currentDate) {
    try {
      const data = await dividendProvider.fetch(symbol);
      return data;
    } catch (error) {
      console.warn(`å–å¾— ${symbol} è‚¡æ¯è³‡è¨Šå¤±æ•—:`, error);
      return dividendProvider.getFallbackData(symbol);
    }
  }

  // ========= åƒ¹æ ¼ CSV åŒ¯å…¥ (symbol,price) =========
  $('#import-csv').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const lines = reader.result.split(/\r?\n/).filter(Boolean);
      for(const line of lines){
        const [sym, price] = line.split(',').map(s=>s.trim());
        const s = DB.stocks.find(x=>x.symbol===sym);
        if(s){ s.price = parseN(price); s.lastPriceAt = nowISO(); }
      }
      saveDB(); fullRender();
    };
    reader.readAsText(f);
  });

  // ========= äº’å‹•ï¼šTabs / æœå°‹ =========
  $$('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      $$('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
      tab.setAttribute('aria-selected','true');
      $$('.view').forEach(v=>v.classList.remove('active'));
      $(tab.dataset.target).classList.add('active');

      // åˆ‡åˆ°æŒæœ‰æ¨™çš„æ™‚ï¼Œç¢ºä¿é‡ç®—ï¼ˆåŒ…å«é•·æœŸæŒ‡æ¨™ï¼‰
      if(tab.dataset.target==='#view-holdings'){ renderHoldings(); renderLongTermMetrics(); }
      // åˆ‡åˆ°ç•°å‹•ç´€éŒ„æ™‚ï¼Œç¢ºä¿é‡ç®—
      if(tab.dataset.target==='#view-txns'){ renderTxns(); }
      // åˆ‡åˆ°è‚¡æ¯è¦åŠƒæ™‚ï¼Œç¢ºä¿é‡ç®—
      if(tab.dataset.target==='#view-dividend'){ renderDividend(); }
      // åˆ‡åˆ°å ±é…¬æª¢è¦–æ™‚ï¼Œç¢ºä¿é‡ç®—
      if(tab.dataset.target==='#view-return'){ renderReturnOverview(); }
    })
  });
  $('#q').addEventListener('change', ()=> {
    renderHoldings();
    renderTxns();
  });

  const allocationTargetBtn = $('#btn-edit-allocation-target');
  if(allocationTargetBtn){ allocationTargetBtn.addEventListener('click', openAllocationTargetDialog); }
  const allocationTargetDialog = $('#dlg-allocation-target');
  if(allocationTargetDialog){
    allocationTargetDialog.addEventListener('close', ()=>{
      if(allocationTargetDialog.returnValue !== 'ok') return;
      const equityInput = $('#target-equity');
      const bondInput = $('#target-bond');
      const equity = parseN(equityInput.value);
      const bond = parseN(bondInput.value);
      const total = equity + bond;
      if(total <= 0){
        alert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ¯”ä¾‹');
        setTimeout(openAllocationTargetDialog, 0);
        return;
      }
      if(Math.abs(total - 100) > 0.01){
        alert('è‚¡ç¥¨èˆ‡å‚µåˆ¸æ¯”ä¾‹ç¸½å’Œéœ€ç‚º 100%');
        setTimeout(openAllocationTargetDialog, 0);
        return;
      }
      const target = {
        equity: Number(equity.toFixed(2)),
        bond: Number(bond.toFixed(2))
      };
      saveAllocationTarget(target);
      renderAllocation();
    });
  }

  const regionTargetBtn = $('#btn-edit-region-target');
  if(regionTargetBtn){ regionTargetBtn.addEventListener('click', openRegionTargetDialog); }
  const regionTargetDialog = $('#dlg-region-target');
  if(regionTargetDialog){
    regionTargetDialog.addEventListener('close', ()=>{
      if(regionTargetDialog.returnValue !== 'ok') return;
      const twInput = $('#target-tw');
      const globalInput = $('#target-global');
      const tw = parseN(twInput.value);
      const global = parseN(globalInput.value);
      const total = tw + global;
      if(total <= 0){
        alert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ¯”ä¾‹');
        setTimeout(openRegionTargetDialog, 0);
        return;
      }
      if(Math.abs(total - 100) > 0.01){
        alert('å°ç£èˆ‡å…¨çƒæ¯”ä¾‹ç¸½å’Œéœ€ç‚º 100%');
        setTimeout(openRegionTargetDialog, 0);
        return;
      }
      const target = {
        tw: Number(tw.toFixed(2)),
        global: Number(global.toFixed(2))
      };
      saveRegionTarget(target);
      renderAllocation();
    });
  }

  const plannerTable = $('#tbl-allocation-planner');
  if(plannerTable){
    plannerTable.addEventListener('input', (event)=>{
      const input = event.target.closest('.planner-input');
      if(!input) return;
      const id = input.dataset.id;
      let value = parseN(input.value);
      if(!Number.isFinite(value)){ value = 0; }
      allocationPlannerAdjustments[id] = value;
      updateAllocationPlannerSummary();
    });
  }
  const plannerResetBtn = $('#btn-reset-planner');
  if(plannerResetBtn){
    plannerResetBtn.addEventListener('click', ()=>{
      allocationPlannerBase.forEach(item => {
        allocationPlannerAdjustments[item.id] = 0;
        const input = document.querySelector(`.planner-input[data-id="${item.id}"]`);
        if(input) input.value = 0;
      });
      updateAllocationPlannerSummary();
    });
  }
  
  // ç•°å‹•ç´€éŒ„é é¢çš„ç¯©é¸å™¨äº‹ä»¶ç›£è½å™¨
  $('#q-txn').addEventListener('change', ()=> {
    renderTxns();
  });
  
  $('#type-filter').addEventListener('change', ()=> {
    renderTxns();
  });
  
  // è‡ªå®šç¾©ç¶²å€æŒ‰éˆ•ï¼ˆå·²ç§»é™¤ UIï¼Œä¿ç•™å ä½é¿å…äº‹ä»¶ç¶å®šéŒ¯èª¤ï¼‰

  // ========= äº’å‹•ï¼šæŒæœ‰è¡¨æ ¼ =========
  $('#tbl-holdings').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    const stock = DB.stocks.find(s=>s.id===id);
    if(action==='edit-stock'){
      openStockDialog(stock);
    }
  });

  // å³æ™‚æ›´æ–°å…¨éƒ¨
  const handleRefreshAllClick = async (e)=>{
    const isAutoRefresh = e === true;
    const buttons = $$('[data-action="refresh-all"]');
    const originalStates = buttons.map(btn => ({btn, text: btn.textContent}));
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.textContent = 'æ›´æ–°ä¸­â€¦';
    });

    let successCount = 0;
    let encounteredError = false;

    try{
      console.log('é–‹å§‹æ›´æ–°è‚¡åƒ¹ï¼Œå…±', DB.stocks.length, 'å€‹æ¨™çš„');
      
      const tasks = DB.stocks.map(async (s) => {
        try{
          console.log(`æ­£åœ¨æ›´æ–° ${s.symbol} çš„è‚¡åƒ¹...`);
          const q = await priceProvider.fetch(s.symbol);
          console.log(`${s.symbol} æ›´æ–°çµæœ:`, q);
          
          if(q && typeof q.price==='number'){
            const oldPrice = s.price;
            s.price = q.price; 
            s.lastPriceAt = nowISO(); 
            console.log(`${s.symbol} è‚¡åƒ¹å¾ ${oldPrice} æ›´æ–°ç‚º ${q.price}`);
            return {ok:true, symbol: s.symbol, price: q.price};
          }
          console.log(`${s.symbol} æ›´æ–°å¤±æ•—ï¼Œç„¡æ³•å–å¾—æœ‰æ•ˆåƒ¹æ ¼`);
          return {ok:false, symbol: s.symbol};
        }catch(err){
          console.error(`${s.symbol} æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err);
          return {ok:false, symbol: s.symbol, error: err.message};
        }
      });
      
      const results = await Promise.allSettled(tasks);
      console.log('æ‰€æœ‰è‚¡åƒ¹æ›´æ–°çµæœ:', results);
      
      successCount = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
      console.log(`æˆåŠŸæ›´æ–° ${successCount}/${DB.stocks.length} å€‹æ¨™çš„çš„è‚¡åƒ¹`);
      
      saveDB(); 
      fullRender();
    }catch(err){
      encounteredError = true;
      console.error('å³æ™‚æ›´æ–°å…¨éƒ¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }finally{
      originalStates.forEach(({btn, text})=>{
        btn.disabled = false;
        btn.textContent = text;
      });
    }

    if (!isAutoRefresh) {
      if(encounteredError || successCount === 0) {
        alert('è‚¡åƒ¹æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦\n\nè«‹åœ¨çµ‚ç«¯æ©Ÿè¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤\ncd ~/Documents/VibeCoding && npm start');
      } else {
        alert(`è‚¡åƒ¹æ›´æ–°å®Œæˆï¼æˆåŠŸæ›´æ–° ${successCount} å€‹æ¨™çš„çš„è‚¡åƒ¹`);
      }
    }
  };

  $$('[data-action="refresh-all"]').forEach(btn=>{
    btn.addEventListener('click', handleRefreshAllClick);
  });

  // ========= Dialogï¼šStock =========
  $('#btn-add-stock').addEventListener('click', ()=> openStockDialog());
  function openStockDialog(stock){
    const dlg = $('#dlg-stock');
    $('#stock-symbol').value = stock?.symbol || '';
    $('#stock-name').value = stock?.name || '';
    $('#stock-market').value = stock?.market || 'TW';
    $('#stock-class').value = stock?.assetClass || 'Equity';
    $('#stock-price').value = Number.isFinite(parseN(stock?.price))? parseN(stock?.price).toFixed(2): '';
    $('#stock-currency').value = stock?.currency || '';
    dlg.returnValue = '';
    dlg.showModal();
    dlg.addEventListener('close', () => {
      if(dlg.returnValue!=='ok') return;
      const symbol = $('#stock-symbol').value.trim();
      const name = $('#stock-name').value.trim();
      if(!symbol || !name) return;
      const payload = {
        id: stock?.id || uid(),
        symbol, name,
        market: $('#stock-market').value,
        assetClass: $('#stock-class').value,
        price: $('#stock-price').value? parseN($('#stock-price').value): undefined,
        currency: $('#stock-currency').value.trim(),
        lastPriceAt: nowISO()
      };
      if(stock){ Object.assign(stock, payload); }
      else{ DB.stocks.push(payload); }
      saveDB(); fullRender();
    }, {once:true});
  }

  // ========= Dialogï¼šTransaction =========
  const openTxnDialog = (txn) =>{
    const dlg = $('#dlg-txn');
    const sel = $('#txn-stock');
    sel.innerHTML = DB.stocks.map(s=>`<option value="${s.id}">${s.symbol} Â· ${s.name}</option>`).join('');
    if(DB.stocks.length===0){ alert('è«‹å…ˆæ–°å¢æ¨™çš„'); return; }

    $('#txn-stock').value = txn?.stockId || DB.stocks[0].id;
    $('#txn-account').value = txn?.account || 'ctbc';
    $('#txn-type').value = txn?.type || 'buy';
    $('#txn-price').value = Number.isFinite(parseN(txn?.price))? parseN(txn?.price).toFixed(2): '';
    $('#txn-qty').value = Number.isFinite(parseN(txn?.qty))? parseN(txn?.qty).toFixed(2): '';
    $('#txn-amount').value = Number.isFinite(parseN(txn?.amount))? Math.round(parseN(txn?.amount)) : '';
    $('#txn-time').value = txn? new Date(txn.time).toISOString().slice(0,16) : new Date().toISOString().slice(0,16);
    $('#txn-note').value = txn?.note || '';

    const recalc = ()=>{
      const type = $('#txn-type').value;
      const price = parseN($('#txn-price').value);
      const qty = parseN($('#txn-qty').value);
      if(type==='dividend') return;
      $('#txn-amount').value = Math.round(price*qty) || '';
    };
    $('#txn-price').oninput = recalc; $('#txn-qty').oninput = recalc; $('#txn-type').onchange = recalc;

    dlg.returnValue=''; dlg.showModal();
    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='ok') return;
      const t = {
        id: txn?.id || uid(),
        stockId: $('#txn-stock').value,
        account: $('#txn-account').value,
        type: $('#txn-type').value,
        price: $('#txn-price').value? parseN($('#txn-price').value): undefined,
        qty: $('#txn-qty').value? parseN($('#txn-qty').value): undefined,
        amount: $('#txn-amount').value? parseN($('#txn-amount').value): undefined,
        time: new Date($('#txn-time').value).toISOString(),
        note: $('#txn-note').value.trim()
      };
      if(txn){ Object.assign(txn, t); }
      else{ DB.txns.push(t); }
      saveDB(); fullRender();
    }, {once:true});
  };
  $('#btn-add-txn').addEventListener('click', ()=> openTxnDialog());
  $('#btn-add-txn-2').addEventListener('click', ()=> openTxnDialog());

  $('#tbl-txns').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    const txn = DB.txns.find(x=>x.id===id);
    if(action==='edit-txn') openTxnDialog(txn);
    if(action==='del-txn'){
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç•°å‹•ï¼Ÿ')){ DB.txns = DB.txns.filter(x=>x.id!==id); saveDB(); fullRender(); }
    }
  });

  // ========= å¸³æˆ¶ Dialog =========
  function openAccountDialog(acct){
    const dlg = $('#dlg-account');
    $('#acct-name').value = acct?.name || '';
    $('#acct-actual').value = Number.isFinite(parseN(acct?.actual))? Math.round(parseN(acct?.actual)) : '';
    $('#acct-settle').value = Number.isFinite(parseN(acct?.settlement))? Math.round(parseN(acct?.settlement)) : '';
    $('#acct-note').value = acct?.note || '';

    dlg.returnValue=''; dlg.showModal();
    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='ok') return;
      const payload = {
        id: acct?.id || uid(),
        name: $('#acct-name').value.trim(),
        actual: Math.round(parseN($('#acct-actual').value)),
        settlement: Math.round(parseN($('#acct-settle').value)),
        note: $('#acct-note').value.trim(),
        history: acct?.history || []
      };
      if(acct){ Object.assign(acct, payload); }
      else{
        DB.accounts.push(payload);
      }
      saveDB(); fullRender();
    }, {once:true});
  }

  function openCapitalDialog(acct, historyIndex, options = {}){
    const isInitial = !!options.initial;
    if(!acct && !isInitial) return;
    const dlg = $('#dlg-capital');
    const typeInput = $('#cap-type');
    const amountInput = $('#cap-amount');
    const dateInput = $('#cap-date');
    const noteInput = $('#cap-note');
    const depositOnly = !!options.depositOnly || isInitial;
    const toLocalInput = (date) => {
      const dt = (date instanceof Date) ? date : new Date(date);
      if(isNaN(dt.valueOf())) return '';
      return new Date(dt.getTime() - dt.getTimezoneOffset()*60000).toISOString().slice(0,16);
    };

    const entries = isInitial ? [ensureInitialCapitalEntry()] : (acct.history || []);
    const idx = isInitial ? 0 : (Number.isInteger(historyIndex) ? historyIndex : null);
    const isEdit = isInitial || (idx !== null && entries[idx]);
    let originalAmount = 0;
    let originalType = null;

    if(isEdit){
      const entry = entries[idx];
      originalAmount = parseN(entry.amount);
      originalType = entry.type;
      const normalizedType = entry.type === 'withdraw' ? 'withdraw' : 'deposit';
      typeInput.value = depositOnly ? 'deposit' : normalizedType;
      amountInput.value = Math.abs(parseN(entry.amount)) || '';
      noteInput.value = entry.note || '';
      dateInput.value = entry.time ? toLocalInput(entry.time) : toLocalInput(new Date());
    }else{
      typeInput.value = 'deposit';
      amountInput.value = '';
      noteInput.value = '';
      dateInput.value = toLocalInput(new Date());
    }
    typeInput.disabled = depositOnly;

    dlg.returnValue = '';
    const onClose = ()=>{
      if(dlg.returnValue !== 'ok') return;
      const amount = Math.round(Math.abs(parseN(amountInput.value)));
      if(!amount){ alert('è«‹è¼¸å…¥é‡‘é¡'); return; }
      const type = depositOnly ? 'deposit' : (typeInput.value === 'withdraw' ? 'withdraw' : 'deposit');
      const note = noteInput.value.trim();
      const dateVal = dateInput.value;
      let time = nowISO();
      if(dateVal){
        const dt = new Date(dateVal);
        if(!isNaN(dt.valueOf())){
          time = dt.toISOString();
        }
      }
      const signedAmount = type === 'withdraw' ? -amount : amount;

      if(isInitial){
        const entry = ensureInitialCapitalEntry();
        entry.amount = signedAmount;
        entry.note = note || 'èµ·å§‹æŠ•å…¥';
        entry.time = time;
      }else if(isEdit){
        if(originalType === 'deposit' || originalType === 'withdraw'){
          acct.actual = Math.round(parseN(acct.actual) - originalAmount);
        }
        if(type === 'deposit' || type === 'withdraw'){
          acct.actual = Math.round(parseN(acct.actual) + signedAmount);
        }
        Object.assign(entries[idx], { time, type, amount: signedAmount, note });
      }else{
        if(type === 'deposit' || type === 'withdraw'){
          acct.actual = Math.round(parseN(acct.actual) + signedAmount);
        }
        acct.history = acct.history || [];
        acct.history.push({ time, type, amount: signedAmount, note });
      }
      saveDB();
      fullRender();
    };
    dlg.addEventListener('close', onClose, {once:true});
    dlg.showModal();
  }

  $('#accounts-list').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    const acct = DB.accounts.find(a=>a.id===id);
    if(action==='edit-account') openAccountDialog(acct);
    if(action==='capital-change') openCapitalDialog(acct);
    if(action==='edit-history'){
      const historyIndex = Number(btn.dataset.historyIndex);
      if(Number.isInteger(historyIndex)) openCapitalDialog(acct, historyIndex);
    }
    if(action==='del-history'){
      const historyIndex = Number(btn.dataset.historyIndex);
      if(Number.isInteger(historyIndex) && acct && acct.history && acct.history[historyIndex]){
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')){
          const entry = acct.history[historyIndex];
          if(entry && (entry.type==='deposit' || entry.type==='withdraw')){
            acct.actual = Math.round(parseN(acct.actual) - parseN(entry.amount));
          }
          acct.history.splice(historyIndex, 1);
          saveDB();
          fullRender();
        }
      }
    }
    if(action==='del-account'){
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤å¸³æˆ¶ï¼Ÿ')){ DB.accounts = DB.accounts.filter(a=>a.id!==id); saveDB(); fullRender(); }
    }
  });

  const investAddBtn = $('#btn-add-invest-log');
  if(investAddBtn){
    investAddBtn.addEventListener('click', ()=>{
      if(DB.accounts.length===0){ alert('è«‹å…ˆæ–°å¢å¸³æˆ¶'); return; }
      const select = $('#invest-log-account');
      const targetId = select && select.value ? select.value : (DB.accounts[0]?.id);
      const acct = DB.accounts.find(a=>a.id===targetId);
      if(!acct){ alert('è«‹å…ˆæ–°å¢å¸³æˆ¶'); return; }
      openCapitalDialog(acct);
    });
  }

  const investLogBox = $('#invest-cash-log');
  if(investLogBox){
    investLogBox.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const action = btn.dataset.action;
      if(action!=='edit-invest-log' && action!=='del-invest-log') return;
      const source = btn.dataset.source || 'history';
      if(source === 'initial'){
        if(action==='edit-invest-log'){
          openCapitalDialog(null, null, { initial: true });
        }
        return;
      }
      const accountId = btn.dataset.accountId;
      const historyIndex = Number(btn.dataset.historyIndex);
      const acct = DB.accounts.find(a=>a.id===accountId);
      if(!acct || !Number.isInteger(historyIndex)) return;
      if(action==='edit-invest-log'){
        openCapitalDialog(acct, historyIndex);
      }
      if(action==='del-invest-log'){
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æŠ•è³‡ç´€éŒ„ï¼Ÿ')){
          const entry = acct.history && acct.history[historyIndex];
          if(entry && entry.type==='deposit'){
            acct.actual = Math.round(parseN(acct.actual) - parseN(entry.amount));
            acct.history.splice(historyIndex, 1);
            saveDB(); fullRender();
          }
        }
      }
    });
  }

  // ========= è³‡ç”¢æˆæœï¼šæ–°å¢/ç·¨è¼¯ =========
  $('#btn-add-snapshot').addEventListener('click', ()=> openSnapshotDialog());
  function openSnapshotDialog(snapshot){
    const dlg = $('#dlg-snapshot');
    
    // è¨ˆç®—ç•¶å‰å¸‚å€¼å’Œå¯ç”¨ç¾é‡‘
    const pos = computeAllPositions();
    const currentHoldings = Object.values(pos).reduce((a,b)=>a + b.marketValue, 0);
    const currentCash = DB.accounts.reduce((a,acc)=> a + (parseN(acc.actual) + parseN(acc.settlement)), 0);
    const currentTotal = currentHoldings + currentCash;
    
    $('#snapshot-date').value = snapshot?.date || todayStr();
    $('#snapshot-holdings').value = snapshot ? Math.round(parseN(snapshot.holdings)) : Math.round(currentHoldings);
    $('#snapshot-cash').value = snapshot ? Math.round(parseN(snapshot.cash)) : Math.round(currentCash);
    $('#snapshot-total').value = Math.round(currentTotal);
    $('#snapshot-note').value = snapshot?.note || '';
    
    // å³æ™‚è¨ˆç®—ç¸½è³‡ç”¢
    const updateTotal = () => {
      const holdings = parseN($('#snapshot-holdings').value) || 0;
      const cash = parseN($('#snapshot-cash').value) || 0;
      $('#snapshot-total').value = Math.round(holdings + cash);
    };
    
    $('#snapshot-holdings').addEventListener('input', updateTotal);
    $('#snapshot-cash').addEventListener('input', updateTotal);
    
    dlg.returnValue=''; dlg.showModal();
    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='ok') return;
      const date = $('#snapshot-date').value;
      const holdings = Math.round(parseN($('#snapshot-holdings').value));
      const cash = Math.round(parseN($('#snapshot-cash').value));
      const total = holdings + cash;
      const note = $('#snapshot-note').value.trim();
      const prev = DB.snapshots.filter(s=>s.date<date).sort((a,b)=> a.date<b.date?1:-1)[0];
      const deltaAmt = prev? total - prev.total : 0;
      const deltaPct = prev? (deltaAmt / (prev.total||1)) : 0;
      const record = {date, holdings, cash, total, deltaAmt, deltaPct, note};
      const idx = DB.snapshots.findIndex(s=>s.date===date);
      if(idx>=0) DB.snapshots[idx]=record; else DB.snapshots.push(record);
      saveDB(); fullRender();
    }, {once:true});
  }
  const snapshotTable = $('#tbl-snapshots');
  if(snapshotTable){
    snapshotTable.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]'); if(!btn) return;
      e.preventDefault();
      const action = btn.dataset.action === 'del-snapshot' ? 'delete' : 'edit';
      handleSnapshotAction(action, btn.dataset.id);
    });
  }

  function sampleData(){
    const s1 = {id:uid(), symbol:'0050', name:'å…ƒå¤§å°ç£50', market:'TW', assetClass:'Equity', price:150, currency:'TWD', lastPriceAt: nowISO()};
    const s2 = {id:uid(), symbol:'VTI', name:'Vanguard Total Stock', market:'Global', assetClass:'Equity', price:2600, currency:'TWD', lastPriceAt: nowISO()};
    const s3 = {id:uid(), symbol:'00687B', name:'åœ‹æ³°20å¹´ç¾å‚µ', market:'TW', assetClass:'Bond', price:33.5, currency:'TWD', lastPriceAt: nowISO()};
    const t0 = new Date();
    const tx = [
      {id:uid(), stockId:s1.id, type:'buy', price:140, qty:100, time:new Date(t0-86400000*20).toISOString(), note:'åˆ†æ‰¹è²·å…¥'},
      {id:uid(), stockId:s1.id, type:'buy', price:155, qty:50, time:new Date(t0-86400000*10).toISOString()},
      {id:uid(), stockId:s1.id, type:'dividend', amount:800, time:new Date(t0-86400000*5).toISOString(), note:'å­£é…æ¯'},
      {id:uid(), stockId:s2.id, type:'buy', price:2500, qty:2, time:new Date(t0-86400000*18).toISOString()},
      {id:uid(), stockId:s2.id, type:'buy', price:2550, qty:1, time:new Date(t0-86400000*7).toISOString()},
      {id:uid(), stockId:s3.id, type:'buy', price:32.8, qty:100, time:new Date(t0-86400000*14).toISOString()},
      {id:uid(), stockId:s3.id, type:'sell', price:33.2, qty:20, time:new Date(t0-86400000*3).toISOString(), note:'èª¿ç¯€'}
    ];
    const a1 = {id:uid(), name:'åˆ¸å•†ä¸€', actual: 200000, settlement: -15000, note:'ä¸»è¦äº¤æ˜“', history:[{time:nowISO(), type:'deposit', amount:200000, note:'åˆå§‹'}]};
    const a2 = {id:uid(), name:'åˆ¸å•†äºŒ', actual: 80000, settlement: 0, note:'å‚™ç”¨', history:[{time:nowISO(), type:'deposit', amount:80000}]};
    const snapshots = [];
    return {stocks:[s1,s2,s3], txns:tx, accounts:[a1,a2], snapshots};
  }

  // ========= ä»£ç†ä¼ºæœå™¨æ§åˆ¶ =========
  // æª¢æŸ¥æ˜¯å¦åœ¨ Electron ç’°å¢ƒä¸­
  const isElectron = typeof window !== 'undefined' && window.electronAPI;
  
  // å•Ÿå‹•ä»£ç†ä¼ºæœå™¨
  async function startProxyServer() {
    if (isElectron) {
      try {
        const result = await window.electronAPI.startProxyServer();
        if (result.success) {
          updateProxyStatus('running', 'ä»£ç†ä¼ºæœå™¨å·²å•Ÿå‹•');
          const startBtn = $('#btn-start-proxy');
          if (startBtn) startBtn.style.display = 'none';
        } else {
          alert('å•Ÿå‹•å¤±æ•—ï¼š' + result.message);
        }
      } catch (error) {
        alert('å•Ÿå‹•å¤±æ•—ï¼š' + error.message);
      }
    } else {
      // åœ¨ç€è¦½å™¨ç’°å¢ƒä¸­ï¼Œæä¾›æ‰‹å‹•å•Ÿå‹•æŒ‡å¼•
      alert('è«‹åœ¨çµ‚ç«¯æ©Ÿä¸­åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä¾†å•Ÿå‹•ä»£ç†ä¼ºæœå™¨ï¼š\n\ncd /Users/harrychao/Documents/VibeCoding\nnode scripts/proxy-server.js\n\næˆ–è€…ä½¿ç”¨ Electron ç‰ˆæœ¬ï¼š\nnpm run electron');
    }
  }
  
  // æ›´æ–°ä»£ç†ä¼ºæœå™¨ç‹€æ…‹é¡¯ç¤º
  function updateProxyStatus(status, message) {
    const statusEl = $('#proxy-status');
    if (!statusEl) return;
    statusEl.textContent = message;
  
    if (status === 'running') {
      statusEl.className = 'badge green';
    } else if (status === 'stopped') {
      statusEl.className = 'badge red';
    } else {
      statusEl.className = 'badge gray';
    }
  }
  
  // æª¢æŸ¥ä»£ç†ä¼ºæœå™¨ç‹€æ…‹
  async function checkProxyStatus() {
    const startBtn = $('#btn-start-proxy');
    if (isElectron) {
      try {
        const result = await window.electronAPI.getProxyStatus();
        if (result.running) {
          updateProxyStatus('running', 'ä»£ç†ä¼ºæœå™¨é‹è¡Œä¸­');
          if (startBtn) startBtn.style.display = 'none';
        } else {
          updateProxyStatus('stopped', 'ä»£ç†ä¼ºæœå™¨æœªé‹è¡Œ');
          if (startBtn) startBtn.style.display = '';
        }
      } catch (error) {
        console.error('æª¢æŸ¥ä»£ç†ä¼ºæœå™¨ç‹€æ…‹å¤±æ•—:', error);
        if (startBtn) startBtn.style.display = '';
      }
    } else {
      // åœ¨ç€è¦½å™¨ç’°å¢ƒä¸­ï¼Œå˜—è©¦é€£æ¥åˆ°ä»£ç†ä¼ºæœå™¨
      try {
        const response = await fetch('http://localhost:3000/health');
        if (response.ok) {
          updateProxyStatus('running', 'ä»£ç†ä¼ºæœå™¨é‹è¡Œä¸­');
          if (startBtn) startBtn.style.display = 'none';
        } else {
          updateProxyStatus('stopped', 'ä»£ç†ä¼ºæœå™¨æœªé‹è¡Œ');
          if (startBtn) startBtn.style.display = '';
        }
      } catch (error) {
        updateProxyStatus('stopped', 'ä»£ç†ä¼ºæœå™¨æœªé‹è¡Œ');
        if (startBtn) startBtn.style.display = '';
      }
    }
  }
  
  // ç¶å®šæŒ‰éˆ•äº‹ä»¶
  $('#btn-start-proxy').addEventListener('click', startProxyServer);
  
  // ç¶å®šæ™‚é–“ç¯„åœé¸æ“‡å™¨äº‹ä»¶
  $$('.range-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const rangeValue = parseInt(btn.dataset.range);
      // æ›´æ–°æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
      $$('.range-btn').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.range) === rangeValue);
      });
      // æ›´æ–°ç•¶å‰ç¯„åœ
      currentRange = rangeValue;
      // é‡æ–°æ¸²æŸ“åœ–è¡¨
      renderSnapshots();
    });
  });
  
  // ç›£è½ Electron çš„ä»£ç†ä¼ºæœå™¨ç‹€æ…‹æ›´æ–°
  if (isElectron) {
    window.electronAPI.onProxyServerStatus((event, data) => {
      console.log('ä»£ç†ä¼ºæœå™¨ç‹€æ…‹æ›´æ–°:', data);
      if (data.status === 'running') {
        updateProxyStatus('running', 'ä»£ç†ä¼ºæœå™¨é‹è¡Œä¸­');
        const startBtn = $('#btn-start-proxy');
        if (startBtn) startBtn.style.display = 'none';
      } else if (data.status === 'stopped') {
        updateProxyStatus('stopped', 'ä»£ç†ä¼ºæœå™¨å·²åœæ­¢');
        const startBtn = $('#btn-start-proxy');
        if (startBtn) startBtn.style.display = '';
      }
    });
  }

  // ========= åˆæ¬¡æ¸²æŸ“ =========
  function fullRender(){
    updateSearchDropdown();
    refreshKPI();
    renderHoldings();
    renderLongTermMetrics();
    renderTxns();
    renderAccounts();
    renderSnapshots();
    renderAllocation();
    renderDividend();
    renderReturnOverview();
    checkProxyStatus(); // æª¢æŸ¥ä»£ç†ä¼ºæœå™¨ç‹€æ…‹
  }
  
  function ensureDividendMonthOptions(){
    const container = $('#dividend-months');
    if(!container || container.dataset.ready === 'true') return;
    for(let month = 1; month <= 12; month++){
      const label = document.createElement('label');
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.gap = '4px';
      label.style.fontSize = '12px';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = String(month);
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(`${month}æœˆ`));
      container.appendChild(label);
    }
    container.dataset.ready = 'true';
  }

  // ========= æ‰‹å‹•ç·¨è¼¯è‚¡æ¯è³‡è¨Š =========
  function openDividendEdit(symbol) {
    const stock = DB.stocks.find(s => s.symbol === symbol);
    if (!stock) return;
    const positions = computeAllPositions();
    const position = positions[stock.id] || { qty: 0 };
    const currentQty = parseN(position.qty);
    
    // å–å¾—ç›®å‰çš„è‚¡æ¯è³‡è¨Š
    const currentDividendInfo = getCurrentDividendInfo(symbol);
    ensureDividendMonthOptions();
    const frequencySelect = $('#dividend-frequency');
    const monthsContainer = $('#dividend-months');
    const selectedMonths = normalizeDividendMonths(currentDividendInfo.payoutMonths);
    if(frequencySelect){
      const defaultFrequency = getDefaultDividendFrequency(symbol);
      const freqValue = normalizeFrequencyCode(currentDividendInfo.frequency) || defaultFrequency;
      frequencySelect.value = freqValue;
    }
    if(monthsContainer){
      monthsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.checked = selectedMonths.includes(Number(cb.value));
      });
    }
    
    // å¡«å…¥å°è©±æ¡†
    $('#dividend-symbol').value = symbol;
    $('#dividend-name').value = stock.name || '';
    $('#dividend-payout-time').value = currentDividendInfo.payoutTime || '';
    $('#dividend-per-share').value = currentDividendInfo.perShare || '';
    const perShareInput = $('#dividend-per-share');
    const totalAmountInput = $('#dividend-total-amount');
    const defaultTotalAmount = parseN(currentDividendInfo.totalAmount) > 0
      ? parseN(currentDividendInfo.totalAmount)
      : (parseN(currentDividendInfo.perShare) || 0) * currentQty;
    totalAmountInput.value = defaultTotalAmount ? Math.round(defaultTotalAmount) : '';
    $('#dividend-ex-date').value = currentDividendInfo.exDate || '';
    $('#dividend-pay-date').value = currentDividendInfo.payDate || '';
    $('#dividend-yield').value = currentDividendInfo.yield || '';
    let totalManualOverride = false;
    totalAmountInput.addEventListener('input', ()=>{ totalManualOverride = true; });
    perShareInput.addEventListener('input', ()=>{
      if(totalManualOverride) return;
      const perShareVal = parseN(perShareInput.value);
      totalAmountInput.value = Math.round(perShareVal * currentQty) || 0;
    });
    
    // é¡¯ç¤ºå°è©±æ¡†
    const dlg = $('#dlg-dividend-edit');
    dlg.returnValue = '';
    dlg.showModal();
    
    // è™•ç†å„²å­˜
    dlg.addEventListener('close', () => {
      if (dlg.returnValue !== 'ok') return;
      
      const payoutTime = $('#dividend-payout-time').value.trim();
      const perShare = parseFloat($('#dividend-per-share').value) || 0;
      const exDate = $('#dividend-ex-date').value || '';
      const payDate = $('#dividend-pay-date').value || '';
      const yield = parseFloat($('#dividend-yield').value) || 0;
      const frequency = $('#dividend-frequency').value || 'none';
      const payoutMonths = monthsContainer ? normalizeDividendMonths(Array.from(monthsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => Number(cb.value))) : [];
      const totalAmount = Math.round(parseN($('#dividend-total-amount').value)) || 0;
      
      // å„²å­˜åˆ° localStorage
      saveDividendInfo(symbol, {
        payoutTime: payoutTime,
        perShare: perShare,
        exDate: exDate,
        payDate: payDate,
        yield: yield,
        frequency: frequency,
        payoutMonths: payoutMonths,
        totalAmount,
        source: 'æ‰‹å‹•è¼¸å…¥',
        sourceUrl: getDividendUrl(symbol),
        lastUpdated: new Date().toISOString()
      });
      
      // é‡æ–°æ¸²æŸ“è‚¡æ¯è¦åŠƒ
      renderDividend();
    }, { once: true });
  }
  
  // å–å¾—ç›®å‰çš„è‚¡æ¯è³‡è¨Š
  function getCurrentDividendInfo(symbol) {
    const key = `dividend_${symbol}`;
    const saved = localStorage.getItem(key);
    if (saved) {
      try {
        const info = JSON.parse(saved);
        const normalizedFrequency = normalizeFrequencyCode(info.frequency);
        info.frequency = normalizedFrequency || getDefaultDividendFrequency(symbol);
        info.payoutMonths = normalizeDividendMonths(info.payoutMonths);
        info.totalAmount = parseN(info.totalAmount);
        return info;
      } catch (e) {
        console.error('è§£æè‚¡æ¯è³‡è¨Šå¤±æ•—:', e);
      }
    }
    
    // é è¨­å€¼
    return {
      payoutTime: '',
      perShare: 0,
      exDate: '',
      payDate: '',
      yield: 0,
      frequency: getDefaultDividendFrequency(symbol),
      payoutMonths: [],
      totalAmount: 0,
      source: 'æ‰‹å‹•è¼¸å…¥',
      sourceUrl: getDividendUrl(symbol)
    };
  }
  
  // å„²å­˜è‚¡æ¯è³‡è¨Š
  function saveDividendInfo(symbol, info) {
    const key = `dividend_${symbol}`;
    localStorage.setItem(key, JSON.stringify(info));
  }
  
  // ä¿®æ”¹ predictNextDividend å‡½æ•¸ä»¥å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„è³‡æ–™
  async function predictNextDividend(symbol, currentDate) {
    // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„è³‡æ–™
    const manualInfo = getCurrentDividendInfo(symbol);
    return manualInfo;
  }
  
  // ========= æ­·å²è¨˜éŒ„ç·¨è¼¯ Dialog =========
  function openHistoryEditDialog(account, historyItem){
    const dlg = document.createElement('div'); dlg.className='dialog';
    dlg.innerHTML = `
      <div class="content">
        <div class="header">
          <div class="title">ç·¨è¼¯æ­·å²è¨˜éŒ„</div>
          <button class="close">&times;</button>
        </div>
        <div class="body">
          <div class="field"><label>æ™‚é–“</label><input id="hist-time" type="datetime-local" /></div>
          <div class="field"><label>é¡å‹</label>
            <select id="hist-type">
              <option value="deposit">å­˜æ¬¾</option>
              <option value="withdraw">ææ¬¾</option>
              <option value="settlement">äº¤å‰²</option>
            </select>
          </div>
          <div class="field"><label>é‡‘é¡</label><input id="hist-amount" type="number" step="1" /></div>
          <div class="field"><label>å‚™è¨»</label><input id="hist-note" /></div>
        </div>
        <div class="footer">
          <button class="btn" id="hist-save">å„²å­˜</button>
          <button class="btn secondary" id="hist-cancel">å–æ¶ˆ</button>
        </div>
      </div>
    `;
    
    // å¡«å……ç¾æœ‰æ•¸æ“š
    const timeInput = dlg.querySelector('#hist-time');
    const date = new Date(historyItem.time);
    timeInput.value = date.toISOString().slice(0, 16);
    dlg.querySelector('#hist-type').value = historyItem.type;
    dlg.querySelector('#hist-amount').value = Math.round(parseN(historyItem.amount));
    dlg.querySelector('#hist-note').value = historyItem.note || '';
    
    document.body.appendChild(dlg);
    
    // äº‹ä»¶è™•ç†
    dlg.querySelector('.close, #hist-cancel').onclick = ()=> dlg.remove();
    dlg.querySelector('#hist-save').onclick = ()=>{
      const time = dlg.querySelector('#hist-time').value;
      const type = dlg.querySelector('#hist-type').value;
      const amount = Math.round(parseN(dlg.querySelector('#hist-amount').value));
      const note = dlg.querySelector('#hist-note').value.trim();
      
      if(!time || !type || !Number.isFinite(amount)){
        alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
        return;
      }
      
      // æ›´æ–°æ­·å²è¨˜éŒ„
      Object.assign(historyItem, {
        time: new Date(time).toISOString(),
        type,
        amount,
        note
      });
      
      saveDB(); fullRender(); dlg.remove();
    };
  };

  updateTargetLabels(getAllocationTarget(), getRegionTarget());
  fullRender();

  // è‡ªå‹•æ›´æ–°è‚¡åƒ¹
  setTimeout(() => handleRefreshAllClick(true), 1000);
  </script>
</body>
</html>
