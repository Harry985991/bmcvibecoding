<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>每日體重紀錄＋BMI 檢核</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f6f8fb;--card:#fff;--ink:#111827;--sub:#6b7280;--line:#e5e7eb;
    --brand:#2563eb;--good:#10b981;--warn:#f59e0b;--bad:#ef4444;
    --shadow:0 8px 28px rgba(17,24,39,.08)
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC",sans-serif}
  /* Make the main container fill more of the viewport like the investment layout
    keep some side padding for breathing room on narrow screens */
  .container{max-width:none;width:calc(100% - 48px);margin:0 auto;padding:0 24px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);width:100%}
  /* Remove top border of the first inner panel so it visually connects to the header */
  .container.card > .row:first-of-type > .panel.card {
    border-top: 0;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    box-shadow: none;
  }
  /* Remove the outer container card border and shadow to avoid a visible gray strip */
  .container.card { border: 0; border-top-left-radius: 8px; border-top-right-radius: 8px; box-shadow: none; overflow: hidden; }
  /* Remove the top padding of the first row so the first panel sits flush beneath the header */
  .container.card > .row:first-of-type { padding-top: 0; }
  .header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:18px 20px}
  .title{font-weight:700;font-size:20px}
  .sub{color:var(--sub);font-size:13px}
  /* increase spacing to match the fuller card layout */
  .row{display:flex;gap:20px;flex-wrap:wrap;padding:24px}
  .panel{flex:1 1 320px;padding:24px}
  label{display:block;font-size:12px;color:var(--sub);margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col3{grid-column:span 12}@media(min-width:720px){.col3{grid-column:span 3}}
  .col4{grid-column:span 12}@media(min-width:720px){.col4{grid-column:span 4}}
  .col6{grid-column:span 12}@media(min-width:720px){.col6{grid-column:span 6}}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.ghost{background:#fff}
  .btn.row{display:flex;gap:8px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar .btn{white-space:nowrap}
  .kpi{display:flex;gap:12px;flex-wrap:wrap}
  .kpi .chip{padding:10px 12px;border-radius:12px;background:#fff;border:1px solid var(--line);min-width:130px}
  .kpi .v{font-weight:700;font-size:18px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
  .badge.ok{background:#ECFDF5;color:#065F46;border-color:#A7F3D0}
  .badge.warn{background:#FFFBEB;color:#92400E;border-color:#FDE68A}
  .badge.bad{background:#FEF2F2;color:#991B1B;border-color:#FCA5A5}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;font-size:12px;text-align:left}
  tr{background:#fff;border:1px solid var(--line)}
  tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .right{text-align:right}
  .muted{color:var(--sub)}
  .actions{display:flex;gap:4px}
  .actions .btn{font-size:11px;padding:4px 8px;white-space:nowrap}
  
  /* 圖表範圍選擇按鈕 */
  .chart-btn{
    padding:6px 12px;
    border:1px solid var(--line);
    border-radius:6px;
    background:#fff;
    color:var(--sub);
    font-size:12px;
    cursor:pointer;
    transition:all 120ms ease;
  }
  .chart-btn:hover{
    background:var(--brand);
    color:#fff;
    border-color:var(--brand);
  }
  .chart-btn.active{
    background:var(--brand);
    color:#fff;
    border-color:var(--brand);
  }
  
  .link{color:var(--brand);cursor:pointer;text-decoration:underline}
  
  /* modal */
  .modal { 
    position: fixed; 
    top:0; 
    left:0; 
    right:0; 
    bottom:0; 
    background: rgba(0,0,0,0.45); 
    display:none; 
    justify-content:center; 
    align-items:center; 
    z-index:1000; 
  }
  .modal-content { 
    background: #ffffff; 
    padding:20px; 
    border-radius:12px; 
    width:420px; 
    box-shadow: 0 6px 20px rgba(39,35,67,0.12); 
    border:1px solid rgba(39,35,67,0.06);
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .footer{padding:18px 24px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;color:var(--sub);font-size:12px}
</style>
</head>
<body>
<div class="container card">
  <div class="header">
    <div>
      <div class="title"></div>
    </div>
    <div class="toolbar">
      <!-- header toolbar intentionally left empty; controls moved into 新增/更新紀錄 panel -->
    </div>
  </div>

  <!-- KPI 與圖表（移到新增紀錄之前） -->
  <div class="row">
    <div class="panel card" style="flex:1 1 100%">
      <div class="kpi">
        <div class="chip">
          <div class="muted">最新體重</div>
          <div class="v" id="kpiWeight">—</div>
        </div>
        <div class="chip">
          <div class="muted">最新 BMI</div>
          <div class="v" id="kpiBMI">—</div>
        </div>
        <div class="chip">
          <div class="muted">BMI 狀態</div>
          <div id="kpiStatus"><span class="badge">—</span></div>
        </div>
        <div class="chip">
          <div class="muted">7 日均重</div>
          <div class="v" id="kpiAvg7">—</div>
        </div>
        <div class="chip">
          <div class="muted">連續紀錄天數</div>
          <div class="v" id="kpiStreak">—</div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <label style="font-size:12px; color:var(--sub);">顯示範圍：</label>
          <button class="chart-btn" data-days="7">7天</button>
          <button class="chart-btn" data-days="14">14天</button>
          <button class="chart-btn active" data-days="30">30天</button>
          <button class="chart-btn" data-days="60">60天</button>
          <button class="chart-btn" data-days="90">90天</button>
          <button class="chart-btn" data-days="120">120天</button>
        </div>
        <div id="weightChange" style="margin-bottom:8px; font-size:12px; color:var(--sub);">
          體重變化：—
        </div>
        <canvas id="chart" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- 新增/更新紀錄（移到圖表下方） -->
  <div class="row">
    <div class="panel card" style="flex:1 1 100%;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin:0 0 16px 0;">
        <h3 style="margin:0; font-size:16px">新增/更新紀錄</h3>
        <div class="toolbar" style="gap:8px">
          <button id="openProfileBtn" class="btn" style="font-size: 12px;">個人設定</button>
          <button id="healthGPTBtn" class="btn" style="font-size: 12px;" onclick="window.open('https://chatgpt.com/share/688edba4-3bf4-800e-93ac-e5595c5a0296', '_blank')">健康GPT</button>
        </div>
      </div>
      <div class="grid" style="display:flex;gap:12px;align-items:end;">
        <div style="flex:1;min-width:0;">
          <label>日期</label>
          <input id="date" type="date">
        </div>
        <div style="flex:1;min-width:0;">
          <label>體重（kg）</label>
          <input id="weightKg" type="number" step="0.1" min="20" max="250" placeholder="例如：76.3">
        </div>
        <div style="flex:1;min-width:0;">
          <label>餐飲筆記</label>
          <input id="dietNote" type="text" placeholder="如：早餐吃麥片、午餐外食">
        </div>
        <div style="flex:1;min-width:0;">
          <label>運動筆記</label>
          <input id="exerciseNote" type="text" placeholder="如：跑步 20 分、重訓 30 分">
        </div>
        <div style="flex-shrink:0;">
          <button id="addBtn" class="btn primary">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 清單與操作 -->
  <div class="row">
    <div class="panel card" style="flex:1 1 100%">
      <div class="header" style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <div class="toolbar" style="gap:12px">
          <input id="search" placeholder="搜尋（日期／備註）" style="min-width:220px;padding:10px 12px;border:1px solid var(--line);border-radius:10px">
          <select id="sort" class="btn">
            <option value="dateDesc">日期：新→舊</option>
            <option value="dateAsc">日期：舊→新</option>
            <option value="weightDesc">體重：大→小</option>
            <option value="weightAsc">體重：小→大</option>
          </select>
        </div>
        <div class="toolbar">
          <span class="sub">共 <span id="count">0</span> 筆</span>
        </div>
      </div>
      <div style="padding:8px 16px 16px 16px">
        <table>
          <thead>
            <tr>
              <th style="width:120px">日期</th>
              <th class="right" style="width:110px">體重 (kg)</th>
              <th class="right" style="width:110px">BMI</th>
              <th style="width:160px">狀態</th>
              <th style="width:200px">餐飲備註</th>
              <th style="width:200px">運動備註</th>
              <th class="right" style="width:120px">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>資料儲存在此裝置（localStorage）。</div>
    <div><span class="sub">合格範圍依台灣衛福部標準：18.5–24</span></div>
  </div>
</div>

<!-- 個人設定彈出視窗 -->
<div id="profileModal" class="modal" style="display:none;">
  <div class="modal-content" style="width:480px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 style="margin:0; font-size:18px;">個人設定</h3>
      <button id="closeProfileBtn" class="btn" style="padding:4px 8px;">✕</button>
    </div>
    <div class="grid">
      <div class="col6">
        <label>身高（cm）</label>
        <input id="heightCm" type="number" min="80" max="250" placeholder="例如：175.7">
      </div>
      <div class="col6">
        <label>體重目標（kg，可選）</label>
        <input id="goalKg" type="number" min="20" max="250" placeholder="例如：75.7">
      </div>
    </div>
    <div style="margin-top:16px" class="btn row">
      <button id="saveProfile" class="btn primary">儲存設定</button>
      <button id="fillExample" class="btn ghost">填入示例數據</button>
    </div>
    <div style="margin-top:12px" class="sub">儲存後將用此身高計算 BMI。</div>
  </div>
</div>



<script>
const STORE_KEY = 'weight_bmi_v1';
const PROFILE_KEY = 'weight_bmi_profile_v1';
const heightEl = document.getElementById('heightCm');
const goalEl = document.getElementById('goalKg');
const dateEl = document.getElementById('date');
const weightEl = document.getElementById('weightKg');
const dietNoteEl = document.getElementById('dietNote');
const exerciseNoteEl = document.getElementById('exerciseNote');
const addBtn = document.getElementById('addBtn');
const clearBtn = document.getElementById('clearInput');
const saveProfileBtn = document.getElementById('saveProfile');
const fillExampleBtn = document.getElementById('fillExample');
const exportBtn = document.getElementById('exportBtn'); // may be null after removal
const importBtn = document.getElementById('importBtn'); // may be null after removal
const importFile = document.getElementById('importFile'); // may be null after removal
const resetBtn = document.getElementById('resetBtn'); // may be null after removal
const searchEl = document.getElementById('search');
const sortEl = document.getElementById('sort');
const tbody = document.getElementById('tbody');
const countEl = document.getElementById('count');
const kpiWeight = document.getElementById('kpiWeight');
const kpiBMI = document.getElementById('kpiBMI');
const kpiStatus = document.getElementById('kpiStatus');
const kpiAvg7 = document.getElementById('kpiAvg7');
const kpiStreak = document.getElementById('kpiStreak');
const weightChange = document.getElementById('weightChange');

let chart;
let selectedDays = 30; // 預設選擇 30 天
function getData(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }catch{ return []; } }
function setData(arr){ localStorage.setItem(STORE_KEY, JSON.stringify(arr)); }
function getProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); }catch{ return {}; } }
function setProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }

function fmt(n, d=1){ if(n===undefined||n===null||Number.isNaN(n)) return '—'; return Number(n).toFixed(d); }
function bmiOf(weightKg, heightCm){
  const h = Number(heightCm)/100;
  if(!h || !weightKg) return null;
  return weightKg / (h*h);
}
function bmiBadge(bmi){
  if(bmi==null) return `<span class="badge">—</span>`;
  if(bmi < 18.5) return `<span class="badge warn">過輕</span>`;
  if(bmi < 24) return `<span class="badge ok">合格</span>`;
  if(bmi < 27) return `<span class="badge warn">過重</span>`;
  return `<span class="badge bad">肥胖</span>`;
}
function todayISO(){ 
  const d = new Date(); 
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
function parseISO(d){ const t = new Date(d); t.setHours(0,0,0,0); return t; }

function render(){
  const profile = getProfile();
  if(profile.heightCm) heightEl.value = profile.heightCm;
  if(profile.goalKg) goalEl.value = profile.goalKg;

  const arr = getData();
  const q = (searchEl.value || '').trim().toLowerCase();
  let filtered = arr.filter(x => !q || x.date.includes(q) || (x.note||'').toLowerCase().includes(q));

  switch(sortEl.value){
    case 'dateAsc': filtered.sort((a,b)=> a.date.localeCompare(b.date)); break;
    case 'weightDesc': filtered.sort((a,b)=> (b.weightKg||0)-(a.weightKg||0)); break;
    case 'weightAsc': filtered.sort((a,b)=> (a.weightKg||0)-(b.weightKg||0)); break;
    default: filtered.sort((a,b)=> b.date.localeCompare(a.date));
  }

  countEl.textContent = filtered.length;
  tbody.innerHTML = filtered.map(x=>{
    const bmi = bmiOf(x.weightKg, profile.heightCm);
    return `<tr>
      <td>${x.date}</td>
      <td class="right">${fmt(x.weightKg,1)}</td>
      <td class="right">${fmt(bmi,1)}</td>
      <td>${bmiBadge(bmi)}</td>
      <td>${x.dietNote?escapeHtml(x.dietNote):''}</td>
      <td>${x.exerciseNote?escapeHtml(x.exerciseNote):''}</td>
      <td class="right actions">
        <button class="btn" onclick="editRow('${x.date}')">編輯</button>
        <button class="btn" onclick="delRow('${x.date}')">刪除</button>
      </td>
    </tr>`;
  }).join('');

  // KPI（取最新一筆）
  const latest = [...arr].sort((a,b)=> b.date.localeCompare(a.date))[0];
  const latestBMI = latest ? bmiOf(latest.weightKg, profile.heightCm) : null;
  kpiWeight.textContent = latest ? fmt(latest.weightKg,1) : '—';
  kpiBMI.textContent = latest ? fmt(latestBMI,1) : '—';
  kpiStatus.innerHTML = bmiBadge(latestBMI);

  // 7日均重
  const last7 = [...arr].sort((a,b)=> b.date.localeCompare(a.date)).slice(0,7);
  const avg7 = last7.length ? (last7.reduce((s,x)=>s+Number(x.weightKg||0),0)/last7.length) : null;
  kpiAvg7.textContent = avg7? fmt(avg7,1) : '—';

  // 連續天數
  kpiStreak.textContent = calcStreak(arr);

  // 圖表
  renderChart(arr, profile.heightCm, profile.goalKg);
  
  // 自動填入最近一筆資料到表單
  if (arr.length > 0) {
    const latest = [...arr].sort((a,b)=> b.date.localeCompare(a.date))[0];
    if (latest) {
      weightEl.value = latest.weightKg || '';
      dietNoteEl.value = latest.dietNote || '';
      exerciseNoteEl.value = latest.exerciseNote || '';
    }
  }
  
  // 確保日期欄位始終顯示當天日期
  dateEl.value = todayISO();
}

function calcStreak(arr){
  if(!arr.length) return '0';
  const set = new Set(arr.map(x=>x.date));
  let streak = 0;
  let d = new Date(); d.setHours(0,0,0,0);
  for(;;){
    const key = d.toISOString().slice(0,10);
    if(set.has(key)) { streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  return String(streak);
}

function calcWeightChange(arr, days){
  if(!arr.length) return null;
  
  // 根據選擇的範圍篩選資料
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  const cutoffISO = cutoffDate.toISOString().slice(0,10);
  
  const sorted = [...arr].sort((a,b)=> a.date.localeCompare(b.date));
  const filtered = sorted.filter(x => x.date >= cutoffISO);
  
  if(filtered.length < 2) return null;
  
  const firstWeight = filtered[0].weightKg;
  const lastWeight = filtered[filtered.length - 1].weightKg;
  
  if(!firstWeight || !lastWeight) return null;
  
  const change = lastWeight - firstWeight;
  const percentage = (change / firstWeight) * 100;
  
  return {
    change: change,
    percentage: percentage,
    firstWeight: firstWeight,
    lastWeight: lastWeight
  };
}

function renderChart(arr, heightCm, goalKg){
  // 根據選擇的範圍篩選資料
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - selectedDays);
  const cutoffISO = cutoffDate.toISOString().slice(0,10);
  
  const sorted = [...arr].sort((a,b)=> a.date.localeCompare(b.date));
  const filtered = sorted.filter(x => x.date >= cutoffISO);
  
  // 格式化日期標籤，只顯示月份和日期
  const labels = filtered.map(x => {
    const date = new Date(x.date);
    const month = date.getMonth() + 1; // getMonth() 返回 0-11
    const day = date.getDate();
    return `${month}/${day}`;
  });
  const weights = filtered.map(x=>x.weightKg || null);

  const ctx = document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'體重 (kg)', data:weights, tension:.25, pointRadius:3, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.1)'},
        ...(goalKg ? [{label:'目標體重', data:labels.map(()=>goalKg), borderDash:[2,2], pointRadius:0, borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.1)'}] : []),
        {label:'理想體重', data:labels.map(()=>72), borderDash:[4,4], pointRadius:0, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)'}
      ]
    },
    options:{
      responsive:true,
      interaction:{mode:'nearest', intersect:false},
      plugins:{ legend:{position:'top'} },
      scales:{
        x: {
          ticks: {
            maxRotation: 0, // 防止標籤旋轉
            minRotation: 0
          }
        },
        y:{ 
          beginAtZero:false,
          min: 70,
          max: function(context) {
            const maxWeight = Math.max(...weights.filter(w => w !== null));
            return Math.ceil(Math.max(maxWeight + 2, 80)); // 至少顯示到 80kg，並確保為整數
          }
        }
      }
    }
  });
  
  // 更新體重變化顯示
  updateWeightChangeDisplay(arr);
}

function updateWeightChangeDisplay(arr){
  const result = calcWeightChange(arr, selectedDays);
  
  if(!result){
    weightChange.textContent = '體重變化：—';
    return;
  }
  
  const { change, percentage, firstWeight, lastWeight } = result;
  const changeText = change >= 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
  const percentageText = percentage >= 0 ? `+${percentage.toFixed(2)}%` : `${percentage.toFixed(2)}%`;
  const color = change >= 0 ? '#ef4444' : '#10b981'; // 紅色表示增加，綠色表示減少
  
  weightChange.innerHTML = `
    體重變化：<span style="color:${color}; font-weight:600;">${changeText}kg (${percentageText})</span>
    <span style="color:var(--sub); font-size:11px;"> (${firstWeight.toFixed(1)}kg → ${lastWeight.toFixed(1)}kg)</span>
  `;
}

function addOrUpdate(){
  const date = dateEl.value || todayISO();
  const weight = Number(weightEl.value);
  if(!weight){ alert('請輸入體重（kg）'); return; }
  const arr = getData();
  const idx = arr.findIndex(x=>x.date===date);
  const row = {
    date, 
    weightKg: Number(weight.toFixed(1)), 
    dietNote: dietNoteEl.value?.trim()||'',
    exerciseNote: exerciseNoteEl.value?.trim()||''
  };
  if(idx>=0) arr[idx] = row; else arr.push(row);
  setData(arr);
  render();
  // 儲存後會自動填入最新資料，不需要手動清空
}

function editRow(date){
  const arr = getData();
  const row = arr.find(x=>x.date===date);
  if(!row) return;
  dateEl.value = row.date;
  weightEl.value = row.weightKg;
  dietNoteEl.value = row.dietNote || '';
  exerciseNoteEl.value = row.exerciseNote || '';
  window.scrollTo({top:0,behavior:'smooth'});
}
function delRow(date){
  if(!confirm(`刪除 ${date} 的紀錄？`)) return;
  const arr = getData().filter(x=>x.date!==date);
  setData(arr); render();
}

function exportJSON(){
  const payload = {
    profile: getProfile(),
    records: getData()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  
  // 生成包含日期時間的檔案名稱
  const now = new Date();
  const dateStr = now.toISOString().slice(0,10).replace(/-/g, ''); // YYYYMMDD
  const timeStr = now.toTimeString().slice(0,8).replace(/:/g, ''); // HHMMSS
  const fileName = `weight-bmi-data_${dateStr}_${timeStr}.json`;
  
  a.href = url; 
  a.download = fileName; 
  a.click();
  URL.revokeObjectURL(url);
}
function importJSON(file){
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const obj = JSON.parse(e.target.result);
      if(obj.profile) setProfile(obj.profile);
      if(Array.isArray(obj.records)) setData(obj.records);
      alert('匯入完成！已匯入 ' + (obj.records ? obj.records.length : 0) + ' 筆紀錄'); 
      render();
    }catch(err){ 
      console.error('匯入錯誤:', err);
      alert('匯入失敗：檔案格式不正確或檔案損壞'); 
    }
  };
  reader.onerror = (err) => {
    console.error('檔案讀取錯誤:', err);
    alert('匯入失敗：無法讀取檔案');
  };
  reader.readAsText(file);
}
function resetAll(){
  if(!confirm('將清除所有紀錄與設定。確定？')) return;
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(PROFILE_KEY);
  render();
}

function saveProfile(){
  const h = Number(heightEl.value);
  if(!h){ alert('請輸入身高（cm）'); return; }
  const goal = goalEl.value? Number(goalEl.value): undefined;
  setProfile({heightCm:h, goalKg: goal});
  render();
  closeModal('profileModal');
}

function fillExample(){
  const sample = [];
  const base = new Date(); base.setHours(0,0,0,0);
  let w = 78.0;
  for(let i=14;i>=0;i--){
    const d = new Date(base); d.setDate(d.getDate()-i);
    w += (Math.random()-.5)*0.4;
    sample.push({
      date: d.toISOString().slice(0,10), 
      weightKg: Number(w.toFixed(1)), 
      dietNote: i%3===0?'早餐麥片、午餐外食':'',
      exerciseNote: i%3===0?'步行 30 分':''
    });
  }
  setData(sample);
  if(!getProfile().heightCm) setProfile({heightCm:175.7, goalKg:75.7});
  render();
}

function escapeHtml(s){ return s?.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) || ''; }

// 初始
dateEl.value = todayISO();
addBtn.onclick = addOrUpdate;
// clearBtn.onclick = ()=>{ weightEl.value=''; dietNoteEl.value=''; exerciseNoteEl.value=''; };
if (saveProfileBtn) saveProfileBtn.onclick = saveProfile;
if (fillExampleBtn) fillExampleBtn.onclick = fillExample;
if (exportBtn) exportBtn.onclick = exportJSON;
if (importBtn && importFile) {
  importBtn.onclick = ()=> { importFile.click(); };
  importFile.onchange = (e)=>{ const f = e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; };
}
if (resetBtn) resetBtn.onclick = resetAll;
searchEl.oninput = render;
sortEl.onchange = render;

// 圖表範圍選擇按鈕事件
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('chart-btn')) {
    // 移除所有按鈕的 active 狀態
    document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
    // 添加當前按鈕的 active 狀態
    e.target.classList.add('active');
    // 更新選擇的天數
    selectedDays = parseInt(e.target.dataset.days);
    // 重新渲染圖表和體重變化
    const profile = getProfile();
    renderChart(getData(), profile.heightCm, profile.goalKg);
  }
});

// 彈出視窗功能
function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// 開啟個人設定
document.getElementById('openProfileBtn').addEventListener('click', () => {
  openModal('profileModal');
});



// 點擊背景關閉彈出視窗
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.style.display = 'none';
  }
});

// ESC 鍵關閉彈出視窗
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.style.display = 'none';
    });
  }
});

render();
</script>
</body>
</html>
  /* Headings use Inter for crisp titles */
  h1, h2, h3, .title { font-family: 'Inter','Noto Sans TC',sans-serif; }
