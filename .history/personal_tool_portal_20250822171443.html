<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>個人工具入口</title>
  <style>
:root{
  --bg: #fffffe;
  --primary: #272343;    /* headline / 主色 */
  --muted: #2d334a;      /* paragraph / 次要文字 */
  --accent: #ffd600;     /* highlight / 按鈕 */
  --teal: #bae8e8;       /* tag / 卡片重點 */
  --card-bg: #ffffff;
  --card-border: #272343;
  --button-hover: #e6c000;
}

/* base */
body {
  font-family: 'Segoe UI', 'Noto Sans TC', sans-serif;
  background-color: var(--bg);
  color: var(--primary);
  margin: 0;
  padding: 0;
}

/* header */
header {
  background-color: transparent;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header h1 {
  font-size: 1rem;
  margin: 0;
  color: var(--primary);
}

/* buttons */
button {
  padding: 0.4rem 0.8rem;
  font-size: 0.8rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  background-color: var(--accent);
  color: var(--primary);
  transition: background 0.12s ease-in-out;
}
button:hover { background-color: var(--button-hover); }

/* layout */
main {
  padding: 2rem;
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
}

.section {
  background: var(--card-bg);
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 1px 4px rgba(39,35,67,0.06);
  border: 1px solid rgba(39,35,67,0.06);
}
.section h2 {
  margin: 0 0 0.75rem 0;
  font-size: 0.95rem;
  color: var(--primary);
}

/* grid & cards */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 1rem;
}

.card {
  background-color: var(--card-bg);
  border: 1.5px solid var(--card-border);
  border-radius: 8px;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.card h3 { margin: 0 0 0.5rem 0; font-size: 0.95rem; color: var(--primary); }
.card p { font-size: 0.8rem; color: var(--muted); flex-grow: 1; }

/* link style */
.card a {
  font-size: 0.8rem;
  text-decoration: none;
  color: var(--primary);
  border-top: 1px dashed rgba(39,35,67,0.06);
  padding-top: 0.5rem;
  display: inline-block;
  word-break: break-all;
}

/* actions */
.card-actions { margin-top: 0.5rem; display:flex; justify-content:flex-end; gap:0.5rem; }
.card-actions button { background-color: transparent; color: var(--primary); border:1px solid rgba(39,35,67,0.08); padding:0.35rem 0.6rem; border-radius:6px; }
.card-actions button:hover { background-color: rgba(39,35,67,0.03); }

/* modal */
.modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.45); display:none; justify-content:center; align-items:center; z-index:1000; }
.modal-content { background: var(--card-bg); padding:1rem; border-radius:6px; width:360px; box-shadow: 0 2px 12px rgba(39,35,67,0.12); border:1px solid rgba(39,35,67,0.06); }
.modal-content h2 { font-size:1rem; margin-top:0; color:var(--primary); }
.modal-content label { font-size:0.75rem; display:block; margin-top:0.5rem; color:var(--primary); }
.modal-content input[type="text"], .modal-content textarea { width:100%; padding:0.4rem; font-size:0.8rem; margin-top:0.3rem; border:1px solid rgba(39,35,67,0.12); border-radius:4px; color:var(--muted); background: #fff; }

/* categories */
.categories { display:flex; gap:0.75rem; margin-top:0.5rem; align-items:center; color:var(--muted); }
.categories input[type="checkbox"] { width:14px; height:14px; accent-color: var(--teal); }

/* small text */
.small-muted { font-size:0.75rem; color:var(--muted); }

/* responsive tweaks */
@media (max-width:480px){
  .modal-content { width: 92%; }
  header { padding: 0.75rem 1rem; }
  main { padding: 1rem; }
}
  </style>
</head>
<body>
  <header>
    <h1>我的工具入口</h1>
    <div style="display:flex; gap:8px;">
      <button id="exportBtn">匯出資料</button>
      <button id="importBtn">匯入資料</button>
      <button id="addBtn">新增工具</button>
    </div>
  </header>

  <main>
    <section class="section" aria-labelledby="webTitle">
      <h2 id="webTitle">自製網頁程式</h2>
      <div id="webContainer" class="grid"></div>
    </section>

    <section class="section" aria-labelledby="gptTitle">
      <h2 id="gptTitle">GPT 工具</h2>
      <div id="gptContainer" class="grid"></div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal" id="toolModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2 id="modalTitle">新增工具</h2>
      <label>工具名稱</label>
      <input type="text" id="toolName" />
      <label>簡介</label>
      <textarea id="toolDesc" rows="3"></textarea>
      <label>連結 (可使用相對路徑，例如 AIAROKR.html 或 ./subfolder/tool.html)</label>
      <input type="text" id="toolLink" placeholder="例：AIAROKR.html 或 ./subfolder/tool.html">

      <label class="small-muted" style="margin-top:.5rem">類別（勾選後會出現在對應區域，可同時勾選多個）</label>
      <div class="categories">
        <label><input type="checkbox" id="catWeb" /> 自製網頁程式</label>
        <label><input type="checkbox" id="catGpt" /> GPT 工具</label>
      </div>

      <div class="modal-actions">
        <button type="button" id="cancelBtn">取消</button>
        <button type="button" id="saveBtn">儲存</button>
      </div>
    </div>
  </div>

  <script>
  const STORAGE_KEY = 'personal_tools_v1';

  let tools = [];
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    tools = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(tools)) tools = [];
  } catch (e) {
    console.warn('localStorage parse error, resetting tools', e);
    tools = [];
  }

  // normalize existing items (backward compatibility) — ensure categories default to ['web']
  tools = tools.map(t => {
    if (!t || typeof t !== 'object') {
      return { name: '', desc: '', link: '', categories: ['web'] };
    }

    const cats = t.categories;

    if (!cats) {
      // missing -> default to web
      t.categories = ['web'];
    } else if (typeof cats === 'string') {
      // string -> split by comma, normalize, fallback to web
      const normalized = cats.split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
        .map(s => (s === 'gpt' || s.includes('gpt')) ? 'gpt' : 'web');
      t.categories = normalized.length ? normalized : ['web'];
    } else if (Array.isArray(cats)) {
      // array -> normalize entries, remove empties, fallback to web if empty
      const normalized = cats.map(s => (typeof s === 'string' ? s.trim().toLowerCase() : ''))
        .filter(Boolean)
        .map(s => (s === 'gpt' || s.includes('gpt')) ? 'gpt' : 'web');
      t.categories = normalized.length ? normalized : ['web'];
    } else {
      t.categories = ['web'];
    }

    return t;
  });

  let editIndex = null;
  const webContainer = document.getElementById('webContainer');
  const gptContainer = document.getElementById('gptContainer');
  const modal = document.getElementById('toolModal');
  const nameInput = document.getElementById('toolName');
  const descInput = document.getElementById('toolDesc');
  const linkInput = document.getElementById('toolLink');
  const modalTitle = document.getElementById('modalTitle');
  const catWeb = document.getElementById('catWeb');
  const catGpt = document.getElementById('catGpt');
  let lastFocusedElement = null;

  function createCard(tool, index) {
    const card = document.createElement('div');
    card.className = 'card';

    const h3 = document.createElement('h3');
    h3.textContent = tool.name || '';

    const p = document.createElement('p');
    p.textContent = tool.desc || '';

    const a = document.createElement('a');
    const href = (tool.link || '').trim() || '#';
    a.href = href;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = '前往工具';

    const actions = document.createElement('div');
    actions.className = 'card-actions';

    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.textContent = '編輯';
    editBtn.addEventListener('click', () => editTool(index));

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.textContent = '刪除';
    delBtn.addEventListener('click', () => deleteTool(index));

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);

    card.appendChild(h3);
    card.appendChild(p);
    card.appendChild(a);
    card.appendChild(actions);

    return card;
  }

  function renderTools() {
    webContainer.innerHTML = '';
    gptContainer.innerHTML = '';

    tools.forEach((tool, index) => {
      // default categories
      const cats = Array.isArray(tool.categories) ? tool.categories : ['web'];

      if (cats.includes('web')) {
        webContainer.appendChild(createCard(tool, index));
      }
      if (cats.includes('gpt')) {
        gptContainer.appendChild(createCard(tool, index));
      }
    });

    // if empty, show helpful hint
    if (!webContainer.children.length) {
      const hint = document.createElement('div');
      hint.className = 'small-muted';
      hint.textContent = '尚未新增自製網頁程式';
      webContainer.appendChild(hint);
    }
    if (!gptContainer.children.length) {
      const hint = document.createElement('div');
      hint.className = 'small-muted';
      hint.textContent = '尚未新增 GPT 工具';
      gptContainer.appendChild(hint);
    }
  }

  modal.setAttribute('role', 'dialog');
  modal.setAttribute('aria-modal', 'true');
  modal.setAttribute('aria-hidden', 'true');

  function openModal(editIdx = null) {
    lastFocusedElement = document.activeElement;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    editIndex = editIdx;
    if (editIndex !== null) {
      modalTitle.textContent = '編輯工具';
      const t = tools[editIndex];
      nameInput.value = t.name || '';
      descInput.value = t.desc || '';
      linkInput.value = t.link || '';
      catWeb.checked = Array.isArray(t.categories) && t.categories.includes('web');
      catGpt.checked = Array.isArray(t.categories) && t.categories.includes('gpt');
    } else {
      modalTitle.textContent = '新增工具';
      nameInput.value = '';
      descInput.value = '';
      linkInput.value = '';
      catWeb.checked = true;
      catGpt.checked = false;
    }
    nameInput.focus();
    document.addEventListener('focus', enforceFocus, true);
  }

  function closeModal() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    document.removeEventListener('focus', enforceFocus, true);
    if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
      lastFocusedElement.focus();
    }
  }

  function enforceFocus(e) {
    if (!modal.contains(e.target)) {
      e.stopPropagation();
      modal.focus();
    }
  }

  function validateLink(raw) {
    const s = (raw || '').trim();
    if (!s) return '';
    return s;
  }

  function saveTool() {
    const categories = [];
    if (catWeb.checked) categories.push('web');
    if (catGpt.checked) categories.push('gpt');
    if (!categories.length) {
      alert('請至少勾選一個類別');
      return;
    }

    const newTool = {
      name: nameInput.value.trim(),
      desc: descInput.value.trim(),
      link: validateLink(linkInput.value),
      categories
    };
    if (!newTool.name) {
      alert('請輸入工具名稱');
      nameInput.focus();
      return;
    }
    if (editIndex !== null) {
      tools[editIndex] = newTool;
    } else {
      tools.push(newTool);
    }
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tools));
    } catch (e) {
      console.warn('localStorage write failed', e);
    }
    renderTools();
    closeModal();
  }

  function editTool(index) {
    openModal(index);
  }

  function deleteTool(index) {
    if (confirm('確定刪除這個工具嗎？')) {
      tools.splice(index, 1);
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tools));
      } catch (e) { console.warn(e); }
      renderTools();
    }
  }

  function exportData() {
    try {
      const payload = JSON.stringify(tools, null, 2);
      const blob = new Blob([payload], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'personal_tools.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error('匯出失敗', e);
      alert('匯出失敗');
    }
  }

  function importDataFile() {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = '.json,application/json';
    inp.addEventListener('change', (ev) => {
      const f = ev.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (!Array.isArray(parsed)) throw new Error('格式錯誤：不是陣列');
          // normalize and accept backward-compatible items
          tools = parsed.map(t => {
            if (!t || typeof t !== 'object') return { name: '', desc: '', link: '', categories: ['web'] };
            if (!Array.isArray(t.categories)) {
              t.categories = t.categories ? (Array.isArray(t.categories) ? t.categories : [t.categories]) : ['web'];
            }
            return t;
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(tools));
          renderTools();
          alert('匯入完成');
        } catch (err) {
          console.error('匯入失敗', err);
          alert('匯入失敗：檔案格式不正確');
        }
      };
      reader.readAsText(f, 'utf-8');
    });
    inp.click();
  }

  document.getElementById('addBtn').addEventListener('click', () => openModal(null));
  document.getElementById('cancelBtn').addEventListener('click', closeModal);
  document.getElementById('saveBtn').addEventListener('click', saveTool);
  document.getElementById('exportBtn').addEventListener('click', exportData);
  document.getElementById('importBtn').addEventListener('click', importDataFile);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.style.display === 'flex') closeModal();
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  renderTools();
  </script>
</body>
</html>
