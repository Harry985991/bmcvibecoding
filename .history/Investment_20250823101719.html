<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å€‹äººæŠ•è³‡ç´€éŒ„ï½œPortfolio Tracker (Flat Enterprise UI)</title>
  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --ink: #1f2937;
      --sub: #6b7280;
      --muted: #e5e7eb;
      --line: #e6e9ef;
      --brand: #2563eb;    /* è— */
      --accent: #0ea5e9;   /* é’ */
      --ok: #10b981;       /* ç¶  */
      --warn: #f59e0b;     /* é»ƒ */
      --danger: #ef4444;   /* ç´… */
      --shadow: 0 6px 18px rgba(17,24,39,0.06);
      --radius: 14px;
      --font: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Hiragino Sans", "Heiti TC", "Microsoft JhengHei", Arial, sans-serif;
      --fs: 14px;          /* å…¨ç«™å°å­—é«” */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink); font: 400 var(--fs)/1.5 var(--font);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    header{
      position:sticky; top:0; z-index:20; backdrop-filter:saturate(1.2) blur(6px);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:16px 20px}
    .titlebar{display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    .brand{font-weight:700; letter-spacing:.3px;}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; box-shadow:var(--shadow)}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .item{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; min-width:150px; box-shadow:var(--shadow)}
    .kpi .label{font-size:12px; color:var(--sub)}
    .kpi .value{font-weight:700; font-size:15px}

    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .search{display:flex; align-items:center; gap:8px; padding:8px 10px; background:#fff; border:1px solid var(--line); border-radius:10px; box-shadow:var(--shadow)}
    .search input{border:0; outline:0; font:inherit; width:200px}
    .btn{border:1px solid var(--line); background:#fff; color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow)}
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger); color:#fff; border-color:transparent}
    .btn.ok{background:var(--ok); color:#fff; border-color:transparent}

    main{max-width:1180px; margin:18px auto; padding:0 20px}

    .tabs{display:flex; gap:6px; border-bottom:1px solid var(--line)}
    .tab{appearance:none; background:transparent; border:0; padding:10px 12px; cursor:pointer; color:var(--sub); position:relative; font-weight:600}
    .tab[aria-selected="true"]{color:var(--brand)}
    .tab[aria-selected="true"]::after{content:""; position:absolute; left:10px; right:10px; bottom:-1px; height:3px; background:var(--brand); border-radius:3px 3px 0 0}

    section.view{display:none; padding:16px 0}
    section.view.active{display:block}

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .card + .card{margin-top:14px}

    table{width:100%; border-collapse:collapse}
    thead th{font-size:12px; color:var(--sub); font-weight:600; text-align:left; padding:10px 8px; border-bottom:1px solid var(--line)}
    tbody td{padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:middle}
    tbody tr:hover{background:#fafafa}
    .num{text-align:right; font-variant-numeric: tabular-nums}
    .muted{color:var(--sub)}
    .grow{flex:1}

    .inline-input{width:100px; padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
    .select{padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
    .stack{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .right{margin-left:auto}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#fff}
    .badge.green{color:#065f46; background:#ecfdf5; border-color:#a7f3d0}
    .badge.red{color:#991b1b; background:#fee2e2; border-color:#fecaca}
    .badge.blue{color:#1e3a8a; background:#eff6ff; border-color:#bfdbfe}

    dialog{border:0; border-radius:16px; box-shadow:0 24px 64px rgba(2,6,23,.2); width:min(680px, calc(100% - 32px)); padding:0}
    dialog::backdrop{background:rgba(2,6,23,.4)}
    .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); background:#fff; border-radius:16px 16px 0 0}
    .dlg-body{padding:16px}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    .field label{display:block; font-size:12px; color:var(--sub); margin-bottom:6px}
    .field input,.field select,.field textarea{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font:inherit}

    .footer{display:flex; justify-content:flex-end; gap:10px; padding:14px 16px; border-top:1px solid var(--line); background:#fff; border-radius:0 0 16px 16px}

    .donut{width:190px; height:190px; border-radius:50%; background:conic-gradient(#d1d5db 0 100%); position:relative; box-shadow:var(--shadow)}
    .donut::after{content:""; position:absolute; inset:22px; background:#fff; border-radius:50%; border:1px solid var(--line)}
    .donut .center{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; font-weight:700}

    .note{font-size:12px; color:var(--sub)}
    .hr{height:1px; background:var(--line); margin:12px 0}

    .mini{font-size:12px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff}

    .empty{padding:18px; color:var(--sub); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="titlebar">
        <div class="brand">ğŸ“ˆ å€‹äººæŠ•è³‡ç´€éŒ„</div>
        <div class="pill mini">ä¼æ¥­ç´šæ‰å¹³åŒ– UI Â· æœ¬åœ°å„²å­˜ Â· å¯é›¢ç·šé‹ä½œ</div>
        <div class="right"></div>
      </div>
      <div class="stack" style="margin-top:10px">
        <div class="kpi">
          <div class="item"><div class="label">ç¸½è³‡ç”¢ (æŒæœ‰å¸‚å€¼ + å¯å‹•ç”¨ç¾é‡‘)</div><div class="value" id="kpi-total">â€”</div></div>
          <div class="item"><div class="label">æŒæœ‰éƒ¨ä½å¸‚å€¼</div><div class="value" id="kpi-holdings">â€”</div></div>
          <div class="item"><div class="label">å¯å‹•ç”¨ç¾é‡‘</div><div class="value" id="kpi-cash">â€”</div></div>
          <div class="item"><div class="label">æœªå¯¦ç¾æç›Š (ä¸å«è‚¡æ¯)</div><div class="value" id="kpi-pnl">â€”</div></div>
        </div>
        <div class="right toolbar">
          <div class="search">
            ğŸ” <input id="q" placeholder="æœå°‹æ¨™çš„ / ä»£è™Ÿâ€¦" />
          </div>
          <button class="btn" id="btn-export">åŒ¯å‡ºè³‡æ–™</button>
          <label class="btn" for="import-json">åŒ¯å…¥è³‡æ–™</label>
          <input id="import-json" type="file" accept="application/json" hidden />
          <button class="btn ghost" id="btn-sample">è¼‰å…¥ç¤ºç¯„è³‡æ–™</button>
          <button class="btn danger" id="btn-reset">æ¸…ç©º</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="tabs" role="tablist" aria-label="ä¸»å°è¦½">
      <button class="tab" role="tab" aria-selected="true" data-target="#view-holdings">æŒæœ‰/æ¨™çš„</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-txns">ç•°å‹•ç´€éŒ„</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-accounts">å¸³æˆ¶ç¾é‡‘</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-snapshots">æ¯æ—¥æˆæœ</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-allocation">è³‡ç”¢é…ç½®</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#view-settings">è¨­å®š / èªªæ˜</button>
    </div>

    <!-- æŒæœ‰/æ¨™çš„ -->
    <section id="view-holdings" class="view active" role="tabpanel">
      <div class="card">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <button class="btn primary" id="btn-add-stock">ï¼‹ æ–°å¢æ¨™çš„</button>
            <button class="btn" id="btn-add-txn">ï¼‹ æ–°å¢ç•°å‹•</button>
          </div>
          <div class="stack">
            <button class="btn" id="btn-update-all-up">æ¨¡æ“¬å…¨éƒ¨ +1%</button>
            <button class="btn" id="btn-update-all-down">æ¨¡æ“¬å…¨éƒ¨ -1%</button>
            <button class="btn" id="btn-refresh-all">å³æ™‚æ›´æ–°å…¨éƒ¨</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="note">æç¤ºï¼šåƒ¹æ ¼å¯ç›´æ¥åœ¨è¡¨æ ¼ä¸­ç·¨è¼¯å¾ŒæŒ‰ã€Œæ›´æ–°ã€ã€‚æ‰€æœ‰è³‡æ–™çš†å„²å­˜åœ¨ç€è¦½å™¨ <span class="chip">localStorage</span> ä¸­ã€‚</div>
        <div class="hr"></div>
        <div class="table-wrap">
          <table id="tbl-holdings">
            <thead>
              <tr>
                <th>ä»£è™Ÿ</th>
                <th>åç¨±</th>
                <th>å¸‚å ´</th>
                <th class="num">æŒæœ‰è‚¡æ•¸/å£æ•¸</th>
                <th class="num">å‡åƒ¹ (äºŒä½)</th>
                <th class="num">ç¾åƒ¹ (å¯ç·¨è¼¯ï¼ŒäºŒä½)</th>
                <th class="num">å¸‚å€¼ (æ•´æ•¸)</th>
                <th class="num">æœªå¯¦ç¾æç›Š (æ•´æ•¸)</th>
                <th class="num">å«è‚¡æ¯ç¸½æç›Š (æ•´æ•¸)</th>
                <th>é¡åˆ¥</th>
                <th class="num">æ›´æ–°</th>
                <th class="num">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ç•°å‹•ç´€éŒ„ -->
    <section id="view-txns" class="view" role="tabpanel">
      <div class="card">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <button class="btn primary" id="btn-add-txn-2">ï¼‹ æ–°å¢ç•°å‹•</button>
          </div>
          <div class="stack">
            <label class="btn" for="import-csv">åŒ¯å…¥åƒ¹æ ¼ (CSV)</label>
            <input id="import-csv" type="file" accept=".csv" hidden />
          </div>
        </div>
        <div class="hr"></div>
        <table id="tbl-txns">
          <thead>
            <tr>
              <th>æ™‚é–“</th>
              <th>æ¨™çš„</th>
              <th>é¡å‹</th>
              <th class="num">åƒ¹æ ¼ (äºŒä½)</th>
              <th class="num">æ•¸é‡ (æ•´æ•¸)</th>
              <th class="num">é‡‘é¡ (æ•´æ•¸)</th>
              <th class="num">æœ¬æ¬¡å¯¦ç¾æç›Š (æ•´æ•¸)</th>
              <th>å‚™è¨»</th>
              <th class="num">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- å¸³æˆ¶ç¾é‡‘ -->
    <section id="view-accounts" class="view" role="tabpanel">
      <div class="card">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <button class="btn primary" id="btn-add-account">ï¼‹ æ–°å¢å¸³æˆ¶</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="accounts-list"></div>
      </div>
    </section>

    <!-- æ¯æ—¥æˆæœ -->
    <section id="view-snapshots" class="view" role="tabpanel">
      <div class="card">
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <button class="btn ok" id="btn-add-snapshot">ï¼‹ è¨˜éŒ„ä»Šå¤©</button>
          </div>
          <div class="note">å…§å®¹åŒ…å«ï¼šæŒæœ‰æ¨™çš„å¸‚å€¼ + æ‰€æœ‰å¸³æˆ¶çš„å¯ç”¨é¤˜é¡ï¼›ä¸¦èˆ‡å‰ä¸€ç­†æ¯”è¼ƒæ¼²è·Œé‡‘é¡èˆ‡æ¯”ä¾‹ã€‚</div>
        </div>
        <div class="hr"></div>
        <table id="tbl-snapshots">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th class="num">æŒæœ‰å¸‚å€¼ (æ•´æ•¸)</th>
              <th class="num">å¯ç”¨ç¾é‡‘ (æ•´æ•¸)</th>
              <th class="num">ç¸½è³‡ç”¢ (æ•´æ•¸)</th>
              <th class="num">èˆ‡å‰æ—¥å·®é¡ (æ•´æ•¸)</th>
              <th class="num">èˆ‡å‰æ—¥æ¯”ä¾‹</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- è³‡ç”¢é…ç½® -->
    <section id="view-allocation" class="view" role="tabpanel">
      <div class="card">
        <div class="stack" style="gap:18px; align-items:center; flex-wrap:wrap">
          <div>
            <div class="donut" id="donut-region"><div class="center"><div><div class="mini muted">å°ç£ vs å…¨çƒ</div><div id="label-region" style="font-size:18px">â€”</div></div></div></div>
          </div>
          <div>
            <div class="donut" id="donut-class"><div class="center"><div><div class="mini muted">è‚¡ç¥¨ vs å‚µåˆ¸</div><div id="label-class" style="font-size:18px">â€”</div></div></div></div>
          </div>
          <div class="grow"></div>
          <div class="card" style="min-width:280px">
            <div class="mini muted">ç›®å‰å¸‚å€¼å æ¯” (ä¾æ¨™çš„)</div>
            <div id="allocation-list" class="mini" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- è¨­å®š / èªªæ˜ -->
    <section id="view-settings" class="view" role="tabpanel">
      <div class="card">
        <h3 style="margin:0 0 8px">èªªæ˜</h3>
        <ul class="mini" style="margin-top:0; color:var(--sub)">
          <li>ç³»çµ±ä»¥ <strong>åŠ æ¬Šå¹³å‡æˆæœ¬æ³•</strong> è¨ˆç®—æŒæœ‰æˆæœ¬ï¼›è³£å‡ºæ™‚å³æ™‚è¨ˆå…¥å¯¦ç¾æç›Šï¼ˆSell äº¤æ˜“ï¼‰ã€‚</li>
          <li>ã€Œå«è‚¡æ¯ç¸½æç›Šã€= æœªå¯¦ç¾æç›Šï¼ˆä»¥ç¾åƒ¹ï¼‰ + è©²æ¨™çš„è‡³ä»Šçš„è‚¡æ¯æ”¶å…¥ï¼ˆDividend äº¤æ˜“é‡‘é¡ï¼‰ã€‚</li>
          <li>ã€Œå¸³æˆ¶å¯ç”¨é¤˜é¡ã€= å¯¦éš›å¸³æˆ¶é‡‘é¡ + é è¨ˆäº¤å‰²é‡‘é¡ï¼ˆå¯ç‚ºæ­£/è² ï¼‰ã€‚</li>
          <li>åƒ¹æ ¼é è¨­ <strong>æ‰‹å‹•æ›´æ–°</strong>ï¼›ä½ ä¹Ÿå¯ä»¥åœ¨ <code>priceProvider.fetch(symbol)</code> æ”¹æˆä½ çš„è¡Œæƒ… APIï¼Œä¸¦ç”¨ã€Œå³æ™‚æ›´æ–°å…¨éƒ¨ã€æŒ‰éˆ•æ‰¹æ¬¡æŠ“åƒ¹ã€‚</li>
        </ul>
        <div class="hr"></div>
        <div class="mini muted">é–‹ç™¼èªªæ˜ï¼šç´”åŸç”Ÿ HTML/CSS/JSï¼Œå–®æª”å³å¯é›¢ç·šä½¿ç”¨ï¼›è³‡æ–™å­˜æ–¼ localStorageï¼Œæä¾›åŒ¯å‡º/åŒ¯å…¥ JSONã€‚</div>
      </div>
    </section>
  </main>

  <!-- Dialog: Stock -->
  <dialog id="dlg-stock">
    <form method="dialog">
      <div class="dlg-head"><div>æ¨™çš„è³‡æ–™</div><button class="btn ghost" value="cancel">âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6"><label>ä»£è™Ÿ (Symbol)</label><input id="stock-symbol" required /></div>
          <div class="field col-6"><label>åç¨±</label><input id="stock-name" required /></div>
          <div class="field col-6"><label>å¸‚å ´</label>
            <select id="stock-market" class="select">
              <option value="TW">å°ç£</option>
              <option value="Global">å…¨çƒ</option>
            </select>
          </div>
          <div class="field col-6"><label>è³‡ç”¢é¡åˆ¥</label>
            <select id="stock-class" class="select">
              <option value="Equity">è‚¡ç¥¨</option>
              <option value="Bond">å‚µåˆ¸</option>
            </select>
          </div>
          <div class="field col-6"><label>ç¾åƒ¹ (å¯ç•™ç©º)</label><input id="stock-price" type="number" step="0.01" /></div>
          <div class="field col-6"><label>å¹£åˆ¥ (è¨»è¨˜)</label><input id="stock-currency" placeholder="TWD / USD â€¦" /></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Transaction -->
  <dialog id="dlg-txn">
    <form method="dialog">
      <div class="dlg-head"><div>æ–°å¢/ç·¨è¼¯ ç•°å‹•ç´€éŒ„</div><button class="btn ghost" value="cancel">âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6">
            <label>æ¨™çš„</label>
            <select id="txn-stock" class="select"></select>
          </div>
          <div class="field col-6">
            <label>é¡å‹</label>
            <select id="txn-type" class="select">
              <option value="buy">è²·å…¥ (Buy)</option>
              <option value="sell">è³£å‡º (Sell)</option>
              <option value="dividend">è‚¡æ¯ (Dividend)</option>
              <option value="fee">æ‰‹çºŒ/è²»ç”¨ (Fee)</option>
            </select>
          </div>
          <div class="field col-6"><label>åƒ¹æ ¼ (Dividend å¯ç•™ç©º)</label><input id="txn-price" type="number" step="0.01" /></div>
          <div class="field col-6"><label>æ•¸é‡ (Dividend å¯ç•™ç©ºæˆ– 0)</label><input id="txn-qty" type="number" step="0.01" /></div>
          <div class="field col-6"><label>é‡‘é¡ (è‡ªå‹•=åƒ¹æ ¼Ã—æ•¸é‡ï¼›Dividend éœ€å¡«å…¥å…¥å¸³é‡‘é¡)</label><input id="txn-amount" type="number" step="1" /></div>
          <div class="field col-6"><label>æ™‚é–“</label><input id="txn-time" type="datetime-local" /></div>
          <div class="field col-12"><label>å‚™è¨»</label><input id="txn-note" /></div>
        </div>
        <div class="mini note" style="margin-top:8px">è³£å‡º(Sell) æœƒä¾åŠ æ¬Šå¹³å‡æˆæœ¬æ³•è¨ˆç®— <strong>æœ¬æ¬¡å¯¦ç¾æç›Š</strong>ï¼›è‚¡æ¯(Dividend) é‡‘é¡æœƒè¨ˆå…¥ã€Œå«è‚¡æ¯ç¸½æç›Šã€ã€‚è²»ç”¨(Fee) æœƒå¢åŠ æŒæœ‰æˆæœ¬ã€‚</div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Account -->
  <dialog id="dlg-account">
    <form method="dialog">
      <div class="dlg-head"><div>å¸³æˆ¶è¨­å®š / ç•°å‹•</div><button class="btn ghost" value="cancel">âœ•</button></div>
      <div class="dlg-body">
        <div class="grid">
          <div class="field col-6"><label>å¸³æˆ¶åç¨±</label><input id="acct-name" required /></div>
          <div class="field col-6"><label>å¯¦éš›å¸³æˆ¶é‡‘é¡</label><input id="acct-actual" type="number" step="1" /></div>
          <div class="field col-6"><label>é è¨ˆäº¤å‰²é‡‘é¡ (å¯æ­£/è² )</label><input id="acct-settle" type="number" step="1" /></div>
          <div class="field col-6"><label>å‚™è¨»</label><input id="acct-note" /></div>
        </div>
        <div class="hr"></div>
        <div class="stack">
          <div class="mini muted">å¿«é€Ÿç•°å‹•ï¼š</div>
          <button class="btn" type="button" data-op="deposit">ï¼‹ å¢è³‡ (Deposit)</button>
          <button class="btn" type="button" data-op="withdraw">ï¼ æ¸›è³‡ (Withdraw)</button>
          <button class="btn" type="button" data-op="settlement">â†” è®Šæ›´äº¤å‰² (Settlement)</button>
          <input id="acct-op-amount" class="inline-input" type="number" step="1" placeholder="é‡‘é¡" />
          <input id="acct-op-note" class="inline-input" placeholder="å‚™è¨»" />
        </div>
      </div>
      <div class="footer">
        <button class="btn ghost" value="cancel">è¿”å›</button>
        <button class="btn primary" value="ok">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <script>
  // ========= åŸºç¤å·¥å…· =========
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  // é¡¯ç¤ºè¦å‰‡ï¼šæ•¸é‡/ç¸½åƒ¹å€¼/æç›Š/å¸³æˆ¶é‡‘é¡/å¿«ç…§é‡‘é¡ -> æ•´æ•¸ä¸”åƒåˆ†è™Ÿï¼›åƒ¹æ ¼/å‡åƒ¹ -> 2 ä½å°æ•¸
  const fmtInt = new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 });
  const fmt2 = new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const pct = (n) => (isFinite(n)? (n*100).toFixed(2)+'%':'â€”');
  const uid = () => Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4);
  const todayStr = () => new Date().toISOString().slice(0,10);
  const nowISO = () => new Date().toISOString();
  const parseN = (v) => isNaN(parseFloat(v))? 0 : parseFloat(v);

  const storeKey = 'pfv1';
  const loadDB = () => JSON.parse(localStorage.getItem(storeKey) || '{"stocks":[],"txns":[],"accounts":[],"snapshots":[]}');
  const saveDB = () => localStorage.setItem(storeKey, JSON.stringify(DB));
  let DB = loadDB();

  // ========= åƒ¹æ ¼ä¾›æ‡‰å™¨ï¼ˆé è¨­æ‰‹å‹•/æ¨¡æ“¬ï¼‰ =========
  const priceProvider = {
    async fetch(symbol){
      if(!symbol) return null;
      const origSym = symbol.toUpperCase();
      const sym = origSym.endsWith('.TW') ? origSym : `${origSym}.TW`;

      const parsePriceFromJson = (j) => {
        try{
          const r = j?.quoteResponse?.result?.[0];
          if(!r) return null;
          return (r.regularMarketPrice ?? r.regularMarketPreviousClose ?? r.regularMarketOpen ?? r.postMarketPrice ?? null);
        }catch(e){
          return null;
        }
      };

      // 1) å…ˆå˜—è©¦æœ¬æ©Ÿ proxyï¼ˆéœ€å…ˆå•Ÿå‹• proxy-server.jsï¼‰
      const localProxy = `http://localhost:3000/quote?symbol=${encodeURIComponent(sym)}`;
      try{
        const res = await fetch(localProxy, {cache:'no-store'});
        if(res.ok){
          const j = await res.json();
          const p = parsePriceFromJson(j);
          if(p !== null && !isNaN(p)) return { price: Number(p), via:'local-proxy' };
        }
      }catch(err){
        console.debug('[priceProvider] local-proxy failed', err && err.message);
      }

      // 2) fallback å˜—è©¦ jina / alloriginsï¼ˆå…¬ç”¨ proxyï¼Œç©©å®šæ€§è¼ƒå·®ï¼‰
      const attempts = [
        { name: 'direct', url: `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(sym)}` },
        { name: 'jina', url: `https://r.jina.ai/http://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(sym)}` },
        { name: 'allorigins', url: `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(sym)}`)}` }
      ];

      for(const a of attempts){
        try{
          console.debug('[priceProvider] try', a.name);
          const res = await fetch(a.url, {cache:'no-store'});
          if(!res.ok) continue;
          const txt = await res.text();
          let j;
          try{ j = JSON.parse(txt); }catch(e){ continue; }
          const p = parsePriceFromJson(j);
          if(p !== null && !isNaN(p)) return { price: Number(p), via: a.name };
        }catch(err){
          console.debug('[priceProvider] fetch error', a.name, err && err.message);
        }
      }

      console.warn('[priceProvider] all attempts failed for', symbol);
      return null;
    }
  };

  // ========= æˆæœ¬/éƒ¨ä½è¨ˆç®—ï¼ˆåŠ æ¬Šå¹³å‡æˆæœ¬æ³•ï¼‰ =========
  function calcPosition(stockId){
    const tx = DB.txns.filter(t=>t.stockId===stockId).sort((a,b)=>new Date(a.time)-new Date(b.time));
    let qty=0, costBasis=0, avgCost=0, dividends=0;
    for(const t of tx){
      const type=t.type;
      if(type==='buy'){
        const amount = parseN(t.price)*parseN(t.qty);
        costBasis += amount;
        qty += parseN(t.qty);
        avgCost = qty? costBasis/qty : 0;
      }else if(type==='sell'){
        const sellQty = parseN(t.qty);
        const realized = (parseN(t.price)-avgCost)*sellQty; // è¨˜éŒ„ç”¨
        costBasis -= avgCost*sellQty; // ç§»é™¤è¢«è³£å‡ºçš„æˆæœ¬
        qty -= sellQty;
        avgCost = qty? costBasis/qty : 0;
        t._realized = realized; // åƒ…ä¾›é¡¯ç¤º
      }else if(type==='fee'){
        costBasis += parseN(t.amount); // è²»ç”¨å¢åŠ æˆæœ¬
        avgCost = qty? costBasis/qty : 0;
      }else if(type==='dividend'){
        dividends += parseN(t.amount);
      }
    }
    const stock = DB.stocks.find(s=>s.id===stockId);
    const price = parseN(stock?.price);
    const marketValue = price*qty;
    const unrealized = marketValue - costBasis; // ä¸å«è‚¡æ¯
    const totalPnl = unrealized + dividends;    // å«è‚¡æ¯
    return {qty, avgCost, costBasis, price, marketValue, unrealized, dividends, totalPnl};
  }

  function computeAllPositions(){
    const map = {};
    for(const s of DB.stocks){ map[s.id] = calcPosition(s.id); }
    return map;
  }

  function computeTxnRealizedList(){
    // å›æ”¾æ‰€æœ‰äº¤æ˜“ï¼Œé€ç­†é™„ä¸Šæœ¬æ¬¡å¯¦ç¾æç›Š
    const tx = DB.txns.slice().sort((a,b)=>new Date(a.time)-new Date(b.time));
    const state = new Map(); // stockId -> {qty, avgCost}
    return tx.map(t=>{
      const st = state.get(t.stockId) || {qty:0, avgCost:0};
      let realized = 0;
      if(t.type==='buy'){
        const amount = parseN(t.price)*parseN(t.qty);
        const newQty = st.qty + parseN(t.qty);
        const newCost = st.avgCost*st.qty + amount;
        st.qty = newQty; st.avgCost = newQty? newCost/newQty : 0;
      }else if(t.type==='sell'){
        realized = (parseN(t.price)-st.avgCost) * parseN(t.qty);
        st.qty -= parseN(t.qty);
      }else if(t.type==='fee'){
        const newCostBasis = st.avgCost*st.qty + parseN(t.amount);
        st.avgCost = st.qty? newCostBasis/st.qty : 0;
      }else if(t.type==='dividend'){
        realized = parseN(t.amount);
      }
      state.set(t.stockId, st);
      return {...t, realized};
    }).sort((a,b)=>new Date(b.time)-new Date(a.time));
  }

  // ========= Header KPI =========
  function refreshKPI(){
    const pos = computeAllPositions();
    const holdings = Object.values(pos).reduce((a,b)=>a + b.marketValue, 0);
    const unreal = Object.values(pos).reduce((a,b)=>a + b.unrealized, 0);
    const cash = DB.accounts.reduce((a,acc)=> a + (parseN(acc.actual) + parseN(acc.settlement)), 0);
    $('#kpi-total').textContent = fmtInt.format(Math.round(holdings + cash));
    $('#kpi-holdings').textContent = fmtInt.format(Math.round(holdings));
    $('#kpi-cash').textContent = fmtInt.format(Math.round(cash));
    $('#kpi-pnl').textContent = (unreal>=0? 'â–² ':'â–¼ ') + fmtInt.format(Math.round(Math.abs(unreal)));
    $('#kpi-pnl').parentElement.querySelector('.label').style.color = unreal>=0? '#065f46' : '#991b1b';
  }

  // ========= Holdings è¡¨æ ¼ =========
  function renderHoldings(){
    const tbody = $('#tbl-holdings tbody');
    tbody.innerHTML = '';
    const q = $('#q').value.trim().toLowerCase();
    const pos = computeAllPositions();
    const rows = DB.stocks
      .filter(s=> !q || s.symbol.toLowerCase().includes(q) || s.name.toLowerCase().includes(q))
      .sort((a,b)=> a.symbol.localeCompare(b.symbol));

    for(const s of rows){
      const p = pos[s.id];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge blue">${s.symbol}</span></td>
        <td>${s.name||''}</td>
        <td class="mini muted">${s.market||'-'}</td>
        <td class="num">${fmtInt.format(Math.round(p.qty))}</td>
        <td class="num">${p.avgCost? fmt2.format(p.avgCost): 'â€”'}</td>
        <td class="num">
          <input class="inline-input" type="number" step="0.01" value="${Number.isFinite(parseN(s.price))? parseN(s.price).toFixed(2): ''}" data-id="${s.id}" />
        </td>
        <td class="num">${fmtInt.format(Math.round(p.marketValue))}</td>
        <td class="num">${p.unrealized>=0? '<span class="badge green">â–² '+fmtInt.format(Math.round(p.unrealized))+'</span>':'<span class="badge red">â–¼ '+fmtInt.format(Math.round(Math.abs(p.unrealized)))+'</span>'}</td>
        <td class="num">${p.totalPnl>=0? '<span class="badge green">â–² '+fmtInt.format(Math.round(p.totalPnl))+'</span>':'<span class="badge red">â–¼ '+fmtInt.format(Math.round(Math.abs(p.totalPnl)))+'</span>'}</td>
        <td class="mini muted">${s.assetClass||'-'}</td>
        <td class="num"><button class="btn mini" data-action="update-price" data-id="${s.id}">æ›´æ–°</button></td>
        <td class="num">
          <div class="stack" style="justify-content:flex-end">
            <button class="btn mini" data-action="edit-stock" data-id="${s.id}">ç·¨è¼¯</button>
            <button class="btn mini danger" data-action="del-stock" data-id="${s.id}">åˆªé™¤</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    }
  }

  // ========= äº¤æ˜“è¡¨æ ¼ =========
  function renderTxns(){
    const tbody = $('#tbl-txns tbody');
    tbody.innerHTML='';
    const list = computeTxnRealizedList();
    if(list.length===0){ tbody.innerHTML = `<tr><td colspan="9" class="empty">å°šç„¡ç•°å‹•ç´€éŒ„</td></tr>`; return; }
    for(const t of list){
      const s = DB.stocks.find(x=>x.id===t.stockId);
      const tr = document.createElement('tr');
      const amount = t.type==='dividend' || t.type==='fee' ? parseN(t.amount) : parseN(t.price)*parseN(t.qty);
      tr.innerHTML = `
        <td class="mini muted">${new Date(t.time).toLocaleString()}</td>
        <td>${s? s.symbol+' Â· '+s.name : '(å·²åˆªé™¤æ¨™çš„)'}</td>
        <td><span class="badge ${t.type==='sell'?'red': t.type==='buy'?'blue': t.type==='dividend'?'green':'"'}">${t.type}</span></td>
        <td class="num">${t.price? fmt2.format(parseN(t.price)): 'â€”'}</td>
        <td class="num">${t.qty? fmtInt.format(Math.round(t.qty)): 'â€”'}</td>
        <td class="num">${fmtInt.format(Math.round(amount))}</td>
        <td class="num">${t.realized>=0? '<span class="badge green">â–² '+fmtInt.format(Math.round(t.realized))+'</span>':'<span class="badge red">â–¼ '+fmtInt.format(Math.round(Math.abs(t.realized)))+'</span>'}</td>
        <td class="mini">${t.note||''}</td>
        <td class="num">
          <div class="stack" style="justify-content:flex-end">
            <button class="btn mini" data-action="edit-txn" data-id="${t.id}">ç·¨è¼¯</button>
            <button class="btn mini danger" data-action="del-txn" data-id="${t.id}">åˆªé™¤</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    }
  }

  // ========= å¸³æˆ¶ =========
  function renderAccounts(){
    const box = $('#accounts-list'); box.innerHTML='';
    if(DB.accounts.length===0){ box.innerHTML = `<div class="empty">å°šç„¡å¸³æˆ¶ï¼Œè«‹æ–°å¢</div>`; return; }
    for(const a of DB.accounts){
      const available = parseN(a.actual) + parseN(a.settlement);
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="stack" style="justify-content:space-between; align-items:center">
          <div class="stack">
            <div class="brand">${a.name}</div>
            <div class="badge">å¯ç”¨é¤˜é¡ï¼š<strong>${fmtInt.format(Math.round(available))}</strong></div>
            <div class="badge blue">å¯¦éš›ï¼š${fmtInt.format(Math.round(parseN(a.actual)))}</div>
            <div class="badge">äº¤å‰²ï¼š${fmtInt.format(Math.round(parseN(a.settlement)))}</div>
          </div>
          <div class="stack">
            <button class="btn mini" data-action="edit-account" data-id="${a.id}">ç·¨è¼¯/ç•°å‹•</button>
            <button class="btn mini danger" data-action="del-account" data-id="${a.id}">åˆªé™¤</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="mini muted">æ­·å²ç´€éŒ„</div>
        <table style="margin-top:6px; width:100%">
          <thead><tr><th>æ™‚é–“</th><th>é¡å‹</th><th>å‚™è¨»</th><th class="num">é‡‘é¡ (æ•´æ•¸)</th></tr></thead>
          <tbody>${(a.history||[]).slice().reverse().map(h=>`<tr><td class="mini muted">${new Date(h.time).toLocaleString()}</td><td>${h.type}</td><td class="mini">${h.note||''}</td><td class="num">${fmtInt.format(Math.round(parseN(h.amount)))}</td></tr>`).join('')}</tbody>
        </table>`;
      box.appendChild(card);
    }
  }

  // ========= æ¯æ—¥æˆæœ =========
  function renderSnapshots(){
    const tbody = $('#tbl-snapshots tbody'); tbody.innerHTML='';
    const list = DB.snapshots.slice().sort((a,b)=> a.date<b.date?1:-1);
    if(list.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="empty">å°šç„¡ç´€éŒ„</td></tr>`; return; }
    for(const s of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.date}</td>
        <td class="num">${fmtInt.format(Math.round(parseN(s.holdings)))}</td>
        <td class="num">${fmtInt.format(Math.round(parseN(s.cash)))}</td>
        <td class="num">${fmtInt.format(Math.round(parseN(s.total)))}</td>
        <td class="num">${s.deltaAmt>=0? 'â–² '+fmtInt.format(Math.round(s.deltaAmt)): 'â–¼ '+fmtInt.format(Math.round(Math.abs(s.deltaAmt)))}</td>
        <td class="num">${s.deltaPct>=0? '+'+ (s.deltaPct*100).toFixed(2)+'%': (s.deltaPct*100).toFixed(2)+'%'}</td>`;
      tbody.appendChild(tr);
    }
  }

  // ========= é…ç½® =========
  function renderAllocation(){
    const pos = computeAllPositions();
    const rows = DB.stocks.map(s=>({s, mval: pos[s.id].marketValue})).filter(r=>r.mval>0);
    const total = rows.reduce((a,b)=>a+b.mval,0) || 1;

    const byRegion = {TW:0, Global:0};
    const byClass = {Equity:0, Bond:0};
    for(const r of rows){ byRegion[r.s.market||'Global'] += r.mval; byClass[r.s.assetClass||'Equity'] += r.mval }

    const twPct = byRegion.TW/total, glbPct = byRegion.Global/total;
    const eqPct = byClass.Equity/total, bdPct = byClass.Bond/total;

    // donut è‘—è‰²ï¼ˆè—/é’ï¼‰
    $('#donut-region').style.background = `conic-gradient(var(--brand) 0 ${twPct*360}deg, var(--accent) 0 360deg)`;
    $('#label-region').textContent = `${(twPct*100).toFixed(1)}% / ${(glbPct*100).toFixed(1)}%`;

    $('#donut-class').style.background = `conic-gradient(var(--brand) 0 ${eqPct*360}deg, var(--accent) 0 360deg)`;
    $('#label-class').textContent = `${(eqPct*100).toFixed(1)}% / ${(bdPct*100).toFixed(1)}%`;

    // åˆ—è¡¨
    const list = rows.sort((a,b)=>b.mval-a.mval).map(r=>{
      const p = (r.mval/total*100).toFixed(1);
      return `<div class="stack" style="justify-content:space-between"><div>${r.s.symbol} Â· ${r.s.name}</div><div class="mini muted">${p}%</div></div>`
    }).join('');
    $('#allocation-list').innerHTML = list || '<div class="empty">å°šç„¡éƒ¨ä½</div>';
  }

  // ========= åŒ¯å…¥/åŒ¯å‡º =========
  $('#btn-export').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(DB, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `portfolio-${todayStr()}.json`; a.click();
  });
  $('#import-json').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => { try{ DB = JSON.parse(reader.result); saveDB(); fullRender(); }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message); } };
    reader.readAsText(f);
  });

  // ========= åƒ¹æ ¼ CSV åŒ¯å…¥ (symbol,price) =========
  $('#import-csv').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const lines = reader.result.split(/\r?\n/).filter(Boolean);
      for(const line of lines){
        const [sym, price] = line.split(',').map(s=>s.trim());
        const s = DB.stocks.find(x=>x.symbol===sym);
        if(s){ s.price = parseN(price); s.lastPriceAt = nowISO(); }
      }
      saveDB(); fullRender();
    };
    reader.readAsText(f);
  });

  // ========= äº’å‹•ï¼šTabs / æœå°‹ =========
  $$('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      $$('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
      tab.setAttribute('aria-selected','true');
      $$('.view').forEach(v=>v.classList.remove('active'));
      $(tab.dataset.target).classList.add('active');
    })
  });
  $('#q').addEventListener('input', ()=> renderHoldings());

  // ========= äº’å‹•ï¼šæŒæœ‰è¡¨æ ¼ =========
  $('#tbl-holdings').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    const stock = DB.stocks.find(s=>s.id===id);
    if(action==='update-price'){
      const tr = e.target.closest('tr');
      const input = tr.querySelector('input.inline-input');
      input.disabled = true;
      const origVal = input.value;
      try{
        const q = await priceProvider.fetch(stock.symbol);
        if(q && typeof q.price === 'number'){ stock.price = q.price; input.value = Number(q.price).toFixed(2); }
        else{ stock.price = parseN(origVal); input.value = Number(stock.price).toFixed(2); }
        stock.lastPriceAt = nowISO(); saveDB(); fullRender();
      }catch(err){
        console.error('update-price failed for', stock.symbol, err);
        // fallback to input value
        stock.price = parseN(origVal);
        stock.lastPriceAt = nowISO(); saveDB(); fullRender();
      }finally{
        input.disabled = false;
      }
    }else if(action==='edit-stock'){
      openStockDialog(stock);
    }else if(action==='del-stock'){
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™çš„ï¼Ÿå…¶äº¤æ˜“ç´€éŒ„ä»æœƒä¿ç•™ã€‚')){ DB.stocks = DB.stocks.filter(s=>s.id!==id); saveDB(); fullRender(); }
    }
  });

  // æ¨¡æ“¬æ•´é«”æ¼²è·Œ
  $('#btn-update-all-up').addEventListener('click', ()=>{ for(const s of DB.stocks){ s.price = parseN(s.price)*(1.01) || 0; s.lastPriceAt = nowISO(); } saveDB(); fullRender(); })
  $('#btn-update-all-down').addEventListener('click', ()=>{ for(const s of DB.stocks){ s.price = parseN(s.price)*(0.99) || 0; s.lastPriceAt = nowISO(); } saveDB(); fullRender(); })

  // å³æ™‚æ›´æ–°å…¨éƒ¨ï¼ˆè‹¥ priceProvider.fetch æœ‰å¯¦ä½œï¼‰
  $('#btn-refresh-all').addEventListener('click', async ()=>{
    const btn = $('#btn-refresh-all');
    btn.disabled = true;
    const origText = btn.textContent;
    btn.textContent = 'æ›´æ–°ä¸­â€¦';
    // ä¸¦è¡Œè«‹æ±‚ï¼ˆæœ‰éŒ¯èª¤ç¹¼çºŒå…¶ä»–ï¼‰
    const tasks = DB.stocks.map(async (s) => {
      try{
        const q = await priceProvider.fetch(s.symbol);
        if(q && typeof q.price==='number'){
          s.price = q.price;
          s.lastPriceAt = nowISO();
          return { id:s.id, ok:true };
        }else{
          return { id:s.id, ok:false, reason:'no-price' };
        }
      }catch(err){
        return { id:s.id, ok:false, reason: err && err.message };
      }
    });
    const results = await Promise.allSettled(tasks);
    // å¯åœ¨ console æª¢è¦–æ¯å€‹æ¨™çš„çµæœ
    results.forEach((r,i)=>{
      if(r.status==='fulfilled'){
        console.debug('[refresh-all] fulfilled', DB.stocks[i].symbol, r.value);
      }else{
        console.debug('[refresh-all] rejected', DB.stocks[i].symbol, r.reason);
      }
    });
    saveDB(); fullRender();
    btn.disabled = false;
    btn.textContent = origText;
  });

  // ========= Dialogï¼šStock =========
  $('#btn-add-stock').addEventListener('click', ()=> openStockDialog());
  function openStockDialog(stock){
    const dlg = $('#dlg-stock');
    $('#stock-symbol').value = stock?.symbol || '';
    $('#stock-name').value = stock?.name || '';
    $('#stock-market').value = stock?.market || 'TW';
    $('#stock-class').value = stock?.assetClass || 'Equity';
    $('#stock-price').value = Number.isFinite(parseN(stock?.price))? parseN(stock?.price).toFixed(2): '';
    $('#stock-currency').value = stock?.currency || '';
    dlg.returnValue = '';
    dlg.showModal();
    dlg.addEventListener('close', () => {
      if(dlg.returnValue!=='ok') return;
      const symbol = $('#stock-symbol').value.trim();
      const name = $('#stock-name').value.trim();
      if(!symbol || !name) return;
      const payload = {
        id: stock?.id || uid(),
        symbol,
        name,
        market: $('#stock-market').value,
        assetClass: $('#stock-class').value,
        price: $('#stock-price').value? parseN($('#stock-price').value): undefined,
        currency: $('#stock-currency').value.trim(),
        lastPriceAt: nowISO()
      };
      if(stock){ Object.assign(stock, payload); }
      else{ DB.stocks.push(payload); }
      saveDB(); fullRender();
    }, {once:true});
  }

  // ========= Dialogï¼šTransaction =========
  const openTxnDialog = (txn) =>{
    const dlg = $('#dlg-txn');
    const sel = $('#txn-stock');
    sel.innerHTML = DB.stocks.map(s=>`<option value="${s.id}">${s.symbol} Â· ${s.name}</option>`).join('');
    if(DB.stocks.length===0){ alert('è«‹å…ˆæ–°å¢æ¨™çš„'); return; }

    $('#txn-stock').value = txn?.stockId || DB.stocks[0].id;
    $('#txn-type').value = txn?.type || 'buy';
    $('#txn-price').value = Number.isFinite(parseN(txn?.price))? parseN(txn?.price).toFixed(2): '';
    $('#txn-qty').value = Number.isFinite(parseN(txn?.qty))? parseN(txn?.qty).toFixed(2): '';
    $('#txn-amount').value = Number.isFinite(parseN(txn?.amount))? Math.round(parseN(txn?.amount)) : '';
    $('#txn-time').value = txn? new Date(txn.time).toISOString().slice(0,16) : new Date().toISOString().slice(0,16);
    $('#txn-note').value = txn?.note || '';

    // è‡ªå‹•è¨ˆé‡‘é¡ï¼ˆæ•´æ•¸ï¼‰
    const recalc = ()=>{
      const type = $('#txn-type').value;
      const price = parseN($('#txn-price').value);
      const qty = parseN($('#txn-qty').value);
      if(type==='dividend') return; // æ‰‹å¡«é‡‘é¡
      $('#txn-amount').value = Math.round(price*qty) || '';
    };
    $('#txn-price').oninput = recalc; $('#txn-qty').oninput = recalc; $('#txn-type').onchange = recalc;

    dlg.returnValue=''; dlg.showModal();
    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='ok') return;
      const t = {
        id: txn?.id || uid(),
        stockId: $('#txn-stock').value,
        type: $('#txn-type').value,
        price: $('#txn-price').value? parseN($('#txn-price').value): undefined,
        qty: $('#txn-qty').value? parseN($('#txn-qty').value): undefined,
        amount: $('#txn-amount').value? parseN($('#txn-amount').value): undefined,
        time: new Date($('#txn-time').value).toISOString(),
        note: $('#txn-note').value.trim()
      };
      if(txn){ Object.assign(txn, t); }
      else{ DB.txns.push(t); }
      saveDB(); fullRender();
    }, {once:true});
  };
  $('#btn-add-txn').addEventListener('click', ()=> openTxnDialog());
  $('#btn-add-txn-2').addEventListener('click', ()=> openTxnDialog());

  $('#tbl-txns').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    const txn = DB.txns.find(x=>x.id===id);
    if(action==='edit-txn') openTxnDialog(txn);
    if(action==='del-txn'){
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç•°å‹•ï¼Ÿ')){ DB.txns = DB.txns.filter(x=>x.id!==id); saveDB(); fullRender(); }
    }
  });

  // ========= å¸³æˆ¶ Dialog =========
  $('#btn-add-account').addEventListener('click', ()=> openAccountDialog());
  function openAccountDialog(acct){
    const dlg = $('#dlg-account');
    $('#acct-name').value = acct?.name || '';
    $('#acct-actual').value = Number.isFinite(parseN(acct?.actual))? Math.round(parseN(acct?.actual)) : '';
    $('#acct-settle').value = Number.isFinite(parseN(acct?.settlement))? Math.round(parseN(acct?.settlement)) : '';
    $('#acct-note').value = acct?.note || '';

    // å¿«é€Ÿç•°å‹•ï¼ˆé‡‘é¡ä»¥æ•´æ•¸ï¼‰
    dlg.querySelectorAll('button[data-op]').forEach(b=>{
      b.onclick = ()=>{
        const amount = Math.round(parseN($('#acct-op-amount').value));
        if(!amount){ alert('è«‹è¼¸å…¥é‡‘é¡'); return; }
        const note = $('#acct-op-note').value.trim();
        const type = b.dataset.op;
        if(type==='deposit') $('#acct-actual').value = Math.round(parseN($('#acct-actual').value) + amount);
        if(type==='withdraw') $('#acct-actual').value = Math.round(parseN($('#acct-actual').value) - amount);
        if(type==='settlement') $('#acct-settle').value = Math.round(parseN($('#acct-settle').value) + amount);
        // ç´€éŒ„è‡³ historyï¼ˆæš«å­˜ï¼Œç¢ºå®šæ™‚å¯«å…¥ï¼‰
        const hist = acct? (acct._pendingHistory = acct._pendingHistory||[]) : (dlg._newPendingHistory = dlg._newPendingHistory||[]);
        (hist).push({time: nowISO(), type, amount: (type==='withdraw'?-amount:amount), note});
        $('#acct-op-amount').value=''; $('#acct-op-note').value='';
      };
    });

    dlg.returnValue=''; dlg.showModal();
    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='ok') return;
      const payload = {
        id: acct?.id || uid(),
        name: $('#acct-name').value.trim(),
        actual: Math.round(parseN($('#acct-actual').value)),
        settlement: Math.round(parseN($('#acct-settle').value)),
        note: $('#acct-note').value.trim(),
        history: acct?.history || []
      };
      if(acct){ Object.assign(acct, payload); if(acct._pendingHistory){ acct.history.push(...acct._pendingHistory); delete acct._pendingHistory; } }
      else{
        const h = dlg._newPendingHistory || []; delete dlg._newPendingHistory;
        payload.history = h; DB.accounts.push(payload);
      }
      saveDB(); fullRender();
    }, {once:true});
  }

  $('#accounts-list').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    const acct = DB.accounts.find(a=>a.id===id);
    if(action==='edit-account') openAccountDialog(acct);
    if(action==='del-account'){
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤å¸³æˆ¶ï¼Ÿ')){ DB.accounts = DB.accounts.filter(a=>a.id!==id); saveDB(); fullRender(); }
    }
  });

  // ========= æ¯æ—¥æˆæœï¼šæ–°å¢ä»Šå¤© =========
  $('#btn-add-snapshot').addEventListener('click', ()=>{
    const pos = computeAllPositions();
    const holdings = Object.values(pos).reduce((a,b)=>a + b.marketValue, 0);
    const cash = DB.accounts.reduce((a,acc)=> a + (parseN(acc.actual) + parseN(acc.settlement)), 0);
    const total = holdings + cash;
    const prev = DB.snapshots.slice().sort((a,b)=> a.date<b.date?1:-1)[0];
    const deltaAmt = prev? total - prev.total : 0;
    const deltaPct = prev? (deltaAmt / (prev.total||1)) : 0;
    const record = {date: todayStr(), holdings, cash, total, deltaAmt, deltaPct};
    // è‹¥åŒæ—¥å·²å­˜åœ¨ï¼Œè¦†è“‹
    const idx = DB.snapshots.findIndex(s=>s.date===record.date);
    if(idx>=0) DB.snapshots[idx]=record; else DB.snapshots.push(record);
    saveDB(); fullRender();
  });

  // ========= ç¯„ä¾‹è³‡æ–™ / æ¸…ç©º =========
  $('#btn-sample').addEventListener('click', ()=>{
    if(!confirm('è¼‰å…¥ç¤ºç¯„è³‡æ–™å°‡è¦†è“‹ç›®å‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ')) return;
    DB = sampleData(); saveDB(); fullRender();
  });
  $('#btn-reset').addEventListener('click', ()=>{
    if(!confirm('æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸ')) return;
    DB = {stocks:[], txns:[], accounts:[], snapshots:[]}; saveDB(); fullRender();
  });

  function sampleData(){
    const s1 = {id:uid(), symbol:'0050', name:'å…ƒå¤§å°ç£50', market:'TW', assetClass:'Equity', price:150, currency:'TWD', lastPriceAt: nowISO()};
    const s2 = {id:uid(), symbol:'VTI', name:'Vanguard Total Stock', market:'Global', assetClass:'Equity', price:2600, currency:'TWD', lastPriceAt: nowISO()};
    const s3 = {id:uid(), symbol:'00687B', name:'åœ‹æ³°20å¹´ç¾å‚µ', market:'TW', assetClass:'Bond', price:33.5, currency:'TWD', lastPriceAt: nowISO()};
    const t0 = new Date();
    const tx = [
      {id:uid(), stockId:s1.id, type:'buy', price:140, qty:100, time:new Date(t0-86400000*20).toISOString(), note:'åˆ†æ‰¹è²·å…¥'},
      {id:uid(), stockId:s1.id, type:'buy', price:155, qty:50, time:new Date(t0-86400000*10).toISOString()},
      {id:uid(), stockId:s1.id, type:'dividend', amount:800, time:new Date(t0-86400000*5).toISOString(), note:'å­£é…æ¯'},
      {id:uid(), stockId:s2.id, type:'buy', price:2500, qty:2, time:new Date(t0-86400000*18).toISOString()},
      {id:uid(), stockId:s2.id, type:'buy', price:2550, qty:1, time:new Date(t0-86400000*7).toISOString()},
      {id:uid(), stockId:s3.id, type:'buy', price:32.8, qty:100, time:new Date(t0-86400000*14).toISOString()},
      {id:uid(), stockId:s3.id, type:'sell', price:33.2, qty:20, time:new Date(t0-86400000*3).toISOString(), note:'èª¿ç¯€'}
    ];
    const a1 = {id:uid(), name:'åˆ¸å•†ä¸€', actual: 200000, settlement: -15000, note:'ä¸»è¦äº¤æ˜“', history:[{time:nowISO(), type:'deposit', amount:200000, note:'åˆå§‹'}]};
    const a2 = {id:uid(), name:'åˆ¸å•†äºŒ', actual: 80000, settlement: 0, note:'å‚™ç”¨', history:[{time:nowISO(), type:'deposit', amount:80000}]};
    const snapshots = [];
    return {stocks:[s1,s2,s3], txns:tx, accounts:[a1,a2], snapshots};
  }

  // ========= åˆæ¬¡æ¸²æŸ“ =========
  function fullRender(){
    refreshKPI(); renderHoldings(); renderTxns(); renderAccounts(); renderSnapshots(); renderAllocation();
  }
  fullRender();
  </script>
</body>
</html>
