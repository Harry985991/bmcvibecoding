<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>組織接班人計畫 (離線版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom base styles */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #F2F2EC;
            color: #385159;
        }

        /* Form element styling */
        .form-input, .form-select, .form-textarea {
            display: block;
            width: 100%;
            border-width: 1px;
            border-color: #A9BDBF;
            border-radius: 0.375rem;
            background-color: white;
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #385159;
            box-shadow: 0 0 0 2px rgba(56, 81, 89, 0.3);
        }

        /* Drag-and-drop styling */
        .dragging {
            opacity: 0.5;
            background: #e0e7e8;
            border: 2px dashed #385159;
        }
        
        /* Modal transition */
        .modal-enter {
            opacity: 0;
        }
        .modal-enter-active {
            opacity: 1;
            transition: opacity 200ms;
        }
        .modal-leave {
            opacity: 1;
        }
        .modal-leave-active {
            opacity: 0;
            transition: opacity 200ms;
        }
        .modal-content-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-content-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms, transform 200ms;
        }
    </style>
</head>
<body>
    <!-- Main application container -->
    <div id="app-root"></div>

    <!-- Modal container -->
    <div id="modal-container"></div>
    
    <!-- Custom confirm dialog container -->
    <div id="confirm-container"></div>

    <script type="module">
        // --- Application State and Constants ---
        const POSITION_LEVELS = ["一級", "中心", "廠處", "部", "課"];
        const FUNCTION_TYPES = ["OU", "BU", "RD", "IU", "其他"];
        const READINESS_OPTIONS = ["1年內", "1-3年", "3-5年"];
        const STATUS_OPTIONS = { green: "綠燈", yellow: "黃燈", red: "紅燈" };
        const OVERALL_STATUS_TYPES = { complete: '完整', partial: '部分', attention: '注意' };
        
        const initialFilters = {
            level: [], status: [], promotionStatus: [], orgCode: '', incumbent: '',
            personName: '', isActing: 'all', division: '', adjustment: '', isBmp: 'all',
        };

        // Application State
        let state = {
            page: 'main', // 'main' or 'analytics'
            positions: [],
            isLoading: false, // No initial loading needed
            error: null,
            isPositionModalOpen: false,
            isSuccessorModalOpen: false,
            isImportModalOpen: false,
            isRemarksModalOpen: false,
            detailsModalData: null,
            currentPosition: null,
            successorToEdit: null,
            remarksTarget: null,
            newPosition: { orgCode: '', level: POSITION_LEVELS[0], incumbent: '', isActing: false, isBmp: false, functionType: FUNCTION_TYPES[0], remarks: '', division: '', adjustment: '' },
            filters: { ...initialFilters },
            editingRowId: null,
            isFilterVisible: true,
            sortConfig: { key: 'orgCode', direction: 'ascending' },
            analyticsState: {
                expandedName: null,
                successorOverlapFilter: [],
                incumbentOverlapFilter: [],
                isDivisionChartVisible: true,
                isAdjustmentChartVisible: true,
                isSuccessorOverlapVisible: true,
                isIncumbentOverlapVisible: true,
            },
        };

        // --- Icon SVGs ---
        const ICONS = {
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>`,
            userPlus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>`,
            upload: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>`,
            userX: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" x2="22" y1="8" y2="13"/><line x1="22" x2="17" y1="8" y2="13"/></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            circle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>`,
            save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            xCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>`,
            notebook: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M16 2v20"/></svg>`,
            alertTriangle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>`,
            chevronUp: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>`,
            barChart2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>`,
            arrowLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" x2="5" y1="12" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>`,
        };

        // --- Helper Functions ---
        const getStatus = (position) => {
            const successor1 = position.successors?.[0];
            if (!successor1 || !successor1.name || successor1.name === 'TBD') return 'red';
            if (successor1.readiness === '3-5年') return 'yellow';
            if (['1年內', '1-3年'].includes(successor1.readiness)) return 'green';
            return 'red';
        };

        const getPromotionStatus = (position, allPositions) => {
            const successor1 = position.successors?.[0];
            if (!successor1 || !successor1.name || successor1.name === 'TBD') return 'red';
            const successorAsIncumbentPos = allPositions.find(p => p.incumbent?.name === successor1.name && !p.incumbent?.isActing);
            if (!successorAsIncumbentPos) return 'red';
            const successorsSuccessor = successorAsIncumbentPos.successors?.[0];
            if (!successorsSuccessor || !successorsSuccessor.name || successorsSuccessor.name === 'TBD') return 'red';
            if (['1年內', '1-3年'].includes(successorsSuccessor.readiness)) return 'green';
            if (successorsSuccessor.readiness === '3-5年') return 'yellow';
            return 'red';
        };
        
        const getOverallStatus = (position, allPositions) => {
            const s1 = getStatus(position);
            const s2 = getPromotionStatus(position, allPositions);
            if (s1 === 'green' && s2 === 'green') return 'complete';
            if ((s1 === 'green' || s2 === 'green') || (s1 === 'yellow' && s2 === 'yellow')) return 'partial';
            return 'attention';
        };

        function parseCsvLine(line) {
            const values = [];
            let currentVal = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        currentVal += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(currentVal);
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            values.push(currentVal);
            return values;
        }

        // --- Data Manipulation Functions (Local State) ---

        const handleAddPosition = () => {
            const { newPosition } = state;
            if (!newPosition.orgCode.trim() || !newPosition.incumbent.trim()) return;
            
            const newPos = {
                id: `pos_${Date.now()}`,
                orgCode: newPosition.orgCode,
                level: newPosition.level,
                division: newPosition.division,
                adjustment: newPosition.adjustment,
                incumbent: {
                    name: newPosition.incumbent,
                    isActing: newPosition.isActing,
                    isBmp: newPosition.isBmp,
                    functionType: newPosition.functionType
                },
                successors: [],
                remarks: ''
            };

            state.positions.push(newPos);
            state.newPosition = { orgCode: '', level: POSITION_LEVELS[0], incumbent: '', isActing: false, isBmp: false, functionType: FUNCTION_TYPES[0], remarks: '', division: '', adjustment: '' };
            closePositionModal();
            render();
        };

        const handleUpdatePosition = (positionId, updatedData) => {
            const positionIndex = state.positions.findIndex(p => p.id === positionId);
            if (positionIndex > -1) {
                state.positions[positionIndex] = {
                    ...state.positions[positionIndex],
                    level: updatedData.level,
                    orgCode: updatedData.orgCode,
                    incumbent: {
                        ...state.positions[positionIndex].incumbent,
                        name: updatedData.incumbent.name,
                        isActing: updatedData.incumbent.isActing,
                    }
                };
            }
            state.editingRowId = null;
            render();
        };

        const handleDeletePosition = async (positionId) => {
            if (await customConfirm('您確定要刪除這個單位及其所有接班人資料嗎？此操作無法復原。')) {
                state.positions = state.positions.filter(p => p.id !== positionId);
                render();
            }
        };
        
        const handleClearAllData = async () => {
            if (await customConfirm('您確定要清除所有資料嗎？此操作將永久刪除所有單位與接班人資訊，且無法復原。')) {
                state.positions = [];
                render();
            }
        };

        const handleUpdateSuccessorReadiness = (positionId, successorId, newReadiness) => {
            const position = state.positions.find(p => p.id === positionId);
            if (position) {
                const successor = position.successors.find(s => s.id === successorId);
                if (successor) {
                    successor.readiness = newReadiness;
                }
            }
            render();
        };

        const handleSaveSuccessor = (successorData) => {
            const { currentPosition } = state;
            if (!currentPosition) return;

            const position = state.positions.find(p => p.id === currentPosition.id);
            if (!position) return;

            if (successorData.id) { // Editing existing
                const successorIndex = position.successors.findIndex(s => s.id === successorData.id);
                if (successorIndex > -1) {
                    position.successors[successorIndex] = successorData;
                }
            } else { // Adding new
                successorData.id = `succ_${Date.now()}`;
                position.successors.push(successorData);
            }
            closeSuccessorModal();
            render();
        };

        const handleReorderSuccessors = (positionId, reorderedSuccessors) => {
            const position = state.positions.find(p => p.id === positionId);
            if (position) {
                position.successors = reorderedSuccessors;
            }
            render();
        };

        const handleDeleteSuccessor = (positionId, successorId) => {
            const position = state.positions.find(p => p.id === positionId);
            if (position) {
                position.successors = position.successors.filter(s => s.id !== successorId);
            }
            render();
        };

        const handleSaveRemarks = (positionId, remarks) => {
            const position = state.positions.find(p => p.id === positionId);
            if (position) {
                position.remarks = remarks;
            }
            closeRemarksModal();
            render();
        };

        const handleImportData = (importedPositions) => {
            state.positions = importedPositions;
            closeImportModal();
            render();
        };

        const handleProcessImport = () => {
            const errorDiv = document.getElementById('import-error');
            const csvData = document.getElementById('csv-data').value;
            errorDiv.textContent = '';

            if (!csvData.trim()) {
                errorDiv.textContent = '請貼上或上傳 CSV 資料。';
                return;
            }

            const lines = csvData.trim().replace(/\r\n/g, '\n').split('\n');
            const headerLine = lines.shift();
            const header = parseCsvLine(headerLine).map(h => h.trim());
            const expectedHeader = ["廠處別", "調整", "組織代碼", "單位層級", "現任主管", "主管功能別", "是否兼任", "BMP", "第一人選姓名", "第一人選準備度", "第一人選主要優勢", "第一人選待發展區域", "第二人選姓名", "第二人選準備度", "第二人選主要優勢", "第二人選待發展區域", "備注"];

            // 建立欄位對應表，允許順序不同與多餘欄位
            const headerMap = {};
            let missingColumns = [];
            expectedHeader.forEach(col => {
                const idx = header.indexOf(col);
                if (idx === -1) {
                    missingColumns.push(col);
                } else {
                    headerMap[col] = idx;
                }
            });
            if (missingColumns.length > 0) {
                errorDiv.textContent = `CSV 缺少必要欄位：${missingColumns.join('、')}。請確認欄位名稱。`;
                return;
            }
            if (header.length > expectedHeader.length) {
                errorDiv.textContent = `警告：CSV 有多餘欄位，僅會匯入必要欄位。`;
                // 不 return，只顯示警告
            }

            const importedPositions = [];
            let lineNum = 1;
            for (const line of lines) {
                lineNum++;
                if (!line.trim()) continue;

                const values = parseCsvLine(line).map(v => v.trim());
                // 允許多餘欄位，只取必要欄位
                const get = (col) => values[headerMap[col]] ?? '';

                // 必要欄位檢查
                if (!get("組織代碼") || !get("現任主管") || !get("單位層級")) {
                    errorDiv.textContent = `第 ${lineNum} 行的組織代碼、現任主管或層級為空。`;
                    return;
                }
                if (!POSITION_LEVELS.includes(get("單位層級"))) {
                    errorDiv.textContent = `第 ${lineNum} 行的單位層級 '${get("單位層級")}' 無效。`;
                    return;
                }
                if (importedPositions.some(p => p.orgCode === get("組織代碼"))) {
                    errorDiv.textContent = `第 ${lineNum} 行的組織代碼 '${get("組織代碼")}' 重複。`;
                    return;
                }

                const successors = [];
                if (get("第一人選姓名")) {
                    successors.push({
                        id: `succ_${Date.now()}_${Math.random()}`,
                        name: get("第一人選姓名"),
                        readiness: READINESS_OPTIONS.includes(get("第一人選準備度")) ? get("第一人選準備度") : READINESS_OPTIONS[0],
                        strengths: get("第一人選主要優勢"),
                        developmentNeeds: get("第一人選待發展區域")
                    });
                }
                if (get("第二人選姓名")) {
                    successors.push({
                        id: `succ_${Date.now()}_${Math.random()}`,
                        name: get("第二人選姓名"),
                        readiness: READINESS_OPTIONS.includes(get("第二人選準備度")) ? get("第二人選準備度") : READINESS_OPTIONS[0],
                        strengths: get("第二人選主要優勢"),
                        developmentNeeds: get("第二人選待發展區域")
                    });
                }

                importedPositions.push({
                    id: `pos_${Date.now()}_${Math.random()}`,
                    division: get("廠處別"),
                    adjustment: get("調整"),
                    orgCode: get("組織代碼"),
                    level: get("單位層級"),
                    incumbent: {
                        name: get("現任主管"),
                        isActing: ['是', 'yes', 'true', '1'].includes((get("是否兼任") || '').toLowerCase()),
                        isBmp: ['是', 'yes', 'true', '1'].includes((get("BMP") || '').toLowerCase()),
                        functionType: FUNCTION_TYPES.includes(get("主管功能別")) ? get("主管功能別") : FUNCTION_TYPES[FUNCTION_TYPES.length - 1],
                    },
                    successors,
                    remarks: get("備注")
                });
            }
            handleImportData(importedPositions);
        };

        const handleExportData = () => {
            const sortedAndFilteredPositions = getSortedAndFilteredPositions();
            const headers = ["廠處別", "調整", "組織代碼", "單位層級", "現任主管", "主管功能別", "是否兼任", "BMP", "第一人選姓名", "第一人選準備度", "第一人選主要優勢", "第一人選待發展區域", "第二人選姓名", "第二人選準備度", "第二人選主要優勢", "第二人選待發展區域", "備注"];
            const rows = sortedAndFilteredPositions.map(p => {
                const suc1 = p.successors?.[0] || {};
                const suc2 = p.successors?.[1] || {};
                const escapeCSV = (str) => `"${(str || '').replace(/"/g, '""')}"`;
                return [
                    p.division || '', p.adjustment || '', p.orgCode, p.level, p.incumbent?.name, p.incumbent?.functionType || '', 
                    p.incumbent?.isActing ? '是' : '否', p.incumbent?.isBmp ? '是' : '否',
                    suc1.name || '', suc1.readiness || '', escapeCSV(suc1.strengths), escapeCSV(suc1.developmentNeeds),
                    suc2.name || '', suc2.readiness || '', escapeCSV(suc2.strengths), escapeCSV(suc2.developmentNeeds),
                    escapeCSV(p.remarks)
                ].join(',');
            });
            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [headers.join(','), ...rows].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "succession_plan_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- UI Control Functions ---
        const openPositionModal = () => { state.isPositionModalOpen = true; renderModals(); };
        const closePositionModal = () => { state.isPositionModalOpen = false; renderModals(); };
        const openSuccessorModal = (position, successor = null) => { state.currentPosition = position; state.successorToEdit = successor; state.isSuccessorModalOpen = true; renderModals(); };
        const closeSuccessorModal = () => { state.currentPosition = null; state.successorToEdit = null; state.isSuccessorModalOpen = false; renderModals(); };
        const openImportModal = () => { state.isImportModalOpen = true; renderModals(); };
        const closeImportModal = () => { state.isImportModalOpen = false; renderModals(); };
        const openRemarksModal = (position) => { state.remarksTarget = position; state.isRemarksModalOpen = true; renderModals(); };
        const closeRemarksModal = () => { state.remarksTarget = null; state.isRemarksModalOpen = false; renderModals(); };
        const openDetailsModal = (title, data, type = 'status') => { state.detailsModalData = { title, data, type }; renderModals(); };
        const closeDetailsModal = () => { state.detailsModalData = null; renderModals(); };
        
        const setPage = (pageName) => { state.page = pageName; render(); };
        
        const customConfirm = (message) => {
            return new Promise((resolve) => {
                const container = document.getElementById('confirm-container');
                const content = `
                    <div id="confirm-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex justify-center items-center p-4">
                        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-sm w-full font-sans">
                            <p class="text-gray-800 mb-4">${message}</p>
                            <div class="flex justify-end space-x-2">
                                <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">取消</button>
                                <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">確定</button>
                            </div>
                        </div>
                    </div>`;
                container.innerHTML = content;
                document.getElementById('confirm-ok').onclick = () => { container.innerHTML = ''; resolve(true); };
                document.getElementById('confirm-cancel').onclick = () => { container.innerHTML = ''; resolve(false); };
            });
        };

        // --- Data Computation (was useMemo) ---
        const getBmpMap = () => {
            return state.positions.reduce((map, p) => {
                if (p.incumbent?.name && p.incumbent.isBmp) {
                    map.set(p.incumbent.name, true);
                }
                return map;
            }, new Map());
        };

        const getSortedAndFilteredPositions = () => {
            let filteredData = state.positions.filter(p => {
                if (state.filters.personName) {
                    return p.incumbent?.name === state.filters.personName || p.successors?.some(s => s.name === state.filters.personName);
                }
                const levelMatch = state.filters.level.length === 0 || state.filters.level.includes(p.level);
                const orgCodeMatch = (p.orgCode || '').toLowerCase().includes(state.filters.orgCode.toLowerCase());
                const incumbentMatch = p.incumbent?.name?.toLowerCase().includes(state.filters.incumbent.toLowerCase()) ?? true;
                const divisionMatch = !state.filters.division || (p.division || '') === state.filters.division;
                const adjustmentMatch = !state.filters.adjustment || (p.adjustment || '') === state.filters.adjustment;
                const statusMatch = state.filters.status.length === 0 || state.filters.status.includes(getStatus(p));
                const promotionStatusMatch = state.filters.promotionStatus.length === 0 || state.filters.promotionStatus.includes(getPromotionStatus(p, state.positions));
                const actingMatch = state.filters.isActing === 'all' || (p.incumbent && ((state.filters.isActing === 'yes' && p.incumbent.isActing) || (state.filters.isActing === 'no' && !p.incumbent.isActing)));
                const bmpMatch = state.filters.isBmp === 'all' || (state.filters.isBmp === 'yes' && p.incumbent?.isBmp);

                return levelMatch && orgCodeMatch && incumbentMatch && statusMatch && promotionStatusMatch && actingMatch && divisionMatch && adjustmentMatch && bmpMatch;
            });

            if (state.sortConfig.key) {
                filteredData.sort((a, b) => {
                    let compareValue = 0;
                    switch (state.sortConfig.key) {
                        case 'status':
                            const scoreMap = { green: 1, yellow: 2, red: 3 };
                            const scoreA = (scoreMap[getStatus(a)] * 10) + scoreMap[getPromotionStatus(a, state.positions)];
                            const scoreB = (scoreMap[getStatus(b)] * 10) + scoreMap[getPromotionStatus(b, state.positions)];
                            compareValue = scoreA - scoreB;
                            break;
                        case 'level':
                            compareValue = POSITION_LEVELS.indexOf(a.level) - POSITION_LEVELS.indexOf(b.level);
                            break;
                        case 'orgCode':
                            compareValue = (a.orgCode || '').localeCompare(b.orgCode || '');
                            break;
                        case 'incumbent':
                            compareValue = (a.incumbent?.name || '').localeCompare(b.incumbent?.name || '', 'zh-Hant');
                            break;
                        case 'successor1':
                            compareValue = (a.successors?.[0]?.name || 'Ω').localeCompare(b.successors?.[0]?.name || 'Ω', 'zh-Hant');
                            break;
                        case 'successor2':
                            compareValue = (a.successors?.[1]?.name || 'Ω').localeCompare(b.successors?.[1]?.name || 'Ω', 'zh-Hant');
                            break;
                        default:
                            compareValue = 0;
                    }
                    return state.sortConfig.direction === 'ascending' ? compareValue : -compareValue;
                });
            }
            return filteredData;
        };
        
        // --- Event Handlers ---
        const handleAppClick = (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const { action, id, key, value, successorId, type, category, statusType } = actionTarget.dataset;
            
            switch(action) {
                case 'toggle-filter':
                    state.isFilterVisible = !state.isFilterVisible;
                    render();
                    break;
                case 'sort':
                    let direction = 'ascending';
                    if (state.sortConfig.key === key && state.sortConfig.direction === 'ascending') {
                        direction = 'descending';
                    }
                    state.sortConfig = { key, direction };
                    render();
                    break;
                case 'set-person-filter':
                    if (value) {
                        state.filters = { ...initialFilters, personName: value };
                        render();
                    }
                    break;
                case 'clear-person-filter':
                    state.filters = { ...initialFilters };
                    render();
                    break;
                case 'edit-position':
                    state.editingRowId = id;
                    render();
                    break;
                case 'cancel-edit':
                    state.editingRowId = null;
                    render();
                    break;
                case 'save-edit':
                    const form = actionTarget.closest('tr');
                    const editedData = {
                        level: form.querySelector(`[data-field="level"]`).value,
                        orgCode: form.querySelector(`[data-field="orgCode"]`).value,
                        incumbent: {
                            name: form.querySelector(`[data-field="incumbent.name"]`).value,
                            isActing: form.querySelector(`[data-field="incumbent.isActing"]`).checked,
                        }
                    };
                    handleUpdatePosition(id, editedData);
                    break;
                case 'delete-position':
                    handleDeletePosition(id);
                    break;
                case 'add-successor':
                    const posAdd = state.positions.find(p => p.id === id);
                    if (posAdd) openSuccessorModal(posAdd);
                    break;
                case 'edit-successor':
                    const posEdit = state.positions.find(p => p.id === id);
                    const succEdit = posEdit?.successors.find(s => s.id === successorId);
                    if (posEdit && succEdit) openSuccessorModal(posEdit, succEdit);
                    break;
                case 'delete-successor':
                    handleDeleteSuccessor(id, successorId);
                    break;
                case 'open-remarks':
                    const posRemarks = state.positions.find(p => p.id === id);
                    if (posRemarks) openRemarksModal(posRemarks);
                    break;
                 // Main action buttons
                case 'set-page':
                    setPage(value);
                    break;
                case 'export-data':
                    handleExportData();
                    break;
                case 'open-import-modal':
                    openImportModal();
                    break;
                case 'open-position-modal':
                    openPositionModal();
                    break;
                case 'clear-all-data':
                    handleClearAllData();
                    break;
                // Analytics actions
                case 'toggle-analytics-section':
                    state.analyticsState[key] = !state.analyticsState[key];
                    render();
                    break;
                case 'toggle-overlap-expand':
                    state.analyticsState.expandedName = state.analyticsState.expandedName === `${type}-${value}` ? null : `${type}-${value}`;
                    render();
                    break;
                case 'open-details-modal':
                    const analyticsData = getAnalyticsData();
                    let positionsToShow = [];
                    let title = '';
                    if (type === 'status') {
                        const categoryData = analyticsData.levelAnalysisData.find(d => d.category === category) || analyticsData.divisionAnalysisData.find(d => d.category === category);
                        if (categoryData) {
                            positionsToShow = categoryData.positions.filter(p => getOverallStatus(p, state.positions) === statusType);
                            title = `${category} - ${OVERALL_STATUS_TYPES[statusType]}`;
                        }
                    } else if (type === 'adjustment') {
                        const categoryData = analyticsData.adjustmentAnalysisData.data.find(d => d.category === category);
                        if (categoryData) {
                           positionsToShow = categoryData.positions;
                           title = category;
                        }
                    }
                    openDetailsModal(title, positionsToShow, type);
                    break;
            }
        };

        const handleAppChange = (e) => {
            const changeTarget = e.target.closest('[data-change]');
            if (!changeTarget) return;

            const { change, key, id, successorId } = changeTarget.dataset;
            const value = changeTarget.type === 'checkbox' ? changeTarget.checked : changeTarget.value;

            switch(change) {
                case 'filter':
                    state.filters.personName = '';
                    state.filters[key] = value;
                    render();
                    break;
                case 'multi-filter':
                    const newSet = new Set(state.filters[key]);
                    if (changeTarget.checked) {
                        newSet.add(changeTarget.dataset.value);
                    } else {
                        newSet.delete(changeTarget.dataset.value);
                    }
                    state.filters.personName = '';
                    state.filters[key] = Array.from(newSet);
                    render();
                    break;
                case 'new-position-field':
                    state.newPosition[key] = value;
                    break;
                case 'update-readiness':
                    handleUpdateSuccessorReadiness(id, successorId, value);
                    break;
                case 'analytics-level-filter':
                    const filterKey = changeTarget.dataset.key;
                    const levelValue = changeTarget.dataset.value;
                    const newFilterSet = new Set(state.analyticsState[filterKey]);
                    if (changeTarget.checked) {
                        newFilterSet.add(levelValue);
                    } else {
                        newFilterSet.delete(levelValue);
                    }
                    state.analyticsState[filterKey] = Array.from(newFilterSet);
                    render();
                    break;
            }
        };
        
        let draggedSuccessorInfo = null;

        const handleDragAndDrop = (e) => {
            const target = e.target;
            const dragTarget = target.closest('[data-drag-id]');

            switch(e.type) {
                case 'dragstart':
                    if (dragTarget) {
                        draggedSuccessorInfo = {
                            positionId: dragTarget.dataset.positionId,
                            successorId: dragTarget.dataset.dragId,
                        };
                        e.dataTransfer.effectAllowed = 'move';
                        // Add dragging class after a short delay to allow the browser to capture the drag image
                        setTimeout(() => dragTarget.classList.add('dragging'), 0);
                    }
                    break;
                case 'dragover':
                    e.preventDefault(); // Necessary to allow drop
                    break;
                case 'drop':
                    e.preventDefault();
                    const dropTarget = target.closest('[data-drag-id]');
                    if (dropTarget && draggedSuccessorInfo && draggedSuccessorInfo.positionId === dropTarget.dataset.positionId && draggedSuccessorInfo.successorId !== dropTarget.dataset.dragId) {
                        const position = state.positions.find(p => p.id === draggedSuccessorInfo.positionId);
                        if (position) {
                            const successors = [...(position.successors || [])];
                            const draggedIndex = successors.findIndex(s => s.id === draggedSuccessorInfo.successorId);
                            const targetIndex = successors.findIndex(s => s.id === dropTarget.dataset.dragId);

                            if (draggedIndex !== -1 && targetIndex !== -1) {
                                [successors[draggedIndex], successors[targetIndex]] = [successors[targetIndex], successors[draggedIndex]];
                                handleReorderSuccessors(position.id, successors);
                            }
                        }
                    }
                    // Clean up dragging styles from all elements
                    document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                    draggedSuccessorInfo = null;
                    break;
                case 'dragend':
                     document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                     draggedSuccessorInfo = null;
                    break;
            }
        };

        // --- Render Functions ---

        function renderIcon(name, size = 20) {
            return (ICONS[name] || '').replace('width="24"', `width="${size}"`).replace('height="24"', `height="${size}"`);
        }

        function renderStatusLight(status) {
            const colorMap = { green: 'text-green-500', yellow: 'text-yellow-500', red: 'text-red-500' };
            const circleIcon = ICONS.circle.replace('<svg ', '<svg fill="currentColor" ');
            return `<div class="h-5 w-5 ${colorMap[status]}">${circleIcon}</div>`;
        }


        function renderFilterBar() {
            if (!state.isFilterVisible) return '';

            const uniqueDivisions = Array.from(new Set(state.positions.map(p => p.division).filter(Boolean))).sort();
            const uniqueAdjustments = Array.from(new Set(state.positions.map(p => p.adjustment).filter(Boolean))).sort();

            return `
                <div class="p-4 border-t border-slate-200 space-y-4">
                    ${state.filters.personName ? `
                        <div class="p-3 bg-[#e0e7e8] rounded-lg flex justify-between items-center">
                            <p class="text-sm font-medium text-[#385159]">正在搜尋人員: <span class="font-bold">${state.filters.personName}</span></p>
                            <button data-action="clear-person-filter" class="text-[#385159] hover:text-opacity-80">${renderIcon('xCircle', 20)}</button>
                        </div>
                    ` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="orgCodeSearch" class="block text-sm font-medium text-[#998E81]">搜尋組織代碼</label>
                            <input type="text" id="orgCodeSearch" class="mt-1 form-input w-full" placeholder="輸入代碼..." value="${state.filters.orgCode}" data-change="filter" data-key="orgCode">
                        </div>
                        <div>
                            <label for="incumbentSearch" class="block text-sm font-medium text-[#998E81]">搜尋現任主管</label>
                            <input type="text" id="incumbentSearch" class="mt-1 form-input w-full" placeholder="輸入姓名..." value="${state.filters.incumbent}" data-change="filter" data-key="incumbent">
                        </div>
                        <div>
                            <label for="divisionSearch" class="block text-sm font-medium text-[#998E81]">篩選廠處別</label>
                            <select id="divisionSearch" class="mt-1 form-select w-full" data-change="filter" data-key="division">
                                <option value="">全部廠處</option>
                                ${uniqueDivisions.map(d => `<option value="${d}" ${state.filters.division === d ? 'selected' : ''}>${d}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="adjustmentSearch" class="block text-sm font-medium text-[#998E81]">篩選調整</label>
                            <select id="adjustmentSearch" class="mt-1 form-select w-full" data-change="filter" data-key="adjustment">
                                <option value="">全部調整</option>
                                ${uniqueAdjustments.map(a => `<option value="${a}" ${state.filters.adjustment === a ? 'selected' : ''}>${a}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 pt-4">
                        <div>
                            <label class="block text-sm font-medium text-[#998E81] mb-2">篩選單位層級</label>
                            <div class="flex flex-col space-y-2">
                                ${POSITION_LEVELS.map(level => `
                                    <div class="flex items-center">
                                        <input id="level-${level}" type="checkbox" ${state.filters.level.includes(level) ? 'checked' : ''} data-change="multi-filter" data-key="level" data-value="${level}" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF] rounded">
                                        <label for="level-${level}" class="ml-2 text-sm text-[#385159]">${level}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#998E81] mb-2">篩選兼任狀態</label>
                            <div class="flex flex-col space-y-2">
                                <div class="flex items-center">
                                    <input id="acting-all" type="radio" name="acting-filter" value="all" ${state.filters.isActing === 'all' ? 'checked' : ''} data-change="filter" data-key="isActing" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF]">
                                    <label for="acting-all" class="ml-2 text-sm text-[#385159]">全部</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="acting-yes" type="radio" name="acting-filter" value="yes" ${state.filters.isActing === 'yes' ? 'checked' : ''} data-change="filter" data-key="isActing" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF]">
                                    <label for="acting-yes" class="ml-2 text-sm text-[#385159]">是</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="acting-no" type="radio" name="acting-filter" value="no" ${state.filters.isActing === 'no' ? 'checked' : ''} data-change="filter" data-key="isActing" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF]">
                                    <label for="acting-no" class="ml-2 text-sm text-[#385159]">否</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#998E81] mb-2">篩選BMP</label>
                            <div class="flex flex-col space-y-2">
                                <div class="flex items-center">
                                    <input id="bmp-all" type="radio" name="bmp-filter" value="all" ${state.filters.isBmp === 'all' ? 'checked' : ''} data-change="filter" data-key="isBmp" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF]">
                                    <label for="bmp-all" class="ml-2 text-sm text-[#385159]">全部</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="bmp-yes" type="radio" name="bmp-filter" value="yes" ${state.filters.isBmp === 'yes' ? 'checked' : ''} data-change="filter" data-key="isBmp" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF]">
                                    <label for="bmp-yes" class="ml-2 text-sm text-[#385159]">是</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#998E81] mb-2">篩選接班人狀態</label>
                            <div class="flex flex-col space-y-2">
                                ${Object.entries(STATUS_OPTIONS).map(([key, value]) => `
                                    <div class="flex items-center">
                                        <input id="status-${key}" type="checkbox" ${state.filters.status.includes(key) ? 'checked' : ''} data-change="multi-filter" data-key="status" data-value="${key}" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF] rounded">
                                        <label for="status-${key}" class="ml-2 text-sm text-[#385159] flex items-center">${renderStatusLight(key)} <span class="ml-1.5">${value}</span></label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#998E81] mb-2">篩選後繼狀態</label>
                            <div class="flex flex-col space-y-2">
                                ${Object.entries(STATUS_OPTIONS).map(([key, value]) => `
                                    <div class="flex items-center">
                                        <input id="promo-status-${key}" type="checkbox" ${state.filters.promotionStatus.includes(key) ? 'checked' : ''} data-change="multi-filter" data-key="promotionStatus" data-value="${key}" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF] rounded">
                                        <label for="promo-status-${key}" class="ml-2 text-sm text-[#385159] flex items-center">${renderStatusLight(key)} <span class="ml-1.5">${value}</span></label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSortableHeader(label, columnKey) {
            const { sortConfig } = state;
            const isSorted = sortConfig.key === columnKey;
            const directionIcon = isSorted ? (sortConfig.direction === 'ascending' ? renderIcon('chevronUp', 14) : renderIcon('chevronDown', 14)) : '';
            return `
                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-[#998E81] uppercase tracking-wider">
                    <button data-action="sort" data-key="${columnKey}" class="flex items-center space-x-1 group">
                        <span>${label}</span>
                        <span class="opacity-60 group-hover:opacity-100">${directionIcon}</span>
                    </button>
                </th>
            `;
        }
        
        function renderSuccessorCell(position, successorIndex) {
            const successor = position.successors?.[successorIndex];
            const bmpMap = getBmpMap();
            
            if (!successor) {
                const canAdd = (position.successors || []).length < 2;
                return canAdd 
                    ? `<button data-action="add-successor" data-id="${position.id}" class="text-sm text-[#385159] hover:text-opacity-80 hover:underline">新增人選 (TBD)</button>`
                    : `<div class="text-sm text-slate-400">TBD</div>`;
            }

            const readinessColors = { "1年內": "bg-green-100 text-green-800", "1-3年": "bg-yellow-100 text-yellow-800", "3-5年": "bg-red-100 text-red-800" };
            return `
                <div class="group flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button data-action="set-person-filter" data-value="${successor.name}" class="text-sm font-medium text-[#385159] hover:text-opacity-80 hover:underline text-left">
                            ${successor.name}
                            ${bmpMap.has(successor.name) ? '<span class="text-xs font-bold text-blue-600 ml-1">(BMP)</span>' : ''}
                        </button>
                        <div class="relative">
                            <select
                                data-change="update-readiness"
                                data-id="${position.id}"
                                data-successor-id="${successor.id}"
                                class="appearance-none cursor-pointer px-2 py-0.5 text-xs leading-5 font-semibold rounded-full ${readinessColors[successor.readiness]} focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#385159]"
                            >
                                ${READINESS_OPTIONS.map(opt => `<option value="${opt}" ${successor.readiness === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity flex flex-col space-y-1 pl-2">
                        <button data-action="edit-successor" data-id="${position.id}" data-successor-id="${successor.id}" class="text-slate-500 hover:text-[#385159]" title="編輯人選詳細資料">${renderIcon('edit', 16)}</button>
                        <button data-action="delete-successor" data-id="${position.id}" data-successor-id="${successor.id}" class="text-slate-500 hover:text-red-600" title="移除人選">${renderIcon('userX', 16)}</button>
                    </div>
                </div>
            `;
        }

        function renderTableRow(position) {
            const { editingRowId } = state;
            const isEditing = editingRowId === position.id;
            
            const successor1 = position.successors?.[0];
            const successor2 = position.successors?.[1];

            return `
                <tr class="hover:bg-[#F2F2EC]" data-id="${position.id}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2" title="接班人狀態: ${STATUS_OPTIONS[getStatus(position)]}, 後繼狀態: ${STATUS_OPTIONS[getPromotionStatus(position, state.positions)]}">
                            ${renderStatusLight(getStatus(position))}
                            ${renderStatusLight(getPromotionStatus(position, state.positions))}
                        </div>
                    </td>
                    ${isEditing ? `
                        <td class="px-6 py-4">
                            <select data-field="level" class="form-input w-full">
                                ${POSITION_LEVELS.map(l => `<option value="${l}" ${position.level === l ? 'selected' : ''}>${l}</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-6 py-4"><input data-field="orgCode" value="${position.orgCode}" class="form-input w-full" /></td>
                        <td class="px-6 py-4">
                            <input data-field="incumbent.name" value="${position.incumbent?.name || ''}" class="form-input w-full mb-1" />
                            <div class="flex items-center my-1">
                                <input type="checkbox" data-field="incumbent.isActing" ${position.incumbent?.isActing ? 'checked' : ''} class="h-4 w-4 text-[#385159] focus:ring-[#385159]" />
                                <span class="ml-2 text-xs">兼任</span>
                            </div>
                        </td>
                    ` : `
                        <td class="px-6 py-4 whitespace-nowrap"><span class="inline-block bg-[#e0e7e8] text-[#385159] text-xs font-semibold px-2.5 py-0.5 rounded-full">${position.level}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-semibold text-[#385159] font-mono">${position.orgCode}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button data-action="set-person-filter" data-value="${position.incumbent?.name}" class="text-sm font-semibold text-[#385159] hover:underline text-left">
                                ${position.incumbent?.name}
                            </button>
                            ${position.incumbent?.isActing ? '<span class="text-xs font-semibold text-red-600 ml-2">(兼任)</span>' : ''}
                            ${position.incumbent?.isBmp ? '<span class="text-xs font-bold text-blue-600 ml-1">(BMP)</span>' : ''}
                        </td>
                    `}
                    <td class="px-6 py-4 whitespace-nowrap" draggable="${!!successor1}" data-drag-id="${successor1?.id}" data-position-id="${position.id}">
                        ${renderSuccessorCell(position, 0)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap" draggable="${!!successor2}" data-drag-id="${successor2?.id}" data-position-id="${position.id}">
                        ${renderSuccessorCell(position, 1)}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button data-action="open-remarks" data-id="${position.id}" class="text-slate-400 hover:text-[#385159]">${renderIcon('notebook', 20)}</button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-2">
                            ${isEditing ? `
                                <button data-action="save-edit" data-id="${position.id}" class="text-green-600 hover:text-green-900" title="儲存">${renderIcon('save', 20)}</button>
                                <button data-action="cancel-edit" class="text-slate-600 hover:text-slate-900" title="取消">${renderIcon('xCircle', 20)}</button>
                            ` : `
                                <button data-action="edit-position" data-id="${position.id}" class="text-blue-600 hover:text-blue-900" title="編輯單位">${renderIcon('edit', 20)}</button>
                                ${ (position.successors || []).length < 2 ? `<button data-action="add-successor" data-id="${position.id}" class="text-[#385159] hover:text-opacity-80" title="新增人選">${renderIcon('userPlus', 20)}</button>` : '' }
                                <button data-action="delete-position" data-id="${position.id}" class="text-red-600 hover:text-red-900" title="刪除單位">${renderIcon('trash', 20)}</button>
                            `}
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderMainPage() {
            const sortedAndFilteredPositions = getSortedAndFilteredPositions();
            const actionButtonClasses = "flex items-center justify-center bg-[#385159] text-white px-3 py-1.5 rounded-md shadow-sm hover:bg-opacity-90 transition-all duration-150 text-xs font-medium";

            return `
                <div class="fixed top-4 right-4 z-50 flex items-center space-x-2">
                    <button data-action="set-page" data-value="analytics" class="${actionButtonClasses}">${renderIcon('barChart2', 16)} <span class="ml-1.5">統計分析</span></button>
                    <button data-action="export-data" class="${actionButtonClasses}">${renderIcon('download', 16)} <span class="ml-1.5">匯出資料</span></button>
                    <button data-action="open-import-modal" class="${actionButtonClasses}">${renderIcon('upload', 16)} <span class="ml-1.5">匯入資料</span></button>
                    <button data-action="open-position-modal" class="${actionButtonClasses}">${renderIcon('plus', 16)} <span class="ml-1.5">新增單位</span></button>
                    <button data-action="clear-all-data" class="${actionButtonClasses} bg-red-600 hover:bg-red-700">${renderIcon('alertTriangle', 16)} <span class="ml-1.5">清除全部</span></button>
                </div>
                
                <header class="bg-white shadow-sm sticky top-0 z-20">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center flex-wrap">
                        <div class="mb-2 sm:mb-0">
                            <h1 class="text-2xl font-bold text-[#385159]">組織接班人計畫</h1>
                            <p class="text-sm text-[#998E81]">檢視與管理關鍵單位的未來領導者</p>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-lg shadow-sm">
                        <button data-action="toggle-filter" class="w-full p-4 flex justify-between items-center text-left text-lg font-medium text-[#385159] bg-[#F2F2EC] rounded-t-lg hover:bg-[#e9ecef]">
                            <span>搜尋與篩選</span>
                            ${state.isFilterVisible ? renderIcon('chevronUp', 24) : renderIcon('chevronDown', 24)}
                        </button>
                        ${renderFilterBar()}
                    </div>

                    <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-[#A9BDBF]">
                                <thead class="bg-[#F2F2EC]">
                                    <tr>
                                        ${renderSortableHeader('狀態', 'status')}
                                        ${renderSortableHeader('單位層級', 'level')}
                                        ${renderSortableHeader('組織代碼', 'orgCode')}
                                        ${renderSortableHeader('現任主管', 'incumbent')}
                                        ${renderSortableHeader('第一人選', 'successor1')}
                                        ${renderSortableHeader('第二人選', 'successor2')}
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-[#998E81] uppercase tracking-wider">備註</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-[#998E81] uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-[#e9ecef]">
                                    ${sortedAndFilteredPositions.length > 0
                                        ? sortedAndFilteredPositions.map(renderTableRow).join('')
                                        : `<tr><td colSpan="8" class="px-6 py-12 text-center text-sm text-[#998E81]">無資料。請點擊右上角的 "匯入資料" 來開始。</td></tr>`
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="px-6 py-4 border-t border-[#A9BDBF] text-sm text-[#998E81] text-right">
                            顯示 ${sortedAndFilteredPositions.length} 筆資料 (共 ${state.positions.length} 筆)
                        </div>
                    </div>
                </main>
            `;
        }
        
        // --- Analytics Page ---
        function getAnalyticsData() {
            const positions = getSortedAndFilteredPositions();
            const allPositions = state.positions;

            const levelAnalysisData = POSITION_LEVELS.map(level => {
                const levelPositions = positions.filter(p => p.level === level);
                if (levelPositions.length === 0) return null;
                const stats = levelPositions.reduce((acc, pos) => {
                    acc[getOverallStatus(pos, allPositions)]++;
                    return acc;
                }, { complete: 0, partial: 0, attention: 0 });
                return { category: level, stats, positions: levelPositions, total: levelPositions.length };
            }).filter(Boolean);

            const divisionGrouped = positions.reduce((acc, pos) => {
                const key = pos.division || '未分類';
                if (!acc[key]) acc[key] = [];
                acc[key].push(pos);
                return acc;
            }, {});
            
            const divisionAnalysisData = Object.entries(divisionGrouped).map(([category, pos]) => {
                const stats = pos.reduce((acc, p) => { acc[getOverallStatus(p, allPositions)]++; return acc; }, { complete: 0, partial: 0, attention: 0 });
                const total = pos.length;
                return { category, stats, positions: pos, total, attentionPct: total > 0 ? (stats.attention / total) * 100 : 0, partialPct: total > 0 ? (stats.partial / total) * 100 : 0 }
            }).sort((a, b) => b.attentionPct - a.attentionPct || b.partialPct - a.partialPct);

            const adjustmentGrouped = positions.reduce((acc, pos) => {
                if (pos.adjustment) {
                    if (!acc[pos.adjustment]) acc[pos.adjustment] = [];
                    acc[pos.adjustment].push(pos);
                }
                return acc;
            }, {});
            const adjustmentData = Object.entries(adjustmentGrouped).map(([category, pos]) => ({
                category, positions: pos, total: pos.length,
            })).sort((a,b) => b.total - a.total);
            const totalWithAdjustments = adjustmentData.reduce((sum, item) => sum + item.total, 0);
            const adjustmentAnalysisData = { data: adjustmentData, total: totalWithAdjustments };

            const personPrimaryRoleLevelMap = allPositions.reduce((map, p) => {
                if (p.incumbent?.name && !p.incumbent?.isActing) {
                    map.set(p.incumbent.name, p.level);
                }
                return map;
            }, new Map());

            const successorCounts = allPositions.flatMap(p => p.successors || []).filter(s => s && s.name && s.name !== 'TBD')
                .reduce((acc, s) => { acc[s.name] = (acc[s.name] || 0) + 1; return acc; }, {});
            
            let successorOverlapData = Object.keys(successorCounts).filter(name => successorCounts[name] > 1).map(name => ({
                name,
                count: successorCounts[name],
                assignments: allPositions.filter(p => p.successors?.some(s => s.name === name)).map(p => ({ orgCode: p.orgCode, level: p.level })),
                level: personPrimaryRoleLevelMap.get(name) || null
            }));
            if (state.analyticsState.successorOverlapFilter.length > 0) {
                successorOverlapData = successorOverlapData.filter(p => p.level && state.analyticsState.successorOverlapFilter.includes(p.level));
            }
            successorOverlapData.sort((a, b) => b.count - a.count);

            const incumbentCounts = allPositions.reduce((acc, p) => {
                if(p.incumbent?.name) acc[p.incumbent.name] = (acc[p.incumbent.name] || 0) + 1;
                return acc;
            }, {});
            let incumbentOverlapData = Object.keys(incumbentCounts).filter(name => incumbentCounts[name] > 2).map(name => {
                let personAssignments = allPositions.filter(p => p.incumbent?.name === name)
                    .map(p => ({ orgCode: p.orgCode, level: p.level, isActing: p.incumbent?.isActing }))
                    .sort((a, b) => {
                        if (!a.isActing && b.isActing) return -1;
                        if (a.isActing && !b.isActing) return 1;
                        return POSITION_LEVELS.indexOf(a.level) - POSITION_LEVELS.indexOf(b.level);
                    });
                return { name, count: incumbentCounts[name], assignments: personAssignments, level: personPrimaryRoleLevelMap.get(name) || null };
            });
             if (state.analyticsState.incumbentOverlapFilter.length > 0) {
                incumbentOverlapData = incumbentOverlapData.filter(p => p.level && state.analyticsState.incumbentOverlapFilter.includes(p.level));
            }
            incumbentOverlapData.sort((a, b) => b.count - a.count);

            return { levelAnalysisData, divisionAnalysisData, adjustmentAnalysisData, successorOverlapData, incumbentOverlapData };
        }

        function renderStackedBarChart(data) {
             if (!data || data.length === 0) return `<p class="text-center text-sm text-slate-400 py-8">無資料可供分析</p>`;
             return `
                <div class="space-y-4">
                ${data.map(({ category, stats, total }) => {
                    const completePct = total > 0 ? (stats.complete / total) * 100 : 0;
                    const partialPct = total > 0 ? (stats.partial / total) * 100 : 0;
                    const attentionPct = total > 0 ? (stats.attention / total) * 100 : 0;
                    return `
                        <div key="${category}">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-[#385159]">${category}</span>
                                <span class="text-sm font-semibold text-[#998E81]">${total} 人</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-6 flex overflow-hidden">
                                <button data-action="open-details-modal" data-type="status" data-category="${category}" data-status-type="complete" class="h-full bg-green-500 hover:bg-green-600 transition-colors flex justify-center items-center" style="width: ${completePct}%" title="完整: ${Math.round(completePct)}%">
                                    <span class="text-white text-xs font-bold">${completePct > 10 ? `${Math.round(completePct)}%` : ''}</span>
                                </button>
                                <button data-action="open-details-modal" data-type="status" data-category="${category}" data-status-type="partial" class="h-full bg-yellow-500 hover:bg-yellow-600 transition-colors flex justify-center items-center" style="width: ${partialPct}%" title="部分: ${Math.round(partialPct)}%">
                                    <span class="text-white text-xs font-bold">${partialPct > 10 ? `${Math.round(partialPct)}%` : ''}</span>
                                </button>
                                <button data-action="open-details-modal" data-type="status" data-category="${category}" data-status-type="attention" class="h-full bg-red-500 hover:bg-red-600 transition-colors flex justify-center items-center" style="width: ${attentionPct}%" title="注意: ${Math.round(attentionPct)}%">
                                    <span class="text-white text-xs font-bold">${attentionPct > 10 ? `${Math.round(attentionPct)}%` : ''}</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
                </div>
             `;
        }

        function renderVerticalBarChart({ data, total }) {
            if (data.length === 0) return `<p class="text-center text-sm text-slate-400 py-8">無資料可供分析</p>`;
            const maxTotal = Math.max(...data.map(d => d.total), 1);
            return `
                <div class="space-y-4">
                ${data.map(({ category, total: itemTotal }) => {
                    const percentage = total > 0 ? ((itemTotal / total) * 100).toFixed(1) : 0;
                    const displayName = category === '上級兼任' ? '上兼下' : category;
                    return `
                        <div key="${category}" class="grid grid-cols-4 items-center gap-2">
                            <span class="col-span-1 text-sm font-medium text-[#385159] text-right pr-2">${displayName}</span>
                            <div class="col-span-3">
                                <button data-action="open-details-modal" data-type="adjustment" data-category="${category}" class="w-full h-8 bg-[#A9BDBF] hover:bg-[#998E81] transition-all duration-200 rounded flex items-center group" style="width: ${ (itemTotal / maxTotal) * 100}%">
                                    <span class="pl-3 text-white font-bold text-sm">${itemTotal} (${percentage}%)</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
                </div>
            `;
        }

        function renderOverlapList(data, type) {
            const { expandedName } = state.analyticsState;
            if (data.length === 0) return `<p class="text-center text-sm text-slate-400 py-8">無符合條件的資料</p>`;
            return `
                <ul class="space-y-2 max-h-[400px] overflow-y-auto">
                ${data.map(({ name, count, assignments, level }) => `
                    <li key="${name}">
                        <button data-action="toggle-overlap-expand" data-type="${type}" data-value="${name}" class="w-full flex justify-between items-center bg-slate-50 p-2 rounded-md text-left">
                            <div class="flex items-center">
                                <span class="font-medium text-[#385159]">${name}</span>
                                ${level ? `<span class="ml-2 inline-block bg-[#e0e7e8] text-[#385159] text-xs font-semibold px-2 py-0.5 rounded-full">${level}</span>` : ''}
                            </div>
                            <span class="text-sm font-semibold ${type === 'succ' ? 'text-red-600 bg-red-100' : 'text-blue-600 bg-blue-100'} px-2 py-0.5 rounded-full">${count} 次</span>
                        </button>
                        ${expandedName === `${type}-${name}` ? `
                            <div class="p-2 mt-1 ${type === 'succ' ? 'bg-blue-50 border-l-2 border-blue-500' : 'bg-green-50 border-l-2 border-green-500'}">
                                <ul class="text-xs space-y-1">
                                    ${assignments.map(a => `<li key="${a.orgCode}">${a.level} - ${a.orgCode} ${a.isActing ? '<span class="text-red-600 font-bold">(兼任)</span>' : ''}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </li>
                `).join('')}
                </ul>
            `;
        }

        function renderAnalyticsPage() {
            const analyticsData = getAnalyticsData();
            const { analyticsState } = state;
            return `
                <header class="bg-white shadow-sm sticky top-0 z-20">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center flex-wrap">
                        <div class="flex items-center">
                            <button data-action="set-page" data-value="main" class="mr-4 text-[#385159] hover:text-opacity-80">${renderIcon('arrowLeft', 24)}</button>
                            <div>
                                <h1 class="text-2xl font-bold text-[#385159]">統計分析儀表板</h1>
                                <p class="text-sm text-[#998E81]">從數據洞察人才佈局的機會與風險</p>
                            </div>
                        </div>
                    </div>
                </header>
                <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white shadow-md rounded-lg p-4">
                                <h2 class="text-lg font-medium text-[#385159]">接班狀態分析（依層級）</h2>
                                <div class="mt-4">${renderStackedBarChart(analyticsData.levelAnalysisData)}</div>
                            </div>
                            <div class="bg-white shadow-md rounded-lg">
                                <button data-action="toggle-analytics-section" data-key="isDivisionChartVisible" class="w-full p-4 flex justify-between items-center text-left text-lg font-medium text-[#385159] hover:bg-[#F2F2EC]">
                                    <span>接班狀態分析（依單位）</span>
                                    ${analyticsState.isDivisionChartVisible ? renderIcon('chevronUp', 24) : renderIcon('chevronDown', 24)}
                                </button>
                                ${analyticsState.isDivisionChartVisible ? `<div class="p-4 border-t border-slate-200">${renderStackedBarChart(analyticsData.divisionAnalysisData)}</div>` : ''}
                            </div>
                             <div class="bg-white shadow-md rounded-lg">
                                <button data-action="toggle-analytics-section" data-key="isAdjustmentChartVisible" class="w-full p-4 flex justify-between items-center text-left text-lg font-medium text-[#385159] hover:bg-[#F2F2EC]">
                                    <span>職位遞補方式統計</span>
                                    ${analyticsState.isAdjustmentChartVisible ? renderIcon('chevronUp', 24) : renderIcon('chevronDown', 24)}
                                </button>
                                ${analyticsState.isAdjustmentChartVisible ? `<div class="p-4 border-t border-slate-200">${renderVerticalBarChart(analyticsData.adjustmentAnalysisData)}</div>` : ''}
                            </div>
                        </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white shadow-md rounded-lg">
                                <button data-action="toggle-analytics-section" data-key="isSuccessorOverlapVisible" class="w-full p-4 flex justify-between items-center text-left text-lg font-medium text-[#385159] hover:bg-[#F2F2EC]">
                                    <span>接班人選重複提報清單</span>
                                    ${analyticsState.isSuccessorOverlapVisible ? renderIcon('chevronUp', 24) : renderIcon('chevronDown', 24)}
                                </button>
                                ${analyticsState.isSuccessorOverlapVisible ? `
                                    <div class="p-4 border-t border-slate-200">
                                        <p class="text-xs text-slate-500 mb-2">列出被提名超過1次的人選 (TBD除外)。篩選條件為該人選的**主要(非兼任)層級**。</p>
                                        <div class="flex flex-wrap gap-x-4 gap-y-2 mb-4">
                                            ${POSITION_LEVELS.map(level => `
                                                <div class="flex items-center">
                                                    <input id="succ-level-${level}" type="checkbox" ${analyticsState.successorOverlapFilter.includes(level) ? 'checked' : ''} data-change="analytics-level-filter" data-key="successorOverlapFilter" data-value="${level}" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF] rounded" />
                                                    <label for="succ-level-${level}" class="ml-2 text-sm text-[#385159]">${level}</label>
                                                </div>
                                            `).join('')}
                                        </div>
                                        ${renderOverlapList(analyticsData.successorOverlapData, 'succ')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="bg-white shadow-md rounded-lg">
                                <button data-action="toggle-analytics-section" data-key="isIncumbentOverlapVisible" class="w-full p-4 flex justify-between items-center text-left text-lg font-medium text-[#385159] hover:bg-[#F2F2EC]">
                                    <span>主管兼任清單</span>
                                    ${analyticsState.isIncumbentOverlapVisible ? renderIcon('chevronUp', 24) : renderIcon('chevronDown', 24)}
                                </button>
                                ${analyticsState.isIncumbentOverlapVisible ? `
                                    <div class="p-4 border-t border-slate-200">
                                        <p class="text-xs text-slate-500 mb-2">列出擔任超過2個單位主管的人員。篩選條件為該人選的**主要(非兼任)層級**。</p>
                                        <div class="flex flex-wrap gap-x-4 gap-y-2 mb-4">
                                            ${POSITION_LEVELS.map(level => `
                                                <div class="flex items-center">
                                                    <input id="inc-level-${level}" type="checkbox" ${analyticsState.incumbentOverlapFilter.includes(level) ? 'checked' : ''} data-change="analytics-level-filter" data-key="incumbentOverlapFilter" data-value="${level}" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF] rounded" />
                                                    <label for="inc-level-${level}" class="ml-2 text-sm text-[#385159]">${level}</label>
                                                </div>
                                            `).join('')}
                                        </div>
                                        ${renderOverlapList(analyticsData.incumbentOverlapData, 'inc')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </main>
            `;
        }


        // --- Modals Rendering ---
        function renderModals() {
            const modalContainer = document.getElementById('modal-container');
            let modalHTML = '';

            if (state.isPositionModalOpen) {
                modalHTML = renderPositionFormModal();
            } else if (state.isSuccessorModalOpen) {
                modalHTML = renderSuccessorFormModal();
            } else if (state.isImportModalOpen) {
                modalHTML = renderImportModal();
            } else if (state.isRemarksModalOpen) {
                modalHTML = renderRemarksModal();
            } else if (state.detailsModalData) {
                modalHTML = renderDetailsModal();
            }
            
            modalContainer.innerHTML = modalHTML;
            
            // Add event listeners for the newly rendered modal
            if (modalContainer.firstChild) {
                modalContainer.querySelector('[data-modal-form]')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const action = e.target.dataset.modalForm;
                    if (action === 'add-position') handleAddPosition();
                    if (action === 'save-successor') {
                        const formData = new FormData(e.target);
                        const successorData = Object.fromEntries(formData.entries());
                        if (state.successorToEdit?.id) successorData.id = state.successorToEdit.id;
                        handleSaveSuccessor(successorData);
                    }
                });
                modalContainer.querySelector('[data-action="import-csv"]')?.addEventListener('click', handleProcessImport);
                modalContainer.querySelector('[data-action="save-remarks"]')?.addEventListener('click', () => {
                     const remarks = modalContainer.querySelector('textarea').value;
                     handleSaveRemarks(state.remarksTarget.id, remarks);
                });
            }
        }
        
        function renderModal(title, content, maxWidth = "max-w-4xl") {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4 transition-opacity modal-enter modal-enter-active" data-action="close-modal-backdrop">
                    <div class="bg-white rounded-lg shadow-xl w-full ${maxWidth} transform transition-all modal-content-enter modal-content-enter-active">
                        <div class="flex justify-between items-center p-4 border-b border-slate-200">
                            <h2 class="text-lg font-semibold text-[#385159]">${title}</h2>
                            <button data-action="close-modal" class="text-slate-400 hover:text-slate-600">${renderIcon('x', 24)}</button>
                        </div>
                        <div class="p-6">${content}</div>
                    </div>
                </div>
            `;
        }

        function renderPositionFormModal() {
            const { newPosition } = state;
            const content = `
                <form data-modal-form="add-position" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="orgCode" class="block text-sm font-medium text-[#998E81]">組織代碼</label>
                            <input type="text" name="orgCode" id="orgCode" value="${newPosition.orgCode}" data-change="new-position-field" data-key="orgCode" class="mt-1 form-input" placeholder="例如：A012" required />
                        </div>
                        <div>
                            <label for="level" class="block text-sm font-medium text-[#998E81]">單位層級</label>
                            <select name="level" id="level" data-change="new-position-field" data-key="level" class="mt-1 form-select">
                                ${POSITION_LEVELS.map(l => `<option value="${l}" ${newPosition.level === l ? 'selected' : ''}>${l}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="division" class="block text-sm font-medium text-[#998E81]">廠處別</label>
                        <input type="text" name="division" id="division" value="${newPosition.division}" data-change="new-position-field" data-key="division" class="mt-1 form-input" placeholder="例如：製造一廠" />
                    </div>
                    <div>
                        <label for="adjustment" class="block text-sm font-medium text-[#998E81]">調整</label>
                        <input type="text" name="adjustment" id="adjustment" value="${newPosition.adjustment}" data-change="new-position-field" data-key="adjustment" class="mt-1 form-input" />
                    </div>
                    <div>
                        <label for="incumbent" class="block text-sm font-medium text-[#998E81]">現任主管姓名</label>
                        <input type="text" name="incumbent" id="incumbent" value="${newPosition.incumbent}" data-change="new-position-field" data-key="incumbent" class="mt-1 form-input" placeholder="例如：王大明" required />
                    </div>
                    <div>
                        <label for="functionType" class="block text-sm font-medium text-[#998E81]">主管功能別</label>
                        <select name="functionType" id="functionType" data-change="new-position-field" data-key="functionType" class="mt-1 form-select">
                           ${FUNCTION_TYPES.map(f => `<option value="${f}" ${newPosition.functionType === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center">
                            <input id="isActing" name="isActing" type="checkbox" ${newPosition.isActing ? 'checked' : ''} data-change="new-position-field" data-key="isActing" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF] rounded" />
                            <label for="isActing" class="ml-2 block text-sm text-[#385159]">此主管為兼任</label>
                        </div>
                        <div class="flex items-center">
                            <input id="isBmp" name="isBmp" type="checkbox" ${newPosition.isBmp ? 'checked' : ''} data-change="new-position-field" data-key="isBmp" class="h-4 w-4 text-[#385159] focus:ring-[#385159] border-[#A9BDBF] rounded" />
                            <label for="isBmp" class="ml-2 block text-sm text-[#385159]">BMP</label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" data-action="close-modal" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">取消</button>
                        <button type="submit" class="px-4 py-2 bg-[#385159] text-white rounded-md hover:bg-opacity-90">儲存</button>
                    </div>
                </form>
            `;
            return renderModal('新增組織單位', content, 'max-w-2xl');
        }

        function renderSuccessorFormModal() {
            // Simplified version for brevity. A full version would include the reference list.
            const { successorToEdit, currentPosition } = state;
            const successor = successorToEdit || {};
            const content = `
                <form data-modal-form="save-successor" class="space-y-6">
                    <p class="text-sm text-slate-600 -mt-2">組織代碼: <span class="font-semibold">${currentPosition?.orgCode}</span></p>
                    <div>
                        <label for="name" class="block text-sm font-medium text-[#998E81]">姓名</label>
                        <input type="text" name="name" id="name" value="${successor.name || ''}" required class="mt-1 form-input" />
                    </div>
                    <div>
                        <label for="readiness" class="block text-sm font-medium text-[#998E81]">準備度</label>
                        <select name="readiness" id="readiness" class="mt-1 form-select">
                            ${READINESS_OPTIONS.map(opt => `<option value="${opt}" ${successor.readiness === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="strengths" class="block text-sm font-medium text-[#998E81]">主要優勢</label>
                        <textarea name="strengths" id="strengths" rows="3" class="mt-1 form-textarea" placeholder="簡述此人選的關鍵優勢...">${successor.strengths || ''}</textarea>
                    </div>
                    <div>
                        <label for="developmentNeeds" class="block text-sm font-medium text-[#998E81]">待發展領域</label>
                        <textarea name="developmentNeeds" id="developmentNeeds" rows="3" class="mt-1 form-textarea" placeholder="簡述需要加強或學習的領域...">${successor.developmentNeeds || ''}</textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" data-action="close-modal" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">取消</button>
                        <button type="submit" class="px-4 py-2 bg-[#385159] text-white rounded-md hover:bg-opacity-90">儲存人選</button>
                    </div>
                </form>
            `;
            return renderModal(`${successorToEdit ? '編輯' : '新增'}接班人`, content);
        }

        function renderImportModal() {
            const sampleCSV = `廠處別,調整,組織代碼,單位層級,現任主管,主管功能別,是否兼任,BMP,第一人選姓名,第一人選準備度,第一人選主要優勢,第一人選待發展區域,第二人選姓名,第二人選準備度,第二人選主要優勢,第二人選待發展區域,備注\\n製造一廠,觀察中,A001,一級,王大明,OU,否,是,李四,1-3年,"溝通能力強,善於合作","需加強財務知識",趙五,3-5年,"執行力佳","",單位重要`;
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">格式說明</label>
                        <p class="text-xs text-slate-500 mt-1">請貼上 CSV 資料，或上傳 .csv 檔案。欄位順序必須如下：</p>
                        <code class="text-xs bg-slate-100 p-1 rounded-md block mt-1">廠處別,調整,組織代碼,單位層級,現任主管,主管功能別,是否兼任,BMP,第一人選姓名,第一人選準備度,第一人選主要優勢,第一人選待發展區域,第二人選姓名,第二人選準備度,第二人選主要優勢,第二人選待發展區域,備注</code>
                    </div>
                    <div>
                        <label for="csv-data" class="block text-sm font-medium text-slate-700">貼上 CSV 資料</label>
                        <textarea id="csv-data" rows="8" class="mt-1 form-textarea font-mono text-sm" placeholder="${sampleCSV.replace(/\\n/g, '\n')}"></textarea>
                    </div>
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden" />
                    <div id="import-error" class="text-sm text-red-600"></div>
                    <div class="flex justify-between items-center pt-4">
                        <button type="button" data-action="upload-csv-file" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-md hover:bg-slate-50 flex items-center">${renderIcon('upload', 16)}<span class="ml-2">上傳檔案</span></button>
                        <div class="flex space-x-3">
                            <button type="button" data-action="close-modal" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">取消</button>
                            <button type="button" data-action="import-csv" class="px-4 py-2 bg-[#385159] text-white rounded-md hover:bg-opacity-90">處理匯入</button>
                        </div>
                    </div>
                </div>
            `;
            return renderModal('從 CSV 匯入資料', content);
        }

        function renderRemarksModal() {
            const { remarksTarget } = state;
            const content = `
                <div class="space-y-4">
                    <textarea rows="10" class="form-textarea w-full" placeholder="請在此輸入備註...">${remarksTarget.remarks || ''}</textarea>
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" data-action="close-modal" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">取消</button>
                        <button data-action="save-remarks" class="px-4 py-2 bg-[#385159] text-white rounded-md hover:bg-opacity-90">儲存備註</button>
                    </div>
                </div>
            `;
            return renderModal(`編輯 ${remarksTarget.orgCode} 的備註`, content, 'max-w-2xl');
        }

        function renderDetailsModal() {
            const { title, data: positions, type } = state.detailsModalData;
            const content = `
                <div class="max-h-96 overflow-y-auto">
                    <ul class="divide-y divide-slate-200">
                    ${positions.map(p => {
                        let displayString, rightTag;
                        if(type === 'adjustment'){
                            displayString = `${p.orgCode}_${p.incumbent?.name}`;
                            rightTag = `<span class="text-xs text-gray-500 truncate" title="${p.remarks || ''}">${p.remarks || ''}</span>`;
                        } else {
                            const incumbentName = (p.incumbent?.name || '') + (p.incumbent?.isActing ? "(兼任)" : "");
                            const successorNames = (p.successors || []).map(s => s.name || 'TBD').join('/');
                            displayString = `${p.orgCode}_${incumbentName}(${successorNames})`;
                            rightTag = `<span class="inline-block bg-[#e0e7e8] text-[#385159] text-xs font-semibold px-2.5 py-0.5 rounded-full">${p.level}</span>`;
                        }
                        return `
                            <li key="${p.id}" class="flex justify-between items-center py-2">
                                <span class="text-sm font-mono">${displayString}</span>
                                ${rightTag}
                            </li>
                        `;
                    }).join('')}
                    </ul>
                </div>
            `;
            return renderModal(title, content, 'max-w-2xl');
        }
        
        // --- Main Render Function ---
        function render() {
            const appRoot = document.getElementById('app-root');
            if (state.isLoading) {
                appRoot.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-xl font-semibold">載入中...</div></div>`;
                return;
            }
            if (state.error) {
                appRoot.innerHTML = `<div class="flex items-center justify-center h-screen bg-red-50"><div class="text-xl font-semibold text-red-600 p-8 bg-white shadow-lg rounded-lg">${state.error}</div></div>`;
                return;
            }

            if (state.page === 'main') {
                appRoot.innerHTML = renderMainPage();
            } else if (state.page === 'analytics') {
                appRoot.innerHTML = renderAnalyticsPage();
            }
            
            renderModals();
        }

        // --- Global Event Listeners ---
        const appRoot = document.getElementById('app-root');
        const modalContainer = document.getElementById('modal-container');
        
        appRoot.addEventListener('click', handleAppClick);
        appRoot.addEventListener('change', handleAppChange);
        appRoot.addEventListener('input', handleAppChange); // For text inputs
        
        // Drag and Drop listeners on the app root for delegation
        appRoot.addEventListener('dragstart', handleDragAndDrop);
        appRoot.addEventListener('dragover', handleDragAndDrop);
        appRoot.addEventListener('drop', handleDragAndDrop);
        appRoot.addEventListener('dragend', handleDragAndDrop);
        
        modalContainer.addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            if (action === 'close-modal' || (action === 'close-modal-backdrop' && e.target === actionTarget)) {
                closePositionModal();
                closeSuccessorModal();
                closeImportModal();
                closeRemarksModal();
                closeDetailsModal();
            }
            if (action === 'upload-csv-file') {
                document.getElementById('csv-file-input').click();
            }
        });
        
        modalContainer.addEventListener('change', (e) => {
             const changeTarget = e.target.closest('[data-change]');
             if (changeTarget) {
                 handleAppChange(e);
             }
             if (e.target.id === 'csv-file-input') {
                 const file = e.target.files[0];
                 if (file) {
                     const reader = new FileReader();
                     reader.onload = (event) => {
                         document.getElementById('csv-data').value = event.target.result;
                     };
                     reader.readAsText(file, 'UTF-8');
                 }
             }
        });
        
        // --- Start the App ---
        window.onload = () => {
            render();
        };

    </script>
</body>
</html>
