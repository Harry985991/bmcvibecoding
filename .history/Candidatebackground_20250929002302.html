<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>104æ‡‰å¾µåˆ†æ</title>
  <style>
    :root {
      --bg: #F8F8F8;           /* page background - æ·ºç°è‰²èƒŒæ™¯ */
      --primary: #333333;      /* æ·±ç°è‰²æ–‡å­— */
      --banner: #1E1E3F;       /* banner color */
      --underline: #3B82F6;    /* banner åº•éƒ¨äº®è—ä¸‹åŠƒç·š */
      --muted: #666666;        /* æ¬¡è¦æ–‡å­—é¡è‰² */
      --accent: #007BFF;       /* ä¸»è¦è—è‰² */
      --teal: #E5E5E5;         /* æ·ºç°è‰² */
      --title-blue: #E3F2FD;   /* æ·ºè—è‰²æ¨™é¡ŒèƒŒæ™¯ */
      --card-bg: #ffffff;      /* ç™½è‰²å¡ç‰‡èƒŒæ™¯ */
      --section-bg: #ffffff;   /* ç™½è‰²å€å¡ŠèƒŒæ™¯ */
      --card-border: rgba(0,0,0,0.08);
      --success: #28A745;      /* æˆåŠŸç¶ è‰² */
      --warning: #FFC107;      /* è­¦å‘Šæ©™è‰² */
      --panel: #ffffff;        /* é¢æ¿èƒŒæ™¯ */
      --text: #1e293b;         /* ä¸»è¦æ–‡å­— */
      --chip: #f1f5f9;         /* æ¨™ç±¤èƒŒæ™¯ */
      --chip-bd: #cbd5e1;      /* æ¨™ç±¤é‚Šæ¡† */
      --table-zebra: #f8fafc;  /* è¡¨æ ¼æ–‘é¦¬ç´‹ */
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', 'Noto Sans TC', sans-serif; 
      background-color: var(--bg); 
      color: var(--text); 
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header { 
      background: var(--banner);
      padding: 8px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: none;
      box-shadow: 0 2px 8px rgba(16,24,40,0.04);
      position: sticky;
      top: 0;
      z-index: 50;
      position: relative;
    }

    /* left: logo + title */
    .header-left {
      display:flex;
      gap:12px;
      align-items:center;
    }

    /* header actions (right) - white text, subtle white borders */
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }
    .container { max-width: none; margin: 0; padding: 0; }
    
    /* æ•´é«”ä½ˆå±€ */
    .main-layout {
      display: flex;
      min-height: calc(100vh - 80px);
      width: 100%;
    }
    
    /* å·¦å´å°èˆªå€ */
    .sidebar {
      width: 200px;
      background: #f8f9fa;
      padding: 20px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.06);
      border-right: 1px solid var(--card-border);
      height: calc(100vh - 80px);
      position: fixed;
      left: 0;
      top: 80px;
      overflow-y: auto;
    }
    
    .sidebar h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
      color: var(--primary);
      font-weight: 700;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent);
    }
    
    .nav-item {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: transparent;
      color: var(--text);
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 200ms ease;
      text-align: left;
    }
    
    .nav-item:hover {
      background: rgba(0,123,255,0.1);
      border-color: rgba(0,123,255,0.2);
    }
    
    .nav-item.active {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }
    
    /* å³å´å…§å®¹å€ */
    .content-area {
      flex: 1;
      min-width: 0;
      margin-left: 200px;
      padding: 24px;
      height: calc(100vh - 80px);
      overflow-y: auto;
    }
    h1 { 
      font-size: 24px;
      color: #ffffff;
      font-weight: 700;
      letter-spacing: 0.2px;
      margin: 0;
    }
    .sub { 
      color: var(--muted); 
      font-size: 14px; 
      margin-top: 8px; 
      line-height: 1.5;
    }
    .panel { 
      background: var(--panel); 
      border: 1px solid var(--card-border); 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      margin-bottom: 24px;
    }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
    .col-12{ grid-column: span 12; }
    .controls-row { display:flex; gap:12px; align-items: center; flex-wrap: wrap; }
    .chip { 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      padding:6px 10px; 
      background: var(--chip); 
      border:1px solid var(--chip-bd); 
      border-radius: 999px; 
      font-size:14px; 
      color: var(--text); 
      font-weight: 600;
    }
    .btn { 
      background: transparent;
      color: #ffffff;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      text-decoration: none;
      cursor: pointer;
    }
    .btn:hover {
      background: rgba(255,255,255,0.04);
      transform: translateY(-1px);
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn.accent { 
      display: inline-block;
      background: var(--banner);
      color: #ffffff;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      text-decoration: none;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }
    .btn.accent:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,123,255,0.16);
      filter: brightness(0.98);
    }
    .btn.ghost { 
      background: rgba(255,255,255,0.2); 
      color: rgba(255,255,255,0.9);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    /* ç¯©é¸å€åŸŸçš„æŒ‰éˆ•æ¨£å¼ */
    .filter-btn {
      background: #f8f9fa;
      color: var(--text);
      border: 1px solid #dee2e6;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 12px;
      text-decoration: none;
      cursor: pointer;
      transition: all 150ms ease;
    }
    
    .filter-btn:hover {
      background: #e9ecef;
      border-color: #adb5bd;
      transform: translateY(-1px);
    }
    .file { 
      border:1px dashed var(--card-border); 
      border-radius: 12px; 
      padding: 12px; 
      display:inline-flex; 
      align-items:center; 
      gap:10px; 
      background: var(--chip); 
    }
    label { 
      font-size: 14px; 
      color: var(--primary); 
      font-weight: 600;
    }
    select, input[type="text"], input[type="search"] { 
      background: var(--card-bg); 
      border:1px solid var(--card-border); 
      color: var(--text); 
      padding:10px 12px; 
      border-radius: 8px; 
      font-size: 14px; 
      min-width: 140px; 
    }
    details { 
      border:1px solid var(--card-border); 
      border-radius: 12px; 
      padding: 16px; 
      background: var(--card-bg);
    }
    details > summary { 
      cursor: pointer; 
      font-size: 14px; 
      color: var(--primary); 
      font-weight: 600;
    }
    .kvs { display:flex; flex-wrap: wrap; gap:8px; margin-top: 8px; }
    .kvs .chip { font-size: 12px; }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 12px; 
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    thead th { 
      position: sticky; 
      top: 0; 
      background: var(--card-bg); 
      border-bottom: 1px solid var(--card-border); 
      padding: 12px; 
      text-align: left; 
      font-weight: 700; 
      font-size: 14px; 
      color: var(--primary);
      z-index: 1;
    }
    tbody td { 
      padding: 12px; 
      border-bottom: 1px solid var(--card-border); 
      font-size: 14px; 
      color: var(--text);
    }
    tbody tr:nth-child(even) { background: var(--table-zebra); }
    .right { text-align: right; }
    .muted { color: var(--muted); }
    .badges { display:flex; gap:8px; flex-wrap:wrap; }
    .nowrap { white-space: nowrap; }
    .grow { flex: 1 1 auto; }
    .search { min-width: 220px; }
    a.company-link { color: var(--accent); text-decoration: underline; cursor:pointer; font-weight: 600; }

    /* Modal */
    .modal-backdrop { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.45); 
      display:none; 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
    }
    .modal { 
      width: min(1400px, 98vw); 
      max-height: 86vh; 
      overflow: hidden; 
      border-radius: 12px; 
      background: var(--card-bg); 
      border:1px solid var(--card-border); 
      box-shadow: 0 6px 20px rgba(0,0,0,0.12); 
      display:flex; 
      flex-direction: column; 
    }
    .modal header { 
      position: relative; 
      padding: 20px; 
      border-bottom: 1px solid var(--card-border); 
      background: var(--card-bg); 
    }
    .modal h2 { 
      font-size: 18px; 
      margin:0; 
      color: var(--primary);
      font-weight: 700;
    }
    .modal .meta { 
      font-size:14px; 
      color: var(--muted); 
      margin-top:8px; 
    }
    .modal main { 
      padding: 0 20px 12px; 
      overflow: auto; 
    }
    
    .modal table {
      min-width: 100%;
      table-layout: auto;
    }
    
    .modal th {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    .modal th:hover {
      background-color: #f8f9fa;
    }
    
    .modal th.sortable::after {
      content: " â†•";
      opacity: 0.5;
      font-size: 12px;
    }
    
    .modal th.sort-asc::after {
      content: " â†‘";
      opacity: 1;
      color: var(--accent);
    }
    
    .modal th.sort-desc::after {
      content: " â†“";
      opacity: 1;
      color: var(--accent);
    }
    .modal footer { 
      padding: 16px 20px; 
      border-top: 1px solid var(--card-border); 
      display:flex; 
      gap:8px; 
      justify-content: flex-end; 
    }
    .tag { 
      border: 1px solid var(--card-border); 
      border-radius: 999px; 
      padding: 4px 8px; 
      font-size: 12px; 
      color: var(--text); 
      background: var(--chip);
    }
    .close-x { 
      position:absolute; 
      right:16px; 
      top:16px; 
      cursor:pointer; 
      font-size: 20px; 
      color: var(--muted);
      font-weight: 700;
    }
    
    /* æ•´é«”åˆ†æè¡¨æ ¼æ¨£å¼è¦†è“‹ */
    .overview-table th[style*="text-align: right"],
    .overview-table td[style*="text-align: right"] {
      text-align: right !important;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>104æ‡‰å¾µåˆ†æ</h1>
    </div>
    
    <div class="header-actions">
      <button class="btn accent" id="importBtn">åŒ¯å…¥è³‡æ–™</button>
      <button id="downloadCsv" class="btn accent" disabled>ä¸‹è¼‰çµæœ</button>
    </div>
  </header>

  <div class="main-layout">
    <!-- å·¦å´å°èˆªå€ -->
    <div class="sidebar">
      <h3>çµ±è¨ˆåˆ†æ</h3>
      <button class="nav-item active" id="tabOverview">æ•´é«”åˆ†æ</button>
      <button class="nav-item" id="tabCompany">å…¬å¸çµ±è¨ˆ</button>
      <button class="nav-item" id="tabExperience">å¹´è³‡çµ±è¨ˆ</button>
      <button class="nav-item" id="tabEducation">å­¸æ­·åˆ†æ</button>
      <button class="nav-item" id="tabGeography">åœ°ç†åˆ†æ</button>
      <button class="nav-item" id="tabJobAnalysis">è·å‹™å‰–æ</button>
      <!-- æ–°å¢å´æ¬„å€å¡Šæ¨™é¡Œï¼šæ–°äººæ‡‰å¾µçµ±è¨ˆ -->
      <div style="margin-top:12px; padding-top:8px; border-top:1px solid var(--card-border);">
        <h3 style="margin:0; font-size:14px; color:var(--primary);">æ–°äººæ‡‰å¾µçµ±è¨ˆ</h3>
        <div style="margin-top:8px;">
          <button class="nav-item" id="tabJobStats">æ•¸æ“šçµ±è¨ˆ</button>
        </div>
      </div>
    </div>
    
    <!-- å³å´å…§å®¹å€ -->
    <div class="content-area">
        <section class="panel" style="margin-top:0px;">
      <div class="grid">
        <div class="col-12">
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- æœˆä»½ç¯©é¸ -->
            <div>
              <div class="controls-row" style="align-items: center; gap: 8px;">
                <label style="margin: 0;">æœˆä»½</label>
                <button class="filter-btn" id="monthSelectAll">å…¨é¸</button>
                <button class="filter-btn" id="monthClear">æ¸…é™¤</button>
                <div id="monthChips" class="kvs" style="margin: 0;"></div>
              </div>
            </div>
            
            <!-- è·ç³»ç¯©é¸ -->
            <div>
              <div class="controls-row" style="align-items: center; gap: 8px;">
                <label style="margin: 0;">è·ç³»</label>
                <button class="filter-btn" id="idlSelectAll">å…¨é¸</button>
                <button class="filter-btn" id="idlClear">æ¸…é™¤</button>
                <div id="idlChips" class="kvs" style="margin: 0;"></div>
              </div>
            </div>
            
            <!-- åŠŸèƒ½ç¯©é¸ -->
            <div>
              <div class="controls-row" style="align-items: center; gap: 8px;">
                <label style="margin: 0;">åŠŸèƒ½</label>
                <button class="filter-btn" id="funcSelectAll">å…¨é¸</button>
                <button class="filter-btn" id="funcClear">æ¸…é™¤</button>
                <div id="funcChips" class="kvs" style="margin: 0;"></div>
              </div>
            </div>
            
            <!-- å» å€ç¯©é¸ -->
            <div>
              <div class="controls-row" style="align-items: center; gap: 8px;">
                <label style="margin: 0;">å» å€</label>
                <button class="filter-btn" id="locSelectAll">å…¨é¸</button>
                <button class="filter-btn" id="locClear">æ¸…é™¤</button>
                <div id="locChips" class="kvs" style="margin: 0;"></div>
              </div>
            </div>
            
          </div>
        </div>
        <div class="col-12 controls-row" style="margin-top:6px; display: none;">
          <label class="chip"><input type="checkbox" id="toggleDedup" /> å»é™¤é‡è¤‡ï¼ˆä»¥ã€Œå§“åï¼‹è·å‹™åç¨±ä¸€ï¼‹æ‡‰å¾µæ—¥æœŸã€å»é‡ï¼‰</label>
          <label class="chip"><input type="checkbox" id="toggleHideUnknown" /> æ’é™¤ã€Œæœªå¡«å¯«ï¼æ±‚è·è€…è¨­å®šéš±è—ã€å…¬å¸</label>
        </div>
      </div>
      
  <!-- (è·å‹™çµ±è¨ˆé¢æ¿å·²ç§»è‡³é é¢åº•éƒ¨ï¼Œé¿å…èˆ‡ç¯©é¸å¡ç‰‡æ··åœ¨ä¸€èµ·) -->
    </section>

    <section class="panel" style="margin-top:12px; display: none;">
      <details>
        <summary>åˆ†é¡è¦å‰‡ï¼ˆå¯æ–¼ç¨‹å¼å…§èª¿æ•´ï¼‰</summary>
        <div style="margin-top:8px; color: var(--muted); font-size: 13px; line-height:1.7;">
          <div><strong>Function å„ªå…ˆåºï¼š</strong>RD â†’ ç”Ÿç”¢è£½é€  â†’ è³‡è¨Š â†’ è¡ŒéŠ·æ¥­å‹™ â†’ å…¶ä»–ã€‚</div>
          <div><strong>è·å‹™åç¨±åœ°é»ï¼š</strong>è‹¥è·å‹™åç¨±å«ã€Œé¾ç§‘ã€â†’ é¾ç§‘å» ï¼›å«ã€Œé›²ç§‘ï¼é›²æ—ï¼æ–—å…­ã€â†’ é›²ç§‘å» ï¼›å«ã€Œä¸­ç§‘ï¼åé‡Œã€â†’ ä¸­ç§‘/åé‡Œï¼›å…¶é¤˜é è¨­ â†’ æ¡ƒåœ’å» ã€‚</div>
        </div>
      </details>
    </section>

    <section class="panel" style="margin-top:12px;">
      <div id="statsHeader" class="controls-row" style="justify-content: space-between;">
        <div class="badges" id="statusBadges"></div>
      </div>
      
      
      <!-- æ•´é«”åˆ†æå…§å®¹ -->
      <div id="overviewStats" class="tab-content">
        <div id="overviewOutput"></div>
      </div>
      
      <!-- å…¬å¸çµ±è¨ˆå…§å®¹ -->
      <div id="companyStats" class="tab-content" style="display: none;">
        <!-- å…¬å¸åç¨±é—œéµå­—æœå°‹ -->
        <div class="panel" style="margin-bottom: 24px;">
          <h4 style="margin: 0 0 16px 0; color: var(--primary);">å…¬å¸ç¯©é¸</h4>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <label style="font-weight: 600; color: var(--text);">å…¬å¸åç¨±é—œéµå­—ï¼š</label>
            <input id="companySearch" class="search" type="search" placeholder="è¼¸å…¥é—œéµå­—éæ¿¾å…¬å¸" style="min-width: 300px; padding: 8px 12px; border: 1px solid var(--card-border); border-radius: 6px; background: var(--card-bg); color: var(--text);" />
          </div>
        </div>
        <div id="output"></div>
      </div>
      
      <!-- å¹´è³‡çµ±è¨ˆå…§å®¹ -->
      <div id="experienceStats" class="tab-content" style="display: none;">
        <div id="experienceOutput"></div>
      </div>
      
      <!-- å­¸æ­·åˆ†æå…§å®¹ -->
      <div id="educationStats" class="tab-content" style="display: none;">
        <div style="margin-bottom: 16px;">
          <button class="btn accent" id="filterNewcomers" style="background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 8px;">
            ç¯©é¸æ–°é€²äººå“¡ï¼ˆç„¡å¹´è³‡+äºŒå¹´ä»¥å…§ï¼‰
          </button>
          <button class="btn" id="clearNewcomerFilter" style="background: #f8f9fa; color: var(--text); border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">
            æ¸…é™¤ç¯©é¸
          </button>
        </div>
        <div id="educationOutput"></div>
      </div>
      
      <!-- åœ°ç†åˆ†æå…§å®¹ -->
      <div id="geographyStats" class="tab-content" style="display: none;">
        <div id="geographyOutput"></div>
      </div>
      
      <!-- è·å‹™åˆ†æå…§å®¹ -->
      <div id="jobAnalysisStats" class="tab-content" style="display: none;">
        <!-- è·å‹™ç¯©é¸å™¨ -->
        <div class="panel" style="margin-bottom: 24px;">
          <h4 style="margin: 0 0 16px 0; color: var(--primary);">è·å‹™ç¯©é¸</h4>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <label style="font-weight: 600; color: var(--text);">é¸æ“‡è·å‹™ï¼š</label>
            <select id="jobFilter" style="min-width: 300px; padding: 8px 12px; border: 1px solid var(--card-border); border-radius: 6px; background: var(--card-bg); color: var(--text);">
              <option value="">è«‹é¸æ“‡è·å‹™...</option>
            </select>
            <button id="clearJobFilter" class="btn" style="background: #f8f9fa; color: var(--text); border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">
              æ¸…é™¤ç¯©é¸
            </button>
          </div>
        </div>
        
        <!-- æ ¸å¿ƒæ•¸æ“šæ‘˜è¦ -->
        <div class="panel" style="margin-bottom: 24px;">
          <h4 style="margin: 0 0 16px 0; color: var(--primary);">æ ¸å¿ƒæ•¸æ“šæ‘˜è¦</h4>
          <div id="jobAnalysisKPIs" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <!-- KPI å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
        <div style="display:flex; align-items:center; gap:8px; margin-top:12px;">
          <div style="display:flex; gap:8px;">
            <button id="jobHistByMonth" class="btn" style="background:#f8f9fa; color:var(--text); border:1px solid var(--card-border);">æŒ‰æœˆ</button>
            <button id="jobHistByWeek" class="btn accent" style="background:var(--accent); color:white; border:none;">æŒ‰é€±</button>
          </div>
        </div>
        <div id="jobHistContainer"></div>
        </div>
        
        <!-- ç¶“é©—èƒŒæ™¯åˆ†æ -->
        <div class="panel" style="margin-bottom: 24px;">
          <h4 style="margin: 0 0 16px 0; color: var(--primary);">ç¶“é©—èƒŒæ™¯åˆ†æ</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- å¹´è³‡åˆ†ä½ˆ -->
            <div>
              <h5 style="margin: 0 0 12px 0; color: var(--primary); font-size: 16px;">å¹´è³‡åˆ†ä½ˆ</h5>
              <div id="jobAnalysisSeniorityChart"></div>
            </div>
            <!-- å‰äº”å¤§ä¾†æºå…¬å¸ -->
            <div>
              <h5 style="margin: 0 0 12px 0; color: var(--primary); font-size: 16px;">å‰äº”å¤§ä¾†æºå…¬å¸</h5>
              <div id="jobAnalysisTopCompanies"></div>
            </div>
          </div>
          <div style="margin-top: 24px;">
            <h5 style="margin: 0 0 12px 0; color: var(--primary); font-size: 16px;">å‰äº”å¤§å‰ç½®è·å‹™</h5>
            <div id="jobAnalysisPreviousJobs"></div>
          </div>
        </div>
        
        <!-- å­¸è¡“èˆ‡åœ°ç†åˆ†æ -->
        <div class="panel" style="margin-bottom: 24px;">
          <h4 style="margin: 0 0 16px 0; color: var(--primary);">å­¸è¡“èˆ‡åœ°ç†åˆ†æ</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- ä¸»è¦ç•¢æ¥­å­¸æ ¡èˆ‡ç§‘ç³» -->
            <div>
              <h5 style="margin: 0 0 12px 0; color: var(--primary); font-size: 16px;">ä¸»è¦ç•¢æ¥­å­¸æ ¡èˆ‡ç§‘ç³»</h5>
              <div id="jobAnalysisEducation"></div>
            </div>
            <!-- æ‡‰å¾µè€…å±…ä½åœ°åˆ†ä½ˆ -->
            <div>
              <h5 style="margin: 0 0 12px 0; color: var(--primary); font-size: 16px;">æ‡‰å¾µè€…å±…ä½åœ°åˆ†ä½ˆ</h5>
              <div id="jobAnalysisLocation"></div>
            </div>
          </div>
        </div>
        
        <!-- æ‡‰å¾µè€…æ¸…å–® -->
        <div class="panel">
          <h4 style="margin: 0 0 16px 0; color: var(--primary);">æ‡‰å¾µè€…æ¸…å–®</h4>
          <div id="jobAnalysisApplicantList"></div>
        </div>
      </div>
      
      <!-- è·å‹™çµ±è¨ˆå…§å®¹ï¼ˆé¡¯ç¤ºæ–¼é é¢æœ€ä¸‹æ–¹ï¼Œé¿å…èˆ‡ç¯©é¸å¡ç‰‡ä¸¦åˆ—ï¼‰ -->
      <div id="jobStatsPanel" class="tab-content" style="display: none;">
        <div class="panel" style="padding:12px;">
          <div style="display:flex; gap:12px; align-items:center; margin-bottom:10px;">
            <label class="chip" style="margin:0;">
              <input type="checkbox" id="jobStatsFreshOnly" checked /> åªè¨ˆç®—ã€Œæ–°é®®äººè·ç¼ºã€ç‚º Y çš„è·ç¼ºæ•¸
            </label>
          </div>
          <!-- ä¸Šæ–¹å¡ç‰‡ï¼šç›®æ¨™æ–°äºº -->
          <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:12px;">
            <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:8px;">ç›®æ¨™æ–°äºº</div>
            <div id="jobStatsContent" style="min-height:20px; color:var(--muted);"></div>
          </div>
          <!-- ä¸‹æ–¹å¡ç‰‡ï¼šå…¨éƒ¨æ–°äºº -->
          <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:12px;">
            <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:8px;">å…¨éƒ¨æ–°äºº</div>
            <div id="targetStatsContent" style="min-height:20px; color:var(--muted);"></div>
          </div>
          <!-- åœ–è¡¨å‘ˆç¾ -->
          <div id="chartPanel" style="margin-top:12px;">
            <h5 style="margin:0 0 8px 0; color: var(--primary);">åœ–è¡¨å‘ˆç¾</h5>
            <div id="comparisonChart" style="min-height:260px;"></div>
          </div>
        </div>
      </div>

      <div class="footer" style="display: none;">æ“ä½œæç¤ºï¼šé»å…¬å¸åç¨±å¯å±•é–‹äººé¸æ¸…å–®ï¼›è¡¨æ ¼æ”¯æ´æ’åºï¼ˆé»æ¬„ä½æ¨™é¡Œï¼‰ã€‚</div>
    </section>
    </div>
  </div>

  <!-- Import Reminder Modal -->
  <div id="importReminderModal" class="modal-backdrop" style="display: flex;">
    <div class="modal" role="dialog" aria-modal="true" style="max-width: 500px;">
      <header>
        <h2>æ­¡è¿ä½¿ç”¨æ‡‰å¾µè€…èƒŒæ™¯åˆ†æç³»çµ±</h2>
        <div class="meta">è«‹å…ˆåŒ¯å…¥ CSV æª”æ¡ˆä»¥é–‹å§‹åˆ†æ</div>
      </header>
      <main style="padding: 20px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
          <p style="color: var(--muted); line-height: 1.6; margin: 0;">
            è«‹é¸æ“‡åŒ…å«æ‡‰å¾µè€…è³‡æ–™çš„ CSV æª”æ¡ˆé€²è¡ŒåŒ¯å…¥ï¼Œ<br>
            ç³»çµ±å°‡è‡ªå‹•åˆ†æä¸¦æä¾›çµ±è¨ˆå ±è¡¨ã€‚
          </p>
        </div>
      </main>
      <footer>
        <button class="btn accent" id="startImportBtn" style="background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
          é¸æ“‡æª”æ¡ˆ
        </button>
      </footer>
    </div>
  </div>

  <!-- Modal for Candidate List -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <span class="close-x" id="modalClose" title="é—œé–‰">Ã—</span>
        <h2 id="modalTitle">äººé¸æ¸…å–®</h2>
        <div class="meta" id="modalMeta"></div>
      </header>
      <main>
        <div style="padding: 10px 0; display:flex; gap:8px; align-items:center;">
          <span class="tag" id="modalFilters"></span>
          <div class="grow"></div>
          <button class="btn" id="btnExportCandidates">åŒ¯å‡ºäººé¸ CSV</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>æœˆä»½</th>
              <th>å§“å</th>
              <th>è·å‹™åç¨± IDL/DL</th>
              <th>å¹´è³‡</th>
              <th>å…¬å¸ï¼ˆå·¥ä½œç¶“é©—ä¸€ï¼‰</th>
              <th>å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±</th>
              <th>å­¸æ ¡NEW</th>
              <th>å­¸æ­·ç§‘ç³»åç¨±ä¸€</th>
              <th>è·ç¼º function</th>
            </tr>
          </thead>
          <tbody id="modalTbody"></tbody>
        </table>
      </main>
      <footer>
        <button class="btn ghost" id="btnClose">é—œé–‰</button>
      </footer>
    </div>
  </div>

  <script>
    // --- Helpers ---
    const MONTH_ORDER = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const MODE = {TOTAL: 'total', BY_MONTH: 'byMonth'};

    const KEYWORDS = {
      RD: ["ç ”ç™¼","é–‹ç™¼","è¨­è¨ˆ","NPI","æ–°äº‹æ¥­","æŠ€è¡“","ææ–™","é…æ–¹","æ‡‰ç”¨å·¥ç¨‹å¸«","ç ”ç™¼å·¥ç¨‹å¸«","ç”¢å“é–‹ç™¼","å…‰å­¸è¨­è¨ˆ","é›»æ©Ÿè¨­è¨ˆ","å·¥è—"],
      MFG: ["è£½ç¨‹","ç”Ÿç”¢","è£½é€ ","ç¾å ´","ç”¢ç·š","å°è£","æ¸¬è©¦","æ©Ÿå°","è¨­å‚™","å“ä¿","å“æª¢","QC","QA","ç¶­ä¿®","ç¶­è­·","ä¿é¤Š","ä½œæ¥­å“¡","æŠ€è¡“å“¡","å·¥å‹™","è£½é€ å·¥ç¨‹å¸«","è£½ç¨‹å·¥ç¨‹å¸«","å„€æ ¡","ç¶­é‹","å·¥æ¥­å·¥ç¨‹","æ•´åˆå·¥ç¨‹å¸«","é›»æ§","è¨­å‚™å·¥ç¨‹å¸«","IE","æ–°ç”¢å“å·¥ç¨‹å¸«"],
      IT: ["è³‡è¨Š","è»Ÿé«”","è»Ÿä»¶","è»Ÿå·¥","å‰ç«¯","å¾Œç«¯","å…¨ç«¯","è³‡æ–™","æ•¸æ“š","AI","æ©Ÿå™¨å­¸ç¿’","æ¼”ç®—æ³•","ç®—æ³•","DevOps","é›²","é›²ç«¯","ç³»çµ±","ç¶²è·¯","è³‡å®‰","IT","MIS","ç¨‹å¼","ç¨‹å¼è¨­è¨ˆ","ç¨‹å¼é–‹ç™¼","Python","Java","C#","SQL","é›²ç«¯å·¥ç¨‹å¸«","æ•¸ä½æŠ€è¡“ä¸­å¿ƒ"],
      MKT: ["è¡ŒéŠ·","å¸‚å ´","å“ç‰Œ","æ¥­å‹™","Sales","é€šè·¯","å®¢æˆ¶ç¶“ç†","æ¥­å‹™åŠ©ç†","BD","å•†å‹™","ä¼åŠƒ","å…¬é—œ","æ•¸ä½è¡ŒéŠ·","ç”¢å“ç¶“ç†","PM","AE","å®¢æœ"]
    };

    const FUNC_LABELS = [
      {key:'RD', label:'ç ”ç™¼'},
      {key:'MFG', label:'ç”Ÿç”¢è£½é€ '},
      {key:'MKT', label:'è¡ŒéŠ·æ¥­å‹™'},
      {key:'IT', label:'è³‡è¨Š'},
      {key:'OTHER', label:'å…¶ä»–'},
      {key:'INTERN', label:'å¯¦ç¿’'}
    ];

    const LOC_LABELS = [
      {key:'HQ', label:'æ¡ƒåœ’å» '},
      {key:'LONGKE', label:'é¾ç§‘å» '},
      {key:'YUNKE', label:'é›²ç§‘å» '},
      {key:'ZK_HOULI', label:'ä¸­ç§‘/åé‡Œ'}
    ];

    function normalizeKey(k){ return (k||'').toString().trim(); }
    function normalizeVal(v){ return (v==null? '': String(v)).trim(); }

    function guessFunction(title){
      const t = (title||'').toString().toLowerCase();
      const hit = (arr) => arr.some(w => t.includes(w.toLowerCase()));
      
      // ç‰¹æ®Šè¦å‰‡ï¼šå„ªå…ˆè™•ç†ç‰¹æ®Šæƒ…æ³
      if(t.includes('qç¨®å­æš‘æœŸå¯¦ç¿’')) return 'INTERN';
      if(t.includes('å¯¦ç¿’')) return 'INTERN';
      if(t.includes('å“è³ªç³»çµ±')) return 'OTHER';
      if(t.includes('é†«æç ”ç™¼æŠ€è¡“æ–‡ä»¶å°ˆå“¡')) return 'OTHER';
      if(t.includes('é†«ç™‚å™¨ææŠ€è¡“æ–‡ä»¶')) return 'OTHER';
      if(t.includes('æŠ€è¡“æ–‡ä»¶')) return 'OTHER';
      if(t.includes('æ•¸ä½æŠ€è¡“ä¸­å¿ƒ')) return 'IT';
      if(t.includes('å“ç‰Œç®¡ç†è™•')) return 'MKT';
      
      // æ¥­å‹™ç›¸é—œè¦å‰‡ï¼šåœ‹éš›æ¥­å‹™ã€æ¥­å‹™å°ˆå“¡ç­‰éƒ½æ­¸ç‚ºè¡ŒéŠ·æ¥­å‹™
      if(t.includes('åœ‹éš›æ¥­å‹™') || t.includes('æ¥­å‹™å°ˆå“¡') || t.includes('æ¥­å‹™')) return 'MKT';
      
      // è£½ç¨‹æŠ€è¡“å±¬æ–¼ç”Ÿç”¢è£½é€ 
      if(t.includes('è£½ç¨‹æŠ€è¡“')) return 'MFG';
      
      // AOIæ‡‰ç”¨å±¬æ–¼è³‡è¨Š
      if(t.includes('aoiæ‡‰ç”¨')) return 'IT';
      
      // ä¸€èˆ¬åˆ†é¡è¦å‰‡
      if(hit(KEYWORDS.RD)) return 'RD';
      if(hit(KEYWORDS.MFG)) return 'MFG';
      if(hit(KEYWORDS.IT)) return 'IT';
      if(hit(KEYWORDS.MKT)) return 'MKT';
      return 'OTHER';
    }

    function guessLocation(title){
      const t = (title||'').toString().toLowerCase();
      if(t.includes('é¾ç§‘')) return 'LONGKE';
      if(t.includes('é›²ç§‘') || t.includes('é›²æ—') || t.includes('æ–—å…­')) return 'YUNKE';
      if(t.includes('ä¸­ç§‘') || t.includes('åé‡Œ') || t.includes('å¾Œé‡Œ')) return 'ZK_HOULI';
      return 'HQ';
    }

    // CSV parser
    function parseCSV(text){
      const rows = [];
      let row = [], cell = '', inQuotes = false;
      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if(inQuotes){
          if(ch === '"' && next === '"'){ cell += '"'; i++; }
          else if(ch === '"'){ inQuotes = false; }
          else { cell += ch; }
        } else {
          if(ch === '"'){ inQuotes = true; }
          else if(ch === ','){ row.push(cell); cell=''; }
          else if(ch === '\n'){ row.push(cell); rows.push(row); row=[]; cell=''; }
          else if(ch === '\r'){ /* skip */ }
          else { cell += ch; }
        }
      }
      if(cell.length>0 || row.length>0){ row.push(cell); rows.push(row); }
      if(rows.length===0) return [];
      const headers = rows[0].map(h=>normalizeKey(h));
      return rows.slice(1).filter(r=>r.some(c=>c!==''))
        .map(r=>{ const o = {}; headers.forEach((h,idx)=>{ o[h] = normalizeVal(r[idx]); }); return o; });
    }

    // Global state
    let raw = [];
    let data = [];
    let selectedMonths = new Set();
    let selectedIDL = new Set();
    let selectedFuncs = new Set();
    let selectedLocs = new Set();
    let mode = MODE.TOTAL; // å›ºå®šç‚ºç¸½åˆæ¨¡å¼
    let isNewcomerFilterActive = false; // æ–°é€²äººå“¡ç¯©é¸ç‹€æ…‹
    let selectedJobTitle = ''; // é¸ä¸­çš„è·å‹™åç¨±

    // Elements
    const $output = document.getElementById('output');
    const $download = document.getElementById('downloadCsv');
    const $monthChips = document.getElementById('monthChips');
    const $idlChips = document.getElementById('idlChips');
    const $funcChips = document.getElementById('funcChips');
    const $locChips = document.getElementById('locChips');
    const $monthSelectAll = document.getElementById('monthSelectAll');
    const $monthClear = document.getElementById('monthClear');
    const $idlSelectAll = document.getElementById('idlSelectAll');
    const $idlClear = document.getElementById('idlClear');
    const $funcSelectAll = document.getElementById('funcSelectAll');
    const $funcClear = document.getElementById('funcClear');
    const $locSelectAll = document.getElementById('locSelectAll');
    const $locClear = document.getElementById('locClear');
    const $companySearch = document.getElementById('companySearch');
    const $toggleDedup = document.getElementById('toggleDedup');
    const $toggleHideUnknown = document.getElementById('toggleHideUnknown');
    const $statusBadges = document.getElementById('statusBadges');
    
    // åˆ†é å…ƒç´ 
    const $tabOverview = document.getElementById('tabOverview');
    const $tabCompany = document.getElementById('tabCompany');
    const $tabExperience = document.getElementById('tabExperience');
    const $tabEducation = document.getElementById('tabEducation');
    const $tabGeography = document.getElementById('tabGeography');
    const $tabJobAnalysis = document.getElementById('tabJobAnalysis');
    const $overviewStats = document.getElementById('overviewStats');
    const $companyStats = document.getElementById('companyStats');
    const $experienceStats = document.getElementById('experienceStats');
    const $educationStats = document.getElementById('educationStats');
    const $geographyStats = document.getElementById('geographyStats');
    const $jobAnalysisStats = document.getElementById('jobAnalysisStats');
  const $jobStatsPanel = document.getElementById('jobStatsPanel');
    const $overviewOutput = document.getElementById('overviewOutput');
    const $experienceOutput = document.getElementById('experienceOutput');
    const $educationOutput = document.getElementById('educationOutput');
    const $geographyOutput = document.getElementById('geographyOutput');
    const $filterNewcomers = document.getElementById('filterNewcomers');
    const $clearNewcomerFilter = document.getElementById('clearNewcomerFilter');
    
    // è·å‹™åˆ†æç›¸é—œå…ƒç´ 
    const $jobFilter = document.getElementById('jobFilter');
    const $clearJobFilter = document.getElementById('clearJobFilter');
    const $jobAnalysisKPIs = document.getElementById('jobAnalysisKPIs');
    const $jobAnalysisSeniorityChart = document.getElementById('jobAnalysisSeniorityChart');
    const $jobAnalysisTopCompanies = document.getElementById('jobAnalysisTopCompanies');
    const $jobAnalysisPreviousJobs = document.getElementById('jobAnalysisPreviousJobs');
    const $jobAnalysisEducation = document.getElementById('jobAnalysisEducation');
    const $jobAnalysisLocation = document.getElementById('jobAnalysisLocation');
    const $jobAnalysisApplicantList = document.getElementById('jobAnalysisApplicantList');

    // Modal elements
    const $modalBackdrop = document.getElementById('modalBackdrop');
    const $modalClose = document.getElementById('modalClose');
    const $btnClose = document.getElementById('btnClose');
    const $modalTitle = document.getElementById('modalTitle');
    const $modalMeta = document.getElementById('modalMeta');
    const $modalTbody = document.getElementById('modalTbody');
    const $modalFilters = document.getElementById('modalFilters');
    const $btnExportCandidates = document.getElementById('btnExportCandidates');

    function enableControls(enabled){
      [$download,$companySearch,$monthSelectAll,$monthClear,$idlSelectAll,$idlClear,$funcSelectAll,$funcClear,$locSelectAll,$locClear]
        .forEach(el=> el.disabled = !enabled);
    }

    function buildChips($root, values, selectedSet, onChange){
      $root.innerHTML = '';
      values.forEach(v=>{
        const id = Math.random().toString(36).slice(2);
        const wrap = document.createElement('label');
        wrap.className = 'chip';
        wrap.innerHTML = `<input type="checkbox" id="${id}"> <span>${v}</span>`;
        const $cb = wrap.querySelector('input');
        $cb.checked = selectedSet.has(v);
        $cb.addEventListener('change', ()=>{ if($cb.checked) selectedSet.add(v); else selectedSet.delete(v); onChange && onChange(); });
        $root.appendChild(wrap);
      });
    }

    function uniqueSortedMonths(arr){
      const u = Array.from(new Set(arr)).filter(Boolean);
      return u.sort((a,b)=> MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
    }
    function uniqueSorted(arr){ return Array.from(new Set(arr)).filter(Boolean).sort(); }

    function initFilters(){
      const months = uniqueSortedMonths(data.map(d=>d['æœˆä»½']));
  const idls = uniqueSorted(data.map(d=>d.__IDL));
      const funcs = FUNC_LABELS.map(f=>f.label);
      const locs = LOC_LABELS.map(l=>l.label);

      selectedMonths = new Set(months);
      selectedIDL = new Set(idls);
      selectedFuncs = new Set(funcs);
      selectedLocs = new Set(locs);

      // åˆå§‹åŒ–ç¯©é¸å™¨æ™‚ä¸è§¸ç™¼æ›´æ–°ï¼Œé¿å…è·³èº
      buildChips($monthChips, months, selectedMonths, null);
      buildChips($idlChips, idls, selectedIDL, null);
      buildChips($funcChips, funcs, selectedFuncs, null);
      buildChips($locChips, locs, selectedLocs, null);

      enableControls(true);
      initJobAnalysis();
      // æœ€å¾Œçµ±ä¸€æ›´æ–°ä¸€æ¬¡
      update();
    }

    function preprocess(rawRows){
      return rawRows.map(r=>{
        const o = {...r};
        const title = o['è·å‹™åç¨±ä¸€'] || o['è·å‹™åç¨±'] || o['è·å‹™'] || '';
        o.__FUNC = guessFunction(title);
        o.__FUNC_LABEL = FUNC_LABELS.find(x=>x.key===o.__FUNC)?.label || 'å…¶ä»–';
        o.__LOC = guessLocation(title);
        o.__LOC_LABEL = LOC_LABELS.find(x=>x.key===o.__LOC)?.label || 'ç¸½éƒ¨';
        o.__COMP = o['å·¥ä½œç¶“é©—ä¸€å…¬å¸åç¨±'] || 'æœªå¡«å¯«';
        o.__IDL = (o['IDL']||'').toUpperCase();
        o.__MONTH = o['æœˆä»½'] || '';
        o.__APPLY = o['æ‡‰å¾µè·å‹™ä¸€æ‡‰å¾µæ—¥æœŸ'] || o['æ‡‰å¾µæ—¥æœŸ'] || '';
        o.__NAME = o['å§“å'] || '';
        return o;
      });
    }

    function dedup(rows){
      const seen = new Set();
      const out = [];
      for(const r of rows){
        const key = [r.__NAME, r['è·å‹™åç¨±ä¸€']||'', r.__APPLY].join('||');
        if(seen.has(key)) continue; seen.add(key); out.push(r);
      }
      return out;
    }

    function filteredRows(){
      let rows = data.slice();
      if($toggleDedup.checked){ rows = dedup(rows); }
      rows = rows.filter(r=> selectedMonths.has(r.__MONTH));
      rows = rows.filter(r=> selectedIDL.has(r.__IDL));
      rows = rows.filter(r=> selectedFuncs.has( FUNC_LABELS.find(x=>x.key===r.__FUNC)?.label || 'å…¶ä»–' ));
      rows = rows.filter(r=> selectedLocs.has( LOC_LABELS.find(x=>x.key===r.__LOC)?.label || 'ç¸½éƒ¨' ));
      if($toggleHideUnknown.checked){ rows = rows.filter(r=> !(r.__COMP==='' || r.__COMP==='æœªå¡«å¯«' || r.__COMP==='æ±‚è·è€…è¨­å®šéš±è—')); }
      const q = $companySearch.value.trim();
      if(q){ const qq = q.toLowerCase(); rows = rows.filter(r=> (r.__COMP||'').toLowerCase().includes(qq)); }
      
      // æ–°é€²äººå“¡ç¯©é¸
      if(isNewcomerFilterActive){
        rows = rows.filter(r=> {
          const experience = r['å¹´è³‡'] || '';
          return experience === 'ç„¡' || 
                 experience.includes('ä¸€å¹´ä»¥ä¸‹') || 
                 experience.includes('1å¹´ä»¥ä¸‹') || 
                 experience === '1' || 
                 experience.includes('1-2å¹´') || 
                 experience.includes('1~2å¹´') || 
                 experience === '2';
        });
      }
      
      return rows;
    }

    function groupByCompany(rows){
      // å…ˆæŒ‰å…¬å¸åˆ†çµ„ï¼Œä¸¦è¨˜éŒ„æ¯å€‹å…¬å¸çš„å”¯ä¸€äººå“¡
      const companyPeople = new Map(); // å„²å­˜ (å…¬å¸åç¨±, Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      
      for(const r of rows){
        const company = r.__COMP || 'æœªå¡«å¯«';
        const personKey = `${r.__NAME}||${r['è·å‹™åç¨±ä¸€']||''}||${r.__APPLY}`; // äººå“¡å”¯ä¸€è­˜åˆ¥
        
        if (!companyPeople.has(company)) {
          companyPeople.set(company, new Set());
        }
        companyPeople.get(company).add(personKey);
      }

      // è¨ˆç®—æ¯å€‹å…¬å¸çš„å”¯ä¸€äººæ•¸
      const initialCounts = new Map();
      for(const [company, peopleSet] of companyPeople.entries()) {
        initialCounts.set(company, peopleSet.size);
      }

      const mergedCounts = new Map(); // å„²å­˜ (ä»£è¡¨å…¬å¸, ç¸½å”¯ä¸€äººæ•¸)
      const prefixToRepresentative = new Map(); // å„²å­˜ (å‰ç¶´, ä»£è¡¨å…¬å¸)
      const representativePeople = new Map(); // å„²å­˜ (ä»£è¡¨å…¬å¸, Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)

      // æŒ‰äººæ•¸é™åºæ’åºï¼Œç¢ºä¿äººæ•¸å¤šçš„å…¬å¸æˆç‚ºä»£è¡¨
      const sortedCompanies = Array.from(initialCounts.entries()).sort((a,b) => b[1] - a[1]);

      for(const [companyName, count] of sortedCompanies) {
        // åˆ¤æ–·å‰ç¶´é•·åº¦ï¼šè²¡åœ˜æ³•äººé–‹é ­ç”¨8å€‹å­—ï¼Œå…¶ä»–ç”¨4å€‹å­—
        const prefix = companyName.startsWith('è²¡åœ˜æ³•äºº') ? 
          companyName.substring(0, 8) : 
          companyName.substring(0, 4);
        
        const peopleSet = companyPeople.get(companyName);

        if (prefixToRepresentative.has(prefix)) {
          // å¦‚æœè©²å‰ç¶´å·²æœ‰ä»£è¡¨å…¬å¸ï¼Œå°‡äººå“¡åˆä½µåˆ°ä»£è¡¨å…¬å¸
          const representative = prefixToRepresentative.get(prefix);
          const representativeSet = representativePeople.get(representative);
          
          // åˆä½µäººå“¡é›†åˆï¼ˆè‡ªå‹•å»é‡ï¼‰
          for(const person of peopleSet) {
            representativeSet.add(person);
          }
          
          mergedCounts.set(representative, representativeSet.size);
        } else {
          // å¦‚æœè©²å‰ç¶´æ²’æœ‰ä»£è¡¨å…¬å¸ï¼Œæ­¤å…¬å¸æˆç‚ºä»£è¡¨
          prefixToRepresentative.set(prefix, companyName);
          representativePeople.set(companyName, new Set(peopleSet));
          mergedCounts.set(companyName, peopleSet.size);
        }
      }

      const arr = Array.from(mergedCounts.entries()).map(([å…¬å¸,äººæ•¸])=>({å…¬å¸,äººæ•¸}));
      arr.sort((a,b)=> b.äººæ•¸ - a.äººæ•¸ || a.å…¬å¸.localeCompare(b.å…¬å¸, 'zh-Hant'));
      return arr;
    }

    function groupByMonth(rows){
      const map = new Map();
      for(const r of rows){ const m = r.__MONTH || 'NA'; if(!map.has(m)) map.set(m, []); map.get(m).push(r); }
      const months = Array.from(map.keys()).sort((a,b)=> MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
      return months.map(m=>({month:m, rows: map.get(m)}));
    }

    function groupByExperience(rows){
      // å…ˆæŒ‰å¹´è³‡åˆ†çµ„ï¼Œä¸¦è¨˜éŒ„æ¯å€‹å¹´è³‡çš„å”¯ä¸€äººå“¡
      const experiencePeople = new Map(); // å„²å­˜ (å¹´è³‡, Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      
      for(const r of rows){
        const experience = r['å¹´è³‡'];
        // æ’é™¤æœªå¡«å¯«å’Œç©ºå€¼
        if (!experience || experience === '' || experience === 'æœªå¡«å¯«') {
          continue;
        }
        
        const personKey = `${r.__NAME}||${r['è·å‹™åç¨±ä¸€']||''}||${r.__APPLY}`; // äººå“¡å”¯ä¸€è­˜åˆ¥
        
        if (!experiencePeople.has(experience)) {
          experiencePeople.set(experience, new Set());
        }
        experiencePeople.get(experience).add(personKey);
      }

      // è¨ˆç®—æ¯å€‹å¹´è³‡çš„å”¯ä¸€äººæ•¸
      const experienceCounts = new Map();
      for(const [experience, peopleSet] of experiencePeople.entries()) {
        experienceCounts.set(experience, peopleSet.size);
      }

      // å¹´è³‡åˆ†çµ„é‚è¼¯
      const groupedExperience = new Map();
      
      for(const [å¹´è³‡, äººæ•¸] of experienceCounts.entries()) {
        let åˆ†çµ„åç¨± = '';
        
        // ç‰¹æ®Šè™•ç†ï¼šç„¡ã€2å¹´ä»¥ä¸‹
        if (å¹´è³‡ === 'ç„¡') {
          åˆ†çµ„åç¨± = 'ç„¡';
        } else if (å¹´è³‡.includes('ä¸€å¹´ä»¥ä¸‹') || å¹´è³‡.includes('1å¹´ä»¥ä¸‹') || å¹´è³‡ === '1' || 
                  å¹´è³‡.includes('1-2å¹´') || å¹´è³‡.includes('1~2å¹´') || å¹´è³‡ === '2') {
          åˆ†çµ„åç¨± = '2å¹´ä»¥ä¸‹';
        } else {
          // æå–æ•¸å­—é€²è¡Œåˆ†çµ„
          const match = å¹´è³‡.match(/(\d+)/);
          if (match) {
            const num = parseInt(match[1]);
            // æ¯ä¸‰å€‹å€é–“åˆä½µï¼š2-5å¹´ã€5-8å¹´ã€8-11å¹´ã€11-14å¹´...
            const startYear = Math.floor((num - 2) / 3) * 3 + 2;
            const endYear = startYear + 3;
            åˆ†çµ„åç¨± = `${startYear}-${endYear}å¹´`;
          } else {
            // ç„¡æ³•è§£æçš„ä¿æŒåŸæ¨£
            åˆ†çµ„åç¨± = å¹´è³‡;
          }
        }
        
        // åˆä½µåˆ°åˆ†çµ„ä¸­
        if (!groupedExperience.has(åˆ†çµ„åç¨±)) {
          groupedExperience.set(åˆ†çµ„åç¨±, new Set());
        }
        
        // å°‡è©²å¹´è³‡çš„æ‰€æœ‰äººå“¡åŠ å…¥åˆ†çµ„
        for(const personKey of experiencePeople.get(å¹´è³‡)) {
          groupedExperience.get(åˆ†çµ„åç¨±).add(personKey);
        }
      }

      // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
      const arr = Array.from(groupedExperience.entries()).map(([å¹´è³‡, peopleSet])=>({
        å¹´è³‡, 
        äººæ•¸: peopleSet.size
      }));
      
      // è¨ˆç®—ç¸½äººæ•¸ç”¨æ–¼ä½”æ¯”
      const totalPeople = arr.reduce((sum, item) => sum + item.äººæ•¸, 0);
      
      // æ·»åŠ ä½”æ¯”ä¸¦æ’åº
      arr.forEach(item => {
        item.ä½”æ¯” = totalPeople > 0 ? ((item.äººæ•¸ / totalPeople) * 100).toFixed(1) : '0.0';
      });
      
      // å¹´è³‡æ’åºé‚è¼¯
      arr.sort((a,b)=> {
        // ç„¡æ’åœ¨æœ€ä¸Šé¢
        if (a.å¹´è³‡ === 'ç„¡') return -1;
        if (b.å¹´è³‡ === 'ç„¡') return 1;
        
        // 2å¹´ä»¥ä¸‹æ’ç¬¬äºŒ
        if (a.å¹´è³‡ === '2å¹´ä»¥ä¸‹') return -1;
        if (b.å¹´è³‡ === '2å¹´ä»¥ä¸‹') return 1;
        
        // å…¶ä»–æŒ‰æ•¸å­—æ’åº
        const aMatch = a.å¹´è³‡.match(/(\d+)/);
        const bMatch = b.å¹´è³‡.match(/(\d+)/);
        
        if (aMatch && bMatch) {
          return parseInt(aMatch[1]) - parseInt(bMatch[1]);
        }
        
        // ç„¡æ³•è§£æçš„æŒ‰å­—ä¸²æ’åº
        return a.å¹´è³‡.localeCompare(b.å¹´è³‡, 'zh-Hant');
      });
      
      return arr;
    }

    function normalizeDegree(degree) {
      if (!degree || degree === 'æœªå¡«å¯«') return 'æœªå¡«å¯«';
      
      const d = degree.toString().toLowerCase();
      
      // ç¢©å£«(è‚„æ¥­)è¦–ç‚º"å¤§å­¸(ç•¢æ¥­)"
      if (d.includes('ç¢©å£«') && d.includes('è‚„æ¥­')) return 'å¤§å­¸(ç•¢æ¥­)';
      
      // åšå£«(è‚„æ¥­)è¦–ç‚ºç¢©å£«ç•¢æ¥­
      if (d.includes('åšå£«') && d.includes('è‚„æ¥­')) return 'ç¢©å£«(ç•¢æ¥­)';
      
      // å¤§å­¸(è‚„æ¥­)è¦–ç‚ºé«˜ä¸­è·
      if (d.includes('å¤§å­¸') && d.includes('è‚„æ¥­')) return 'é«˜ä¸­è·';
      
      // å››æŠ€(ç•¢æ¥­)åŠäºŒæŠ€(ç•¢æ¥­)ä½µç‚ºä¸€ç¨®ç‚º"æŠ€æ ¡(ç•¢æ¥­)"
      if (d.includes('å››æŠ€') && d.includes('ç•¢æ¥­')) return 'æŠ€æ ¡(ç•¢æ¥­)';
      if (d.includes('äºŒæŠ€') && d.includes('ç•¢æ¥­')) return 'æŠ€æ ¡(ç•¢æ¥­)';
      
      // äºŒå°ˆåŠä¸‰å°ˆåŠäº”å°ˆä½µç‚ºä¸€ç¨®ç‚º"å°ˆç§‘"
      if (d.includes('äºŒå°ˆ')) return 'å°ˆç§‘';
      if (d.includes('ä¸‰å°ˆ')) return 'å°ˆç§‘';
      if (d.includes('äº”å°ˆ')) return 'å°ˆç§‘';
      
      // é«˜ä¸­åŠé«˜è·ä½µç‚ºä¸€ç¨®ç‚º"é«˜ä¸­è·"
      if (d.includes('é«˜ä¸­') && !d.includes('è‚„æ¥­') && !d.includes('å°±å­¸ä¸­')) return 'é«˜ä¸­è·';
      if (d.includes('é«˜è·') && !d.includes('è‚„æ¥­')) return 'é«˜ä¸­è·';
      
      // é«˜ä¸­(è‚„æ¥­) é«˜è·(è‚„æ¥­) åœ‹ä¸­ä»¥ä¸‹(è‚„æ¥­) é«˜ä¸­(å°±å­¸ä¸­) åœ‹ä¸­ä»¥ä¸‹(ç•¢æ¥­) ä½µç‚ºä¸€ç¨®ç‚º"é«˜ä¸­ä»¥ä¸‹"
      if (d.includes('é«˜ä¸­') && d.includes('è‚„æ¥­')) return 'é«˜ä¸­ä»¥ä¸‹';
      if (d.includes('é«˜è·') && d.includes('è‚„æ¥­')) return 'é«˜ä¸­ä»¥ä¸‹';
      if (d.includes('åœ‹ä¸­ä»¥ä¸‹') && d.includes('è‚„æ¥­')) return 'é«˜ä¸­ä»¥ä¸‹';
      if (d.includes('é«˜ä¸­') && d.includes('å°±å­¸ä¸­')) return 'é«˜ä¸­ä»¥ä¸‹';
      if (d.includes('åœ‹ä¸­ä»¥ä¸‹') && d.includes('ç•¢æ¥­')) return 'é«˜ä¸­ä»¥ä¸‹';
      
      // å…¶ä»–ä¿æŒåŸæ¨£
      return degree;
    }

    function normalizeMajor(major) {
      if (!major || major === 'æœªå¡«å¯«') return 'æœªå¡«å¯«';
      
      let m = major.toString().trim();
      
      // ç§‘ç³»æ•´ä½µè¦å‰‡ï¼ˆå„ªå…ˆè™•ç†ï¼‰
      if (m.includes('ææ–™ç§‘å­¸èˆ‡å·¥ç¨‹') || m.includes('ææ–™ç³»')) return 'ææ–™å·¥ç¨‹ç³»';
      if (m.includes('é«˜åˆ†å­ç§‘å­¸èˆ‡å·¥ç¨‹å­¸ç ”ç©¶') || m.includes('æœ‰æ©Ÿé«˜åˆ†å­ç³»')) return 'é«˜åˆ†å­ç³»';
      if (m.includes('ä¼ç®¡ç³»') || m.includes('ä¼æ¥­ç®¡ç†')) return 'ä¼æ¥­ç®¡ç†ç³»';
      if (m.includes('åŒ–å·¥ç³»') || m.includes('åŒ–å­¸å·¥ç¨‹ç³»') || m.includes('åŒ–å­¸å·¥ç¨‹å­¸ç³»')) return 'åŒ–å­¸å·¥ç¨‹ç³»';
      if (m.includes('åŒ–å­¸å·¥ç¨‹èˆ‡ææ–™å·¥ç¨‹å­¸ç³»')) return 'åŒ–å·¥ææ–™ç³»';
      if (m.includes('æ©Ÿæ¢°ç³»')) return 'æ©Ÿæ¢°å·¥ç¨‹ç³»';
      if (m.includes('è³‡ç®¡ç³»') || m.includes('è³‡è¨Šç®¡ç†')) return 'è³‡è¨Šç®¡ç†ç³»';
      
      // çµ±ä¸€è¡“èªï¼šç ”ç©¶æ‰€ æ”¹ç‚ºç³»ï¼ˆä½†ä¿æŒåŒ–å­¸ç³»ã€æ‡‰ç”¨åŒ–å­¸ç³»ç­‰ä¸è®Šï¼‰
      if (m.endsWith('ç ”ç©¶æ‰€')) {
        m = m.replace(/ç ”ç©¶æ‰€$/, 'ç³»');
      }
      
      // çµ±ä¸€è¡“èªï¼šæ‰€ã€å­¸ç³» éƒ½è¦–åŒç‚º"ç³»"ï¼ˆä½†ä¿æŒåŒ–å­¸ç³»ã€æ‡‰ç”¨åŒ–å­¸ç³»ç­‰ä¸è®Šï¼‰
      if (m.endsWith('æ‰€') && !m.includes('åŒ–å­¸') && !m.includes('æ‡‰ç”¨åŒ–å­¸')) {
        m = m.replace(/æ‰€$/, 'ç³»');
      }
      if (m.endsWith('å­¸ç³»') && !m.includes('åŒ–å­¸') && !m.includes('æ‡‰ç”¨åŒ–å­¸')) {
        m = m.replace(/å­¸ç³»$/, 'ç³»');
      }
      
      // æ²’æœ‰å¯«ç³»æˆ–æ‰€çš„ï¼ŒåŠ ä¸Š"ç³»"
      if (!m.includes('ç³»') && !m.includes('æ‰€') && m !== 'æœªå¡«å¯«') {
        m = m + 'ç³»';
      }
      
      return m;
    }

    function parseAddress(address) {
      if (!address || address === 'æœªå¡«å¯«' || address === '') {
        return { city: 'æœªå¡«å¯«', district: 'æœªå¡«å¯«' };
      }
      
      const addr = address.toString().trim();
      
      // å°ç£ç¸£å¸‚åˆ—è¡¨
      const cities = [
        'å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'æ¡ƒåœ’å¸‚', 'å°ä¸­å¸‚', 'å°å—å¸‚', 'é«˜é›„å¸‚',
        'åŸºéš†å¸‚', 'æ–°ç«¹å¸‚', 'å˜‰ç¾©å¸‚',
        'æ–°ç«¹ç¸£', 'è‹—æ —ç¸£', 'å½°åŒ–ç¸£', 'å—æŠ•ç¸£', 'é›²æ—ç¸£', 'å˜‰ç¾©ç¸£',
        'å±æ±ç¸£', 'å®œè˜­ç¸£', 'èŠ±è“®ç¸£', 'å°æ±ç¸£', 'æ¾æ¹–ç¸£', 'é‡‘é–€ç¸£', 'é€£æ±Ÿç¸£'
      ];
      
      // å°‹æ‰¾ç¸£å¸‚
      let city = 'æœªå¡«å¯«';
      for (const c of cities) {
        if (addr.includes(c)) {
          city = c;
          break;
        }
      }
      
      // å°‹æ‰¾é„‰é®å¸‚å€ï¼ˆåœ¨ç¸£å¸‚ä¹‹å¾Œçš„éƒ¨åˆ†ï¼‰
      let district = 'æœªå¡«å¯«';
      if (city !== 'æœªå¡«å¯«') {
        const cityIndex = addr.indexOf(city);
        const afterCity = addr.substring(cityIndex + city.length);
        
        // å¸¸è¦‹çš„é„‰é®å¸‚å€å¾Œç¶´
        const districtSuffixes = ['å¸‚', 'å€', 'é®', 'é„‰', 'é‡Œ'];
        for (const suffix of districtSuffixes) {
          const regex = new RegExp(`([^\\s${suffix}]+)${suffix}`, 'g');
          const match = regex.exec(afterCity);
          if (match) {
            let foundDistrict = match[1] + suffix;
            
            // å¦‚æœé„‰é®å¸‚å€åç¨±åŒ…å«ç¸£å¸‚åç¨±ï¼Œç§»é™¤ç¸£å¸‚åç¨±
            for (const c of cities) {
              if (foundDistrict.includes(c)) {
                foundDistrict = foundDistrict.replace(c, '');
                break;
              }
            }
            
            // å¦‚æœè™•ç†å¾Œé‚„æœ‰å…§å®¹ï¼Œä½¿ç”¨è™•ç†å¾Œçš„åç¨±
            if (foundDistrict.trim()) {
              district = foundDistrict.trim();
              break;
            }
          }
        }
        
        // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦å–ç¸£å¸‚å¾Œçš„ç¬¬ä¸€å€‹è©
        if (district === 'æœªå¡«å¯«') {
          const words = afterCity.trim().split(/[\s,ï¼Œ]/);
          if (words.length > 0 && words[0]) {
            let foundDistrict = words[0];
            
            // å¦‚æœé„‰é®å¸‚å€åç¨±åŒ…å«ç¸£å¸‚åç¨±ï¼Œç§»é™¤ç¸£å¸‚åç¨±
            for (const c of cities) {
              if (foundDistrict.includes(c)) {
                foundDistrict = foundDistrict.replace(c, '');
                break;
              }
            }
            
            if (foundDistrict.trim()) {
              district = foundDistrict.trim();
            }
          }
        }
      }
      
      return { city, district };
    }

    function groupByGeography(rows){
      const cityStats = {};
      const cityDistrictStats = {}; // ç¸£å¸‚+é„‰é®å¸‚å€çµ„åˆçµ±è¨ˆ
      const totalPeople = new Set();
      
      // ç”¨æ–¼å»é‡çš„é›†åˆï¼Œæ¯å€‹äººéƒ½åªè¨ˆç®—ä¸€ç­†
      const cityPeople = new Map(); // å„²å­˜ (ç¸£å¸‚, Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      const cityDistrictPeople = new Map(); // å„²å­˜ (ç¸£å¸‚+é„‰é®å¸‚å€, Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      
      rows.forEach(r => {
        // äººå“¡å”¯ä¸€è­˜åˆ¥
        const personKey = `${r.__NAME}||${r['è·å‹™åç¨±ä¸€']||''}||${r.__APPLY}`;
        totalPeople.add(personKey);
        
        // è§£æåœ°å€
        const address = r['é€šè¨Šåœ°å€'] || '';
        const { city, district } = parseAddress(address);
        
        // ç¸£å¸‚çµ±è¨ˆ
        if (city !== 'æœªå¡«å¯«') {
          if (!cityPeople.has(city)) {
            cityPeople.set(city, new Set());
          }
          cityPeople.get(city).add(personKey);
        }
        
        
        // ç¸£å¸‚+é„‰é®å¸‚å€çµ„åˆçµ±è¨ˆ
        if (city !== 'æœªå¡«å¯«' && district !== 'æœªå¡«å¯«') {
          const cityDistrictKey = `${city} - ${district}`;
          if (!cityDistrictPeople.has(cityDistrictKey)) {
            cityDistrictPeople.set(cityDistrictKey, new Set());
          }
          cityDistrictPeople.get(cityDistrictKey).add(personKey);
        }
      });
      
      // è½‰æ›ç‚ºçµ±è¨ˆæ•¸å­—
      for (const [city, peopleSet] of cityPeople.entries()) {
        cityStats[city] = peopleSet.size;
      }
      
      
      for (const [cityDistrict, peopleSet] of cityDistrictPeople.entries()) {
        cityDistrictStats[cityDistrict] = peopleSet.size;
      }
      
      // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
      const topCities = Object.entries(cityStats)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 10)
        .map(([city, count]) => ({ç¸£å¸‚: city, äººæ•¸: count}));
        
        
      const topCityDistricts = Object.entries(cityDistrictStats)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 15)
        .map(([cityDistrict, count]) => ({ç¸£å¸‚é„‰é®: cityDistrict, äººæ•¸: count}));
      
      return {
        topCities,
        topCityDistricts,
        totalPeople: totalPeople.size
      };
    }

    function renderGeographyTable(geographyData, caption){
      const { topCities, topCityDistricts, totalPeople } = geographyData;
      
      const html = `
        <div class="block" style="margin-top:12px;">
          <div class="controls-row" style="justify-content: space-between;">
            <div class="muted">${caption||''}</div>
            <div class="muted">ç¸½äººæ•¸ï¼š${totalPeople.toLocaleString()}</div>
          </div>
          
          <!-- è©³ç´°çµ±è¨ˆè¡¨æ ¼ -->
          <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px;">
            <!-- å‰åå¤§å±…ä½ç¸£å¸‚ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å‰åå¤§å±…ä½ç¸£å¸‚</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">ç¸£å¸‚</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${topCities.map((city, index) => {
                    const percentage = totalPeople > 0 ? ((city.äººæ•¸ / totalPeople) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                          <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                          ${city.ç¸£å¸‚}
                        </td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${city.äººæ•¸.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- ç¸£å¸‚+é„‰é®å¸‚å€çµ„åˆ -->
          <div style="margin-top: 32px;">
            <h4 style="margin: 0 0 16px 0; color: var(--primary);">å‰åäº”å¤§ç¸£å¸‚+é„‰é®å¸‚å€çµ„åˆ</h4>
            <table class="overview-table" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">ç¸£å¸‚+é„‰é®å¸‚å€</th>
                  <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                  <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                </tr>
              </thead>
              <tbody>
                ${topCityDistricts.map((cityDistrict, index) => {
                  const percentage = totalPeople > 0 ? ((cityDistrict.äººæ•¸ / totalPeople) * 100).toFixed(1) : '0.0';
                  return `
                    <tr>
                      <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                        <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                        ${cityDistrict.ç¸£å¸‚é„‰é®}
                      </td>
                      <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${cityDistrict.äººæ•¸.toLocaleString()}</td>
                      <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
      return html;
    }

    function groupByEducation(rows){
      // ä¸»è¦ç•¢æ¥­å­¸æ ¡åˆ†ä½ˆ
      const schoolStats = {};
      const majorStats = {};
      const degreeStats = {};
      const schoolMajorStats = {}; // å­¸æ ¡+ç§‘ç³»çµ„åˆçµ±è¨ˆ
      const targetSchoolStats = { total: 0, target: 0 };
      
      // ç”¨æ–¼å»é‡çš„é›†åˆï¼Œæ¯å€‹äººéƒ½åªè¨ˆç®—ä¸€ç­†
      const uniquePeople = new Set();
      const schoolPeople = new Map(); // å„²å­˜ (å­¸æ ¡, Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      const majorPeople = new Map(); // å„²å­˜ (ç§‘ç³», Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      const schoolMajorPeople = new Map(); // å„²å­˜ (å­¸æ ¡+ç§‘ç³», Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      const degreePeople = new Map(); // å„²å­˜ (å­¸æ­·, Set<äººå“¡å”¯ä¸€è­˜åˆ¥>)
      const targetSchoolPeople = new Set(); // ç›®æ¨™å­¸æ ¡äººå“¡é›†åˆ
      
      rows.forEach(r => {
        // äººå“¡å”¯ä¸€è­˜åˆ¥
        const personKey = `${r.__NAME}||${r['è·å‹™åç¨±ä¸€']||''}||${r.__APPLY}`;
        
        // å¦‚æœé€™å€‹äººå·²ç¶“è¨ˆç®—éï¼Œè·³é
        if (uniquePeople.has(personKey)) return;
        uniquePeople.add(personKey);
        
        // å­¸æ ¡çµ±è¨ˆ
        const school = r['å­¸æ­·å­¸æ ¡åç¨±ä¸€'] || 'æœªå¡«å¯«';
        if (school !== 'æœªå¡«å¯«' && school !== '') {
          if (!schoolPeople.has(school)) {
            schoolPeople.set(school, new Set());
          }
          schoolPeople.get(school).add(personKey);
        }
        
        // ç§‘ç³»çµ±è¨ˆï¼ˆä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„ç§‘ç³»ï¼‰
        const originalMajor = r['å­¸æ­·ç§‘ç³»åç¨±ä¸€'] || 'æœªå¡«å¯«';
        const normalizedMajor = normalizeMajor(originalMajor);
        if (normalizedMajor !== 'æœªå¡«å¯«' && normalizedMajor !== '') {
          if (!majorPeople.has(normalizedMajor)) {
            majorPeople.set(normalizedMajor, new Set());
          }
          majorPeople.get(normalizedMajor).add(personKey);
        }
        
        // å­¸æ ¡+ç§‘ç³»çµ„åˆçµ±è¨ˆ
        if (school !== 'æœªå¡«å¯«' && school !== '' && normalizedMajor !== 'æœªå¡«å¯«' && normalizedMajor !== '') {
          const schoolMajorKey = `${school} - ${normalizedMajor}`;
          if (!schoolMajorPeople.has(schoolMajorKey)) {
            schoolMajorPeople.set(schoolMajorKey, new Set());
          }
          schoolMajorPeople.get(schoolMajorKey).add(personKey);
        }
        
        // å­¸æ­·ç­‰ç´šçµ±è¨ˆï¼ˆä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„å­¸æ­·ï¼‰
        const originalDegree = r['å­¸æ­·ä¸€'] || 'æœªå¡«å¯«';
        const normalizedDegree = normalizeDegree(originalDegree);
        if (normalizedDegree !== 'æœªå¡«å¯«' && normalizedDegree !== '') {
          if (!degreePeople.has(normalizedDegree)) {
            degreePeople.set(normalizedDegree, new Set());
          }
          degreePeople.get(normalizedDegree).add(personKey);
        }
        
        // ç›®æ¨™å­¸æ ¡çµ±è¨ˆ
        targetSchoolStats.total++;
        const isTarget = r['ç›®æ¨™å­¸æ ¡'] === 'Y';
        if (isTarget) {
          targetSchoolStats.target++;
          targetSchoolPeople.add(personKey);
        }
      });
      
      // è½‰æ›ç‚ºçµ±è¨ˆæ•¸å­—
      for (const [school, peopleSet] of schoolPeople.entries()) {
        schoolStats[school] = peopleSet.size;
      }
      
      for (const [major, peopleSet] of majorPeople.entries()) {
        majorStats[major] = peopleSet.size;
      }
      
      for (const [schoolMajor, peopleSet] of schoolMajorPeople.entries()) {
        schoolMajorStats[schoolMajor] = peopleSet.size;
      }
      
      for (const [degree, peopleSet] of degreePeople.entries()) {
        degreeStats[degree] = peopleSet.size;
      }
      
      // é‡æ–°è¨ˆç®—ç›®æ¨™å­¸æ ¡çµ±è¨ˆï¼ˆåŸºæ–¼å”¯ä¸€äººå“¡ï¼‰
      targetSchoolStats.total = uniquePeople.size;
      targetSchoolStats.target = targetSchoolPeople.size;
      
      // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
      const topSchools = Object.entries(schoolStats)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 10)
        .map(([school, count]) => ({å­¸æ ¡: school, äººæ•¸: count}));
        
      const topMajors = Object.entries(majorStats)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 10)
        .map(([major, count]) => ({ç§‘ç³»: major, äººæ•¸: count}));
        
      const topSchoolMajors = Object.entries(schoolMajorStats)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 10)
        .map(([schoolMajor, count]) => ({å­¸æ ¡ç§‘ç³»: schoolMajor, äººæ•¸: count}));
        
      const degreeDistribution = Object.entries(degreeStats)
        .sort((a,b) => b[1] - a[1])
        .map(([degree, count]) => ({å­¸æ­·: degree, äººæ•¸: count}));
      
      return {
        topSchools,
        topMajors,
        topSchoolMajors,
        degreeDistribution,
        targetSchoolStats
      };
    }

    function renderEducationTable(educationData, caption){
      const { topSchools, topMajors, topSchoolMajors, degreeDistribution, targetSchoolStats } = educationData;
      const totalPeople = targetSchoolStats.total;
      const targetPercentage = totalPeople > 0 ? ((targetSchoolStats.target / totalPeople) * 100).toFixed(1) : '0.0';
      
      const html = `
        <div class="block" style="margin-top:12px;">
          <div class="controls-row" style="justify-content: space-between;">
            <div class="muted">${caption||''}</div>
            <div class="muted">ç¸½äººæ•¸ï¼š${totalPeople.toLocaleString()}</div>
          </div>
          
          <!-- ç›®æ¨™å­¸æ ¡æˆæ•ˆåˆ†æ -->
          <div style="margin-bottom: 32px;">
            <h4 style="margin: 0 0 16px 0; color: var(--primary);">ç›®æ¨™å­¸æ ¡æˆæ•ˆåˆ†æ</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
              <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${targetSchoolStats.target.toLocaleString()}</div>
                <div style="font-size: 14px; color: var(--muted);">ç›®æ¨™å­¸æ ¡äººæ•¸</div>
              </div>
              <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${targetPercentage}%</div>
                <div style="font-size: 14px; color: var(--muted);">ç›®æ¨™å­¸æ ¡ä½”æ¯”</div>
              </div>
            </div>
          </div>
          
          <!-- è©³ç´°çµ±è¨ˆè¡¨æ ¼ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <!-- å‰åå¤§ç•¢æ¥­å­¸æ ¡ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å‰åå¤§ç•¢æ¥­å­¸æ ¡</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å­¸æ ¡åç¨±</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${topSchools.map((school, index) => {
                    const percentage = totalPeople > 0 ? ((school.äººæ•¸ / totalPeople) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                          <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                          ${school.å­¸æ ¡}
                        </td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${school.äººæ•¸.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- å‰åå¤§ç•¢æ¥­ç§‘ç³» -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å‰åå¤§ç•¢æ¥­ç§‘ç³»</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">ç§‘ç³»åç¨±</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${topMajors.map((major, index) => {
                    const percentage = totalPeople > 0 ? ((major.äººæ•¸ / totalPeople) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                          <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                          ${major.ç§‘ç³»}
                        </td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${major.äººæ•¸.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- å­¸æ­·ç­‰ç´šåˆ†ä½ˆ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å­¸æ­·ç­‰ç´šåˆ†ä½ˆ</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å­¸æ­·ç­‰ç´š</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${degreeDistribution.map((degree, index) => {
                    const percentage = totalPeople > 0 ? ((degree.äººæ•¸ / totalPeople) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${degree.å­¸æ­·}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${degree.äººæ•¸.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- å‰åå¤§å­¸æ ¡+ç§‘ç³»çµ„åˆ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å‰åå¤§å­¸æ ¡+ç§‘ç³»çµ„åˆ</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å­¸æ ¡+ç§‘ç³»</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${topSchoolMajors.map((schoolMajor, index) => {
                    const percentage = totalPeople > 0 ? ((schoolMajor.äººæ•¸ / totalPeople) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                          <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                          <a href="#" class="school-major-link" data-school-major="${escapeHtml(schoolMajor.å­¸æ ¡ç§‘ç³»)}" style="color: var(--accent); text-decoration: underline; cursor: pointer; font-weight: 600;">${schoolMajor.å­¸æ ¡ç§‘ç³»}</a>
                        </td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${schoolMajor.äººæ•¸.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>`;
      return html;
    }

    function renderTable(arr, caption, monthTag){
      const tableId = 'tbl_' + Math.random().toString(36).slice(2);
      const html = `
        <div class="block" data-month="${monthTag||''}" style="margin-top:12px;">
          <div class=\"controls-row\" style=\"justify-content: space-between;\">
            <div class=\"muted\">${caption||''}</div>
            <div class=\"muted\">å…¬å¸æ•¸ï¼š${arr.length.toLocaleString()}</div>
          </div>
          <table id="${tableId}">
            <thead>
              <tr>
                <th data-k="å…¬å¸">å…¬å¸åç¨±</th>
                <th data-k="äººæ•¸" class="right">äººæ•¸</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r=>`
                <tr>
                  <td><a href="#" class="company-link" data-company="${escapeHtml(r.å…¬å¸)}">${escapeHtml(r.å…¬å¸)}</a></td>
                  <td class="right">${r.äººæ•¸.toLocaleString()}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      return html;
    }


    
    function getExperienceColor(experience) {
      const colors = {
        'ç„¡': '#90EE90',
        '2å¹´ä»¥ä¸‹': '#28a745',
        '2-5å¹´': '#007bff',
        '5-8å¹´': '#ffc107',
        '8-11å¹´': '#fd7e14',
        '11-14å¹´': '#dc3545',
        '14-17å¹´': '#dc3545',
        '17-20å¹´': '#dc3545',
        '20-23å¹´': '#dc3545',
        '23-26å¹´': '#dc3545'
      };
      return colors[experience] || '#dc3545';
    }

    function renderExperienceTable(arr, caption){
      const tableId = 'exp_tbl_' + Math.random().toString(36).slice(2);
      const totalPeople = arr.reduce((sum, item) => sum + item.äººæ•¸, 0);
      const maxCount = Math.max(...arr.map(item => item.äººæ•¸));
      const yAxisMax = Math.ceil(maxCount * 1.5); // yè»¸æœ€å¤§å€¼è¨­ç‚ºå¯¦éš›æœ€å¤§å€¼çš„1.5å€
      
      const html = `
        <div class="block" style="margin-top:12px;">
          <div class=\"controls-row\" style=\"justify-content: space-between;\">
            <div class=\"muted\">${caption||''}</div>
            <div class=\"muted\">å¹´è³‡å€é–“æ•¸ï¼š${arr.length.toLocaleString()} | ç¸½äººæ•¸ï¼š${totalPeople.toLocaleString()}</div>
          </div>
          <table id="${tableId}">
            <thead>
              <tr>
                <th data-k="å¹´è³‡">å¹´è³‡å€é–“</th>
                <th data-k="äººæ•¸" class="right">äººæ•¸</th>
                <th data-k="ä½”æ¯”" class="right">ä½”æ¯”</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r=>`
                <tr>
                  <td>${escapeHtml(r.å¹´è³‡)}</td>
                  <td class="right">${r.äººæ•¸.toLocaleString()}</td>
                  <td class="right">${r.ä½”æ¯”}%</td>
                </tr>`).join('')}
            </tbody>
          </table>
          
          <!-- ç›´æ–¹åœ– -->
          <div class="histogram-container" style="margin-top: 24px;">
            <div class="histogram-title" style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 16px;">
              å¹´è³‡åˆ†å¸ƒç›´æ–¹åœ–
            </div>
            <div class="histogram" style="display: flex; align-items: end; gap: 8px; height: 200px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
              ${arr.map((item, index) => {
                const height = (item.äººæ•¸ / yAxisMax) * 160; // æœ€å¤§é«˜åº¦160pxï¼ŒåŸºæ–¼yè»¸æœ€å¤§å€¼è¨ˆç®—
                const color = index === 0 ? '#90EE90' : // ç„¡ - æ·¡ç¶ è‰²
                              index === 1 ? '#28a745' : // 2å¹´ä»¥ä¸‹ - ç¶ è‰²
                              index === 2 ? '#007bff' : // 2-5å¹´ - è—è‰²
                              index === 3 ? '#ffc107' : // 5-8å¹´ - é»ƒè‰²
                              index === 4 ? '#fd7e14' : // 8-11å¹´ - æ©™è‰²
                              '#dc3545'; // å…¶ä»– - ç´…è‰²
                return `
                  <div class="histogram-bar" style="display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 0;">
                    <div class="bar" style="
                      width: 100%; 
                      height: ${height}px; 
                      background: ${color}; 
                      border-radius: 4px 4px 0 0;
                      transition: all 0.3s ease;
                      cursor: pointer;
                      position: relative;
                    " 
                    onmouseover="this.style.opacity='0.8'; this.style.transform='scale(1.05)'"
                    onmouseout="this.style.opacity='1'; this.style.transform='scale(1)'"
                    title="${item.å¹´è³‡}: ${item.äººæ•¸.toLocaleString()}äºº (${item.ä½”æ¯”}%)">
                    </div>
                    <div class="bar-label" style="
                      font-size: 12px; 
                      color: var(--muted); 
                      margin-top: 8px; 
                      text-align: center;
                      writing-mode: horizontal-tb;
                      word-break: break-all;
                      line-height: 1.2;
                      max-width: 100%;
                      font-weight: 500;
                    ">${item.å¹´è³‡}</div>
                    <div class="bar-value" style="
                      font-size: 11px; 
                      color: var(--primary); 
                      margin-top: 4px; 
                      text-align: center;
                      font-weight: 600;
                    ">${item.äººæ•¸.toLocaleString()}</div>
                  </div>
                `;
              }).join('')}
            </div>
            
          </div>
        </div>`;
      return html;
    }

    function escapeHtml(s){
      return (s==null?'':String(s))
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/\"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function updateBadges(rows){
      const uniqCompany = new Set(rows.map(r=>r.__COMP));
      const uniqName = new Set(rows.map(r=>r.__NAME));
      const badge = (label, val) => `<span class="chip"><strong>${label}ï¼š</strong> ${val.toLocaleString()}</span>`;
      $statusBadges.innerHTML = [ badge('ç­†æ•¸', rows.length), badge('å…¬å¸æ•¸', uniqCompany.size), badge('å€™é¸äººæ•¸(å»é‡å§“å)', uniqName.size) ].join(' ');
    }

    function toCsv(rows){
      const header = ['å…¬å¸','äººæ•¸'];
      const lines = [header.join(',')];
      rows.forEach(r=>{ const cc = '"' + (r.å…¬å¸||'').replace(/\"/g,'\"\"') + '"'; lines.push([cc, r.äººæ•¸].join(',')); });
      return lines.join('\n');
    }

    function renderOverviewTable(rows){
      const totalRecords = rows.length;
      const uniqueCandidates = new Set(rows.map(r=>r.__NAME)).size;
      const avgApplicationsPerPerson = uniqueCandidates > 0 ? (totalRecords / uniqueCandidates).toFixed(1) : 0;
      
      // å¹´è³‡åˆ†å¸ƒï¼ˆä½¿ç”¨èˆ‡å¹´è³‡çµ±è¨ˆç›¸åŒçš„è¨ˆç®—åŸºç¤ï¼‰
      const experienceAgg = groupByExperience(rows);
      
      // å‰äº”å¤§ä¾†æºå…¬å¸ï¼ˆä½¿ç”¨èˆ‡å…¬å¸çµ±è¨ˆç›¸åŒçš„è¨ˆç®—åŸºç¤ï¼‰
      const companyAgg = groupByCompany(rows);
      const top5Companies = companyAgg.slice(0, 5);
      
      // å‰äº”å¤§ç•¢æ¥­å­¸æ ¡
      const schoolStats = {};
      rows.forEach(r => {
        const school = r['å­¸æ ¡NEW'] || 'æœªå¡«å¯«';
        if (school !== 'æœªå¡«å¯«' && school !== '') {
          schoolStats[school] = (schoolStats[school] || 0) + 1;
        }
      });
      const top5Schools = Object.entries(schoolStats)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 5)
        .map(([school, count]) => ({å­¸æ ¡: school, äººæ•¸: count}));
      
      // æŒ‰æœˆä»½çµ±è¨ˆ
      const monthStats = {};
      rows.forEach(r => {
        const month = r.__MONTH || 'æœªçŸ¥';
        monthStats[month] = (monthStats[month] || 0) + 1;
      });
      
      // æŒ‰è·ç³»çµ±è¨ˆ
      const idlStats = {};
      rows.forEach(r => {
        const idl = r.__IDL || 'æœªçŸ¥';
        idlStats[idl] = (idlStats[idl] || 0) + 1;
      });
      
      // æŒ‰åŠŸèƒ½çµ±è¨ˆ
      const funcStats = {};
      rows.forEach(r => {
        const func = r.__FUNC_LABEL || 'æœªçŸ¥';
        funcStats[func] = (funcStats[func] || 0) + 1;
      });
      
      // æŒ‰å» å€çµ±è¨ˆ
      const locStats = {};
      rows.forEach(r => {
        const loc = r.__LOC_LABEL || 'æœªçŸ¥';
        locStats[loc] = (locStats[loc] || 0) + 1;
      });

      const html = `
        <div class="block" style="margin-top:12px;">
          <div class="controls-row" style="justify-content: space-between;">
            <div class="muted">æ•´é«”åˆ†ææ¦‚è¦½</div>
          </div>
          
          <!-- åŸºæœ¬çµ±è¨ˆ -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 16px 0;">
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${totalRecords.toLocaleString()}</div>
              <div style="font-size: 14px; color: var(--muted);">ç¸½ç­†æ•¸</div>
            </div>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${uniqueCandidates.toLocaleString()}</div>
              <div style="font-size: 14px; color: var(--muted);">å€™é¸äººæ•¸</div>
            </div>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${avgApplicationsPerPerson}</div>
              <div style="font-size: 14px; color: var(--muted);">å¹³å‡æ¯äººæŠ•éæ•¸</div>
            </div>
          </div>
          
          <!-- è©³ç´°çµ±è¨ˆè¡¨æ ¼ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <!-- å¹´è³‡åˆ†å¸ƒ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å¹´è³‡åˆ†å¸ƒ</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å¹´è³‡å€é–“</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${experienceAgg.map(item => `
                    <tr>
                      <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${item.å¹´è³‡}</td>
                      <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${item.äººæ•¸.toLocaleString()}</td>
                      <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${item.ä½”æ¯”}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- åŠŸèƒ½åˆ†å¸ƒ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">åŠŸèƒ½åˆ†å¸ƒ</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">åŠŸèƒ½</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ç­†æ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(funcStats).sort((a,b) => b[1] - a[1]).map(([func, count]) => {
                    const percentage = totalRecords > 0 ? ((count / totalRecords) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${func}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${count.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- å‰äº”å¤§ä¾†æºå…¬å¸ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å‰äº”å¤§ä¾†æºå…¬å¸</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å…¬å¸åç¨±</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${top5Companies.map((company, index) => {
                    const percentage = uniqueCandidates > 0 ? ((company.äººæ•¸ / uniqueCandidates) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                          <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                          ${company.å…¬å¸}
                        </td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${company.äººæ•¸.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- å‰äº”å¤§ç•¢æ¥­å­¸æ ¡ -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: var(--primary);">å‰äº”å¤§ç•¢æ¥­å­¸æ ¡</h4>
              <table class="overview-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å­¸æ ¡åç¨±</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">ä½”æ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  ${top5Schools.map((school, index) => {
                    const percentage = uniqueCandidates > 0 ? ((school.äººæ•¸ / uniqueCandidates) * 100).toFixed(1) : '0.0';
                    return `
                      <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                          <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                          ${school.å­¸æ ¡}
                        </td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${school.äººæ•¸.toLocaleString()}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${percentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- æœˆä»½æ‡‰å¾µç­†æ•¸ç›´æ–¹åœ– -->
          <div style="margin-top: 32px;">
            <h4 style="margin: 0 0 16px 0; color: var(--primary);">æœˆä»½æ‡‰å¾µç­†æ•¸åˆ†å¸ƒ</h4>
            <div class="month-histogram-container" style="margin-top: 16px;">
              <div class="month-histogram" style="display: flex; align-items: end; gap: 8px; height: 320px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                ${(() => {
                  const entries = Object.entries(monthStats).sort((a,b) => {
                    const monthOrder = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                    return monthOrder.indexOf(a[0]) - monthOrder.indexOf(b[0]);
                  });
                  const counts = entries.map(e => e[1] || 0);
                  const maxCount = Math.max(...counts, 1);
                  const yAxisMax = Math.ceil(maxCount * 1.2); // 20% headroom
                  const maxBarHeight = 260; // px, fits within the container height (320px with padding)
                  const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8', '#343a40', '#f8f9fa'];
                  return entries.map(([month, count], index) => {
                    const h = count > 0 ? (count / yAxisMax) * maxBarHeight : 0;
                    const color = colors[index % colors.length];
                    return `
                      <div class="month-histogram-bar" style="display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 0;">
                        <div class="bar" style="
                          width: 100%; 
                          height: ${h}px; 
                          background: ${color}; 
                          border-radius: 4px 4px 0 0;
                          transition: all 0.3s ease;
                          cursor: pointer;
                          position: relative;
                        " 
                        onmouseover="this.style.opacity='0.8'; this.style.transform='scale(1.05)'"
                        onmouseout="this.style.opacity='1'; this.style.transform='scale(1)'"
                        title="${month}: ${count.toLocaleString()}ç­†">
                        </div>
                        <div class="bar-label" style="
                          font-size: 12px; 
                          color: var(--muted); 
                          margin-top: 8px; 
                          text-align: center;
                          writing-mode: horizontal-tb;
                          word-break: break-all;
                          line-height: 1.2;
                          max-width: 100%;
                          font-weight: 500;
                        ">${month}</div>
                        <div class="bar-value" style="
                          font-size: 11px; 
                          color: var(--primary); 
                          margin-top: 4px; 
                          text-align: center;
                          font-weight: 600;
                        ">${count.toLocaleString()}</div>
                      </div>
                    `;
                  }).join('');
                })()}
              </div>
            </div>
          </div>
        </div>`;
      
      return html;
    }

    function update(){
      if(data.length===0){ 
        $output.innerHTML=''; 
        $experienceOutput.innerHTML='';
        $overviewOutput.innerHTML='';
        $educationOutput.innerHTML='';
        $geographyOutput.innerHTML='';
        updateJobAnalysis();
        return; 
      }
      const rows = filteredRows();
      updateBadges(rows);

      // æ›´æ–°å…¬å¸çµ±è¨ˆ
      let companyHtml = '';
      if(mode===MODE.TOTAL){
        const agg = groupByCompany(rows);
        companyHtml += renderTable(agg, 'ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹çš„å…¬å¸åˆ†å¸ƒ', '');
        $download.onclick = ()=> downloadBlob(toCsv(agg), generateFilename());
      } else {
        const byM = groupByMonth(rows);
        const chunks = byM.map(({month, rows})=> renderTable(groupByCompany(rows), `æœˆä»½ï¼š${month}`, month));
        companyHtml += chunks.join('');
        $download.onclick = ()=>{
          const blocks = [];
          blocks.push('æœˆä»½,å…¬å¸,äººæ•¸');
          byM.forEach(({month, rows})=>{
            const agg = groupByCompany(rows);
            agg.forEach(r=>{ const c = '"' + (r.å…¬å¸||'').replace(/\"/g,'\"\"') + '"'; blocks.push([month, c, r.äººæ•¸].join(',')); });
          });
          downloadBlob(blocks.join('\n'), generateFilename());
        };
      }
      $output.innerHTML = companyHtml;

      // æ›´æ–°æ•´é«”åˆ†æ
      const overviewHtml = renderOverviewTable(rows);
      $overviewOutput.innerHTML = overviewHtml;

      // æ›´æ–°å¹´è³‡çµ±è¨ˆ
      const experienceAgg = groupByExperience(rows);
      const experienceHtml = renderExperienceTable(experienceAgg, 'ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹çš„å¹´è³‡åˆ†å¸ƒ');
      $experienceOutput.innerHTML = experienceHtml;

  // æ›´æ–°è·å‹™çµ±è¨ˆï¼ˆå¯åœ¨è·å‹™çµ±è¨ˆé é¢æŸ¥çœ‹ï¼‰
  if(typeof updateJobStatistics === 'function') updateJobStatistics(rows);

      // æ›´æ–°å­¸æ­·åˆ†æ
      const educationAgg = groupByEducation(rows);
      const educationHtml = renderEducationTable(educationAgg, 'ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹çš„å­¸æ­·åˆ†æ');
      $educationOutput.innerHTML = educationHtml;

      // æ›´æ–°åœ°ç†åˆ†æ
      const geographyAgg = groupByGeography(rows);
      const geographyHtml = renderGeographyTable(geographyAgg, 'ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹çš„åœ°ç†åˆ†æ');
      $geographyOutput.innerHTML = geographyHtml;
      
      // æ›´æ–°è·å‹™åˆ†æ
      updateJobFilterOptions();
      updateJobAnalysis();
    }

    function downloadBlob(text, filename){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function generateFilename(){
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `104result-${year}-${month}-${day}.csv`;
    }

    // --- Company click â†’ modal ---
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a.company-link');
      if(!a) return; e.preventDefault();
      const company = a.getAttribute('data-company');
      const block = a.closest('.block');
      const monthTag = block?.getAttribute('data-month') || '';
      openCandidateModal(company, monthTag);
    });

    // --- School+Major click â†’ modal ---
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a.school-major-link');
      if(!a) return; e.preventDefault();
      const schoolMajor = a.getAttribute('data-school-major');
      openSchoolMajorModal(schoolMajor);
    });

    function openCandidateModal(company, monthTag){
      let rows = filteredRows();
      if(monthTag){ rows = rows.filter(r=> r.__MONTH === monthTag); }
      
      // ä½¿ç”¨èˆ‡ä¸»è¡¨æ ¼ç›¸åŒçš„åˆä½µé‚è¼¯ï¼šè²¡åœ˜æ³•äººç”¨8å€‹å­—ï¼Œå…¶ä»–ç”¨4å€‹å­—
      const companyPrefix = company.startsWith('è²¡åœ˜æ³•äºº') ? 
        company.substring(0, 8) : 
        company.substring(0, 4);
      
      rows = rows.filter(r=> {
        const compName = r.__COMP || '';
        const compPrefix = compName.startsWith('è²¡åœ˜æ³•äºº') ? 
          compName.substring(0, 8) : 
          compName.substring(0, 4);
        return compPrefix === companyPrefix;
      });
      rows.sort((a,b)=> (b.__APPLY||'').localeCompare(a.__APPLY||''));

      // è¨ˆç®—ä¸é‡è¤‡çš„äººæ•¸ï¼ˆèˆ‡ä¸»è¡¨æ ¼çµ±è¨ˆä¸€è‡´ï¼‰
      const uniquePeople = new Set();
      for(const r of rows) {
        const personKey = `${r.__NAME}||${r['è·å‹™åç¨±ä¸€']||''}||${r.__APPLY}`;
        uniquePeople.add(personKey);
      }

      $modalTitle.textContent = `äººé¸æ¸…å–®ï¼š${company}`;
      const filtersTxt = [ monthTag? `æœˆä»½ï¼š${monthTag}`: 'æœˆä»½ï¼šå¤šé¸', `IDL/DLï¼š${Array.from(selectedIDL).join('ã€')||'â€”'}`, `Functionï¼š${Array.from(selectedFuncs).join('ã€')||'â€”'}`, `åœ°é»ï¼š${Array.from(selectedLocs).join('ã€')||'â€”'}` ].join('ï½œ');
      $modalMeta.textContent = `å…± ${uniquePeople.size} äººï¼ˆ${rows.length} ç­†è¨˜éŒ„ï¼‰`;
      $modalFilters.textContent = filtersTxt;

      $modalTbody.innerHTML = rows.map(r=>{
        return `<tr>
          <td>${escapeHtml(r.__MONTH)}</td>
          <td>${escapeHtml(r.__NAME)}</td>
          <td>${escapeHtml((r['è·å‹™åç¨±ä¸€']||'') + ' ' + (r.__IDL||''))}</td>
          <td>${escapeHtml(r['å¹´è³‡']||'')}</td>
          <td>${escapeHtml(r.__COMP)}</td>
          <td>${escapeHtml(r['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±']||'')}</td>
          <td>${escapeHtml(r['å­¸æ ¡NEW']||'')}</td>
          <td>${escapeHtml(r['å­¸æ­·ç§‘ç³»åç¨±ä¸€']||'')}</td>
          <td>${escapeHtml(r.__FUNC_LABEL||'')}</td>
        </tr>`;
      }).join('');
      
      // æ·»åŠ æ’åºåŠŸèƒ½
      setupModalTableSorting(rows);

      $btnExportCandidates.onclick = ()=>{
        const header = ["æœˆä»½","å§“å","è·å‹™åç¨± IDL/DL","å¹´è³‡","å…¬å¸ï¼ˆå·¥ä½œç¶“é©—ä¸€ï¼‰","å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±","å­¸æ ¡NEW","å­¸æ­·ç§‘ç³»åç¨±ä¸€","è·ç¼º function"];
        const lines = [header.join(',')];
        rows.forEach(r=>{
          const line = [ r.__MONTH, r.__NAME, (r['è·å‹™åç¨±ä¸€']||'') + ' ' + (r.__IDL||''), r['å¹´è³‡']||'', r.__COMP, r['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±']||'', r['å­¸æ ¡NEW']||'', r['å­¸æ­·ç§‘ç³»åç¨±ä¸€']||'', r.__FUNC_LABEL||'' ]
            .map(v=> '"' + String(v||'').replace(/\"/g,'\"\"') + '"').join(',');
          lines.push(line);
        });
        downloadBlob(lines.join('\n'), `candidates_${company}.csv`);
      }

      $modalBackdrop.style.display = 'flex';
      $modalBackdrop.setAttribute('aria-hidden','false');
    }

    function openSchoolMajorModal(schoolMajor){
      let rows = filteredRows();
      
      // è§£æå­¸æ ¡+ç§‘ç³»çµ„åˆ
      const [school, major] = schoolMajor.split(' - ');
      
      // ç¯©é¸å‡ºç¬¦åˆè©²å­¸æ ¡+ç§‘ç³»çµ„åˆçš„äººé¸
      rows = rows.filter(r=> {
        const candidateSchool = r['å­¸æ­·å­¸æ ¡åç¨±ä¸€'] || '';
        const candidateMajor = normalizeMajor(r['å­¸æ­·ç§‘ç³»åç¨±ä¸€'] || '');
        return candidateSchool === school && candidateMajor === major;
      });
      
      rows.sort((a,b)=> (b.__APPLY||'').localeCompare(a.__APPLY||''));

      // è¨ˆç®—ä¸é‡è¤‡çš„äººæ•¸
      const uniquePeople = new Set();
      for(const r of rows) {
        const personKey = `${r.__NAME}||${r['è·å‹™åç¨±ä¸€']||''}||${r.__APPLY}`;
        uniquePeople.add(personKey);
      }

      $modalTitle.textContent = `äººé¸æ¸…å–®ï¼š${schoolMajor}`;
      const filtersTxt = [ 
        `æœˆä»½ï¼š${Array.from(selectedMonths).join('ã€')||'â€”'}`, 
        `IDL/DLï¼š${Array.from(selectedIDL).join('ã€')||'â€”'}`, 
        `Functionï¼š${Array.from(selectedFuncs).join('ã€')||'â€”'}`, 
        `åœ°é»ï¼š${Array.from(selectedLocs).join('ã€')||'â€”'}`,
        isNewcomerFilterActive ? 'æ–°é€²äººå“¡ç¯©é¸ï¼šå•Ÿç”¨' : ''
      ].filter(Boolean).join('ï½œ');
      $modalMeta.textContent = `å…± ${uniquePeople.size} äººï¼ˆ${rows.length} ç­†è¨˜éŒ„ï¼‰`;
      $modalFilters.textContent = filtersTxt;

      $modalTbody.innerHTML = rows.map(r=>{
        return `<tr>
          <td>${escapeHtml(r.__MONTH)}</td>
          <td>${escapeHtml(r.__NAME)}</td>
          <td>${escapeHtml((r['è·å‹™åç¨±ä¸€']||'') + ' ' + (r.__IDL||''))}</td>
          <td>${escapeHtml(r['å¹´è³‡']||'')}</td>
          <td>${escapeHtml(r.__COMP)}</td>
          <td>${escapeHtml(r['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±']||'')}</td>
          <td>${escapeHtml(r['å­¸æ ¡NEW']||'')}</td>
          <td>${escapeHtml(r['å­¸æ­·ç§‘ç³»åç¨±ä¸€']||'')}</td>
          <td>${escapeHtml(r.__FUNC_LABEL||'')}</td>
        </tr>`;
      }).join('');
      
      // æ·»åŠ æ’åºåŠŸèƒ½
      setupModalTableSorting(rows);

      $btnExportCandidates.onclick = ()=>{
        const header = ["æœˆä»½","å§“å","è·å‹™åç¨± IDL/DL","å¹´è³‡","å…¬å¸ï¼ˆå·¥ä½œç¶“é©—ä¸€ï¼‰","å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±","å­¸æ ¡NEW","å­¸æ­·ç§‘ç³»åç¨±ä¸€","è·ç¼º function"];
        const lines = [header.join(',')];
        rows.forEach(r=>{
          const line = [ r.__MONTH, r.__NAME, (r['è·å‹™åç¨±ä¸€']||'') + ' ' + (r.__IDL||''), r['å¹´è³‡']||'', r.__COMP, r['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±']||'', r['å­¸æ ¡NEW']||'', r['å­¸æ­·ç§‘ç³»åç¨±ä¸€']||'', r.__FUNC_LABEL||'' ]
            .map(v=> '"' + String(v||'').replace(/\"/g,'\"\"') + '"').join(',');
          lines.push(line);
        });
        downloadBlob(lines.join('\n'), `candidates_${schoolMajor.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}.csv`);
      }

      $modalBackdrop.style.display = 'flex';
      $modalBackdrop.setAttribute('aria-hidden','false');
    }

    function closeModal(){ $modalBackdrop.style.display = 'none'; $modalBackdrop.setAttribute('aria-hidden','true'); }
    [$modalClose, $btnClose].forEach(el=> el.addEventListener('click', closeModal));
    $modalBackdrop.addEventListener('click', (e)=>{ if(e.target === $modalBackdrop) closeModal(); });

    // è¡¨æ ¼æ’åºåŠŸèƒ½
    let currentSortColumn = -1;
    let currentSortDirection = 'asc';
    let modalRows = [];

    function setupModalTableSorting(rows) {
      modalRows = rows;
      const headers = $modalTbody.closest('table').querySelectorAll('thead th');
      
      headers.forEach((header, index) => {
        header.classList.add('sortable');
        header.addEventListener('click', () => sortModalTable(index));
      });
    }

    function sortModalTable(columnIndex) {
      const headers = $modalTbody.closest('table').querySelectorAll('thead th');
      
      // é‡ç½®æ‰€æœ‰æ¨™é¡Œçš„æ’åºç‹€æ…‹
      headers.forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
      });
      
      // å¦‚æœé»æ“ŠåŒä¸€æ¬„ä½ï¼Œåˆ‡æ›æ’åºæ–¹å‘
      if (currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortDirection = 'asc';
        currentSortColumn = columnIndex;
      }
      
      // è¨­å®šç•¶å‰æ¨™é¡Œçš„æ’åºç‹€æ…‹
      headers[columnIndex].classList.add(`sort-${currentSortDirection}`);
      
      // æ’åºè³‡æ–™
      const sortedRows = [...modalRows].sort((a, b) => {
        let valueA, valueB;
        
        switch(columnIndex) {
          case 0: // æœˆä»½
            valueA = a.__MONTH || '';
            valueB = b.__MONTH || '';
            break;
          case 1: // å§“å
            valueA = a.__NAME || '';
            valueB = b.__NAME || '';
            break;
          case 2: // è·å‹™åç¨±
            valueA = (a['è·å‹™åç¨±ä¸€']||'') + ' ' + (a.__IDL||'');
            valueB = (b['è·å‹™åç¨±ä¸€']||'') + ' ' + (b.__IDL||'');
            break;
          case 3: // å¹´è³‡
            valueA = a['å¹´è³‡'] || '';
            valueB = b['å¹´è³‡'] || '';
            break;
          case 4: // å…¬å¸
            valueA = a.__COMP || '';
            valueB = b.__COMP || '';
            break;
          case 5: // å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±
            valueA = a['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±'] || '';
            valueB = b['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±'] || '';
            break;
          case 6: // å­¸æ ¡
            valueA = a['å­¸æ ¡NEW'] || '';
            valueB = b['å­¸æ ¡NEW'] || '';
            break;
          case 7: // å­¸æ­·ç§‘ç³»
            valueA = a['å­¸æ­·ç§‘ç³»åç¨±ä¸€'] || '';
            valueB = b['å­¸æ­·ç§‘ç³»åç¨±ä¸€'] || '';
            break;
          case 8: // è·ç¼ºfunction
            valueA = a.__FUNC_LABEL || '';
            valueB = b.__FUNC_LABEL || '';
            break;
          default:
            return 0;
        }
        
        // å­—ä¸²æ¯”è¼ƒ
        const comparison = valueA.localeCompare(valueB, 'zh-Hant');
        return currentSortDirection === 'asc' ? comparison : -comparison;
      });
      
      // é‡æ–°æ¸²æŸ“è¡¨æ ¼
      $modalTbody.innerHTML = sortedRows.map(r=>{
        return `<tr>
          <td>${escapeHtml(r.__MONTH)}</td>
          <td>${escapeHtml(r.__NAME)}</td>
          <td>${escapeHtml((r['è·å‹™åç¨±ä¸€']||'') + ' ' + (r.__IDL||''))}</td>
          <td>${escapeHtml(r['å¹´è³‡']||'')}</td>
          <td>${escapeHtml(r.__COMP)}</td>
          <td>${escapeHtml(r['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±']||'')}</td>
          <td>${escapeHtml(r['å­¸æ ¡NEW']||'')}</td>
          <td>${escapeHtml(r['å­¸æ­·ç§‘ç³»åç¨±ä¸€']||'')}</td>
          <td>${escapeHtml(r.__FUNC_LABEL||'')}</td>
        </tr>`;
      }).join('');
    }


    // è·å‹™åˆ†æç›¸é—œå‡½æ•¸
  // histogram mode: 'week' or 'month'
  window.jobHistMode = 'week';
    function initJobAnalysis() {
      if (data.length === 0) return;
      
      // åˆå§‹åŒ–è·å‹™ç¯©é¸å™¨é¸é …
      updateJobFilterOptions();
      // è¨­å®šæŒ‰éˆ•äº‹ä»¶
      const btnMonth = document.getElementById('jobHistByMonth');
      const btnWeek = document.getElementById('jobHistByWeek');
      if(btnMonth && btnWeek){
        btnMonth.addEventListener('click', ()=>{
          window.jobHistMode = 'month';
          btnMonth.className = 'btn accent'; btnMonth.style.background = 'var(--accent)'; btnMonth.style.color='white'; btnMonth.style.border='none';
          btnWeek.className = 'btn'; btnWeek.style.background = '#f8f9fa'; btnWeek.style.color='var(--text)'; btnWeek.style.border='1px solid var(--card-border)';
          updateJobAnalysis();
        });
        btnWeek.addEventListener('click', ()=>{
          window.jobHistMode = 'week';
          btnWeek.className = 'btn accent'; btnWeek.style.background = 'var(--accent)'; btnWeek.style.color='white'; btnWeek.style.border='none';
          btnMonth.className = 'btn'; btnMonth.style.background = '#f8f9fa'; btnMonth.style.color='var(--text)'; btnMonth.style.border='1px solid var(--card-border)';
          updateJobAnalysis();
        });
      }
    }

    function renderJobMonthlyHistogram(monthArr){
      if(!monthArr || monthArr.length===0) return '<div style="color: var(--muted); padding: 12px;">ç„¡æœˆä»½è³‡æ–™</div>';
      const max = Math.max(...monthArr.map(i=>i.count));
      const maxBar = 200;
      return `
        <div style="margin-top:16px;">
          <h5 style="margin:0 0 8px 0; color: var(--primary);">æœˆä»½æ‡‰å¾µç­†æ•¸</h5>
          <div style="display:flex; gap:8px; align-items:end; height:${maxBar + 60}px; padding:8px; background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef;">
            ${monthArr.map(item=>{ const h = max>0? Math.round((item.count/max)*maxBar):0; return `
              <div style="flex:1; display:flex; flex-direction:column; align-items:center; min-width:0;">
                <div style="position: relative; width:100%; display:flex; justify-content:center;">
                  <div style="width:100%; height:${h}px; background:#28a745; border-radius:4px 4px 0 0; position:relative; display:flex; align-items:flex-start; justify-content:center;">
                    <div style="font-size:12px; font-weight:700; color:#ffffff; padding:2px 6px; margin-top:4px; text-shadow:0 1px 0 rgba(0,0,0,0.3);">${item.count}</div>
                  </div>
                </div>
                <div style="font-size:11px; color:var(--muted); margin-top:8px;">${item.month}</div>
              </div>`; }).join('')}
          </div>
        </div>
      `;
    }
    
    function updateJobFilterOptions() {
      if (data.length === 0) return;
      
      // æ ¹æ“šç•¶å‰ç¯©é¸æ¢ä»¶ç²å–å¯ç”¨çš„è·å‹™åˆ—è¡¨
      const filteredData = data.filter(r => {
        // æª¢æŸ¥æœˆä»½ç¯©é¸
        if (!selectedMonths.has(r.__MONTH)) return false;
        
        // æª¢æŸ¥è·ç³»ç¯©é¸
        if (!selectedIDL.has(r.__IDL)) return false;
        
        // æª¢æŸ¥åŠŸèƒ½ç¯©é¸
        const funcLabel = FUNC_LABELS.find(x => x.key === r.__FUNC)?.label || 'å…¶ä»–';
        if (!selectedFuncs.has(funcLabel)) return false;
        
        // æª¢æŸ¥å» å€ç¯©é¸
        const locLabel = LOC_LABELS.find(x => x.key === r.__LOC)?.label || 'ç¸½éƒ¨';
        if (!selectedLocs.has(locLabel)) return false;
        
        // æª¢æŸ¥å…¬å¸åç¨±é—œéµå­—ç¯©é¸
        const companySearch = $companySearch.value.trim();
        if (companySearch) {
          const companyName = (r.__COMP || '').toLowerCase();
          if (!companyName.includes(companySearch.toLowerCase())) return false;
        }
        
        // æª¢æŸ¥å»é‡å’Œéš±è—æœªçŸ¥å…¬å¸é¸é …
        if ($toggleHideUnknown.checked) {
          if (r.__COMP === '' || r.__COMP === 'æœªå¡«å¯«' || r.__COMP === 'æ±‚è·è€…è¨­å®šéš±è—') return false;
        }
        
        return true;
      });
      
      // å¾ç¯©é¸å¾Œçš„æ•¸æ“šä¸­æå–ä¸é‡è¤‡çš„è·å‹™åç¨±
      const jobTitles = uniqueSorted(filteredData.map(d => d['è·å‹™åç¨±ä¸€'])).filter(Boolean);
      
      // æ›´æ–°ä¸‹æ‹‰é¸å–®
      $jobFilter.innerHTML = '<option value="">è«‹é¸æ“‡è·å‹™...</option>' + 
        jobTitles.map(job => `<option value="${escapeHtml(job)}">${escapeHtml(job)}</option>`).join('');
      
      // å¦‚æœç•¶å‰é¸ä¸­çš„è·å‹™ä¸åœ¨æ–°çš„é¸é …ä¸­ï¼Œæ¸…é™¤é¸æ“‡
      if (selectedJobTitle && !jobTitles.includes(selectedJobTitle)) {
        selectedJobTitle = '';
        $jobFilter.value = '';
        updateJobAnalysis();
      }
    }
    
    function getJobFilteredRows() {
      if (!selectedJobTitle) return [];
      return filteredRows().filter(r => r['è·å‹™åç¨±ä¸€'] === selectedJobTitle);
    }
    
    function updateJobAnalysis() {
      if (data.length === 0) {
        $jobAnalysisKPIs.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">è«‹å…ˆåŒ¯å…¥è³‡æ–™</div>';
        return;
      }
      
      if (!selectedJobTitle) {
        $jobAnalysisKPIs.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">è«‹é¸æ“‡ä¸€å€‹è·å‹™é€²è¡Œåˆ†æ</div>';
        $jobAnalysisSeniorityChart.innerHTML = '';
        $jobAnalysisTopCompanies.innerHTML = '';
        $jobAnalysisPreviousJobs.innerHTML = '';
        $jobAnalysisEducation.innerHTML = '';
        $jobAnalysisLocation.innerHTML = '';
        $jobAnalysisApplicantList.innerHTML = '';
        return;
      }
      
      const jobRows = getJobFilteredRows();
      if (jobRows.length === 0) {
        $jobAnalysisKPIs.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">è©²è·å‹™æš«ç„¡æ‡‰å¾µè€…è³‡æ–™</div>';
        return;
      }
      
      // æ›´æ–°æ ¸å¿ƒæ•¸æ“šæ‘˜è¦
      updateJobAnalysisKPIs(jobRows);
      
      // æ›´æ–°ç¶“é©—èƒŒæ™¯åˆ†æ
      updateJobAnalysisExperience(jobRows);
      
      // æ›´æ–°å­¸è¡“èˆ‡åœ°ç†åˆ†æ
      updateJobAnalysisEducationAndLocation(jobRows);
      
      // æ›´æ–°æ‡‰å¾µè€…æ¸…å–®
      updateJobAnalysisApplicantList(jobRows);
    }
    
    function updateJobAnalysisKPIs(jobRows) {
      const totalApplicants = jobRows.length;
      const uniqueApplicants = new Set(jobRows.map(r => r.__NAME)).size;
      
      // è¨ˆç®—å¹³å‡å¹´è³‡
      const validExperiences = jobRows
        .map(r => r['å¹´è³‡'])
        .filter(exp => exp && exp !== 'æœªå¡«å¯«' && exp !== 'ç„¡')
        .map(exp => {
          const match = exp.match(/(\d+)/);
          return match ? parseInt(match[1]) : 0;
        });
      const avgSeniority = validExperiences.length > 0 ? 
        (validExperiences.reduce((sum, exp) => sum + exp, 0) / validExperiences.length).toFixed(1) : 'N/A';
      
      // è¨ˆç®—æ–°é®®äººä½”æ¯”
      const freshGraduates = jobRows.filter(r => {
        const exp = r['å¹´è³‡'] || '';
        return exp === 'ç„¡' || exp.includes('ä¸€å¹´ä»¥ä¸‹') || exp.includes('1å¹´ä»¥ä¸‹') || 
               exp === '1' || exp.includes('1-2å¹´') || exp.includes('1~2å¹´') || exp === '2';
      }).length;
      const freshGraduateRatio = totalApplicants > 0 ? ((freshGraduates / totalApplicants) * 100).toFixed(1) : '0.0';
      
      // è¨ˆç®—ç›®æ¨™å­¸æ ¡ä½”æ¯”
      const targetSchoolApplicants = jobRows.filter(r => r['ç›®æ¨™å­¸æ ¡'] === 'Y').length;
      const targetSchoolRatio = totalApplicants > 0 ? ((targetSchoolApplicants / totalApplicants) * 100).toFixed(1) : '0.0';
      
  $jobAnalysisKPIs.innerHTML = `
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${totalApplicants.toLocaleString()}</div>
          <div style="font-size: 14px; color: var(--muted);">æ‡‰å¾µç¸½äººæ•¸</div>
        </div>
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${avgSeniority}</div>
          <div style="font-size: 14px; color: var(--muted);">å¹³å‡å¹´è³‡</div>
        </div>
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${freshGraduateRatio}%</div>
          <div style="font-size: 14px; color: var(--muted);">æ–°é®®äººä½”æ¯”</div>
        </div>
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${targetSchoolRatio}%</div>
          <div style="font-size: 14px; color: var(--muted);">ç›®æ¨™å­¸æ ¡ä½”æ¯”</div>
        </div>
      `;

  // æ ¹æ“šæ¨¡å¼é¡¯ç¤ºæœˆæˆ–é€±ç›´æ–¹åœ–
  const $histContainer = document.getElementById('jobHistContainer');
  if($histContainer){
    if(window.jobHistMode === 'week'){
      const weekly = groupByWeek(jobRows);
      $histContainer.innerHTML = renderJobWeeklyHistogram(weekly);
    } else {
      const byMonth = groupByMonth(jobRows).map(m=> ({ month: m.month, count: m.rows.length }));
      $histContainer.innerHTML = renderJobMonthlyHistogram(byMonth);
    }
  }
    }

    // æ–°å¢ï¼šä»¥é€±çš„èµ·å§‹/çµæŸæ—¥æœŸç‚ºæ¨™ç±¤ä¾†çµ±è¨ˆæ¯é€±ç­†æ•¸
    function pad(n){ return String(n).padStart(2,'0'); }

    function formatMd(d){ return `${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }

    // é€™å€‹ function æœƒæ ¹æ“šå‚³å…¥æ—¥æœŸè¨ˆç®—è©²æ—¥æœŸæ‰€åœ¨çš„ã€Œå¹´ + é€±åºã€ä»¥åŠè©²é€±çš„èµ·è¿„ Date
    function getWeekInfo(dateStr){
      if(!dateStr) return null;
      const d = new Date(dateStr);
      if(isNaN(d)) return null;
      const year = d.getFullYear();
      const jan1 = new Date(year,0,1);
      const dayOfYear = Math.floor((d - jan1) / 86400000) + 1;
      const week = Math.ceil(dayOfYear / 7);
      const weekKey = `${year}-W${String(week).padStart(2,'0')}`;
      const start = new Date(jan1.getTime() + (week - 1) * 7 * 86400000);
      const end = new Date(start.getTime() + 6 * 86400000);
      const label = `${formatMd(start)} - ${formatMd(end)}`;
      return { weekKey, start, end, label };
    }

    function groupByWeek(rows){
      const map = new Map(); // weekKey -> {count, start, end, label}
      for(const r of rows){
        const dateVal = r.__APPLY || r['æ‡‰å¾µæ—¥æœŸ'] || '';
        const info = getWeekInfo(dateVal) || { weekKey: 'æœªçŸ¥', start: null, end: null, label: 'æœªçŸ¥' };
        const key = info.weekKey;
        if(!map.has(key)) map.set(key, { count: 0, start: info.start, end: info.end, label: info.label });
        map.get(key).count += 1;
      }
      const arr = Array.from(map.entries()).map(([weekKey, v])=> ({ weekKey, count: v.count, start: v.start, end: v.end, label: v.label }));
      arr.sort((a,b)=> {
        if(a.start && b.start) return a.start - b.start;
        return a.weekKey.localeCompare(b.weekKey);
      });
      return arr;
    }

    function renderJobWeeklyHistogram(weeklyArr){
      if(!weeklyArr || weeklyArr.length===0) return '<div style="color: var(--muted); padding: 12px;">ç„¡é€±åˆ¥è³‡æ–™</div>';
      const maxCount = Math.max(...weeklyArr.map(i=>i.count));
      const maxBar = 200; // px
      return `
        <div style="margin-top:16px;">
          <h5 style="margin:0 0 8px 0; color: var(--primary);">é€±åˆ¥æ‡‰å¾µç­†æ•¸ (é€±èµ·è¿„æ—¥æœŸ)</h5>
          <div style="display:flex; gap:8px; align-items:end; height: ${maxBar + 60}px; padding: 8px; background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef;">
            ${weeklyArr.map(item=>{
              const h = maxCount>0? Math.round((item.count/maxCount)*maxBar):0;
              // split label ("MM/DD - MM/DD") into two lines with hyphen at line end
              const parts = (item.label||'').split(' - ');
              const left = parts[0] || '';
              const right = parts[1] || '';
              return `
                <div style="flex:1; display:flex; flex-direction:column; align-items:center; min-width:0;">
                  <div style="position: relative; width:100%; display:flex; justify-content:center;">
                    <div title="${item.label}: ${item.count} ç­†" style="width:100%; height:${h}px; background:var(--accent); border-radius:4px 4px 0 0; position:relative; display:flex; align-items:flex-start; justify-content:center;">
                      <div style="font-size:12px; font-weight:700; color:#ffffff; padding:2px 6px; margin-top:4px; text-shadow:0 1px 0 rgba(0,0,0,0.3);">${item.count}</div>
                    </div>
                  </div>
                  <div style="font-size:11px; color:var(--muted); margin-top:8px; white-space:normal; text-align:center; line-height:1.0;">${left}-<br>${right}</div>
                </div>`;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    function updateJobAnalysisExperience(jobRows) {
      // å¹´è³‡åˆ†ä½ˆ
      const experienceAgg = groupByExperience(jobRows);
      $jobAnalysisSeniorityChart.innerHTML = renderJobAnalysisSeniorityChart(experienceAgg);
      
      // å‰äº”å¤§ä¾†æºå…¬å¸
      const companyAgg = groupByCompany(jobRows);
      const top5Companies = companyAgg.slice(0, 5);
      $jobAnalysisTopCompanies.innerHTML = renderJobAnalysisTopCompanies(top5Companies);
      
      // å‰äº”å¤§å‰ç½®è·å‹™
      const previousJobStats = {};
      jobRows.forEach(r => {
        const prevJob = r['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±'] || 'æœªå¡«å¯«';
        if (prevJob !== 'æœªå¡«å¯«' && prevJob !== '') {
          previousJobStats[prevJob] = (previousJobStats[prevJob] || 0) + 1;
        }
      });
      const top5PreviousJobs = Object.entries(previousJobStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([job, count]) => ({è·å‹™: job, äººæ•¸: count}));
      $jobAnalysisPreviousJobs.innerHTML = renderJobAnalysisPreviousJobs(top5PreviousJobs);
    }
    
    function updateJobAnalysisEducationAndLocation(jobRows) {
      // ä¸»è¦ç•¢æ¥­å­¸æ ¡èˆ‡ç§‘ç³»
      const schoolMajorStats = {};
      jobRows.forEach(r => {
        const school = r['å­¸æ­·å­¸æ ¡åç¨±ä¸€'] || 'æœªå¡«å¯«';
        const major = normalizeMajor(r['å­¸æ­·ç§‘ç³»åç¨±ä¸€'] || 'æœªå¡«å¯«');
        if (school !== 'æœªå¡«å¯«' && major !== 'æœªå¡«å¯«') {
          const key = `${school} - ${major}`;
          schoolMajorStats[key] = (schoolMajorStats[key] || 0) + 1;
        }
      });
      const top5SchoolMajors = Object.entries(schoolMajorStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([schoolMajor, count]) => ({å­¸æ ¡ç§‘ç³»: schoolMajor, äººæ•¸: count}));
      $jobAnalysisEducation.innerHTML = renderJobAnalysisEducation(top5SchoolMajors);
      
      // æ‡‰å¾µè€…å±…ä½åœ°åˆ†ä½ˆ
      const locationStats = {};
      jobRows.forEach(r => {
        const address = r['é€šè¨Šåœ°å€'] || '';
        const { city } = parseAddress(address);
        if (city !== 'æœªå¡«å¯«') {
          locationStats[city] = (locationStats[city] || 0) + 1;
        }
      });
      const top5Locations = Object.entries(locationStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([city, count]) => ({ç¸£å¸‚: city, äººæ•¸: count}));
      $jobAnalysisLocation.innerHTML = renderJobAnalysisLocation(top5Locations);
    }
    
    function updateJobAnalysisApplicantList(jobRows) {
      // æŒ‰æ‡‰å¾µæ—¥æœŸæ’åºï¼Œæœ€è¿‘çš„æ’åœ¨æœ€ä¸Šé¢
      const sortedRows = [...jobRows].sort((a, b) => {
        const dateA = new Date(a.__APPLY || '');
        const dateB = new Date(b.__APPLY || '');
        return dateB - dateA; // é™åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰
      });
      
      $jobAnalysisApplicantList.innerHTML = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6; width: 80px;">å§“å</th>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å¹´è³‡</th>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å‰ä¸€å…¬å¸</th>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å‰ä¸€è·å‹™</th>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">æœ€é«˜å­¸æ­·</th>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">ç•¢æ¥­å­¸æ ¡+ç§‘ç³»</th>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">æ‡‰å¾µæ—¥æœŸ</th>
            </tr>
          </thead>
          <tbody>
            ${sortedRows.map(r => {
              // æ ¼å¼åŒ–æ‡‰å¾µæ—¥æœŸï¼Œåªä¿ç•™æœˆ/æ—¥/å¹´
              const applyDate = r.__APPLY || '';
              const formattedDate = applyDate ? applyDate.split(' ')[0] : '';
              
              // çµ„åˆç•¢æ¥­å­¸æ ¡+ç§‘ç³»
              const school = r['å­¸æ ¡NEW'] || '';
              const major = r['å­¸æ­·ç§‘ç³»åç¨±ä¸€'] || '';
              const schoolMajor = school && major ? `${school} - ${major}` : (school || major || '');
              
              return `
                <tr>
                  <td style="padding: 8px; border-bottom: 1px solid #f1f3f4; width: 80px;">${escapeHtml(r.__NAME)}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${escapeHtml(r['å¹´è³‡'] || '')}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${escapeHtml(r.__COMP)}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${escapeHtml(r['å·¥ä½œç¶“é©—ä¸€è·å‹™åç¨±'] || '')}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${escapeHtml(r['å­¸æ­·ä¸€'] || '')}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${escapeHtml(schoolMajor)}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">${escapeHtml(formattedDate)}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }
    
    function renderJobAnalysisSeniorityChart(experienceAgg) {
      const maxCount = Math.max(...experienceAgg.map(item => item.äººæ•¸));
      const yAxisMax = Math.ceil(maxCount * 1.2);
      
      return `
        <div style="display: flex; align-items: end; gap: 8px; height: 150px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          ${experienceAgg.map((item, index) => {
            const height = (item.äººæ•¸ / yAxisMax) * 120;
            const colors = ['#90EE90', '#28a745', '#007bff', '#ffc107', '#fd7e14', '#dc3545'];
            const color = colors[index % colors.length];
            return `
              <div style="display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 0;">
                <div style="
                  width: 100%; 
                  height: ${height}px; 
                  background: ${color}; 
                  border-radius: 4px 4px 0 0;
                  transition: all 0.3s ease;
                  cursor: pointer;
                " 
                onmouseover="this.style.opacity='0.8'"
                onmouseout="this.style.opacity='1'"
                title="${item.å¹´è³‡}: ${item.äººæ•¸.toLocaleString()}äºº">
                </div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 8px; text-align: center; word-break: break-all; line-height: 1.2;">
                  ${item.å¹´è³‡}
                </div>
                <div style="font-size: 10px; color: var(--primary); margin-top: 4px; text-align: center; font-weight: 600;">
                  ${item.äººæ•¸}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // --- è·å‹™çµ±è¨ˆï¼šè¨ˆç®—æ¯æœˆè·å‹™æ•¸ã€ç´¯è¨ˆè·å‹™æ•¸ã€æ¯æœˆå±¥æ­·æŠ•éç­†æ•¸ã€ç´¯è¨ˆå±¥æ­·æŠ•éç­†æ•¸ã€å¹³å‡æ¯è·ç¼ºå±¥æ­·æ•¸ ---
    function computeJobStats(rows){
      // rows: already filtered rows (may include duplicates depending on dedup toggle)
      // 1) group by month -> per-month job set and counts
      const freshOnlyCheckbox = document.getElementById('jobStatsFreshOnly');
      const freshOnly = !!(freshOnlyCheckbox && freshOnlyCheckbox.checked);
      const byMonth = new Map(); // month -> { jobs: Set, resumes: count }
      rows.forEach(r => {
        // only count rows that belong to an IDL category
        const idl = (r.__IDL || '').toString().trim();
        if(!idl) return; // skip rows not classified to an IDL
        // If freshOnly is enabled (job-level), only consider rows whose åŸå§‹æ¬„ä½ æ–°é®®äººè·ç¼º is 'Y'
        const freshFlag = (r['æ–°é®®äººè·ç¼º'] || r.__isFresh || '').toString().trim().toUpperCase();
        if(freshOnly && freshFlag !== 'Y') return;

        const month = r.__MONTH || 'æœªçŸ¥';
        if(!byMonth.has(month)) byMonth.set(month, { jobs: new Set(), resumes: 0 });
        const entry = byMonth.get(month);
        const jobTitle = r['è·å‹™åç¨±ä¸€'] || 'æœªå¡«å¯«';
        entry.jobs.add(jobTitle);

        // Applicant-level fresh flag: prefer explicit column(s) indicating applicant is fresh grads
        const applicantFreshRaw = (r['æ–°é®®äººï¼ˆ2yå…§ï¼‰'] || r['æ–°é®®äºº'] || r.__isFreshApplicant || '').toString().trim().toUpperCase();
        let isApplicantFresh = false;
        if(applicantFreshRaw) {
          isApplicantFresh = (applicantFreshRaw === 'Y');
        } else {
          // fallback: infer from å¹´è³‡ field (same logic as elsewhere)
          const exp = (r['å¹´è³‡'] || '').toString();
          isApplicantFresh = (exp === 'ç„¡' || exp.includes('ä¸€å¹´ä»¥ä¸‹') || exp.includes('1å¹´ä»¥ä¸‹') || exp === '1' || exp.includes('1-2å¹´') || exp.includes('1~2å¹´') || exp === '2');
        }

        // Count resumes only when applicant is fresh (per requirement)
        if(isApplicantFresh) entry.resumes += 1;
      });

      // Convert to sorted array by MONTH_ORDER or by natural month ordering if present
      const months = Array.from(byMonth.keys()).sort((a,b)=>{
        const ia = MONTH_ORDER.indexOf(a);
        const ib = MONTH_ORDER.indexOf(b);
        if(ia>=0 && ib>=0) return ia-ib;
        if(ia>=0) return -1;
        if(ib>=0) return 1;
        return a.localeCompare(b);
      });

      const stats = [];
      let cumulativeJobsSet = new Set();
      let cumulativeResumes = 0;
      months.forEach(m => {
        const entry = byMonth.get(m);
        const jobCount = entry.jobs.size;
        cumulativeJobsSet = new Set([...cumulativeJobsSet, ...Array.from(entry.jobs)]);
        cumulativeResumes += entry.resumes;
        // å¹³å‡æ¯è·ç¼ºå±¥æ­·æ•¸ï¼šä½¿ç”¨ç´¯è¨ˆå±¥æ­·æŠ•é / ç´¯è¨ˆè·ç¼ºæ•¸
        const cumulativeJobs = cumulativeJobsSet.size;
        const avgResumesPerJob = cumulativeJobs > 0 ? (cumulativeResumes / cumulativeJobs) : 0;
        stats.push({ month: m, jobCount, resumes: entry.resumes, cumulativeJobs, cumulativeResumes, avgResumesPerJob });
      });

      // Also compute overall averages across months
      const totalJobCounts = stats.reduce((s,it)=> s+it.jobCount, 0);
      const totalResumes = stats.reduce((s,it)=> s+it.resumes, 0);
      const avgJobsPerMonth = stats.length ? (totalJobCounts / stats.length) : 0;
      const avgResumesPerMonth = stats.length ? (totalResumes / stats.length) : 0;

      return { stats, avgJobsPerMonth, avgResumesPerMonth };
    }

    function renderJobStats(computed, title){
      if(!computed) return `<div style="color:var(--muted); padding:12px;">æš«ç„¡è³‡æ–™</div>`;
      const rows = computed.stats || [];
      const header = `
        <div style="display:flex; flex-direction:column; gap:6px; margin-bottom:8px;">
          ${title ? `<div style="font-weight:700; font-size:15px;">${escapeHtml(title)}</div>` : ''}
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            <div style="background:#f8f9fa; padding:10px; border-radius:8px;">å¹³å‡æ¯æœˆè·ç¼ºæ•¸ï¼š<strong>${computed.avgJobsPerMonth.toFixed(1)}</strong></div>
            <div style="background:#f8f9fa; padding:10px; border-radius:8px;">å¹³å‡æ¯æœˆå±¥æ­·æŠ•éï¼š<strong>${computed.avgResumesPerMonth.toFixed(1)}</strong></div>
          </div>
        </div>
      `;

      const tableRows = rows.map(r=> `
        <div style="display:flex; gap:12px; align-items:center; padding:8px 0; border-bottom:1px solid var(--card-border);">
          <div style="width:110px; font-weight:700;">${escapeHtml(r.month)}</div>
          <div style="flex:1; display:flex; gap:12px;">
            <div style="min-width:140px;">è·ç¼ºæ•¸ï¼š<strong>${r.jobCount}</strong></div>
            <div style="min-width:140px;">ç´¯è¨ˆè·ç¼ºï¼š<strong>${r.cumulativeJobs}</strong></div>
            <div style="min-width:160px;">æœ¬æœˆå±¥æ­·æŠ•éï¼š<strong>${r.resumes}</strong></div>
            <div style="min-width:160px;">ç´¯è¨ˆå±¥æ­·æŠ•éï¼š<strong>${r.cumulativeResumes}</strong></div>
            <div style="min-width:180px;">å¹³å‡æ¯è·ç¼ºå±¥æ­·æ•¸ï¼š<strong>${r.avgResumesPerJob.toFixed(2)}</strong></div>
          </div>
        </div>
      `).join('');

      return `<div>${header}<div style="background:var(--panel); padding:8px; border-radius:8px;">${tableRows}</div></div>`;
    }

    function updateJobStatistics(rows){
      // compute and render into #jobStatsContent
      const container = document.getElementById('jobStatsContent');
      if(!container) return;
      const computed = computeJobStats(rows);
      container.innerHTML = renderJobStats(computed);
      // also compute target-newcomer stats (same logic but resumes count only when ç›®æ¨™å­¸æ ¡ === 'Y')
      const tcontainer = document.getElementById('targetStatsContent');
      if(tcontainer){
        const tcomputed = computeTargetStats(rows);
        tcontainer.innerHTML = renderJobStats(tcomputed);
      }
      // render comparison chart showing monthly resumes for all vs target schools
      const chartEl = document.getElementById('comparisonChart');
      if(chartEl){
        try{
          const all = computeJobStats(rows).stats || [];
          const target = computeTargetStats(rows).stats || [];
          chartEl.innerHTML = renderComparisonChart(all, target);
        }catch(e){ chartEl.innerHTML = '<div style="color:var(--muted); padding:12px;">ç„¡æ³•ç”¢ç”Ÿåœ–è¡¨</div>'; }
      }
    }

    // render a simple SVG two-line chart for comparison
    function renderComparisonChart(allStats, targetStats){
      // styled line chart matching provided attachment
      const MONTH_ORDER = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const months = Array.from(new Set([...(allStats||[]).map(s=>s.month), ...(targetStats||[]).map(s=>s.month)]));
      months.sort((a,b)=> MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
      const allMap = (allStats||[]).reduce((m,s)=> (m[s.month]=s.resumes, m), {});
      const tgtMap = (targetStats||[]).reduce((m,s)=> (m[s.month]=s.resumes, m), {});

      const values = months.map(m=> Math.max(allMap[m]||0, tgtMap[m]||0));
      const maxV = Math.max(1, ...values);

      const w = 900, h = 260, pad = 50;
      const xStep = (w - pad*2) / Math.max(1, months.length - 1);
      const yScale = v => h - pad - ((v / maxV) * (h - pad*2));

      const makePath = (map) => months.map((m,i)=> `${pad + i * xStep},${yScale(map[m]||0)}`).join(' ');
      const pAll = makePath(allMap);
      const pTgt = makePath(tgtMap);

      const monthLabels = months.map((m,i)=> `<text x="${pad + i * xStep}" y="${h - pad + 22}" font-size="14" text-anchor="middle" fill="var(--muted)">${m}</text>`).join('');

      const allLabels = months.map((m,i)=> `<text x="${pad + i * xStep}" y="${yScale(allMap[m]||0) - 12}" font-size="12" text-anchor="middle" fill="#666">${allMap[m]||0}</text>`).join('');
      const tgtLabels = months.map((m,i)=> `<text x="${pad + i * xStep}" y="${yScale(tgtMap[m]||0) - 12}" font-size="12" text-anchor="middle" fill="#b5631a">${tgtMap[m]||0}</text>`).join('');

      const allDots = months.map((m,i)=> `<circle cx="${pad + i * xStep}" cy="${yScale(allMap[m]||0)}" r="4" fill="#7a7a7a" />`).join('');
      const tgtDots = months.map((m,i)=> `<circle cx="${pad + i * xStep}" cy="${yScale(tgtMap[m]||0)}" r="4" fill="#f0b429" />`).join('');

      // legend centered
      const legend = `
        <g transform="translate(${w/2 - 140},14)">
          <circle cx="8" cy="8" r="6" fill="#7a7a7a" />
          <text x="22" y="12" font-size="13" fill="#333">æ–°é®®äººæ‡‰å¾µå–®æœˆæ•¸_å…¨éƒ¨å­¸æ ¡</text>
          <circle cx="260" cy="8" r="6" fill="#f0b429" />
          <text x="284" y="12" font-size="13" fill="#333">æ–°é®®äººæ‡‰å¾µå–®æœˆæ•¸_ç›®æ¨™å­¸æ ¡</text>
        </g>
      `;

      return `
        <svg width="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet">
          <rect x="0" y="0" width="${w}" height="${h}" fill="transparent" />
          <!-- subtle horizontal grid -->
          ${[0,0.25,0.5,0.75,1].map(g=> `<line x1="${pad}" x2="${w-pad}" y1="${pad + g*(h-pad*2)}" y2="${pad + g*(h-pad*2)}" stroke="#f1f1f1" stroke-width="1"/>`).join('')}
          ${legend}
          <!-- target (yellow) line -->
          <polyline points="${pTgt}" fill="none" stroke="#f0b429" stroke-width="4" stroke-linejoin="round" stroke-linecap="round" />
          ${tgtDots}
          <!-- all (grey) line -->
          <polyline points="${pAll}" fill="none" stroke="#7a7a7a" stroke-width="4" stroke-linejoin="round" stroke-linecap="round" />
          ${allDots}
          ${tgtLabels}
          ${allLabels}
          ${monthLabels}
        </svg>
      `;
    }

    function computeTargetStats(rows){
      // same structure as computeJobStats but resumes only count when r['ç›®æ¨™å­¸æ ¡'] === 'Y'
      const byMonth = new Map();
      rows.forEach(r => {
        const idl = (r.__IDL || '').toString().trim();
        if(!idl) return;
        const freshFlagJob = (r['æ–°é®®äººè·ç¼º'] || r.__isFresh || '').toString().trim().toUpperCase();
        const freshOnlyCheckbox = document.getElementById('jobStatsFreshOnly');
        const freshOnly = !!(freshOnlyCheckbox && freshOnlyCheckbox.checked);
        if(freshOnly && freshFlagJob !== 'Y') return;

        const month = r.__MONTH || 'æœªçŸ¥';
        if(!byMonth.has(month)) byMonth.set(month, { jobs: new Set(), resumes: 0 });
        const entry = byMonth.get(month);
        const jobTitle = r['è·å‹™åç¨±ä¸€'] || 'æœªå¡«å¯«';
        entry.jobs.add(jobTitle);

        // Count resumes only when applicant is from ç›®æ¨™å­¸æ ¡ === 'Y'
        const targetFlag = (r['ç›®æ¨™å­¸æ ¡'] || '').toString().trim().toUpperCase();
        if(targetFlag === 'Y') entry.resumes += 1;
      });

      const months = Array.from(byMonth.keys()).sort((a,b)=>{
        const ia = MONTH_ORDER.indexOf(a);
        const ib = MONTH_ORDER.indexOf(b);
        if(ia>=0 && ib>=0) return ia-ib;
        if(ia>=0) return -1;
        if(ib>=0) return 1;
        return a.localeCompare(b);
      });

      const stats = [];
      let cumulativeJobsSet = new Set();
      let cumulativeResumes = 0;
      months.forEach(m => {
        const entry = byMonth.get(m);
        const jobCount = entry.jobs.size;
        cumulativeJobsSet = new Set([...cumulativeJobsSet, ...Array.from(entry.jobs)]);
        cumulativeResumes += entry.resumes;
        const cumulativeJobs = cumulativeJobsSet.size;
        const avgResumesPerJob = cumulativeJobs > 0 ? (cumulativeResumes / cumulativeJobs) : 0;
        stats.push({ month: m, jobCount, resumes: entry.resumes, cumulativeJobs, cumulativeResumes, avgResumesPerJob });
      });

      const totalJobCounts = stats.reduce((s,it)=> s+it.jobCount, 0);
      const totalResumes = stats.reduce((s,it)=> s+it.resumes, 0);
      const avgJobsPerMonth = stats.length ? (totalJobCounts / stats.length) : 0;
      const avgResumesPerMonth = stats.length ? (totalResumes / stats.length) : 0;

      return { stats, avgJobsPerMonth, avgResumesPerMonth };
    }

    // Sidebar button: show jobStats panel
    const $tabJobStats = document.getElementById('tabJobStats');
    if($tabJobStats){
      $tabJobStats.addEventListener('click', ()=>{
        // hide other panels and show jobStatsPanel
        document.querySelectorAll('.tab-content').forEach(el=> el.style.display = 'none');
        const p = document.getElementById('jobStatsPanel'); if(p) p.style.display = 'block';
      });
    }
    // jobStatsFreshOnly checkbox: re-render job stats on change
    const $jobStatsFreshOnly = document.getElementById('jobStatsFreshOnly');
    if($jobStatsFreshOnly){
      $jobStatsFreshOnly.addEventListener('change', ()=>{
        // recompute and render based on current filters
        try{ updateJobStatistics(filteredRows()); }catch(e){/* ignore */}
      });
    }
    
    function renderJobAnalysisTopCompanies(companies) {
      return `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${companies.map((company, index) => {
            const maxCount = Math.max(...companies.map(c => c.äººæ•¸));
            const width = (company.äººæ•¸ / maxCount) * 100;
            return `
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="font-size: 12px; color: var(--muted); min-width: 20px;">${index + 1}</div>
                <div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 20px; position: relative;">
                  <div style="
                    background: var(--accent); 
                    height: 100%; 
                    width: ${width}%; 
                    border-radius: 4px; 
                    transition: width 0.3s ease;
                  "></div>
                  <div style="position: absolute; top: 50%; left: 8px; transform: translateY(-50%); font-size: 11px; color: white; font-weight: 600;">
                    ${company.å…¬å¸}
                  </div>
                </div>
                <div style="font-size: 12px; color: var(--primary); font-weight: 600; min-width: 30px;">
                  ${company.äººæ•¸}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function renderJobAnalysisPreviousJobs(jobs) {
      return `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${jobs.map((job, index) => {
            const maxCount = Math.max(...jobs.map(j => j.äººæ•¸));
            const width = (job.äººæ•¸ / maxCount) * 100;
            return `
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="font-size: 12px; color: var(--muted); min-width: 20px;">${index + 1}</div>
                <div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 20px; position: relative;">
                  <div style="
                    background: #28a745; 
                    height: 100%; 
                    width: ${width}%; 
                    border-radius: 4px; 
                    transition: width 0.3s ease;
                  "></div>
                  <div style="position: absolute; top: 50%; left: 8px; transform: translateY(-50%); font-size: 11px; color: white; font-weight: 600;">
                    ${job.è·å‹™}
                  </div>
                </div>
                <div style="font-size: 12px; color: var(--primary); font-weight: 600; min-width: 30px;">
                  ${job.äººæ•¸}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function renderJobAnalysisEducation(schoolMajors) {
      return `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">å­¸æ ¡+ç§‘ç³»</th>
              <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
            </tr>
          </thead>
          <tbody>
            ${schoolMajors.map((item, index) => `
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                  <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                  ${escapeHtml(item.å­¸æ ¡ç§‘ç³»)}
                </td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${item.äººæ•¸.toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    function renderJobAnalysisLocation(locations) {
      return `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">ç¸£å¸‚</th>
              <th style="padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;">äººæ•¸</th>
            </tr>
          </thead>
          <tbody>
            ${locations.map((item, index) => `
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f1f3f4;">
                  <span style="display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>
                  ${escapeHtml(item.ç¸£å¸‚)}
                </td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f3f4;">${item.äººæ•¸.toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    $companySearch.addEventListener('input', ()=> update());
    $toggleDedup.addEventListener('change', ()=> update());
    $toggleHideUnknown.addEventListener('change', ()=> update());

    $monthSelectAll.addEventListener('click', ()=>{ selectedMonths = new Set(uniqueSortedMonths(data.map(d=>d['æœˆä»½']))); buildChips($monthChips, Array.from(selectedMonths).sort((a,b)=> MONTH_ORDER.indexOf(a)-MONTH_ORDER.indexOf(b)), selectedMonths, update); update(); });
    $monthClear.addEventListener('click', ()=>{ selectedMonths = new Set(); buildChips($monthChips, uniqueSortedMonths(data.map(d=>d['æœˆä»½'])), selectedMonths, update); update(); });

  $idlSelectAll.addEventListener('click', ()=>{ selectedIDL = new Set(uniqueSorted(data.map(d=>d.__IDL))); buildChips($idlChips, Array.from(selectedIDL).sort(), selectedIDL, update); update(); });
  $idlClear.addEventListener('click', ()=>{ selectedIDL = new Set(); buildChips($idlChips, uniqueSorted(data.map(d=>d.__IDL)), selectedIDL, update); update(); });

    $funcSelectAll.addEventListener('click', ()=>{ selectedFuncs = new Set(FUNC_LABELS.map(f=>f.label)); buildChips($funcChips, Array.from(selectedFuncs), selectedFuncs, update); update(); });
    $funcClear.addEventListener('click', ()=>{ selectedFuncs = new Set(); buildChips($funcChips, FUNC_LABELS.map(f=>f.label), selectedFuncs, update); update(); });

    $locSelectAll.addEventListener('click', ()=>{ selectedLocs = new Set(LOC_LABELS.map(l=>l.label)); buildChips($locChips, Array.from(selectedLocs), selectedLocs, update); update(); });
    $locClear.addEventListener('click', ()=>{ selectedLocs = new Set(); buildChips($locChips, LOC_LABELS.map(l=>l.label), selectedLocs, update); update(); });

    // è·å‹™åˆ†æç¯©é¸å™¨äº‹ä»¶
    $jobFilter.addEventListener('change', ()=>{
      selectedJobTitle = $jobFilter.value;
      updateJobAnalysis();
    });
    
    $clearJobFilter.addEventListener('click', ()=>{
      selectedJobTitle = '';
      $jobFilter.value = '';
      updateJobAnalysis();
    });

    // åˆ†é åˆ‡æ›äº‹ä»¶
    $tabOverview.addEventListener('click', ()=>{
      $tabOverview.className = 'nav-item active';
      $tabCompany.className = 'nav-item';
      $tabExperience.className = 'nav-item';
      $tabEducation.className = 'nav-item';
      $tabGeography.className = 'nav-item';
      $tabJobAnalysis.className = 'nav-item';
  $overviewStats.style.display = 'block';
      $companyStats.style.display = 'none';
      $experienceStats.style.display = 'none';
      $educationStats.style.display = 'none';
      $geographyStats.style.display = 'none';
  $jobAnalysisStats.style.display = 'none';
  if($jobStatsPanel) $jobStatsPanel.style.display = 'none';
    });

    $tabCompany.addEventListener('click', ()=>{
      $tabOverview.className = 'nav-item';
      $tabCompany.className = 'nav-item active';
      $tabExperience.className = 'nav-item';
      $tabEducation.className = 'nav-item';
      $tabGeography.className = 'nav-item';
      $tabJobAnalysis.className = 'nav-item';
  $overviewStats.style.display = 'none';
  $companyStats.style.display = 'block';
  $experienceStats.style.display = 'none';
  $educationStats.style.display = 'none';
  $geographyStats.style.display = 'none';
  $jobAnalysisStats.style.display = 'none';
  if($jobStatsPanel) $jobStatsPanel.style.display = 'none';
    });

    $tabExperience.addEventListener('click', ()=>{
      $tabOverview.className = 'nav-item';
      $tabCompany.className = 'nav-item';
      $tabExperience.className = 'nav-item active';
      $tabEducation.className = 'nav-item';
      $tabGeography.className = 'nav-item';
      $tabJobAnalysis.className = 'nav-item';
  $overviewStats.style.display = 'none';
  $companyStats.style.display = 'none';
  $experienceStats.style.display = 'block';
  $educationStats.style.display = 'none';
  $geographyStats.style.display = 'none';
  $jobAnalysisStats.style.display = 'none';
  if($jobStatsPanel) $jobStatsPanel.style.display = 'none';
    });

    $tabEducation.addEventListener('click', ()=>{
      $tabOverview.className = 'nav-item';
      $tabCompany.className = 'nav-item';
      $tabExperience.className = 'nav-item';
      $tabEducation.className = 'nav-item active';
      $tabGeography.className = 'nav-item';
      $tabJobAnalysis.className = 'nav-item';
  $overviewStats.style.display = 'none';
  $companyStats.style.display = 'none';
  $experienceStats.style.display = 'none';
  $educationStats.style.display = 'block';
  $geographyStats.style.display = 'none';
  $jobAnalysisStats.style.display = 'none';
  if($jobStatsPanel) $jobStatsPanel.style.display = 'none';
    });

    $tabGeography.addEventListener('click', ()=>{
      $tabOverview.className = 'nav-item';
      $tabCompany.className = 'nav-item';
      $tabExperience.className = 'nav-item';
      $tabEducation.className = 'nav-item';
      $tabGeography.className = 'nav-item active';
      $tabJobAnalysis.className = 'nav-item';
  $overviewStats.style.display = 'none';
  $companyStats.style.display = 'none';
  $experienceStats.style.display = 'none';
  $educationStats.style.display = 'none';
  $geographyStats.style.display = 'block';
  $jobAnalysisStats.style.display = 'none';
  if($jobStatsPanel) $jobStatsPanel.style.display = 'none';
    });

    $tabJobAnalysis.addEventListener('click', ()=>{
      $tabOverview.className = 'nav-item';
      $tabCompany.className = 'nav-item';
      $tabExperience.className = 'nav-item';
      $tabEducation.className = 'nav-item';
      $tabGeography.className = 'nav-item';
      $tabJobAnalysis.className = 'nav-item active';
  $overviewStats.style.display = 'none';
  $companyStats.style.display = 'none';
  $experienceStats.style.display = 'none';
  $educationStats.style.display = 'none';
  $geographyStats.style.display = 'none';
  $jobAnalysisStats.style.display = 'block';
  if($jobStatsPanel) $jobStatsPanel.style.display = 'none';
    });

    // æ–°é€²äººå“¡ç¯©é¸æŒ‰éˆ•äº‹ä»¶
    $filterNewcomers.addEventListener('click', ()=>{
      isNewcomerFilterActive = true;
      $filterNewcomers.style.background = '#28a745';
      $filterNewcomers.textContent = 'âœ“ å·²ç¯©é¸æ–°é€²äººå“¡';
      update();
    });

    $clearNewcomerFilter.addEventListener('click', ()=>{
      isNewcomerFilterActive = false;
      $filterNewcomers.style.background = 'var(--accent)';
      $filterNewcomers.textContent = 'ç¯©é¸æ–°é€²äººå“¡ï¼ˆç„¡å¹´è³‡+äºŒå¹´ä»¥å…§ï¼‰';
      update();
    });

    // ç¦ç”¨æ§åˆ¶ç›´åˆ°è¼‰å…¥è³‡æ–™
    enableControls(false);
    
    // åŒ¯å…¥æé†’è¦–çª—ç›¸é—œå…ƒç´ 
    const $importReminderModal = document.getElementById('importReminderModal');
    const $startImportBtn = document.getElementById('startImportBtn');
    
    // é–‹å§‹åŒ¯å…¥æŒ‰éˆ•äº‹ä»¶
    $startImportBtn.addEventListener('click', () => {
      // é—œé–‰æé†’è¦–çª—
      $importReminderModal.style.display = 'none';
      // è§¸ç™¼æª”æ¡ˆé¸æ“‡
      document.getElementById('importBtn').click();
    });
    
    // æª”æ¡ˆåŒ¯å…¥æˆåŠŸå¾Œé—œé–‰æé†’è¦–çª—
    const originalImportHandler = document.getElementById('importBtn').onclick;
    document.getElementById('importBtn').addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // å‰µå»ºæ–°çš„æª”æ¡ˆè¼¸å…¥å…ƒç´ 
      const newFileInput = document.createElement('input');
      newFileInput.type = 'file';
      newFileInput.accept = '.csv';
      newFileInput.style.display = 'none';
      
      newFileInput.addEventListener('change', (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const text = reader.result.toString();
            raw = parseCSV(text);
            if (raw.length === 0) {
              alert('è®€ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèª CSV å…§å®¹ã€‚');
              return;
            }
            data = preprocess(raw);
            mode = MODE.TOTAL;
            $companySearch.value = '';
            $toggleDedup.checked = false;
            $toggleHideUnknown.checked = false;
            initFilters();
            
            // åŒ¯å…¥æˆåŠŸå¾Œé—œé–‰æé†’è¦–çª—
            $importReminderModal.style.display = 'none';
            
            // è‡ªå‹•åˆ‡æ›åˆ°æ•´é«”åˆ†æé é¢
            $tabOverview.className = 'nav-item active';
            $tabCompany.className = 'nav-item';
            $tabExperience.className = 'nav-item';
            $overviewStats.style.display = 'block';
            $companyStats.style.display = 'none';
            $experienceStats.style.display = 'none';
          } catch (error) {
            console.error('æª”æ¡ˆè™•ç†éŒ¯èª¤:', error);
            alert('æª”æ¡ˆè™•ç†å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
          }
        };
        reader.onerror = () => {
          alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
        };
        reader.readAsText(file, 'utf-8');
        
        // æ¸…ç†è‡¨æ™‚å…ƒç´ 
        document.body.removeChild(newFileInput);
      });
      
      // æ·»åŠ åˆ° DOM ä¸¦è§¸ç™¼é»æ“Š
      document.body.appendChild(newFileInput);
      newFileInput.click();
    });
  </script>
</body>
</html>
